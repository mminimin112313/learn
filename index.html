<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learnia 0.1</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome (for icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Google Fonts: Inter (for English) and Noto Sans KR (for Korean) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        :root {
            --bg-primary: #FFFFFF;
            --bg-secondary: #F0F3F7;
            --card-background: #FFFFFF;
            --accent-primary: #4285F4; /* Google Blue */
            --text-primary: #3C4043; /* Dark Gray */
            --text-secondary: #5F6368; /* Medium Gray */
            --success-color: #34A853;
            --warning-color: #FBBC04;
            --danger-color: #EA4335;
        }

        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }

        /* Loading Spinner */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease-in-out;
        }

        .spinner-border {
            color: var(--accent-primary);
        }

        /* Global Container */
        .learnia-container {
            display: grid;
            grid-template-columns: 280px 1fr; /* Sidebar and main content */
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        #sidebar {
            background-color: var(--bg-secondary);
            padding: 20px;
            border-right: 1px solid #E0E0E0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: relative; /* For mobile toggle */
        }

        #sidebar.collapsed {
            transform: translateX(-100%);
            position: absolute;
            left: 0;
            height: 100vh; /* Ensure it covers full height when collapsed on mobile */
            z-index: 1050; /* Above main content, below modals */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .sidebar-header .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-primary);
            text-decoration: none;
        }

        .sidebar-section-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-secondary);
            margin-top: 25px;
            margin-bottom: 10px;
            padding-left: 10px;
        }

        .sidebar-link, .sidebar-button, .list-group-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            color: var(--text-primary);
            text-decoration: none;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 0.95rem;
        }

        .sidebar-link i, .sidebar-button i {
            margin-right: 10px;
            width: 20px; /* Fixed width for icons */
            text-align: center;
        }

        .sidebar-link:hover, .sidebar-button:hover, .list-group-item:hover {
            background-color: rgba(66, 133, 244, 0.1); /* Light blue hover */
            color: var(--accent-primary);
        }

        .list-group-item.active {
            background-color: var(--accent-primary);
            color: white;
            font-weight: 500;
        }

        .list-group-item.active i {
             color: white;
        }


        .auth-section {
            margin-bottom: 20px;
            padding: 10px;
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        /* Main Content Area */
        .main-content {
            background-color: var(--bg-primary);
            overflow-y: auto;
            padding: 20px;
        }

        .mobile-header {
            display: none; /* Hidden on desktop */
            background-color: var(--bg-primary);
            padding: 15px 20px;
            border-bottom: 1px solid #E0E0E0;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .mobile-header .hamburger-menu {
            font-size: 1.5rem;
            color: var(--text-primary);
            cursor: pointer;
        }

        .mobile-header .project-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Welcome Screen */
        #welcome-screen {
            text-align: center;
            padding: 50px;
            background-color: var(--card-background);
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            margin: 50px auto;
            max-width: 700px;
        }

        #welcome-screen h2 {
            font-size: 2.5rem;
            color: var(--accent-primary);
            margin-bottom: 20px;
        }

        #welcome-screen p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .start-action-buttons .btn {
            font-size: 1rem;
            padding: 12px 25px;
            margin: 0 10px;
            border-radius: 8px;
            font-weight: 500;
        }

        /* Project Workspace */
        #project-workspace {
            display: none; /* Hidden by default */
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0;
        }

        /* Planning Section */
        #planning-section .card {
            border-radius: 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        #planning-section .card-header {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid #E0E0E0;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            padding: 15px 20px;
            font-weight: 500;
        }

        /* Progress Analysis */
        #progress-analysis .card {
            border-radius: 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .progress-circle {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(var(--accent-primary) 0%, lightgray 0%);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .progress-circle::before {
            content: '';
            position: absolute;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background-color: white;
        }

        .progress-circle span {
            position: relative;
            z-index: 1;
        }

        /* Learning Dashboard (Project Cards) */
        .project-card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .project-card {
            background-color: var(--card-background);
            border-radius: 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            padding: 25px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .project-card .card-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .project-card .card-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .project-card .card-text {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.5;
            flex-grow: 1;
        }

        .project-card .badge-status {
            font-size: 0.85rem;
            padding: 6px 10px;
            border-radius: 5px;
        }

        .badge-pending { background-color: var(--warning-color); color: white; }
        .badge-inprogress { background-color: var(--accent-primary); color: white; }
        .badge-completed { background-color: var(--success-color); color: white; }

        /* Modals */
        .modal-content {
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid #E0E0E0;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            padding: 1.25rem 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            border-top: 1px solid #E0E0E0;
            padding: 1rem 1.5rem;
        }

        .btn-primary {
            background-color: var(--accent-primary);
            border-color: var(--accent-primary);
            border-radius: 8px;
            padding: 10px 20px;
        }

        .btn-primary:hover {
            background-color: #357AE8; /* Slightly darker Google Blue */
            border-color: #357AE8;
        }

        .btn-outline-secondary {
            border-radius: 8px;
            padding: 10px 20px;
        }

        /* Project Overview Modal */
        #projectOverviewModal .list-group-item {
            cursor: pointer;
            border-radius: 10px;
            margin-bottom: 8px;
            border: 1px solid #e0e0e0;
        }

        /* Lecture Detail Modal */
        #lectureDetailModal .modal-dialog {
            max-width: 90vw; /* Wider modal for lecture details */
        }

        #lectureDetailModal .modal-content {
            display: flex;
            flex-direction: column;
            min-height: 80vh;
        }

        #edx-progress-panel {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            background-color: var(--bg-primary);
            border-bottom: 1px solid #E0E0E0;
            overflow-x: auto;
            white-space: nowrap;
        }

        .module-progress-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 15px;
            cursor: pointer;
        }

        .module-progress-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #E0E0E0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: var(--text-secondary);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .module-progress-circle.active {
            background-color: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .module-progress-circle.completed {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .module-progress-circle.inprogress {
            background-color: var(--warning-color);
            color: white;
            border-color: var(--warning-color);
        }

        .module-progress-title {
            font-size: 0.85rem;
            margin-top: 5px;
            color: var(--text-secondary);
            text-align: center;
        }

        .lecture-content-wrapper {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        .lesson-sidebar {
            width: 250px;
            background-color: var(--bg-secondary);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #E0E0E0;
        }

        .lesson-sidebar .list-group-item {
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
        }

        .lesson-sidebar .list-group-item.active {
            background-color: var(--accent-primary);
            color: white;
        }

        .lesson-sidebar .lesson-title {
            flex-grow: 1;
            margin-right: 10px;
        }

        .lesson-content {
            flex-grow: 1;
            padding: 25px;
            overflow-y: auto;
        }

        .lesson-content h4 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .lesson-content .lesson-navigation {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .lesson-content-viewer {
            padding: 20px;
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            min-height: 200px; /* Ensure some height for content */
        }

        /* Utility classes */
        .rounded-12 { border-radius: 12px; }
        .rounded-16 { border-radius: 16px; }

        .form-control:focus {
            box-shadow: 0 0 0 0.25rem rgba(66, 133, 244, 0.25);
            border-color: var(--accent-primary);
        }

        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1060; /* Above modals */
        }

        .toast {
            background-color: var(--text-primary);
            color: white;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .toast .toast-header {
            background-color: transparent;
            border-bottom: none;
            color: white;
            padding-bottom: 5px;
            font-weight: bold;
        }

        .toast .toast-body {
            font-size: 0.9rem;
        }

        /* Responsive Design */
        @media (max-width: 992px) { /* Tablet and Mobile */
            .learnia-container {
                grid-template-columns: 1fr; /* Stack sidebar and main content */
            }

            #sidebar {
                position: fixed;
                width: 280px;
                height: 100vh;
                top: 0;
                left: 0;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                z-index: 1050;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            }

            #sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                padding: 0; /* Remove padding as mobile header handles it */
            }

            .mobile-header {
                display: flex; /* Show mobile header */
            }

            #welcome-screen {
                margin: 20px;
                padding: 30px;
            }

            .project-card-container {
                grid-template-columns: 1fr; /* Single column on small screens */
            }

            #lectureDetailModal .modal-dialog {
                max-width: 100vw;
                margin: 0;
            }

            .lecture-content-wrapper {
                flex-direction: column; /* Stack lesson sidebar and content */
            }

            .lesson-sidebar {
                width: 100%;
                max-height: 250px; /* Limit height for scrollability */
                border-right: none;
                border-bottom: 1px solid #E0E0E0;
            }

            .lesson-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Main Application Container -->
    <div class="learnia-container d-none" id="app-container">
        <!-- Sidebar -->
        <aside id="sidebar">
            <div class="sidebar-header">
                <a href="#" class="logo">Learnia <span class="badge bg-secondary">0.1</span></a>
            </div>

            <div class="auth-section">
                <p id="auth-status" class="mb-2 text-secondary small">로그인 필요</p>
                <div id="auth-buttons">
                    <button id="google-login-btn" class="btn btn-primary btn-sm w-100 mb-2">
                        <i class="fab fa-google"></i> Google 로그인
                    </button>
                    <p class="mb-0 text-secondary small" id="user-id-display"></p>
                </div>
            </div>

            <div class="d-grid gap-2 mb-4">
                <button id="new-project-btn" class="sidebar-button btn btn-outline-primary"><i class="fas fa-plus"></i> 새 프로젝트</button>
                <button id="import-project-btn" class="sidebar-button btn btn-outline-secondary"><i class="fas fa-file-import"></i> 프로젝트 가져오기</button>
                <button id="export-project-btn" class="sidebar-button btn btn-outline-secondary"><i class="fas fa-file-export"></i> 프로젝트 내보내기</button>
            </div>

            <h5 class="sidebar-section-title">내 프로젝트</h5>
            <div id="project-list" class="list-group">
                <!-- Projects will be dynamically loaded here -->
            </div>

            <h5 class="sidebar-section-title">자원 라이브러리</h5>
            <div id="resource-list" class="list-group mb-3">
                <!-- Resources will be dynamically loaded here -->
            </div>
            <div class="d-grid gap-2">
                <button id="add-resource-btn" class="sidebar-button btn btn-outline-secondary"><i class="fas fa-plus-circle"></i> 자원 추가</button>
                <button id="action-manager-btn" class="sidebar-button btn btn-outline-secondary"><i class="fas fa-cogs"></i> AI 액션 관리</button>
                <button id="download-studypad-btn" class="sidebar-button btn btn-outline-secondary"><i class="fas fa-download"></i> 스터디 패드 전체 다운로드</button>
            </div>
             <button id="logout-btn" class="sidebar-button btn btn-danger mt-auto mx-auto w-75 d-none">
                 <i class="fas fa-sign-out-alt"></i> 로그아웃
             </button>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Mobile Header -->
            <header class="mobile-header">
                <i class="fas fa-bars hamburger-menu" id="hamburger-menu"></i>
                <h1 class="project-title" id="mobile-current-project-title">선택된 프로젝트 없음</h1>
            </header>

            <!-- Welcome Screen -->
            <section id="welcome-screen">
                <h2>Learnia 0.1에 오신 것을 환영합니다!</h2>
                <p>
                    Learnia는 인공지능 튜터와 함께 개인 맞춤형 학습 계획을 세우고, 체계적으로 학습을 진행하며,
                    학습 자료를 관리하고 AI 액션을 통해 심층적인 학습 경험을 제공하는 통합 학습 환경입니다.
                </p>
                <div class="start-action-buttons">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newProjectModal">
                        <i class="fas fa-plus"></i> 새 프로젝트 시작
                    </button>
                    <button class="btn btn-outline-primary" id="welcome-import-project-btn">
                        <i class="fas fa-file-import"></i> 프로젝트 불러오기
                    </button>
                </div>
            </section>

            <!-- Project Workspace -->
            <section id="project-workspace" class="container-fluid">
                <div class="section-header">
                    <h3 id="project-title-main">선택된 프로젝트</h3>
                </div>
                <p class="text-secondary" id="project-goal">프로젝트 목표가 여기에 표시됩니다.</p>

                <!-- Plan Creation Section -->
                <div id="planning-section" class="card mb-4 rounded-16">
                    <div class="card-header bg-light">
                        <i class="fas fa-cogs me-2"></i>AI 튜터 페르소나 및 학습 계획 수립
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="aiTutorPersona" class="form-label">AI 튜터 페르소나</label>
                            <textarea class="form-control" id="aiTutorPersona" rows="3" placeholder="예: '친절하고 인내심 있는 초등 교사', '깊이 있는 지식을 가진 대학 교수'" readonly></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="learningPlanInput" class="form-label">학습 계획 (JSON 형식)</label>
                            <textarea class="form-control" id="learningPlanInput" rows="10" placeholder='여기에 AI가 생성한 JSON 학습 계획을 붙여넣으세요. 예: {"projectName": "...", "mainGoal": "...", "modules": [...]}' readonly></textarea>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button id="generate-plan-prompt-btn" class="btn btn-outline-primary me-2"><i class="fas fa-magic me-2"></i>계획 생성 프롬프트</button>
                            <button id="apply-plan-btn" class="btn btn-primary" disabled><i class="fas fa-check-circle me-2"></i>학습 계획 적용</button>
                        </div>
                    </div>
                </div>

                <!-- Learning Progress Analysis Section -->
                <div id="progress-analysis" class="card mb-4 rounded-16">
                    <div class="card-header bg-light">
                        <i class="fas fa-chart-line me-2"></i>학습 진행도 분석
                    </div>
                    <div class="card-body row align-items-center">
                        <div class="col-md-4 d-flex justify-content-center">
                            <canvas id="progressChart" style="max-width: 200px; max-height: 200px;"></canvas>
                        </div>
                        <div class="col-md-8">
                            <p class="h4 text-primary mb-3">전체 진행률: <span id="overall-progress-percentage">0%</span></p>
                            <div class="d-flex justify-content-around text-center">
                                <div>
                                    <h5 class="text-secondary">완료</h5>
                                    <span class="h3 text-success" id="completed-modules-count">0</span>
                                </div>
                                <div>
                                    <h5 class="text-secondary">진행 중</h5>
                                    <span class="h3 text-primary" id="inprogress-modules-count">0</span>
                                </div>
                                <div>
                                    <h5 class="text-secondary">대기 중</h5>
                                    <span class="h3 text-warning" id="pending-modules-count">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Learning and Execution Dashboard -->
                <h4 class="section-header">학습 및 실행 대시보드</h4>
                <div id="learning-dashboard" class="project-card-container">
                    <!-- Module cards will be dynamically loaded here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->

    <!-- New Project Modal -->
    <div class="modal fade" id="newProjectModal" tabindex="-1" aria-labelledby="newProjectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newProjectModalLabel">새 프로젝트 생성</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="new-project-form">
                        <div class="mb-3">
                            <label for="projectName" class="form-label">프로젝트 이름</label>
                            <input type="text" class="form-control" id="projectName" required>
                        </div>
                        <div class="mb-3">
                            <label for="projectGoal" class="form-label">최종 학습 목표</label>
                            <textarea class="form-control" id="projectGoal" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" form="new-project-form" class="btn btn-primary">생성</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Resource Management Modal -->
    <div class="modal fade" id="resourceModal" tabindex="-1" aria-labelledby="resourceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resourceModalLabel">자원 관리</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="resource-form">
                        <input type="hidden" id="resourceId">
                        <div class="mb-3">
                            <label for="resourceName" class="form-label">자원 이름</label>
                            <input type="text" class="form-control" id="resourceName" required>
                        </div>
                        <div class="mb-3">
                            <label for="resourceContent" class="form-label">자원 내용 (Markdown/텍스트)</label>
                            <textarea class="form-control" id="resourceContent" rows="10"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="resourceFileUpload" class="form-label">파일 업로드</label>
                            <input class="form-control" type="file" id="resourceFileUpload" accept=".txt,.md,.json">
                        </div>
                    </form>
                    <h6 class="mt-4">등록된 자원</h6>
                    <ul class="list-group" id="modal-resource-list">
                        <!-- Resources will be listed here dynamically -->
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="submit" form="resource-form" class="btn btn-primary" id="save-resource-btn">자원 저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Prompt Generation Modal -->
    <div class="modal fade" id="promptModal" tabindex="-1" aria-labelledby="promptModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="promptModalLabel">AI 프롬프트 생성</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="promptActionSelect" class="form-label">AI 액션 선택</label>
                        <select class="form-select" id="promptActionSelect">
                            <!-- Actions will be loaded dynamically -->
                        </select>
                    </div>
                    <div id="dynamic-prompt-inputs" class="mb-3">
                        <!-- Dynamic input fields based on selected action -->
                    </div>
                    <div class="mb-3">
                        <label for="promptDataSource" class="form-label">데이터 소스 선택</label>
                        <select class="form-select" id="promptDataSource">
                            <option value="none">없음</option>
                            <option value="resource-library">자원 라이브러리</option>
                            <option value="study-pad">스터디 패드</option>
                            <option value="direct-input">직접 입력</option>
                        </select>
                    </div>
                    <div id="data-source-content" class="mb-3 d-none">
                        <label for="dataSourceTextarea" class="form-label">데이터 소스 내용</label>
                        <textarea class="form-control" id="dataSourceTextarea" rows="5" placeholder="선택된 데이터 소스의 내용 또는 직접 입력"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="finalPrompt" class="form-label">최종 프롬프트 미리보기</label>
                        <textarea class="form-control" id="finalPrompt" rows="10" readonly></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" id="copy-prompt-btn"><i class="fas fa-copy me-2"></i>프롬프트 복사</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Manager Modal -->
    <div class="modal fade" id="actionManagerModal" tabindex="-1" aria-labelledby="actionManagerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionManagerModalLabel">AI 액션 관리</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="action-form" class="mb-4">
                        <input type="hidden" id="actionId">
                        <div class="mb-3">
                            <label for="actionTitle" class="form-label">액션 제목</label>
                            <input type="text" class="form-control" id="actionTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="actionCategory" class="form-label">카테고리</label>
                            <select class="form-select" id="actionCategory">
                                <option value="계획">계획</option>
                                <option value="이해와 탐구">이해와 탐구</option>
                                <option value="적용과 연습">적용과 연습</option>
                                <option value="심화와 표현">심화와 표현</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="actionPurpose" class="form-label">프롬프트 템플릿</label>
                            <textarea class="form-control" id="actionPurpose" rows="5" placeholder="예: [핵심 개념]에 대해 자세히 설명해줘." required></textarea>
                            <small class="form-text text-muted">변수는 [변수명] 형식으로 입력하세요. (예: [모듈 제목], [핵심 개념], [스터디 패드 내용])</small>
                        </div>
                        <button type="submit" class="btn btn-primary" id="save-action-btn">액션 저장</button>
                        <button type="button" class="btn btn-outline-danger d-none" id="delete-action-btn">액션 삭제</button>
                        <button type="button" class="btn btn-outline-secondary" id="cancel-edit-action-btn">새 액션 추가</button>
                    </form>
                    <h6 class="mt-4">등록된 AI 액션</h6>
                    <ul class="list-group" id="action-list">
                        <!-- Actions will be listed here dynamically -->
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Selector Modal -->
    <div class="modal fade" id="actionSelectorModal" tabindex="-1" aria-labelledby="actionSelectorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionSelectorModalLabel">AI 액션 선택</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="list-group" id="available-actions-list">
                        <!-- Actions will be grouped by category and listed here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Study Pad Viewer Modal -->
    <div class="modal fade" id="studyPadViewerModal" tabindex="-1" aria-labelledby="studyPadViewerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studyPadViewerModalLabel">스터디 패드</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="studyPadContent" class="mb-3 border p-3 rounded-8" style="background-color: var(--bg-secondary); min-height: 200px;">
                        <!-- Markdown content will be rendered here -->
                    </div>
                    <textarea class="form-control d-none" id="studyPadEditor" rows="15" style="background-color: var(--bg-secondary);"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" id="edit-studypad-btn">편집</button>
                    <button type="button" class="btn btn-primary d-none" id="save-studypad-btn">저장</button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Viewer Modal (Generic for long texts) -->
    <div class="modal fade" id="detailViewerModal" tabindex="-1" aria-labelledby="detailViewerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailViewerModalLabel">자세히 보기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="detailViewerContent" class="markdown-body">
                        <!-- Content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Overview Modal -->
    <div class="modal fade" id="projectOverviewModal" tabindex="-1" aria-labelledby="projectOverviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="projectOverviewModalLabel">프로젝트 개요: <span id="overview-project-name"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>최종 학습 목표</h6>
                    <p id="overview-project-goal" class="text-secondary mb-4"></p>
                    <h6>포함된 모듈</h6>
                    <div class="list-group" id="overview-module-list">
                        <!-- Modules will be listed here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lecture Detail Modal -->
    <div class="modal fade" id="lectureDetailModal" tabindex="-1" aria-labelledby="lectureDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="lectureDetailModalLabel">강의 상세</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- edX Style Progress Panel -->
                    <div id="edx-progress-panel">
                        <!-- Module progress circles will be here -->
                    </div>

                    <div class="lecture-content-wrapper">
                        <!-- Lesson List Sidebar -->
                        <div class="lesson-sidebar">
                            <h6 class="mb-3">레슨 목록 (<span id="current-module-title-sidebar"></span>)</h6>
                            <ul class="list-group" id="lesson-list-sidebar">
                                <!-- Lessons will be dynamically loaded here -->
                            </ul>
                        </div>

                        <!-- Lesson Content Area -->
                        <div class="lesson-content">
                            <h4 id="lesson-current-title">레슨 제목</h4>
                            <p class="text-secondary mb-3">상태: <span id="lesson-current-status"></span></p>

                            <div class="lesson-navigation mb-4">
                                <button class="btn btn-outline-primary" id="prev-lesson-btn" disabled><i class="fas fa-arrow-left me-2"></i>이전 레슨</button>
                                <button class="btn btn-success" id="mark-lesson-complete-btn"><i class="fas fa-check-circle me-2"></i>레슨 완료</button>
                                <button class="btn btn-outline-primary" id="next-lesson-btn" disabled>다음 레슨<i class="fas fa-arrow-right ms-2"></i></button>
                            </div>

                            <div class="lesson-content-viewer markdown-body" id="lesson-content-viewer">
                                <!-- Lesson content (Markdown) will be rendered here -->
                            </div>

                            <h6 class="mt-4">스터디 패드 및 개인 메모</h6>
                            <textarea class="form-control" id="lesson-studypad-input" rows="8" placeholder="학습 내용이나 개인 메모를 여기에 작성하세요."></textarea>
                            <div class="d-flex justify-content-end mt-2">
                                <button class="btn btn-outline-secondary me-2" id="save-lesson-studypad-btn"><i class="fas fa-save me-2"></i>저장</button>
                                <button class="btn btn-primary" id="lesson-ai-action-btn"><i class="fas fa-robot me-2"></i>AI 액션 실행</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container p-3" id="toast-container"></div>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Chart.js for progress visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- MathJax for LaTeX rendering (optional, if markdown content includes math) -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Firebase SDK (ESM) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore,
            collection,
            doc,
            getDoc,
            setDoc,
            addDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            query,
            where
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // =========================================================
        // 1. Firebase Initialization & Global Variables
        // =========================================================
        let app;
        let db;
        let auth;
        let authProvider;
        let currentUserId = null;
        let unsubscribeProjects = null; // Firestore real-time listener for projects
        let unsubscribeActions = null; // Firestore real-time listener for actions

        // Global data stores
        let userProjects = [];
        let userResources = [];
        let userActions = [];
        let activeProject = null;
        let activeModuleIndex = -1;
        let activeLessonIndex = -1;

        // Firebase configuration (provided by environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyCaVi8p8WAoXRZpvWaoCUnqG1IM0aoWJo0",
            authDomain: "learneverything-dcef7.firebaseapp.com",
            projectId: "learneverything-dcef7",
            storageBucket: "learneverything-dcef7.firebasestorage.app",
            messagingSenderId: "727818762307",
            appId: "1:727818762307:web:88b939848357f1eee53cf6",
            measurementId: "G-E9FRPC2Z9B"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Default AI Actions (to be added for new users)
        const DEFAULT_ACTIONS = [
            { key: '0_plan', title: '학습 계획 생성', category: '계획', purpose: '다음 목표를 달성하기 위한 상세 학습 계획 (모듈 및 레슨 포함)을 JSON 형식으로 생성해줘. 목표: [최종 학습 목표]. AI 튜터 페르소나: [AI 튜터 페르소나]' },
            { key: '1_concept_explanation', title: '핵심 개념 설명', category: '이해와 탐구', purpose: '[핵심 개념]에 대해 자세히 설명해줘. 대상 독자: 초보자. 기존 지식: [스터디 패드 내용]' },
            { key: '2_problem_creation', title: '문제 생성', category: '적용과 연습', purpose: '[모듈 제목]의 [핵심 개념]을 활용한 문제 3개를 객관식 또는 주관식으로 만들어줘. 해설 포함. 난이도: 중. 참고 자료: [데이터 소스 내용]' },
            { key: '3_deep_dive', title: '심층 탐구 질문', category: '심화와 표현', purpose: '[주제]에 대해 더 깊이 탐구할 수 있는 질문 5개를 생성해줘. 배경 지식: [스터디 패드 내용]' },
            { key: '4_summary', title: '요약', category: '이해와 탐구', purpose: '다음 내용을 3줄로 요약해줘: [데이터 소스 내용]' },
            { key: '5_analogy', title: '비유 설명', category: '이해와 탐구', purpose: '[개념]을 일상생활의 비유를 들어 설명해줘. 대상: [대상 독자]' },
            { key: '6_example_code', title: '예제 코드 생성', category: '적용과 연습', purpose: '[주제]와 관련된 간단한 예제 코드 ([언어])를 작성해줘. [데이터 소스 내용]을 참고해줘.' },
            { key: '7_review_quiz', title: '복습 퀴즈', category: '적용과 연습', purpose: '[모듈 제목] 전체 내용을 아우르는 복습 퀴즈 5개를 생성해줘. 정답과 해설 포함.' },
            { key: '8_mind_map', title: '마인드맵 아이디어', category: '심화와 표현', purpose: '[모듈 제목]의 핵심 개념들을 시각적으로 정리할 수 있는 마인드맵 아이디어를 제안해줘. 주요 가지와 세부 내용 포함.' }
        ];

        // =========================================================
        // 2. UI Elements & Helper Functions
        // =========================================================
        const DOMElements = {
            loadingOverlay: document.getElementById('loading-overlay'),
            appContainer: document.getElementById('app-container'),
            authStatus: document.getElementById('auth-status'),
            googleLoginBtn: document.getElementById('google-login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            userIdDisplay: document.getElementById('user-id-display'),
            newProjectBtn: document.getElementById('new-project-btn'),
            importProjectBtn: document.getElementById('import-project-btn'),
            exportProjectBtn: document.getElementById('export-project-btn'),
            projectList: document.getElementById('project-list'),
            resourceList: document.getElementById('resource-list'),
            addResourceBtn: document.getElementById('add-resource-btn'),
            actionManagerBtn: document.getElementById('action-manager-btn'),
            downloadStudypadBtn: document.getElementById('download-studypad-btn'),
            hamburgerMenu: document.getElementById('hamburger-menu'),
            mobileCurrentProjectTitle: document.getElementById('mobile-current-project-title'),
            welcomeScreen: document.getElementById('welcome-screen'),
            welcomeImportProjectBtn: document.getElementById('welcome-import-project-btn'),
            projectWorkspace: document.getElementById('project-workspace'),
            projectTitleMain: document.getElementById('project-title-main'),
            projectGoal: document.getElementById('project-goal'),
            aiTutorPersona: document.getElementById('aiTutorPersona'),
            learningPlanInput: document.getElementById('learningPlanInput'),
            generatePlanPromptBtn: document.getElementById('generate-plan-prompt-btn'),
            applyPlanBtn: document.getElementById('apply-plan-btn'),
            progressChartCanvas: document.getElementById('progressChart'),
            overallProgressPercentage: document.getElementById('overall-progress-percentage'),
            completedModulesCount: document.getElementById('completed-modules-count'),
            inprogressModulesCount: document.getElementById('inprogress-modules-count'),
            pendingModulesCount: document.getElementById('pending-modules-count'),
            learningDashboard: document.getElementById('learning-dashboard'),

            // Modals
            newProjectModal: new bootstrap.Modal(document.getElementById('newProjectModal')),
            newProjectForm: document.getElementById('new-project-form'),
            projectNameInput: document.getElementById('projectName'),
            projectGoalInput: document.getElementById('projectGoal'),

            resourceModal: new bootstrap.Modal(document.getElementById('resourceModal')),
            resourceForm: document.getElementById('resource-form'),
            resourceIdInput: document.getElementById('resourceId'),
            resourceNameInput: document.getElementById('resourceName'),
            resourceContentInput: document.getElementById('resourceContent'),
            resourceFileUploadInput: document.getElementById('resourceFileUpload'),
            modalResourceList: document.getElementById('modal-resource-list'),
            saveResourceBtn: document.getElementById('save-resource-btn'),

            promptModal: new bootstrap.Modal(document.getElementById('promptModal')),
            promptActionSelect: document.getElementById('promptActionSelect'),
            dynamicPromptInputs: document.getElementById('dynamic-prompt-inputs'),
            promptDataSource: document.getElementById('promptDataSource'),
            dataSourceContent: document.getElementById('data-source-content'),
            dataSourceTextarea: document.getElementById('dataSourceTextarea'),
            finalPrompt: document.getElementById('finalPrompt'),
            copyPromptBtn: document.getElementById('copy-prompt-btn'),

            actionManagerModal: new bootstrap.Modal(document.getElementById('actionManagerModal')),
            actionForm: document.getElementById('action-form'),
            actionIdInput: document.getElementById('actionId'),
            actionTitleInput: document.getElementById('actionTitle'),
            actionCategorySelect: document.getElementById('actionCategory'),
            actionPurposeInput: document.getElementById('actionPurpose'),
            saveActionBtn: document.getElementById('save-action-btn'),
            deleteActionBtn: document.getElementById('delete-action-btn'),
            cancelEditActionBtn: document.getElementById('cancel-edit-action-btn'),
            actionList: document.getElementById('action-list'),

            actionSelectorModal: new bootstrap.Modal(document.getElementById('actionSelectorModal')),
            availableActionsList: document.getElementById('available-actions-list'),

            studyPadViewerModal: new bootstrap.Modal(document.getElementById('studyPadViewerModal')),
            studyPadContent: document.getElementById('studyPadContent'),
            studyPadEditor: document.getElementById('studyPadEditor'),
            editStudypadBtn: document.getElementById('edit-studypad-btn'),
            saveStudypadBtn: document.getElementById('save-studypad-btn'),

            detailViewerModal: new bootstrap.Modal(document.getElementById('detailViewerModal')),
            detailViewerContent: document.getElementById('detailViewerContent'),

            projectOverviewModal: new bootstrap.Modal(document.getElementById('projectOverviewModal')),
            overviewProjectName: document.getElementById('overview-project-name'),
            overviewProjectGoal: document.getElementById('overview-project-goal'),
            overviewModuleList: document.getElementById('overview-module-list'),

            lectureDetailModal: new bootstrap.Modal(document.getElementById('lectureDetailModal')),
            edxProgressPanel: document.getElementById('edx-progress-panel'),
            currentModuleTitleSidebar: document.getElementById('current-module-title-sidebar'),
            lessonListSidebar: document.getElementById('lesson-list-sidebar'),
            lessonCurrentTitle: document.getElementById('lesson-current-title'),
            lessonCurrentStatus: document.getElementById('lesson-current-status'),
            prevLessonBtn: document.getElementById('prev-lesson-btn'),
            markLessonCompleteBtn: document.getElementById('mark-lesson-complete-btn'),
            nextLessonBtn: document.getElementById('next-lesson-btn'),
            lessonContentViewer: document.getElementById('lesson-content-viewer'),
            lessonStudypadInput: document.getElementById('lesson-studypad-input'),
            saveLessonStudypadBtn: document.getElementById('save-lesson-studypad-btn'),
            lessonAiActionBtn: document.getElementById('lesson-ai-action-btn'),

            toastContainer: document.getElementById('toast-container')
        };

        let progressChartInstance;

        /**
         * Shows a Bootstrap toast message.
         * @param {string} title - The title of the toast.
         * @param {string} message - The message content.
         * @param {string} [type='info'] - Type of message (info, success, warning, danger) for styling.
         */
        function showToast(title, message, type = 'info') {
            const toastElement = document.createElement('div');
            toastElement.classList.add('toast', `text-bg-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'danger' ? 'danger' : 'primary'}`, 'border-0');
            toastElement.setAttribute('role', 'alert');
            toastElement.setAttribute('aria-live', 'assertive');
            toastElement.setAttribute('aria-atomic', 'true');
            toastElement.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${title}</strong>: ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            DOMElements.toastContainer.append(toastElement);
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        /**
         * Generates a unique ID using a timestamp and a random string.
         * @param {string} prefix - Prefix for the ID (e.g., 'proj_', 'res_').
         * @returns {string} Unique ID.
         */
        function generateUniqueId(prefix) {
            return `${prefix}${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
        }

        /**
         * Renders Markdown content into an HTML element.
         * @param {HTMLElement} element - The HTML element to render into.
         * @param {string} markdownText - The Markdown text to render.
         */
        function renderMarkdown(element, markdownText) {
            // Using marked library to convert markdown to HTML
            element.innerHTML = marked.parse(markdownText || '');
            // Optional: If MathJax is loaded, typeset mathematical equations
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise([element]).catch((err) => console.error("MathJax typesetting failed:", err));
            }
        }

        /**
         * Copies text to the clipboard.
         * @param {string} text - The text to copy.
         */
        function copyToClipboard(text) {
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand('copy');
                showToast('성공', '클립보드에 복사되었습니다.');
            } catch (err) {
                console.error('클립보드 복사 실패:', err);
                showToast('오류', '클립보드 복사에 실패했습니다.');
            } finally {
                document.body.removeChild(tempInput);
            }
        }

        /**
         * Toggles loading overlay visibility.
         * @param {boolean} show - True to show, false to hide.
         */
        function toggleLoading(show) {
            if (show) {
                DOMElements.loadingOverlay.classList.remove('d-none');
                DOMElements.loadingOverlay.style.opacity = '1';
                DOMElements.appContainer.classList.add('d-none');
            } else {
                DOMElements.loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    DOMElements.loadingOverlay.classList.add('d-none');
                    DOMElements.appContainer.classList.remove('d-none');
                }, 300); // Match CSS transition duration
            }
        }

        /**
         * Updates the UI based on authentication status.
         * @param {Object|null} user - Firebase User object or null.
         */
        function updateAuthUI(user) {
            if (user) {
                DOMElements.authStatus.textContent = `로그인됨: ${user.email || '익명 사용자'}`;
                DOMElements.userIdDisplay.textContent = `UserID: ${user.uid}`;
                DOMElements.googleLoginBtn.classList.add('d-none');
                DOMElements.logoutBtn.classList.remove('d-none');
            } else {
                DOMElements.authStatus.textContent = '로그인 필요';
                DOMElements.userIdDisplay.textContent = '';
                DOMElements.googleLoginBtn.classList.remove('d-none');
                DOMElements.logoutBtn.classList.add('d-none');
                // Clear active project and show welcome screen
                activeProject = null;
                renderAppScreen();
            }
        }

        /**
         * Renders the main app screen (welcome or project workspace).
         */
        function renderAppScreen() {
            if (activeProject && currentUserId) {
                DOMElements.welcomeScreen.style.display = 'none';
                DOMElements.projectWorkspace.style.display = 'block';
                DOMElements.projectTitleMain.textContent = activeProject.name;
                DOMElements.projectGoal.textContent = activeProject.goal;
                DOMElements.mobileCurrentProjectTitle.textContent = activeProject.name;
                DOMElements.aiTutorPersona.value = activeProject.learningPlan?.tutorPersona?.characteristics?.join(', ') || '';
                DOMElements.learningPlanInput.value = JSON.stringify(activeProject.learningPlan, null, 2);
                DOMElements.applyPlanBtn.disabled = !activeProject.learningPlan; // Enable if plan exists

                renderLearningDashboard();
                updateProgressAnalysis();
            } else {
                DOMElements.welcomeScreen.style.display = 'block';
                DOMElements.projectWorkspace.style.display = 'none';
                DOMElements.mobileCurrentProjectTitle.textContent = '선택된 프로젝트 없음';
            }
        }

        /**
         * Renders the list of projects in the sidebar.
         */
        function renderProjectsList() {
            DOMElements.projectList.innerHTML = '';
            if (userProjects.length === 0) {
                const noProjectItem = document.createElement('div');
                noProjectItem.classList.add('list-group-item', 'text-secondary');
                noProjectItem.textContent = '생성된 프로젝트가 없습니다.';
                DOMElements.projectList.appendChild(noProjectItem);
                return;
            }

            userProjects.forEach(project => {
                const projectItem = document.createElement('a');
                projectItem.href = '#';
                projectItem.classList.add('list-group-item', 'list-group-item-action');
                if (activeProject && activeProject.id === project.id) {
                    projectItem.classList.add('active');
                }
                projectItem.innerHTML = `
                    <i class="fas fa-book me-2"></i>
                    <span class="flex-grow-1">${project.name}</span>
                    <button class="btn btn-sm btn-outline-danger ms-2 delete-project-btn" data-project-id="${project.id}" title="프로젝트 삭제"><i class="fas fa-trash-alt"></i></button>
                `;
                projectItem.addEventListener('click', (event) => {
                    // Prevent immediate navigation if delete button is clicked
                    if (!event.target.closest('.delete-project-btn')) {
                        setActiveProject(project.id);
                    }
                });
                DOMElements.projectList.appendChild(projectItem);
            });
        }

        /**
         * Renders the list of resources in the sidebar.
         */
        function renderResourceList() {
            DOMElements.resourceList.innerHTML = '';
            if (userResources.length === 0) {
                const noResourceItem = document.createElement('div');
                noResourceItem.classList.add('list-group-item', 'text-secondary');
                noResourceItem.textContent = '등록된 자원이 없습니다.';
                DOMElements.resourceList.appendChild(noResourceItem);
                return;
            }

            userResources.forEach(resource => {
                const resourceItem = document.createElement('a');
                resourceItem.href = '#';
                resourceItem.classList.add('list-group-item', 'list-group-item-action');
                resourceItem.innerHTML = `
                    <i class="fas fa-file-alt me-2"></i>
                    <span class="flex-grow-1">${resource.name}</span>
                    <button class="btn btn-sm btn-outline-primary ms-2 edit-resource-btn" data-resource-id="${resource.id}" title="자원 편집"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger ms-1 delete-resource-btn" data-resource-id="${resource.id}" title="자원 삭제"><i class="fas fa-trash-alt"></i></button>
                `;
                resourceItem.querySelector('.edit-resource-btn').addEventListener('click', () => openResourceModalForEdit(resource.id));
                resourceItem.querySelector('.delete-resource-btn').addEventListener('click', () => deleteResource(resource.id));
                DOMElements.resourceList.appendChild(resourceItem);
            });
        }

        /**
         * Renders the learning dashboard with module cards.
         */
        function renderLearningDashboard() {
            DOMElements.learningDashboard.innerHTML = '';
            if (!activeProject || !activeProject.learningPlan || !activeProject.learningPlan.modules || activeProject.learningPlan.modules.length === 0) {
                DOMElements.learningDashboard.innerHTML = '<p class="text-center text-secondary">학습 계획이 없거나 모듈이 없습니다. AI 튜터와 함께 계획을 수립해보세요!</p>';
                DOMEElements.applyPlanBtn.disabled = true; // Ensure button is disabled if no plan
                return;
            }
             DOMElements.applyPlanBtn.disabled = false; // Enable if plan exists

            activeProject.learningPlan.modules.forEach((module, index) => {
                const moduleCard = document.createElement('div');
                moduleCard.classList.add('project-card');
                let statusClass = '';
                let statusText = '';
                switch (module.status) {
                    case 'completed':
                        statusClass = 'badge-completed';
                        statusText = '완료';
                        break;
                    case 'inprogress':
                        statusClass = 'badge-inprogress';
                        statusText = '진행 중';
                        break;
                    case 'pending':
                    default:
                        statusClass = 'badge-pending';
                        statusText = '대기';
                        break;
                }

                moduleCard.innerHTML = `
                    <h5 class="card-title">${module.title}</h5>
                    <p class="card-subtitle"><span class="badge ${statusClass}">${statusText}</span></p>
                    <p class="card-text">
                        <strong>핵심 개념:</strong> ${module.keyConcepts.join(', ').substring(0, 100)}...<br>
                        <strong>학습 목표:</strong> ${module.learningObjectives.join(', ').substring(0, 100)}...
                    </p>
                    <div class="d-flex justify-content-between align-items-center mt-auto">
                        <button class="btn btn-sm btn-outline-primary start-module-btn" data-module-index="${index}">
                            <i class="fas fa-play me-1"></i> 모듈 시작/개요 보기
                        </button>
                        <button class="btn btn-sm btn-outline-secondary ai-action-module-btn" data-module-index="${index}">
                            <i class="fas fa-robot me-1"></i> AI 액션
                        </button>
                    </div>
                `;
                DOMElements.learningDashboard.appendChild(moduleCard);
            });
        }

        /**
         * Updates the progress analysis section and donut chart.
         */
        function updateProgressAnalysis() {
            if (!activeProject || !activeProject.learningPlan || !activeProject.learningPlan.modules) {
                DOMElements.overallProgressPercentage.textContent = '0%';
                DOMElements.completedModulesCount.textContent = '0';
                DOMElements.inprogressModulesCount.textContent = '0';
                DOMElements.pendingModulesCount.textContent = '0';
                if (progressChartInstance) {
                    progressChartInstance.data.datasets[0].data = [0, 0, 100];
                    progressChartInstance.update();
                }
                return;
            }

            const modules = activeProject.learningPlan.modules;
            const totalModules = modules.length;
            if (totalModules === 0) {
                DOMElements.overallProgressPercentage.textContent = '0%';
                DOMElements.completedModulesCount.textContent = '0';
                DOMElements.inprogressModulesCount.textContent = '0';
                DOMElements.pendingModulesCount.textContent = '0';
                if (progressChartInstance) {
                    progressChartInstance.data.datasets[0].data = [0, 0, 100];
                    progressChartInstance.update();
                }
                return;
            }

            const completed = modules.filter(m => m.status === 'completed').length;
            const inprogress = modules.filter(m => m.status === 'inprogress').length;
            const pending = totalModules - completed - inprogress;
            const overallProgress = (completed / totalModules * 100).toFixed(0);

            DOMElements.overallProgressPercentage.textContent = `${overallProgress}%`;
            DOMElements.completedModulesCount.textContent = completed.toString();
            DOMElements.inprogressModulesCount.textContent = inprogress.toString();
            DOMElements.pendingModulesCount.textContent = pending.toString();

            // Chart.js update
            const chartData = [completed, inprogress, pending];
            if (progressChartInstance) {
                progressChartInstance.data.datasets[0].data = chartData;
                progressChartInstance.update();
            } else {
                const ctx = DOMElements.progressChartCanvas.getContext('2d');
                progressChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['완료', '진행 중', '대기'],
                        datasets: [{
                            data: chartData,
                            backgroundColor: [
                                getComputedStyle(document.documentElement).getPropertyValue('--success-color'),
                                getComputedStyle(document.documentElement).getPropertyValue('--accent-primary'),
                                getComputedStyle(document.documentElement).getPropertyValue('--warning-color')
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.raw;
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        /**
         * Opens the new project modal with cleared fields.
         */
        function openNewProjectModal() {
            DOMElements.newProjectForm.reset();
            DOMElements.newProjectModal.show();
        }

        /**
         * Opens the resource management modal.
         * @param {string|null} resourceId - The ID of the resource to edit, or null for new.
         */
        function openResourceModalForEdit(resourceId = null) {
            DOMElements.resourceForm.reset();
            DOMElements.resourceIdInput.value = '';
            if (resourceId) {
                const resource = userResources.find(r => r.id === resourceId);
                if (resource) {
                    DOMElements.resourceIdInput.value = resource.id;
                    DOMElements.resourceNameInput.value = resource.name;
                    DOMElements.resourceContentInput.value = resource.content;
                    DOMElements.resourceModalLabel.textContent = '자원 편집';
                }
            } else {
                DOMElements.resourceModalLabel.textContent = '새 자원 추가';
            }
            renderModalResourceList();
            DOMElements.resourceModal.show();
        }

        /**
         * Renders the list of resources inside the resource management modal.
         */
        function renderModalResourceList() {
            DOMElements.modalResourceList.innerHTML = '';
            userResources.forEach(resource => {
                const listItem = document.createElement('li');
                listItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                listItem.innerHTML = `
                    <span>${resource.name}</span>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2 edit-resource-btn-modal" data-resource-id="${resource.id}" title="편집"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger delete-resource-btn-modal" data-resource-id="${resource.id}" title="삭제"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                listItem.querySelector('.edit-resource-btn-modal').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openResourceModalForEdit(resource.id);
                });
                listItem.querySelector('.delete-resource-btn-modal').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteResource(resource.id);
                });
                DOMElements.modalResourceList.appendChild(listItem);
            });
        }


        let currentPromptContext = {
            module: null,
            lesson: null,
            studyPad: ''
        };

        /**
         * Opens the prompt generation modal.
         * @param {Object} context - The context for prompt generation (module, lesson, studyPad).
         */
        function openPromptModal(context = {}) {
            currentPromptContext = context;
            DOMElements.promptActionSelect.innerHTML = '<option value="">액션 선택</option>';
            userActions.forEach(action => {
                const option = document.createElement('option');
                option.value = action.key;
                option.textContent = action.title;
                DOMElements.promptActionSelect.appendChild(option);
            });

            DOMElements.dynamicPromptInputs.innerHTML = '';
            DOMElements.promptDataSource.value = 'none';
            DOMElements.dataSourceContent.classList.add('d-none');
            DOMElements.dataSourceTextarea.value = '';
            DOMElements.finalPrompt.value = '';
            DOMElements.promptModal.show();
        }

        /**
         * Dynamically generates input fields for prompt variables.
         */
        function updateDynamicPromptInputs() {
            const selectedActionKey = DOMElements.promptActionSelect.value;
            const selectedAction = userActions.find(a => a.key === selectedActionKey);
            DOMElements.dynamicPromptInputs.innerHTML = '';

            if (selectedAction) {
                // Regex to find [variable] placeholders
                const regex = /\[([^\]]+)\]/g;
                let match;
                let variables = new Set();
                while ((match = regex.exec(selectedAction.purpose)) !== null) {
                    variables.add(match[1]);
                }

                variables.forEach(variable => {
                    // Skip context-aware variables that will be filled automatically
                    if (['최종 학습 목표', 'AI 튜터 페르소나', '모듈 제목', '핵심 개념', '스터디 패드 내용', '데이터 소스 내용'].includes(variable)) {
                        return;
                    }

                    const div = document.createElement('div');
                    div.classList.add('mb-3');
                    div.innerHTML = `
                        <label for="prompt-var-${variable}" class="form-label">변수: ${variable}</label>
                        <input type="text" class="form-control prompt-variable-input" id="prompt-var-${variable}" data-variable-name="${variable}" placeholder="${variable}을(를) 입력하세요.">
                    `;
                    DOMElements.dynamicPromptInputs.appendChild(div);
                });
            }
            updateFinalPromptPreview();
        }

        /**
         * Updates the final prompt preview based on selected action and inputs.
         */
        function updateFinalPromptPreview() {
            const selectedActionKey = DOMElements.promptActionSelect.value;
            const selectedAction = userActions.find(a => a.key === selectedActionKey);
            let promptText = selectedAction ? selectedAction.purpose : '';

            // 1. Fill dynamic inputs
            document.querySelectorAll('.prompt-variable-input').forEach(input => {
                const varName = input.dataset.variableName;
                const varValue = input.value || '';
                promptText = promptText.replaceAll(`[${varName}]`, varValue);
            });

            // 2. Fill context-aware variables
            if (activeProject) {
                promptText = promptText.replaceAll('[최종 학습 목표]', activeProject.goal || '');
                promptText = promptText.replaceAll('[AI 튜터 페르소나]', activeProject.learningPlan?.tutorPersona?.characteristics?.join(', ') || '');
            }
            if (currentPromptContext.module) {
                promptText = promptText.replaceAll('[모듈 제목]', currentPromptContext.module.title || '');
                promptText = promptText.replaceAll('[핵심 개념]', currentPromptContext.module.keyConcepts?.join(', ') || '');
            }
            if (currentPromptContext.studyPad) {
                promptText = promptText.replaceAll('[스터디 패드 내용]', currentPromptContext.studyPad || '');
            }

            // 3. Fill data source content
            const dataSourceType = DOMElements.promptDataSource.value;
            let dataSourceContent = '';
            if (dataSourceType === 'direct-input') {
                dataSourceContent = DOMElements.dataSourceTextarea.value;
            } else if (dataSourceType === 'resource-library') {
                dataSourceContent = userResources.map(r => `--- ${r.name} ---\n${r.content}`).join('\n\n');
            } else if (dataSourceType === 'study-pad' && activeProject) {
                dataSourceContent = activeProject.learningPlan.modules
                    .map(m => m.studyPad ? `--- ${m.title} Study Pad ---\n${m.studyPad}` : '')
                    .filter(Boolean)
                    .join('\n\n');
                 if (currentPromptContext.lesson) {
                     dataSourceContent += `\n\n--- ${currentPromptContext.lesson.title} Study Pad ---\n${currentPromptContext.lesson.studyPad || ''}`;
                 }
            }
            promptText = promptText.replaceAll('[데이터 소스 내용]', dataSourceContent);

            DOMElements.finalPrompt.value = promptText;
        }

        /**
         * Opens the action manager modal.
         */
        function openActionManagerModal() {
            DOMElements.actionForm.reset();
            DOMElements.actionIdInput.value = '';
            DOMElements.deleteActionBtn.classList.add('d-none');
            DOMElements.saveActionBtn.textContent = '액션 저장';
            renderActionList();
            DOMElements.actionManagerModal.show();
        }

        /**
         * Renders the list of actions inside the action manager modal.
         */
        function renderActionList() {
            DOMElements.actionList.innerHTML = '';
            userActions.sort((a, b) => a.key.localeCompare(b.key)).forEach(action => { // Sort by key for consistent order
                const listItem = document.createElement('li');
                listItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                listItem.innerHTML = `
                    <span><strong>${action.title}</strong> (${action.category})</span>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2 edit-action-btn-modal" data-action-id="${action.key}" title="편집"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger delete-action-btn-modal" data-action-id="${action.key}" title="삭제"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                listItem.querySelector('.edit-action-btn-modal').addEventListener('click', (e) => {
                    e.stopPropagation();
                    editAction(action.key);
                });
                listItem.querySelector('.delete-action-btn-modal').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteAction(action.key);
                });
                DOMElements.actionList.appendChild(listItem);
            });
        }

        /**
         * Sets the action form for editing an existing action.
         * @param {string} actionKey - The key of the action to edit.
         */
        function editAction(actionKey) {
            const action = userActions.find(a => a.key === actionKey);
            if (action) {
                DOMElements.actionIdInput.value = action.key;
                DOMElements.actionTitleInput.value = action.title;
                DOMElements.actionCategorySelect.value = action.category;
                DOMElements.actionPurposeInput.value = action.purpose;
                DOMElements.deleteActionBtn.classList.remove('d-none');
                DOMElements.saveActionBtn.textContent = '액션 업데이트';
            }
        }

        /**
         * Renders the project overview modal with module list.
         */
        function renderProjectOverviewModal() {
            if (!activeProject || !activeProject.learningPlan) return;

            DOMElements.overviewProjectName.textContent = activeProject.name;
            DOMElements.overviewProjectGoal.textContent = activeProject.goal;
            DOMElements.overviewModuleList.innerHTML = '';

            activeProject.learningPlan.modules.forEach((module, index) => {
                let statusIcon = '';
                switch (module.status) {
                    case 'completed': statusIcon = '<i class="fas fa-check-circle text-success me-2"></i>'; break;
                    case 'inprogress': statusIcon = '<i class="fas fa-hourglass-half text-primary me-2"></i>'; break;
                    case 'pending': statusIcon = '<i class="fas fa-clock text-warning me-2"></i>'; break;
                }

                const moduleItem = document.createElement('a');
                moduleItem.href = '#';
                moduleItem.classList.add('list-group-item', 'list-group-item-action', 'd-flex', 'align-items-center');
                moduleItem.innerHTML = `
                    ${statusIcon}
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${module.title}</h6>
                        <small class="text-secondary">핵심 개념: ${module.keyConcepts.join(', ').substring(0, 80)}...</small>
                    </div>
                `;
                moduleItem.addEventListener('click', () => {
                    activeModuleIndex = index;
                    activeLessonIndex = -1; // Reset lesson index when changing modules
                    DOMElements.projectOverviewModal.hide();
                    renderLectureDetailModal();
                    DOMElements.lectureDetailModal.show();
                });
                DOMElements.overviewModuleList.appendChild(moduleItem);
            });
        }

        /**
         * Renders the lecture detail modal for a specific module.
         */
        function renderLectureDetailModal() {
            if (!activeProject || !activeProject.learningPlan || activeModuleIndex === -1) {
                console.error("No active project or module selected for lecture details.");
                return;
            }

            const currentModule = activeProject.learningPlan.modules[activeModuleIndex];
            DOMElements.currentModuleTitleSidebar.textContent = currentModule.title;

            // Render edX style progress panel
            DOMElements.edxProgressPanel.innerHTML = '';
            activeProject.learningPlan.modules.forEach((module, index) => {
                const item = document.createElement('div');
                item.classList.add('module-progress-item');
                const circle = document.createElement('div');
                circle.classList.add('module-progress-circle');
                circle.textContent = index + 1;
                if (index === activeModuleIndex) {
                    circle.classList.add('active');
                }
                if (module.status === 'completed') {
                    circle.classList.add('completed');
                } else if (module.status === 'inprogress') {
                    circle.classList.add('inprogress');
                }
                circle.addEventListener('click', () => {
                    activeModuleIndex = index;
                    activeLessonIndex = -1; // Reset lesson index when module changes
                    renderLectureDetailModal(); // Re-render the modal for the new module
                });
                const title = document.createElement('div');
                title.classList.add('module-progress-title');
                title.textContent = module.title;
                item.appendChild(circle);
                item.appendChild(title);
                DOMElements.edxProgressPanel.appendChild(item);
            });


            // Render lesson list sidebar
            DOMElements.lessonListSidebar.innerHTML = '';
            if (currentModule.lessons && currentModule.lessons.length > 0) {
                currentModule.lessons.forEach((lesson, index) => {
                    const lessonItem = document.createElement('a');
                    lessonItem.href = '#';
                    lessonItem.classList.add('list-group-item', 'list-group-item-action', 'd-flex', 'align-items-center');
                    if (index === activeLessonIndex) {
                        lessonItem.classList.add('active');
                    }
                    let statusIcon = '';
                    switch (lesson.status) {
                        case 'completed': statusIcon = '<i class="fas fa-check-circle text-success ms-auto"></i>'; break;
                        case 'pending': statusIcon = '<i class="fas fa-clock text-warning ms-auto"></i>'; break;
                    }
                    lessonItem.innerHTML = `
                        <span class="lesson-title">${index + 1}. ${lesson.title}</span>
                        ${statusIcon}
                    `;
                    lessonItem.addEventListener('click', () => {
                        activeLessonIndex = index;
                        renderLectureDetailModal(); // Re-render to show active lesson
                    });
                    DOMElements.lessonListSidebar.appendChild(lessonItem);
                });
            } else {
                DOMElements.lessonListSidebar.innerHTML = '<li class="list-group-item text-secondary">레슨이 없습니다.</li>';
            }

            // Render lesson content
            if (activeLessonIndex !== -1 && currentModule.lessons && currentModule.lessons[activeLessonIndex]) {
                const currentLesson = currentModule.lessons[activeLessonIndex];
                DOMElements.lessonCurrentTitle.textContent = currentLesson.title;
                DOMElements.lessonCurrentStatus.textContent = currentLesson.status === 'completed' ? '완료' : '대기';
                renderMarkdown(DOMElements.lessonContentViewer, currentLesson.content);
                DOMElements.lessonStudypadInput.value = currentLesson.studyPad || '';

                // Update navigation buttons
                DOMElements.prevLessonBtn.disabled = activeLessonIndex === 0;
                DOMElements.nextLessonBtn.disabled = activeLessonIndex === currentModule.lessons.length - 1;
                DOMElements.markLessonCompleteBtn.disabled = currentLesson.status === 'completed';
            } else {
                // No lesson selected or no lessons available, clear content
                DOMElements.lessonCurrentTitle.textContent = '레슨을 선택하세요';
                DOMElements.lessonCurrentStatus.textContent = '';
                DOMElements.lessonContentViewer.innerHTML = '<p class="text-secondary text-center">좌측에서 레슨을 선택하여 내용을 확인하세요.</p>';
                DOMElements.lessonStudypadInput.value = '';
                DOMElements.prevLessonBtn.disabled = true;
                DOMElements.nextLessonBtn.disabled = true;
                DOMElements.markLessonCompleteBtn.disabled = true;
            }
        }


        // =========================================================
        // 3. Firebase Operations (CRUD, Listeners)
        // =========================================================

        /**
         * Initializes Firebase and sets up authentication listener.
         */
        async function initializeFirebase() {
            toggleLoading(true);
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                authProvider = new GoogleAuthProvider();

                // Set up authentication state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        updateAuthUI(user);
                        await setupFirestoreListeners();
                        await initializeDefaultActions();
                        renderAppScreen(); // Render app content after auth and data load
                    } else {
                        currentUserId = null;
                        updateAuthUI(null);
                        cleanupFirestoreListeners(); // Stop listening if user logs out
                    }
                    toggleLoading(false); // Hide loading after auth state is determined
                });

                // Attempt to sign in with custom token or anonymously if no user is found
                if (!auth.currentUser) {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                }
            } catch (error) {
                console.error("Firebase 초기화 또는 로그인 중 오류 발생:", error);
                showToast('오류', `Firebase 초기화 실패: ${error.message}`, 'danger');
                toggleLoading(false);
            }
        }

        /**
         * Sets up real-time Firestore listeners for projects and actions.
         */
        async function setupFirestoreListeners() {
            if (!currentUserId) {
                console.warn("User ID not available for Firestore listeners.");
                return;
            }

            cleanupFirestoreListeners(); // Clean up existing listeners first

            // Projects listener
            const projectsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/projects`);
            unsubscribeProjects = onSnapshot(projectsRef, (snapshot) => {
                userProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Re-set active project if it was deleted or changed
                if (activeProject) {
                    const updatedActiveProject = userProjects.find(p => p.id === activeProject.id);
                    if (!updatedActiveProject) {
                        activeProject = null; // Active project was deleted
                    } else {
                        activeProject = updatedActiveProject; // Update active project data
                    }
                }
                renderProjectsList();
                renderAppScreen(); // Re-render main screen to reflect project changes
                updateProgressAnalysis(); // Update progress analysis if active project data changed
                renderResourceList(); // Resource list is tied to project, so refresh
            }, (error) => {
                console.error("Error listening to projects:", error);
                showToast('오류', `프로젝트 로드 실패: ${error.message}`, 'danger');
            });

            // Actions listener
            const actionsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/actions`);
            unsubscribeActions = onSnapshot(actionsRef, (snapshot) => {
                userActions = snapshot.docs.map(doc => ({ key: doc.id, ...doc.data() }));
                renderActionList(); // Update action manager modal
            }, (error) => {
                console.error("Error listening to actions:", error);
                showToast('오류', `액션 로드 실패: ${error.message}`, 'danger');
            });

            console.log(`Firestore listeners set up for user: ${currentUserId}`);
        }

        /**
         * Cleans up Firestore real-time listeners.
         */
        function cleanupFirestoreListeners() {
            if (unsubscribeProjects) {
                unsubscribeProjects();
                unsubscribeProjects = null;
                console.log("Unsubscribed from projects.");
            }
            if (unsubscribeActions) {
                unsubscribeActions();
                unsubscribeActions = null;
                console.log("Unsubscribed from actions.");
            }
        }

        /**
         * Initializes default AI actions for a new user if they don't exist.
         */
        async function initializeDefaultActions() {
            if (!currentUserId) return;

            const actionsColRef = collection(db, `artifacts/${appId}/users/${currentUserId}/actions`);

            // Fetch existing actions to avoid duplicates
            const existingActionsSnapshot = await getDocs(actionsColRef);
            const existingActionKeys = new Set(existingActionsSnapshot.docs.map(doc => doc.id));

            for (const action of DEFAULT_ACTIONS) {
                if (!existingActionKeys.has(action.key)) {
                    try {
                        await setDoc(doc(actionsColRef, action.key), action);
                        console.log(`Default action '${action.title}' added.`);
                    } catch (error) {
                        console.error(`Error adding default action ${action.title}:`, error);
                    }
                }
            }
        }

        /**
         * Signs in with Google.
         */
        async function signInWithGoogle() {
            try {
                await signInWithPopup(auth, authProvider);
                showToast('성공', 'Google 로그인 성공!');
            } catch (error) {
                console.error("Google 로그인 오류:", error);
                showToast('오류', `Google 로그인 실패: ${error.message}`, 'danger');
            }
        }

        /**
         * Signs out the current user.
         */
        async function handleSignOut() {
            try {
                await signOut(auth);
                showToast('성공', '로그아웃 되었습니다.');
            } catch (error) {
                console.error("로그아웃 오류:", error);
                showToast('오류', `로그아웃 실패: ${error.message}`, 'danger');
            }
        }

        /**
         * Sets the active project and updates UI.
         * @param {string} projectId - The ID of the project to set as active.
         */
        function setActiveProject(projectId) {
            activeProject = userProjects.find(p => p.id === projectId) || null;
            renderProjectsList(); // Re-render to highlight active project
            renderAppScreen(); // Update main content
        }

        /**
         * Creates a new project in Firestore.
         * @param {string} name - Project name.
         * @param {string} goal - Project goal.
         */
        async function createProject(name, goal) {
            if (!currentUserId) {
                showToast('오류', '로그인 후 프로젝트를 생성할 수 있습니다.', 'warning');
                return;
            }
            try {
                const newProjectId = generateUniqueId('proj_');
                const projectRef = doc(db, `artifacts/${appId}/users/${currentUserId}/projects`, newProjectId);
                const newProjectData = {
                    id: newProjectId,
                    name: name,
                    goal: goal,
                    resources: [],
                    learningPlan: null,
                    createdAt: new Date()
                };
                await setDoc(projectRef, newProjectData);
                showToast('성공', `'${name}' 프로젝트가 생성되었습니다.`);
                DOMElements.newProjectModal.hide();
                setActiveProject(newProjectId); // Set as active after creation
            } catch (error) {
                console.error("프로젝트 생성 오류:", error);
                showToast('오류', `프로젝트 생성 실패: ${error.message}`, 'danger');
            }
        }

        /**
         * Deletes a project from Firestore.
         * @param {string} projectId - The ID of the project to delete.
         */
        async function deleteProject(projectId) {
            if (!currentUserId) return;
            // A custom modal for confirmation
            const confirmDelete = await showConfirmation('프로젝트 삭제', '정말로 이 프로젝트를 삭제하시겠습니까? 모든 학습 내용이 사라집니다.');
            if (!confirmDelete) return;

            try {
                const projectRef = doc(db, `artifacts/${appId}/users/${currentUserId}/projects`, projectId);
                await deleteDoc(projectRef);
                showToast('성공', '프로젝트가 삭제되었습니다.');
                if (activeProject && activeProject.id === projectId) {
                    activeProject = null;
                    renderAppScreen(); // Go back to welcome screen if active project deleted
                }
            } catch (error) {
                console.error("프로젝트 삭제 오류:", error);
                showToast('오류', `프로젝트 삭제 실패: ${error.message}`, 'danger');
            }
        }

        /**
         * Imports project data from a JSON file.
         */
        function importProject() {
            if (!currentUserId) {
                showToast('오류', '로그인 후 프로젝트를 가져올 수 있습니다.', 'warning');
                return;
            }
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            try {
                                const projectData = JSON.parse(event.target.result);
                                if (!projectData.id || !projectData.name || !projectData.goal) {
                                    throw new Error('유효하지 않은 프로젝트 데이터 형식입니다. (ID, 이름, 목표 필드 필요)');
                                }

                                // Check if project with same ID already exists
                                const existingProject = userProjects.find(p => p.id === projectData.id);
                                if (existingProject) {
                                    const overwriteConfirm = await showConfirmation(
                                        '프로젝트 덮어쓰기',
                                        `'${projectData.name}' (ID: ${projectData.id}) 프로젝트가 이미 존재합니다. 덮어쓰시겠습니까?`
                                    );
                                    if (!overwriteConfirm) {
                                        showToast('취소', '프로젝트 가져오기가 취소되었습니다.');
                                        return;
                                    }
                                }

                                const projectRef = doc(db, `artifacts/${appId}/users/${currentUserId}/projects`, projectData.id);
                                await setDoc(projectRef, projectData, { merge: true }); // Use merge to allow partial updates
                                showToast('성공', `'${projectData.name}' 프로젝트가 성공적으로 가져와졌습니다.`);
                                setActiveProject(projectData.id);
                            } catch (parseError) {
                                console.error("JSON 파싱 또는 데이터 저장 오류:", parseError);
                                showToast('오류', `프로젝트 가져오기 실패: ${parseError.message}`, 'danger');
                            }
                        };
                        reader.readAsText(file);
                    } catch (fileError) {
                        console.error("파일 읽기 오류:", fileError);
                        showToast('오류', `파일 읽기 실패: ${fileError.message}`, 'danger');
                    }
                }
            };
            input.click();
        }

        /**
         * Exports the current active project to a JSON file.
         */
        function exportProject() {
            if (!activeProject) {
                showToast('경고', '내보낼 활성 프로젝트가 없습니다.', 'warning');
                return;
            }
            try {
                const dataStr = JSON.stringify(activeProject, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                const exportFileDefaultName = `${activeProject.name}_Learnia_Project.json`;

                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                document.body.appendChild(linkElement);
                linkElement.click();
                document.body.removeChild(linkElement);
                showToast('성공', `'${activeProject.name}' 프로젝트가 내보내졌습니다.`);
            } catch (error) {
                console.error("프로젝트 내보내기 오류:", error);
                showToast('오류', `프로젝트 내보내기 실패: ${error.message}`, 'danger');
            }
        }

        /**
         * Saves or updates a resource in Firestore.
         */
        async function saveResource() {
            if (!currentUserId) return;
            const resourceId = DOMElements.resourceIdInput.value;
            const resourceName = DOMElements.resourceNameInput.value.trim();
            const resourceContent = DOMElements.resourceContentInput.value;

            if (!resourceName) {
                showToast('경고', '자원 이름을 입력해주세요.', 'warning');
                return;
            }

            try {
                if (!activeProject) {
                    showToast('오류', '자원을 저장할 활성 프로젝트를 선택해주세요.', 'danger');
                    return;
                }

                // Update resource in active project's resources array
                const projectRef = doc(db, `artifacts/${appId}/users/${currentUserId}/projects`, activeProject.id);
                let updatedResources = [...(activeProject.resources || [])];

                if (resourceId) { // Editing existing resource
                    const resourceIndex = updatedResources.findIndex(r => r.id === resourceId);
                    if (resourceIndex > -1) {
                        updatedResources[resourceIndex] = { id: resourceId, name: resourceName, content: resourceContent };
                    } else {
                        showToast('오류', '편집할 자원을 찾을 수 없습니다.', 'danger');
                        return;
                    }
                } else { // Adding new resource
                    const newResourceId = generateUniqueId('res_');
                    updatedResources.push({ id: newResourceId, name: resourceName, content: resourceContent });
                }

                await updateDoc(projectRef, { resources: updatedResources });
                showToast('성공', '자원이 저장되었습니다.');
                DOMElements.resourceModal.hide();
            } catch (error) {
                console.error("자원 저장 오류:", error);
                showToast('오류', `자원 저장 실패: ${error.message}`, 'danger');
            }
        }

        /**
         * Deletes a resource from the active project in Firestore.
         * @param {string} resourceId - The ID of the resource to delete.
         */
        async function deleteResource(resourceId) {
            if (!currentUserId || !activeProject) return;

            const confirmDelete = await showConfirmation('자원 삭제', '정말로 이 자원을 삭제하시겠습니까?');
            if (!confirmDelete) return;

            try {
                const projectRef = doc(db, `artifacts/${appId}/users/${currentUserId}/projects`, activeProject.id);
                const updatedResources = (activeProject.resources || []).filter(r => r.id !== resourceId);
                await updateDoc(projectRef, { resources: updatedResources });
                showToast('성공', '자원이 삭제되었습니다.');
                DOMElements.resourceModal.hide(); // Hide if deleting from modal list
            } catch (error) {
                console.error("자원 삭제 오류:", error);
                showToast('오류', `자원 삭제 실패: ${error.message}`, 'danger');
            }
        }

        /**
         * Handles file upload for resources.
         */
        async function handleResourceFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                DOMElements.resourceContentInput.value = e.target.result;
                DOMElements.resourceNameInput.value = file.name.split('.').slice(0, -1).join('.'); // Set name from filename
            };
            reader.onerror = (e) => {
                console.error("File reading error:", e);
                showToast('오류', '파일을 읽는 중 오류가 발생했습니다.', 'danger');
            };
            reader.readAsText(file);
        }

        /**
         * Applies the learning plan JSON to the active project.
         */
        async function applyLearningPlan() {
            if (!currentUserId || !activeProject) return;

            let planJson;
            try {
                planJson = JSON.parse(DOMElements.learningPlanInput.value);
                if (!planJson.modules || !Array.isArray(planJson.modules)) {
                    throw new Error("유효한 학습 계획 JSON이 아닙니다. 'modules' 배열이 필요합니다.");
                }

                // Initialize module and lesson statuses if not present
                planJson.modules = planJson.modules.map(mod => {
                    if (!mod.status) mod.status = 'pending';
                    mod.id = mod.id || generateUniqueId('mod_'); // Ensure ID for modules
                    if (mod.lessons) {
                        mod.lessons = mod.lessons.map(les => {
                            if (!les.status) les.status = 'pending';
                            les.id = les.id || generateUniqueId('les_'); // Ensure ID for lessons
                            return les;
                        });
                    }
                    return mod;
                });

            } catch (error) {
                showToast('오류', `학습 계획 JSON 파싱 실패: ${error.message}`, 'danger');
                console.error("JSON 파싱 오류:", error);
                return;
            }

            try {
                const projectRef = doc(db, `artifacts/${appId}/users/${currentUserId}/projects`, activeProject.id);
                await updateDoc(projectRef, { learningPlan: planJson });
                showToast('성공', '학습 계획이 적용되었습니다.');
                // The onSnapshot listener will pick up the change and re-render
            } catch (error) {
                console.error("학습 계획 적용 오류:", error);
                showToast('오류', `학습 계획 적용 실패: ${error.message}`, 'danger');
            }
        }

        /**
         * Updates the status of a module in Firestore.
         * @param {number} moduleIndex - Index of the module.
         * @param {string} status - New status ('pending', 'inprogress', 'completed').
         */
        async function updateModuleStatus(moduleIndex, status) {
            if (!currentUserId || !activeProject || !activeProject.learningPlan) return;

            try {
                const projectRef = doc(db, `artifacts/${appId}/users/${currentUserId}/projects`, activeProject.id);
                const updatedLearningPlan = { ...activeProject.learningPlan };
                updatedLearningPlan.modules[moduleIndex].status = status;

                await updateDoc(projectRef, { learningPlan: updatedLearningPlan });
                showToast('성공', '모듈 상태가 업데이트되었습니다.');
            } catch (error) {
                console.error("모듈 상태 업데이트 오류:", error);
                showToast('오류', `모듈 상태 업데이트 실패: ${error.message}`, 'danger');
            }
        }

        /**
         * Updates the status of a lesson in Firestore.
         * @param {number} moduleIndex - Index of the parent module.
         * @param {number} lessonIndex - Index of the lesson.
         * @param {string} status - New status ('pending', 'completed').
         */
        async function updateLessonStatus(moduleIndex, lessonIndex, status) {
            if (!currentUserId || !activeProject || !activeProject.learningPlan) return;

            try {
                const projectRef = doc(db, `artifacts/${appId}/users/${currentUserId}/projects`, activeProject.id);
                const updatedLearningPlan = { ...activeProject.learningPlan };
                updatedLearningPlan.modules[moduleIndex].lessons[lessonIndex].status = status;

                // If all lessons in a module are completed, mark module as completed
                const module = updatedLearningPlan.modules[moduleIndex];
                if (module.lessons && module.lessons.every(lesson => lesson.status === 'completed')) {
                    module.status = 'completed';
                } else if (module.status === 'pending' && status === 'completed') {
                    module.status = 'inprogress'; // If first lesson completed, module is in progress
                }


                await updateDoc(projectRef, { learningPlan: updatedLearningPlan });
                showToast('성공', '레슨 상태가 업데이트되었습니다.');
            } catch (error) {
                console.error("레슨 상태 업데이트 오류:", error);
                showToast('오류', `레슨 상태 업데이트 실패: ${error.message}`, 'danger');
            }
        }

        /**
         * Saves or updates an AI action template in Firestore.
         */
        async function saveAction() {
            if (!currentUserId) return;
            const actionId = DOMElements.actionIdInput.value;
            const actionTitle = DOMElements.actionTitleInput.value.trim();
            const actionCategory = DOMElements.actionCategorySelect.value;
            const actionPurpose = DOMElements.actionPurposeInput.value.trim();

            if (!actionTitle || !actionPurpose) {
                showToast('경고', '액션 제목과 프롬프트 템플릿을 모두 입력해주세요.', 'warning');
                return;
            }

            try {
                const actionsColRef = collection(db, `artifacts/${appId}/users/${currentUserId}/actions`);
                const actionData = {
                    title: actionTitle,
                    category: actionCategory,
                    purpose: actionPurpose
                };

                if (actionId && userActions.some(a => a.key === actionId)) { // Editing existing action
                    await setDoc(doc(actionsColRef, actionId), actionData);
                    showToast('성공', 'AI 액션이 업데이트되었습니다.');
                } else { // Adding new action
                    const newActionKey = `custom_${Date.now()}`;
                    await setDoc(doc(actionsColRef, newActionKey), actionData);
                    showToast('성공', '새 AI 액션이 추가되었습니다.');
                }
                DOMElements.actionManagerModal.hide(); // Hide after save
                DOMElements.actionForm.reset(); // Reset form for next action
                DOMElements.actionIdInput.value = '';
                DOMElements.deleteActionBtn.classList.add('d-none');
                DOMElements.saveActionBtn.textContent = '액션 저장';
            } catch (error) {
                console.error("AI 액션 저장 오류:", error);
                showToast('오류', `AI 액션 저장 실패: ${error.message}`, 'danger');
            }
        }

        /**
         * Deletes an AI action template from Firestore.
         * @param {string} actionKey - The key of the action to delete.
         */
        async function deleteAction(actionKey) {
            if (!currentUserId) return;

            const confirmDelete = await showConfirmation('액션 삭제', '정말로 이 AI 액션을 삭제하시겠습니까?');
            if (!confirmDelete) return;

            try {
                const actionsColRef = collection(db, `artifacts/${appId}/users/${currentUserId}/actions`);
                await deleteDoc(doc(actionsColRef, actionKey));
                showToast('성공', 'AI 액션이 삭제되었습니다.');
                DOMElements.actionManagerModal.hide(); // Hide if deleting from form
                DOMElements.actionForm.reset(); // Reset form
                DOMElements.actionIdInput.value = '';
                DOMElements.deleteActionBtn.classList.add('d-none');
                DOMElements.saveActionBtn.textContent = '액션 저장';
            } catch (error) {
                console.error("AI 액션 삭제 오류:", error);
                showToast('오류', `AI 액션 삭제 실패: ${error.message}`, 'danger');
            }
        }

        /**
         * Saves the study pad content for the current lesson/module to Firestore.
         */
        async function saveStudyPadContent(isLessonPad = true) {
            if (!currentUserId || !activeProject || !activeProject.learningPlan) return;

            try {
                const projectRef = doc(db, `artifacts/${appId}/users/${currentUserId}/projects`, activeProject.id);
                const updatedLearningPlan = { ...activeProject.learningPlan };

                if (isLessonPad && activeModuleIndex !== -1 && activeLessonIndex !== -1) {
                    updatedLearningPlan.modules[activeModuleIndex].lessons[activeLessonIndex].studyPad = DOMElements.lessonStudypadInput.value;
                } else if (!isLessonPad && activeModuleIndex !== -1) { // This part is for module-level study pad in viewer modal
                    updatedLearningPlan.modules[activeModuleIndex].studyPad = DOMElements.studyPadEditor.value;
                }

                await updateDoc(projectRef, { learningPlan: updatedLearningPlan });
                showToast('성공', '스터디 패드 내용이 저장되었습니다.');

                if (!isLessonPad) { // If saving from the viewer modal
                    DOMElements.studyPadContent.classList.remove('d-none');
                    DOMElements.studyPadEditor.classList.add('d-none');
                    DOMElements.editStudypadBtn.classList.remove('d-none');
                    DOMElements.saveStudypadBtn.classList.add('d-none');
                    renderMarkdown(DOMElements.studyPadContent, DOMElements.studyPadEditor.value);
                }
            } catch (error) {
                console.error("스터디 패드 저장 오류:", error);
                showToast('오류', `스터디 패드 저장 실패: ${error.message}`, 'danger');
            }
        }

        /**
         * Downloads all study pad content into a single Markdown file.
         */
        function downloadAllStudyPads() {
            if (!activeProject || !activeProject.learningPlan || !activeProject.learningPlan.modules) {
                showToast('경고', '다운로드할 스터디 패드 내용이 없습니다.', 'warning');
                return;
            }

            let allStudyPadsContent = `# ${activeProject.name} - 전체 스터디 패드\n\n`;
            allStudyPadsContent += `## 최종 학습 목표: ${activeProject.goal}\n\n`;

            activeProject.learningPlan.modules.forEach(module => {
                allStudyPadsContent += `\n\n# ${module.title}\n\n`;
                if (module.studyPad) {
                    allStudyPadsContent += `### 모듈 스터디 패드\n${module.studyPad}\n\n`;
                }
                if (module.notes) {
                    allStudyPadsContent += `### 모듈 개인 메모\n${module.notes}\n\n`;
                }
                if (module.lessons && module.lessons.length > 0) {
                    module.lessons.forEach(lesson => {
                        allStudyPadsContent += `\n## ${lesson.title}\n\n`;
                        if (lesson.studyPad) {
                            allStudyPadsContent += `### 레슨 스터디 패드\n${lesson.studyPad}\n\n`;
                        }
                    });
                }
            });

            const blob = new Blob([allStudyPadsContent], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${activeProject.name}_All_StudyPads.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // Clean up the object URL
            showToast('성공', '모든 스터디 패드 내용이 다운로드되었습니다.');
        }

        // =========================================================
        // 4. Custom Confirmation Modal (instead of alert/confirm)
        // =========================================================
        let confirmationModalInstance = null;
        let resolveConfirmationPromise = null;

        /**
         * Shows a custom confirmation modal.
         * @param {string} title - The title of the confirmation.
         * @param {string} message - The message for the user.
         * @returns {Promise<boolean>} Resolves to true if confirmed, false if cancelled.
         */
        function showConfirmation(title, message) {
            return new Promise((resolve) => {
                resolveConfirmationPromise = resolve;

                if (!confirmationModalInstance) {
                    const modalHtml = `
                        <div class="modal fade" id="customConfirmationModal" tabindex="-1" aria-labelledby="customConfirmationModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="customConfirmationModalLabel">${title}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <p>${message}</p>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-secondary" id="confirm-cancel-btn" data-bs-dismiss="modal">취소</button>
                                        <button type="button" class="btn btn-danger" id="confirm-ok-btn">확인</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    confirmationModalInstance = new bootstrap.Modal(document.getElementById('customConfirmationModal'));

                    document.getElementById('confirm-ok-btn').addEventListener('click', () => {
                        confirmationModalInstance.hide();
                        resolveConfirmationPromise(true);
                    });

                    document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
                        confirmationModalInstance.hide();
                        resolveConfirmationPromise(false);
                    });

                    document.getElementById('customConfirmationModal').addEventListener('hidden.bs.modal', () => {
                        if (resolveConfirmationPromise) {
                            // If modal is closed without explicit button click
                            resolveConfirmationPromise(false);
                            resolveConfirmationPromise = null;
                        }
                        // Optionally remove the modal from DOM if it's dynamic
                        // document.getElementById('customConfirmationModal').remove();
                        // confirmationModalInstance = null;
                    });
                } else {
                    // Update content if modal already exists
                    document.getElementById('customConfirmationModalLabel').textContent = title;
                    document.querySelector('#customConfirmationModal .modal-body p').textContent = message;
                }
                confirmationModalInstance.show();
            });
        }


        // =========================================================
        // 5. Event Listeners & Initial Setup
        // =========================================================

        document.addEventListener('DOMContentLoaded', async () => {
            await initializeFirebase();

            // Sidebar toggle for mobile
            DOMElements.hamburgerMenu.addEventListener('click', () => {
                DOMElements.sidebar.classList.toggle('active');
            });

            // Close sidebar when clicking outside on mobile
            document.querySelector('.main-content').addEventListener('click', (event) => {
                if (DOMElements.sidebar.classList.contains('active') && window.innerWidth <= 992) {
                    if (!DOMElements.sidebar.contains(event.target) && !DOMElements.hamburgerMenu.contains(event.target)) {
                        DOMElements.sidebar.classList.remove('active');
                    }
                }
            });


            DOMElements.googleLoginBtn.addEventListener('click', signInWithGoogle);
            DOMElements.logoutBtn.addEventListener('click', handleSignOut);
            DOMElements.newProjectBtn.addEventListener('click', openNewProjectModal);
            DOMElements.welcomeImportProjectBtn.addEventListener('click', importProject);
            DOMElements.importProjectBtn.addEventListener('click', importProject);
            DOMElements.exportProjectBtn.addEventListener('click', exportProject);
            DOMElements.newProjectForm.addEventListener('submit', (e) => {
                e.preventDefault();
                createProject(DOMElements.projectNameInput.value, DOMElements.projectGoalInput.value);
            });

            // Project delete buttons (event delegation as they are dynamic)
            DOMElements.projectList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-project-btn')) {
                    const projectId = e.target.dataset.projectId;
                    deleteProject(projectId);
                }
            });

            DOMElements.addResourceBtn.addEventListener('click', () => openResourceModalForEdit(null));
            DOMElements.resourceFileUploadInput.addEventListener('change', handleResourceFileUpload);
            DOMElements.saveResourceBtn.addEventListener('click', saveResource);
            // Resource delete/edit buttons (event delegation) in modal
            DOMElements.modalResourceList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-resource-btn-modal')) {
                    const resourceId = e.target.dataset.resourceId;
                    deleteResource(resourceId);
                }
            });


            DOMElements.applyPlanBtn.addEventListener('click', applyLearningPlan);
            DOMElements.learningPlanInput.addEventListener('input', () => {
                try {
                    JSON.parse(DOMElements.learningPlanInput.value);
                    DOMElements.applyPlanBtn.disabled = false;
                } catch (e) {
                    DOMElements.applyPlanBtn.disabled = true;
                }
            });

            // Handle start module button click (event delegation)
            DOMElements.learningDashboard.addEventListener('click', (e) => {
                const startModuleBtn = e.target.closest('.start-module-btn');
                if (startModuleBtn) {
                    activeModuleIndex = parseInt(startModuleBtn.dataset.moduleIndex);
                    activeLessonIndex = -1; // Reset lesson index
                    renderLectureDetailModal();
                    DOMElements.lectureDetailModal.show();
                }
                const aiActionButton = e.target.closest('.ai-action-module-btn');
                if (aiActionButton) {
                    const moduleIndex = parseInt(aiActionButton.dataset.moduleIndex);
                    const currentModule = activeProject.learningPlan.modules[moduleIndex];
                    openPromptModal({ module: currentModule, lesson: null, studyPad: currentModule.studyPad || '' });
                }
            });

            DOMElements.actionManagerBtn.addEventListener('click', openActionManagerModal);
            DOMElements.actionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveAction();
            });
            DOMElements.deleteActionBtn.addEventListener('click', () => {
                if (DOMElements.actionIdInput.value) {
                    deleteAction(DOMElements.actionIdInput.value);
                }
            });
            DOMElements.cancelEditActionBtn.addEventListener('click', () => {
                DOMElements.actionForm.reset();
                DOMElements.actionIdInput.value = '';
                DOMElements.deleteActionBtn.classList.add('d-none');
                DOMElements.saveActionBtn.textContent = '액션 저장';
            });

            // Prompt Modal logic
            DOMElements.promptActionSelect.addEventListener('change', updateDynamicPromptInputs);
            DOMElements.dynamicPromptInputs.addEventListener('input', updateFinalPromptPreview);
            DOMElements.promptDataSource.addEventListener('change', () => {
                if (DOMElements.promptDataSource.value === 'direct-input') {
                    DOMElements.dataSourceContent.classList.remove('d-none');
                } else {
                    DOMElements.dataSourceContent.classList.add('d-none');
                    DOMElements.dataSourceTextarea.value = ''; // Clear when not direct input
                }
                updateFinalPromptPreview();
            });
            DOMElements.dataSourceTextarea.addEventListener('input', updateFinalPromptPreview);
            DOMElements.copyPromptBtn.addEventListener('click', () => {
                copyToClipboard(DOMElements.finalPrompt.value);
            });

            // Download Study Pad
            DOMElements.downloadStudypadBtn.addEventListener('click', downloadAllStudyPads);

            // Detail Viewer Modal (generic for long texts)
            document.body.addEventListener('click', (e) => {
                if (e.target.classList.contains('view-detail-btn')) {
                    const contentId = e.target.dataset.contentId;
                    let content = '';
                    if (contentId === 'project-goal-full' && activeProject) {
                        content = activeProject.goal;
                    }
                    // Add more conditions here for other types of content to view
                    DOMElements.detailViewerContent.innerHTML = content;
                    DOMElements.detailViewerModal.show();
                }
            });

            // Project Overview Modal (new feature button click)
            DOMElements.learningDashboard.addEventListener('click', (e) => {
                const overviewButton = e.target.closest('.start-module-btn'); // Using existing button for now
                if (overviewButton) {
                    // Assuming 'start-module-btn' will open project overview first
                    // The spec says "프로젝트 카드 클릭하면 프로젝트 개요 모달이 열립니다"
                    // For now, I'll hook it up to the activeProject flow
                    if (activeProject) {
                        renderProjectOverviewModal();
                        DOMElements.projectOverviewModal.show();
                    } else {
                        showToast('경고', '활성 프로젝트가 없습니다.', 'warning');
                    }
                }
            });


            // Study Pad Viewer Modal specific logic
            DOMElements.editStudypadBtn.addEventListener('click', () => {
                DOMElements.studyPadContent.classList.add('d-none');
                DOMElements.studyPadEditor.classList.remove('d-none');
                DOMElements.editStudypadBtn.classList.add('d-none');
                DOMElements.saveStudypadBtn.classList.remove('d-none');
                DOMElements.studyPadEditor.value = DOMElements.studyPadContent.textContent; // Load current rendered text
            });
            DOMElements.saveStudypadBtn.addEventListener('click', () => saveStudyPadContent(false));


            // Lecture Detail Modal navigation and actions
            DOMElements.prevLessonBtn.addEventListener('click', () => {
                if (activeLessonIndex > 0) {
                    activeLessonIndex--;
                    renderLectureDetailModal();
                }
            });
            DOMElements.nextLessonBtn.addEventListener('click', () => {
                const currentModule = activeProject.learningPlan.modules[activeModuleIndex];
                if (activeLessonIndex < currentModule.lessons.length - 1) {
                    activeLessonIndex++;
                    renderLectureDetailModal();
                }
            });
            DOMElements.markLessonCompleteBtn.addEventListener('click', () => {
                if (activeModuleIndex !== -1 && activeLessonIndex !== -1) {
                    updateLessonStatus(activeModuleIndex, activeLessonIndex, 'completed');
                }
            });
            DOMElements.saveLessonStudypadBtn.addEventListener('click', () => saveStudyPadContent(true));
            DOMElements.lessonAiActionBtn.addEventListener('click', () => {
                if (activeProject && activeProject.learningPlan && activeModuleIndex !== -1 && activeLessonIndex !== -1) {
                    const currentModule = activeProject.learningPlan.modules[activeModuleIndex];
                    const currentLesson = currentModule.lessons[activeLessonIndex];
                    openPromptModal({ module: currentModule, lesson: currentLesson, studyPad: currentLesson.studyPad || '' });
                } else {
                    showToast('경고', 'AI 액션을 실행할 레슨이 선택되지 않았습니다.', 'warning');
                }
            });
        });
    </script>
</body>
</html>
