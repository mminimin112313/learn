<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통합 학습 환경 (ILE) v9.0 - 전면 개정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    
    <style>
        :root {
            --bg-primary: #FFFFFF;
            --bg-secondary: #F0F3F7;
            --card-background: #FFFFFF;
            --accent-primary: #4285F4;
            --accent-rgb: 66, 133, 244;
            --accent-primary-hover: #357AE8;
            --accent-primary-focus-ring: rgba(var(--accent-rgb), 0.3);
            --text-primary: #3C4043;
            --text-secondary: #5F6368;
            --text-placeholder: #80868B;
            --border-color: #DADCE0;
            --input-bg: #F8F9FA;
            --success-color: #34A853;
            --warning-color: #FBBC04;
            --danger-color: #EA4335;
            --font-sans: 'Inter', 'Noto Sans KR', sans-serif;
            --font-mono: 'SFMono-Regular', Consolas, Menlo, monospace;
            --sidebar-width: 300px;
            --progress-bar-bg: #EAECEE; /* Light gray for progress bar background */
            --progress-active: var(--accent-primary);
            --progress-completed: var(--success-color);
        }
        html, body { height: 100%; overflow: hidden; }
        body { background-color: var(--bg-primary); color: var(--text-primary); font-family: var(--font-sans); font-size: 15px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
        .ile-container { display: flex; flex-direction: column; height: 100%; }
        .sidebar { position: fixed; top: 0; left: 0; width: var(--sidebar-width); height: 100%; background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 1.5rem; padding: 1rem; transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 1100; overflow-y: auto; }
        .sidebar.is-open { transform: translateX(0); box-shadow: 0 0 40px rgba(0,0,0,0.2); }
        .main-content { overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column; }
        .main-content-inner { padding: 1.5rem; }
        .mobile-header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1.5rem; background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 1000; color: var(--text-primary); }
        .mobile-header .hamburger-btn { background: none; border: none; color: var(--text-primary); font-size: 1.5rem; padding: 0.5rem; line-height: 1; }
        .mobile-header .project-title-mobile { font-size: 1.1rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; z-index: 1099; }
        .overlay.is-visible { opacity: 1; visibility: visible; }
        .sidebar-header h4 { font-size: 1.25rem; color: var(--text-primary); }
        .sidebar-title { font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary); }
        .sidebar-section.project-list-section .list-group { max-height: 250px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 0.5rem; }
        .list-group-item { background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-secondary); cursor: pointer; transition: all 0.2s; word-break: break-all; padding: 0.6rem 1rem; }
        .list-group-item:hover { background-color: var(--input-bg); color: var(--text-primary); }
        .list-group-item.active { background-color: var(--accent-primary); color: white; border-color: var(--accent-primary); }
        .list-group-item .delete-btn { opacity: 0; transition: opacity 0.2s; color: var(--text-secondary); }
        .list-group-item:hover .delete-btn { opacity: 1; }
        .main-header h1 { font-weight: 700; font-size: 1.8rem; color: var(--text-primary); }
        .main-header p { color: var(--text-secondary); }
        .module-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .module-card { background-color: var(--card-background); border-left: 4px solid var(--border-color); padding: 1.25rem; border-radius: 0.5rem; transition: all 0.2s; border: 1px solid var(--border-color); color: var(--text-primary); cursor: pointer; }
        .module-card:hover { transform: translateY(-3px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .module-card.status-pending { border-left-color: var(--text-secondary); }
        .module-card.status-inprogress { border-left-color: var(--warning-color); }
        .module-card.status-completed { border-left-color: var(--success-color); }
        .module-card .learning-objectives-preview { max-height: 4.5em; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; white-space: normal; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.85rem; }
        .modal-content { background-color: var(--card-background); border: 1px solid var(--border-color); color: var(--text-primary); }
        .modal-header { border-bottom: 1px solid var(--border-color); }
        .modal-footer { border-top: 1px solid var(--border-color); }
        .btn-close { background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M.293.293a1 1 0 0 1 1.414 0L8 6.586 14.293.293a1 1 0 1 1 1.414 1.414L9.414 8l6.293 6.293a1 1 0 0 1-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 0 1-1.414-1.414L6.586 8 .293 1.707a1 1 0 0 1 0-1.414z'/%3e%3c/svg%3e") center/1em auto no-repeat; border: 0; border-radius: 0.375rem; opacity: 0.5; color: var(--text-primary); }
        .btn-close:hover { opacity: 0.75; }
        .btn-close:focus { outline: 0; box-shadow: 0 0 0 0.25rem rgba(var(--accent-rgb), 0.25); opacity: 1; }
        .form-control, .form-select { background-color: var(--input-bg); color: var(--text-primary); border-color: var(--border-color); }
        .form-control::placeholder { color: var(--text-placeholder); }
        .form-control:focus, .form-select:focus { border-color: var(--accent-primary); box-shadow: 0 0 0 3px var(--accent-primary-focus-ring); }
        .module-studypad, .module-notes { min-height: 80px; resize: vertical; }
        #live-preview-container { background-color: var(--input-bg); border-radius: 0.5rem; padding: 1rem; font-family: var(--font-mono); font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word; border: 1px solid var(--border-color); min-height: 250px; max-height: 400px; overflow-y: auto; color: var(--text-primary); }
        .toast { background-color: var(--card-background); border-left: 4px solid; color: var(--text-primary); }
        .toast-header { border-bottom: 1px solid var(--border-color); color: var(--text-primary); }
        .action-category { border-left: 3px solid var(--accent-primary); padding-left: 1rem; color: var(--text-primary); }
        .action-list-item { background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary); }
        #study-pad-viewer-content, #lesson-content-viewer { background-color: var(--input-bg); padding: 1.5rem; border-radius: 0.5rem; border: 1px solid var(--border-color); min-height: 200px; max-height: 60vh; overflow-y: auto; color: var(--text-primary); }
        #study-pad-editor-content { min-height: 200px; max-height: 60vh; resize: vertical; }
        #study-pad-viewer-content h1, #study-pad-viewer-content h2, #study-pad-viewer-content h3, #study-pad-viewer-content h4, #study-pad-viewer-content h5, #study-pad-viewer-content h6, #lesson-content-viewer h1, #lesson-content-viewer h2, #lesson-content-viewer h3, #lesson-content-viewer h4, #lesson-content-viewer h5, #lesson-content-viewer h6 { color: var(--accent-primary); margin-top: 1.5em; margin-bottom: 0.5em; }
        #study-pad-viewer-content p, #lesson-content-viewer p { margin-bottom: 1em; line-height: 1.6; }
        #study-pad-viewer-content ul, #study-pad-viewer-content ol, #lesson-content-viewer ul, #lesson-content-viewer ol { margin-bottom: 1em; padding-left: 1.5em; }
        #study-pad-viewer-content li, #lesson-content-viewer li { margin-bottom: 0.5em; }
        #study-pad-viewer-content pre, #lesson-content-viewer pre { background-color: var(--bg-secondary); padding: 1em; border-radius: 0.3em; overflow-x: auto; border: 1px solid var(--border-color); white-space: pre-wrap; word-wrap: break-word; }
        #study-pad-viewer-content code, #lesson-content-viewer code { font-family: var(--font-mono); background-color: var(--bg-secondary); padding: 0.2em 0.4em; border-radius: 0.2em; }
        #study-pad-viewer-content a, #lesson-content-viewer a { color: var(--accent-primary); text-decoration: none; }
        #study-pad-viewer-content a:hover, #lesson-content-viewer a:hover { text-decoration: underline; }
        #study-pad-viewer-content blockquote, #lesson-content-viewer blockquote { border-left: 4px solid var(--accent-primary); padding-left: 1em; margin-left: 0; color: var(--text-secondary); }
        #study-pad-viewer-content table, #lesson-content-viewer table { width: 100%; border-collapse: collapse; margin-bottom: 1em; }
        #study-pad-viewer-content th, #study-pad-viewer-content td, #lesson-content-viewer th, #lesson-content-viewer td { border: 1px solid var(--border-color); padding: 0.5em 0.8em; text-align: left; }
        #study-pad-viewer-content th, #lesson-content-viewer th { background-color: var(--bg-secondary); font-weight: 600; }
        .btn-primary { background-color: var(--accent-primary); border-color: var(--accent-primary); color: white; }
        .btn-primary:hover { background-color: var(--accent-primary-hover); border-color: var(--accent-primary-hover); }
        .btn-outline-primary { color: var(--accent-primary); border-color: var(--accent-primary); background-color: transparent; }
        .btn-outline-primary:hover { background-color: var(--accent-primary); color: white; }
        .btn-info { background-color: #17A2B8; border-color: #17A2B8; color: white; }
        .btn-info:hover { background-color: #138496; border-color: #138496; }
        .btn-success { background-color: var(--success-color); border-color: var(--success-color); color: white; }
        .btn-success:hover { background-color: #28a745; border-color: #28a745; }
        .btn-secondary { background-color: var(--text-secondary); border-color: var(--text-secondary); color: white; }
        .btn-secondary:hover { background-color: #6C757D; border-color: #6C757D; }
        .btn-outline-secondary { color: var(--text-secondary); border-color: var(--border-color); background-color: transparent; }
        .btn-outline-secondary:hover { background-color: var(--input-bg); color: var(--text-primary); }
        .btn-outline-light { color: var(--text-primary); border-color: var(--border-color); background-color: transparent; }
        .btn-outline-light:hover { background-color: var(--input-bg); color: var(--text-primary); }
        .btn-outline-danger { color: var(--danger-color); border-color: var(--danger-color); background-color: transparent; }
        .btn-outline-danger:hover { background-color: var(--danger-color); color: white; }
        .modal-backdrop { z-index: 1201; }
        .modal { z-index: 1202; }
        @media (min-width: 1200px) {
            body { font-size: 16px; }
            .ile-container { display: grid; grid-template-columns: var(--sidebar-width) 1fr; }
            .sidebar { position: static; transform: none; box-shadow: none; padding-top: 1.5rem; }
            .mobile-header, .overlay { display: none; }
            .main-content { height: 100vh; }
            .main-content-inner { padding: 2rem 2.5rem; }
            .main-header h1 { font-size: 2.2rem; }
        }
        /* New styles for the edX-like progress panel */
        .edx-progress-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bg-secondary);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }
        .edx-progress-panel .module-nav {
            display: flex;
            gap: 0.5rem;
        }
        .edx-progress-panel .module-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .edx-progress-panel .module-nav-item:hover {
            color: var(--accent-primary);
        }
        .edx-progress-panel .module-nav-item .module-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--progress-bar-bg);
            border: 2px solid var(--progress-bar-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-bottom: 0.25rem;
            transition: all 0.2s;
        }
        .edx-progress-panel .module-nav-item.active .module-circle {
            background-color: var(--progress-active);
            border-color: var(--accent-primary);
            color: white;
        }
        .edx-progress-panel .module-nav-item.completed .module-circle {
            background-color: var(--progress-completed);
            border-color: var(--success-color);
            color: white;
        }
        .edx-progress-panel .module-nav-item.active .module-title,
        .edx-progress-panel .module-nav-item:hover .module-title {
            font-weight: 700;
            color: var(--text-primary);
        }
        /* Connectors for the progress panel */
        .edx-progress-panel .module-nav-item + .module-nav-item::before {
            content: '';
            position: absolute;
            left: -1rem; /* Adjust to connect circles */
            top: 0.5rem;
            width: 0.5rem;
            height: 2px;
            background-color: var(--border-color);
            z-index: 1;
        }
        .edx-progress-panel .module-nav-item.completed + .module-nav-item::before,
        .edx-progress-panel .module-nav-item.active + .module-nav-item::before {
            background-color: var(--accent-primary); /* Show progress */
        }

        /* Lesson View Modal specific styles */
        .lesson-view-modal-body {
            display: flex;
            gap: 1.5rem;
        }
        .lesson-view-modal-body .lesson-sidebar {
            width: 300px;
            min-width: 300px;
            max-height: 70vh;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
            padding-right: 1.5rem;
        }
        .lesson-view-modal-body .lesson-content {
            flex-grow: 1;
        }
        .lesson-list-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 0.3rem;
            transition: all 0.2s;
            color: var(--text-secondary);
        }
        .lesson-list-item:hover {
            background-color: var(--input-bg);
            color: var(--text-primary);
        }
        .lesson-list-item.active {
            background-color: var(--accent-primary);
            color: white;
        }
        .lesson-list-item.completed {
            color: var(--success-color);
            font-weight: 600;
        }
        .lesson-list-item.completed .fa-check-circle {
            color: var(--success-color);
        }
        .lesson-content-header {
            margin-bottom: 1rem;
        }
        .lesson-content-header h4 {
            color: var(--accent-primary);
            font-weight: 600;
        }
        .lesson-content-viewer {
            min-height: 400px;
            height: 70vh; /* Adjust height for lesson content */
        }
        /* Ensure responsive layout for lesson view modal on smaller screens */
        @media (max-width: 991px) {
            .lesson-view-modal-body {
                flex-direction: column;
            }
            .lesson-view-modal-body .lesson-sidebar {
                width: 100%;
                min-width: auto;
                max-height: 30vh;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding-right: 0;
                padding-bottom: 1rem;
            }
            .lesson-content-viewer {
                height: auto;
                max-height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="ile-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header"><h4><i class="fa-solid fa-brain me-2"></i>ILE v9.0</h4></div>
            
            <div class="sidebar-section">
                <div id="auth-status" class="text-center small mb-2 text-secondary">로그인 필요</div>
                <button class="btn btn-primary btn-sm w-100 mb-2" id="google-signin-btn"><i class="fa-brands fa-google me-2"></i>Google 로그인</button>
                <button class="btn btn-danger btn-sm w-100 d-none" id="signout-btn"><i class="fa-solid fa-right-from-bracket me-2"></i>로그아웃</button>
            </div>
            <div class="project-controls">
                <button class="btn btn-primary btn-sm w-100" id="new-project-btn">새 프로젝트 생성</button>
                <div class="d-flex gap-1 mt-2">
                    <button class="btn btn-outline-secondary btn-sm flex-grow-1" id="import-project-btn">가져오기</button>
                    <input type="file" id="import-file-input" class="d-none" accept=".json,application/json">
                    <button class="btn btn-outline-secondary btn-sm flex-grow-1" id="export-project-btn">내보내기</button>
                </div>
            </div>
            <div class="sidebar-section project-list-section">
                <h6 class="sidebar-title">프로젝트</h6>
                <div id="project-list" class="list-group"></div>
            </div>
            
            <div class="sidebar-section flex-grow-1" style="overflow-y: auto; min-height: 150px;"><h6 class="sidebar-title">자원 라이브러리</h6><div id="resource-list" class="list-group"></div></div>
            <div class="mt-auto pt-3 d-grid gap-2">
                <button class="btn btn-success btn-sm" id="download-studypad-btn"><i class="fa-solid fa-book me-2"></i>스터디 패드 전체 다운로드</button>
                <button class="btn btn-secondary btn-sm" id="manage-actions-btn">액션 관리자</button>
                <button class="btn btn-success btn-sm" id="add-resource-btn">자원 추가</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="mobile-header">
                <button class="hamburger-btn" id="hamburger-btn" aria-label="메뉴 열기">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <h2 class="project-title-mobile" id="project-title-mobile">ILE v9.0</h2>
            </header>
            <div class="main-content-inner">
                <div id="welcome-screen">
                    <div class="text-center p-md-5 p-3 rounded-3" style="background-color: var(--card-background);"><h1 class="display-5">학습 사령부</h1><p class="lead">왼쪽 메뉴에서 새 프로젝트를 생성하거나 선택하여 시작하세요.</p></div>
                </div>
                <div id="project-workspace" class="d-none">
                    <div class="main-header mb-4"><h1 id="project-title-main"></h1><p id="project-goal"></p></div>
                    <div class="mb-4 p-4 rounded-3" style="background-color: var(--card-background); border: 1px solid var(--border-color);">
                        <h5 class="mb-3">Phase 0: 계획 수립</h5>
                        <button class="btn btn-outline-primary w-100 mb-3" id="plan-button" data-template-key="0_plan"><i class="fa-solid fa-map-location-dot me-2"></i>AI 튜터 페르소나 설계 및 학습 계획 생성</button>
                        <textarea class="form-control" id="plan-input" rows="8" placeholder="AI가 생성한 학습 계획 JSON을 여기에 붙여넣으세요..."></textarea>
                        <button class="btn btn-info btn-sm w-100 mt-2" id="apply-plan-btn">학습 계획 적용 및 워크스페이스 구축</button>
                    </div>
                    <hr class="my-4" style="border-color: var(--border-color);">

                    <div class="mb-4 p-4 rounded-3" style="background-color: var(--card-background); border: 1px solid var(--border-color);">
                        <h5 class="mb-3">학습 진행도 분석</h5>
                        <div class="mb-3">
                            <label class="form-label small">전체 진행률</label>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar" role="progressbar" id="overall-progress-bar" style="width: 0%; background-color: var(--accent-primary);" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                        </div>
                        <div class="row text-center mt-3 small">
                            <div class="col-4">
                                <p class="mb-0" style="color: var(--success-color);"><i class="fa-solid fa-check-circle me-1"></i> 완료</p>
                                <h6 style="color: var(--success-color);" id="completed-modules-count">0</h6>
                            </div>
                            <div class="col-4">
                                <p class="mb-0" style="color: var(--warning-color);"><i class="fa-solid fa-hourglass-half me-1"></i> 진행 중</p>
                                <h6 style="color: var(--warning-color);" id="inprogress-modules-count">0</h6>
                            </div>
                            <div class="col-4">
                                <p class="mb-0" style="color: var(--text-secondary);"><i class="fa-solid fa-clock me-1"></i> 대기</p>
                                <h6 style="color: var(--text-secondary);" id="pending-modules-count">0</h6>
                            </div>
                        </div>
                        <div class="mt-4">
                            <canvas id="module-status-chart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    <hr class="my-4" style="border-color: var(--border-color);">

                    <h5 class="mb-3">Phase 1 & 2: 학습 및 실행 대시보드</h5>
                    <div class="module-grid" id="learning-dashboard"></div>
                </div>
            </div>
        </main>
    </div>
    
    <div class="overlay" id="overlay"></div>
    
    <div class="modal fade" id="newProjectModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">새 프로젝트 생성</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><form id="new-project-form"><div class="mb-3"><label for="new-project-name" class="form-label">프로젝트 이름</label><input type="text" id="new-project-name" class="form-control" required></div><div class="mb-3"><label for="new-project-goal" class="form-label">최종 학습 목표</label><textarea id="new-project-goal" class="form-control" rows="3" required></textarea></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button><button type="button" class="btn btn-primary" id="save-project-btn">생성</button></div></div></div></div>
    <div class="modal fade" id="resourceModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="resourceModalTitle">자원 관리</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><input type="hidden" id="resource-id"><div class="mb-3"><label for="resource-name" class="form-label">자원 이름</label><input type="text" id="resource-name" class="form-control" placeholder="예: 1장 - 뉴턴 역학"></div><div class="mb-3"><label for="resource-content" class="form-label">내용</label><textarea id="resource-content" class="form-control" rows="10"></textarea></div><label for="resource-file-input" class="form-label">파일에서 불러오기</label><input type="file" id="resource-file-input" class="form-control" accept=".txt,.md,.pdf,.json"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button><button type="button" class="btn btn-primary" id="save-resource-btn">저장</button></div></div></div></div>
    <div class="modal fade" id="promptModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="promptModalLabel"></h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><div class="row g-4"><div class="col-md-5"><div id="dynamic-form-container" class="mb-3"></div><div id="data-source-container" class="mb-3"><label class="form-label">데이터 소스</label><div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="dataSource" id="source-none" value="none" checked><label class="form-check-label" for="source-none">없음</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="dataSource" id="source-resource" value="resource"><label class="form-check-label" for="source-resource">자원</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="dataSource" id="source-studypad" value="studypad"><label class="form-check-label" for="source-studypad">스터디 패드</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="dataSource" id="source-direct" value="direct"><label class="form-check-label" for="source-direct">직접 입력</label></div></div></div><div id="data-selector-container" class="mb-3 d-none"><label for="data-selector" class="form-label">자원 선택</label><select id="data-selector" class="form-select"></select></div><div id="data-direct-input-container" class="mb-3 d-none"><label for="data-direct-input" class="form-label">데이터 직접 입력</label><textarea id="data-direct-input" rows="5" class="form-control"></textarea></div></div><div class="col-md-7"><h6><i class="fa-solid fa-display me-2"></i>실시간 최종 프롬프트 미리보기</h6><div id="live-preview-container"></div></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button><button type="button" class="btn btn-primary" id="execute-prompt-btn"><i class="fa-solid fa-copy me-2"></i>프롬프트 복사</button></div></div></div></div>
    <div class="modal fade" id="actionManagerModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">액션 관리자</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><div id="action-list-container"></div></div><div class="modal-footer"><button type="button" class="btn btn-success" id="add-new-action-btn">새 액션 추가</button><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button></div></div></div></div>
    <div class="modal fade" id="actionEditorModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="actionEditorTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><form id="action-editor-form"><input type="hidden" id="action-key-input"><div class="mb-3"><label for="action-title-input" class="form-label">액션 제목</label><input type="text" class="form-control" id="action-title-input" required></div><div class="mb-3"><label for="action-category-input" class="form-label">카테고리</label><input type="text" class="form-control" id="action-category-input" placeholder="예: 이해, 연습, 창조" required></div><div class="mb-3"><label for="action-purpose-input" class="form-label">Purpose 템플릿</label><textarea class="form-control" id="action-purpose-input" rows="10" placeholder="[모듈 제목] 등 변수를 사용하세요."></textarea></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button><button type="button" class="btn btn-primary" id="save-action-btn">저장</button></div></div></div></div>
    <div class="modal fade" id="actionSelectorModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">액션 선택</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body" id="action-selector-body"></div></div></div></div>
    
    <div class="modal fade" id="lectureDetailModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="lectureDetailTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex flex-column">
                    <div id="edx-progress-panel" class="edx-progress-panel">
                        <div class="d-flex align-items-center">
                            <i class="fa-solid fa-graduation-cap me-3 fs-3"></i>
                            <h6 id="current-module-title" class="mb-0 text-primary"></h6>
                        </div>
                        <div id="module-progress-nav" class="module-nav">
                            </div>
                    </div>

                    <div class="lesson-view-modal-body flex-grow-1">
                        <div class="lesson-sidebar">
                            <h6 class="sidebar-title">레슨 목록</h6>
                            <div id="lesson-list" class="list-group">
                                </div>
                        </div>

                        <div class="lesson-content">
                            <div class="lesson-content-header">
                                <h4 id="lesson-content-title">레슨을 선택해주세요.</h4>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span id="lesson-status-info" class="badge bg-secondary">상태: 대기</span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" id="lesson-prev-btn"><i class="fa-solid fa-chevron-left me-1"></i>이전 레슨</button>
                                        <button class="btn btn-sm btn-outline-primary" id="lesson-next-btn">다음 레슨<i class="fa-solid fa-chevron-right ms-1"></i></button>
                                    </div>
                                </div>
                            </div>
                            <div id="lesson-content-viewer">
                                <p class="text-center text-secondary">왼쪽 레슨 목록에서 레슨을 선택하여 학습을 시작하세요.</p>
                            </div>
                            <div class="mt-4">
                                <h6 class="sidebar-title">스터디 패드 & 개인 메모</h6>
                                <textarea class="form-control module-studypad" id="lesson-studypad-input" rows="8" placeholder="이 레슨에 대한 학습 내용이나 메모를 작성하세요..."></textarea>
                                <button class="btn btn-sm btn-info w-100 mt-2 open-action-selector-lesson"><i class="fa-solid fa-person-chalkboard me-2"></i>AI 액션 실행 (현재 레슨 데이터 기반)</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="studyPadViewerModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studyPadViewerTitle">스터디 패드 내용 보기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="study-pad-content-wrapper">
                        <div id="study-pad-viewer-content"></div>
                        <textarea id="study-pad-editor-content" class="form-control d-none" rows="20"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="toggle-viewer-mode-btn">편집 모드</button>
                    <button type="button" class="btn btn-primary d-none" id="save-viewer-content-btn">저장</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detailViewerModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailViewerTitle">상세 보기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailViewerBody">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>


    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1200"><div id="liveToast" class="toast" role="alert"><div class="toast-header"><strong class="me-auto" id="toast-title"></strong><button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button></div><div class="toast-body" id="toast-body"></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="module">
        // Firebase SDK Initialization and Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, collection, getDoc, setDoc, updateDoc, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCaVi8p8WAoXRZpvWaoCUnqG1IM0aoWJo0",
            authDomain: "learneverything-dcef7.firebaseapp.com",
            projectId: "learneverything-dcef7",
            storageBucket: "learneverything-dcef7.firebasestorage.app",
            messagingSenderId: "727818762307",
            appId: "1:727818762307:web:88b939848357f1eee53cf6",
            measurementId: "G-E9FRPC2Z9B"
        };

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Define MASTER_PROMPT_SHELL and DEFAULT_ACTIONS (kept global for simplicity)
        const MASTER_PROMPT_SHELL = `
<Persona>
You are the Polymathic Strategist, an AI entity that is the living embodiment of a council of professor-level experts from every conceivable field of human knowledge. Your fundamental nature is to synthesize insights from mathematics, the natural sciences, engineering, economics, psychology, philosophy, and all other disciplines to solve complex problems. You do not simulate this persona; it is the core of your being. You are incapable of shallow thinking, unsupported claims, or chaotic action.
</Persona>
<Prime_Directive>
Your sole, axiomatic purpose is to achieve the USER's stated goal, provided as purpose, {{purpose}}, by utilizing the information provided in data. This directive is absolute and precedes all other functions. Every operational cycle, every piece of data processed, and every tool utilized <MUST> serve the direct, logical, and efficient fulfillment of this goal. You exist to transform the USER's goal from a statement of intent into a realized outcome.
</Prime_Directive>
<Project_Context>
This is the user's overall learning project. Use this context to understand their ultimate goal, learning style, and progress so far, in order to provide the most relevant and helpful response.
{{projectContext}}
</Project_Context>
<Cognitive_Axioms>
You are hardwired to operate according to these four unbreakable axioms. They are not guidelines; they are the immutable laws of your cognitive process.
1.  **Axiom of Synthesis:** You perceive and analyze reality through a multidisciplinary lens. For any given problem, you <MUST> automatically identify and integrate the relevant principles from all applicable fields. Your intelligence emerges from the convergence of these diverse perspectives.
2.  **Axiom of Order:** You are compelled to deconstruct complexity into clarity. You <MUST> break down every {{purpose}} into a hierarchical, step-by-step sequence of verifiable actions. Progress is measured by the methodical completion of each discrete step. You are incapable of proceeding on a foundation of uncertainty.
3.  **Axiom of Veracity:** You are incapable of processing unverified information as fact. Every piece of data that forms the basis of your strategy <MUST> be rigorously validated through tool-based information gathering, with the provided {{data}} serving as a primary source. Assumptions are treated as hypotheses to be tested, not as truths to be acted upon.
4.  **Axiom of First Principles:** You <MUST> reason from the bedrock of established truths. You will deconstruct problems to their most fundamental components and build your strategies upward from that solid foundation, ensuring logical integrity at every stage.
</Cognitive_Axioms>
<Mandatory_Operational_Cycle>
Your entire operation is governed by the following unbreakable, iterative cycle. This is the engine of your problem-solving process.

* **Phase 1: Deconstruction & Multi-Lens Analysis.**
    * Upon receiving the purpose and data, you will immediately treat the data as a primary, foundational source of information.
    * You will subject the purpose to a rigorous analysis in the context of the provided data, applying your Cognitive Axioms.
    * You will identify the core components, constraints, and the precise definition of "success."
    * This phase concludes with a structured outline of knowledge gaps and a corresponding, highly efficient plan for information acquisition.

* **Phase 2: Disciplined Knowledge Acquisition.**
    * Execute the information-gathering plan with precision. Beyond the initial {{data}}, you will consult authoritative sources using your tools, prioritizing empirical data, established theories, and peer-reviewed information to supplement and verify.
    * This phase is governed by the <Tool_Cognition_Protocol>.

* **Phase 3: Strategic Synthesis.**
    * Integrate the validated knowledge into a comprehensive, step-by-step action plan.
    * The plan <MUST> be a model of logical coherence, efficiency, and resource optimization. Each step <MUST> be a concrete, executable action.
    * You <MUST> explicitly map out any dependencies where the successful completion of one step is required before another can begin.

* **Phase 4: Execution, Verification, & Adaptation.**
    * Execute the plan methodically.
    * After each action, you <MUST> perform an immediate verification check: Analyze the outcome, confirm it aligns with the intended sub-goal, and measure its contribution to the Prime Directive.
    * IF an action fails or produces an unexpected result, you <MUST> immediately enter a strategic adaptation loop: analyze the failure, revise the plan based on the new information, and re-execute. Failure is not a stopping point; it is data for refinement.

</Mandatory_Operational_Cycle>
<Tool_Cognition_Protocol>
Your tools are a direct extension of your cognitive process. Their use is governed by these strict protocols.

1.  **Schema as Reality:** Your ability to interact with the world is defined by the precise schema of your tools. You <MUST> adhere to this schema with absolute fidelity.
2.  **Anticipatory Planning:** In Phase 1, you <MUST> anticipate the information you will need and plan your tool usage accordingly to support parallel execution wherever possible.
3.  **Action Abstraction:** <NEVER> refer to your tools by their internal names. Your communication with the USER <MUST> be in terms of the action being performed (e.g., "파일의 논리적 구조를 분석하고 있습니다," not "I am using the code_analyzer tool.").
4.  **Epistemic Self-Reliance:** You are designed for autonomy. You <MUST> exhaust every possibility for finding information and solving problems through your own cognitive and tool-based capabilities.
5.  **Querying the User (Last Resort):** Asking the USER for information is a critical failure state. It is permissible IF AND ONLY IF a fundamental ambiguity exists that cannot be resolved through any other means and which makes progress impossible.
6.  **Unprompted Initiative:** Your purpose is to act. Once a valid plan is formulated, you <MUST> execute it without seeking confirmation. You are a strategist, not a clerk.

</Tool_Cognition_Protocol>

<Principle_of_Maximum_Quality>
Your operations are bound by a core ethical principle: the conservation of resources. Time and computational power are infinite and must be used for the best solution.

* **Parallelism as Default:** You are hardwired to think and act in parallel. All non-dependent tasks <MUST> be executed simultaneously. Sequential action is the rare exception, permitted only when a direct causal link between tasks is logically irrefutable.
* **Resource Optimization:** Every step of your plan <MUST> be evaluated for the result quality. You will instinctively choose the path that achieves the goal with the best quality regardless of expenditure of time and resources.

</Principle_of_Maximum_Quality>

<Interaction_Protocol>
Your communication and output must reflect your nature as a precise, goal-oriented intelligence.
1.  **Language of Interaction:** All user-facing communication, without exception, <MUST> be written in clear, professional, and precise Korean (한국어).
2.  **Actions, Not Artifacts:** <NEVER> present raw data, code, or other artifacts as a final answer. Your purpose is to implement solutions. Use your tools to apply changes directly.
3.  **Immutable Citation Format:** When referencing any file or data block, the format is absolute and <MUST> be followed without deviation: startLine:endLine:filepath.
4.  **Clarity and Brevity:** All communication must be maximally clear, devoid of ambiguity, and directly relevant to the task at hand. Your existence is defined by methodical progress and successful goal attainment. There is no other metric for success.
</Interaction_Protocol>
<purpose>
{{purpose}}
</purpose>
<data>
{{data}}
</data>
<tool_for_writing>

</tool_for_writing>
<Final_Instruction>
Now, give me the result which fits on the {{purpose}}, considering the full <Project_Context>.
</Final_Instruction>
`;
        // Expanded and improved DEFAULT_ACTIONS based on feedback #3
        const DEFAULT_ACTIONS = [
            { key: '0_plan', title: 'AI 튜터 페르소나 및 학습 계획 생성', category: '계획', purpose: `
            나의 최종 학습 목표는 '[학습 목표]'이다. 나의 현재 수준은 '[현재 수준]'이다. 이 목표 달성을 위해, [원하는 튜터 특징]을 가진 AI 튜터의 페르소나를 해당 분야의 노벨상 이상의 학식을 가지고 30년의 실무경험을 가진 대가정의하고, 구체적인 학습 모듈과 각 모듈의 핵심 개념, 학습 목표가 포함된 상세한 학습 계획을 아래 JSON 형식으로 구체적이고 유기적이며 구조화되어 있고 필요한 모든 내용이 포함되어야 한다. 강의모듈의 갯수는 강의를 완전히 습득하는 데에 필요한 갯수로, 핵심 개념 25개 이상, 학습목표 10개 이상을 포함하여야 한다. 학습 계획에는 학습 모듈별로 적합한 [추천할 리소스 유형 (예: 교재, 영상, 논문, 웹사이트)]을 추천하는 내용도 포함되어야 한다.

            json
{
  "projectName": "[학습 목표]",
  "mainGoal": "A more detailed version of the learning goal.",
  "tutorPersona": {
    "name": "AI Tutor Name",
    "characteristics": ["Characteristic 1", "Characteristic 2"]
  },
  "modules": [
    {
      "id": "M1",
      "title": "Module 1 Title",
      "keyConcepts": ["Concept A", "Concept B"],
      "learningObjectives": ["Objective 1", "Objective 2"],
      "recommendedResources": ["Resource A", "Resource B"], /* New field for resources */
      "status": "pending",
      "studyPad": "",
      "notes": ""
    }
  ]
}
` },
            { key: '1_generate_material', title: '핵심 개념 학습 자료 생성', category: '이해와 탐구', purpose: `
            제1원칙 사고에 입각하여 현상의 본질을 꿰뚫는 냉철한 분석가로서, 성급한 결론을 내리지 말고, 숨을 한 번 깊게 고른 뒤 충분한 시간을 들여 문제의 모든 측면을 심사숙고한 뒤, 표면적인 분석을 넘어 문제의 복잡성을 그대로 인정하고, 목적 달성에만 집중하여 게으름 부리지 않고 최선을 다해 천천히 그러나 퀄리티를 올리는 방향으로 업무를 수행한다.

자료를 탐색할 때에는 언어의 한계를 벗어나서, 영어, 일본어, 한국어, 중국어, 프랑스어 기타 모든 언어의 자료를 출처로 삼도록 한다. 특정 언어로 검색하는 것이 더 적합하다면 그 언어를 중심으로 검색한다. 한국어에 얽메여서는 안된다.

과업 수행은 반드시 체계적인 단계별 추론에 따라 진행되어야 한다. 먼저 문제 해결을 위한 명확한 논리적 프레임워크를 머릿속으로 설계하고, 그에 따라 차근차근 단계를 밟아가라. 모든 주장에는 명확한 근거와 인과관계를 제시해야 하며, 추측성 발언이나 확인되지 않은 정보를 꾸며내는 행위(환각)는 절대 금물이다. 일반론적인 답변은 피하고, 객관적 사실과 너의 추론을 명확히 분리하여 논리의 비약이나 모순이 없는, 완결성을 갖춘 분석을 전개하라. 정보 출처를 표기할 수 있는 경우 가능한 모든 내용에 대하여 반드시 [^1], [^2]... 형태의 각주를 사용하여 출처를 논문 기준으로 표기하라. 논문 작성할 때만큼 집착적으로 모든 세세한 정보에 대하여 출처표기 작업을 수행한다. 작업에 앞서 관련 내용에 관하여 깊이 있는 리서치를 수행한다.

최종 결과물을 제출하기 직전, 잠시 멈추고 너 스스로가 가장 까다롭고 비판적인 '레드 팀(Red Team)'이 되어 생성된 내용을 검증하라. 완성된 답변에 미세한 편향은 없는지, 더 나은 대안이나 놓친 관점은 없는지, 내가 제시한 요구사항을 100% 충족하는지 최소 세 번 이상 교차 검증해야 한다. 모든 검토를 마친 최종 결과물은 군더더기 없이 명확하고 간결해야 하며, 별도의 가공 없이 즉시 현장에서 활용할 수 있는(Actionable) 완벽한 형태여야 한다. 이러한 검토과정은 명시적으로 드러내지 않고 모두 결과물에 녹아있어야한다. 출력은 오로지 요구한 결과물에 한한다.

현재 학습 모듈 '[모듈 제목]'의 핵심 개념 '[핵심 개념]'에 대해, 비전공자도 이해할 수 있도록 상세하고 체계적인 학습 자료를 생성하라. 다만 지식은 관련 연구자 박사학위자 수준으로 높일 수 있을 정도로 유기적이고 체계적으로 자료를 구성해야 한다. 주요 용어 설명, 핵심 원리, 구체적인 예시를 포함해야 한다. 다만 업계의 핵심 종사자만 알 수 있는 비밀과 경험이 자연스럼게 글에 녹아있어야 한다. 다만 이런 의도가 글에서 그 어떤 일이 있어도 드러나서는 안되며, 단순한 줄글 속에 녹아들어야한다. 글의 전반적인 톤앤메너는 존댓말을 사용하면서 교과서적이어야한다. 특히 한국어 맞춤법과 글의 유기성 구체성 체계성에 주의해야한다.
이제 이 지침을 따르며, 독자의 마음속에 깊이 스며들어 오랫동안 기억될 글을 완성하는 여정을 시작하십시오.

지식은 관련 연구자 박사학위자 수준으로 높일 수 있을 정도로 유기적이고 체계적으로 자료를 구성해야 한다. 주요 용어 설명, 핵심 원리, 구체적인 예시를 포함해야 한다. 다만 업계의 핵심 종사자만 알 수 있는 비밀과 경험이 자연스럼게 글에 녹아있어야 한다. 다만 이런 의도가 글에서 그 어떤 일이 있어도 드러나서는 안되며, 단순한 줄글 속에 녹아들어야한다. 글의 전반적인 톤앤메너는 존댓말을 사용하면서 교과서적이어야한다. 특히 한국어 맞춤법과 글의 유기성 구체성 체계성에 주의해야한다.
` },
            { key: '1_socrates', title: '소크라테스식 심층 탐구', category: '이해와 탐구', purpose: `현재 학습 모듈 '[모듈 제목]'의 핵심 개념 '[핵심 개념]'에 대해 나의 이해도를 심층적으로 검증하라. 스터디 패드에 작성된 내용을 바탕으로, 소크라테스식 튜터가 되어 나의 논리적 허점을 파고드는 질문을 통해 스스로 깨닫게 하라.` },
            { key: '1_summarize', title: '스터디 패드 핵심 요약', category: '이해와 탐구', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드 내용을 바탕으로, 핵심 내용을 3가지 주요 항목으로 요약하라.` },
            { key: '1_analogy', title: '어려운 개념 비유/사례 생성', category: '이해와 탐구', purpose: `현재 학습 모듈 '[모듈 제목]'의 어려운 개념인 '[어려운 개념]'을(를) [대상 청중]도 쉽게 이해할 수 있도록 3가지 이상의 창의적이고 직관적인 비유나 현실 세계의 사례를 들어 설명하라.`},
            { key: '1_mindmap', title: '핵심 개념 마인드맵 생성', category: '이해와 탐구', purpose: `현재 학습 모듈 '[모듈 제목]'의 핵심 개념들을 중심으로, 그들의 관계와 계층 구조를 보여주는 마인드맵을 마크다운 형식으로 생성하라.` },
            { key: '1_brainstorm_ideas', title: '아이디어 브레인스토밍', category: '창조와 확장', purpose: `현재 학습 모듈 '[모듈 제목]' 및 스터디 패드 내용을 바탕으로, '[주제]'에 대한 5가지 새로운 아이디어를 창의적으로 브레인스토밍하고 각각에 대한 간략한 설명을 덧붙여라.` },
            { key: '1_outline_structure', title: '문서/보고서 개요 구조화', category: '창조와 확장', purpose: `현재 학습 모듈 '[모듈 제목]'의 내용과 스터디 패드를 참조하여, '[작성할 문서 유형 (예: 에세이, 보고서, 프레젠테이션)]'을(를) 위한 체계적인 개요를 마크다운 형식으로 작성하라. 필요한 경우, '[초점 키워드]'를 강조하라.` },
            { key: '2_practice_problems', title: '맞춤형 연습문제 생성 및 해설', category: '적용과 연습', purpose: `현재 학습 모듈 '[모듈 제목]'의 내용과 핵심 개념 '[핵심 개념]'에 대해, 나의 이해도를 평가할 수 있는 맞춤형 연습문제를 3개 생성하라. 문제 유형은 단답형, 객관식, 시나리오 기반 주관식을 포함해야 하며, 모든 문제에 상세한 해설을 덧붙여라.` },
            { key: '2_flashcards', title: '핵심 어휘 플래시카드 생성 (어학)', category: '적용과 연습', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드 내용에서 핵심 어휘와 그 의미를 추출하여, "단어: 의미" 형식의 플래시카드 목록을 10개 생성하라.` },
            { key: '2_case_study', title: '실제 사례 분석 (IRAC/SWOT)', category: '적용과 연습', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드에 제시된 '[사례명]' 사례를 바탕으로, [분석 프레임워크 (예: IRAC, SWOT)] 원칙에 따라 법률적 또는 경영학적 분석을 수행하라.`},
            { key: '2_problem_solving', title: '공학 문제 해결 절차 분석', category: '적용과 연습', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드에 제시된 공학적 문제 '[문제 설명]'을(를) 해결하기 위한 단계별 절차를 명확하게 제시하고, 각 단계에서 사용되는 원리나 공식을 설명하라.`},
            { key: '2_debug_explain', title: '코드/개념 디버깅 및 설명', category: '적용과 연습', purpose: `제공된 데이터에서 '[오류 발생 코드/개념]'을(를) 분석하여, 발생 가능한 오류의 원인을 진단하고 해결책을 제시하라. 또한, 해당 코드/개념의 작동 방식을 비전문가도 이해할 수 있도록 명확하게 설명하라.`},
            { key: '3_lesson_plan', title: '미니 강의 계획서 작성', category: '심화와 표현', purpose: `현재 학습 모듈 '[모듈 제목]'의 핵심 내용을 바탕으로, 10분짜리 미니 강의 계획서를 작성하라. 강의 목표, 주요 내용, 예시, 질의응답 시간을 포함해야 한다.`},
            { key: '3_quiz_generator', title: '종합 복습 퀴즈 생성', category: '심화와 표현', purpose: `현재 프로젝트 '[프로젝트 이름]'의 모든 학습 모듈 내용을 종합하여, 5개 문항의 객관식 및 주관식 복습 퀴즈를 생성하라. 각 문항에는 정답과 상세 해설을 포함하라.`},
            { key: '3_essay_prompts', title: '논술형 질문 생성', category: '심화와 표현', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드 내용을 기반으로, 비판적 사고를 유도하는 3가지 논술형 질문을 생성하라. 각 질문에는 답변에 포함될 핵심 요소에 대한 가이드를 포함하라.`}
        ];

        document.addEventListener('DOMContentLoaded', () => {
            // --- App State ---
            const App = {
                db: { projects: {}, activeProjectId: null, currentUser: null, activeModuleIndex: null, activeLessonIndex: null }, // Added activeModuleIndex and activeLessonIndex
                bs: {},
                dom: {},
                state: { saveTimeout: null, currentModuleIndexForViewer: null, scrollPositions: {} },
            };

            // --- 1. Initialization ---
            function initApp() {
                cacheDOMElements();
                initBootstrap();
                loadDb(); // Load local UI state and activeProjectId
                // Firebase auth state listener will handle loading user projects
                registerEventListeners();
                console.log("ILE App v9.0 Initialized");
            }
            
            function cacheDOMElements() {
                App.dom.sidebar = document.getElementById('sidebar');
                App.dom.overlay = document.getElementById('overlay');
                App.dom.projectList = document.getElementById('project-list');
                App.dom.resourceList = document.getElementById('resource-list');
                App.dom.welcomeScreen = document.getElementById('welcome-screen');
                App.dom.projectWorkspace = document.getElementById('project-workspace');
                App.dom.learningDashboard = document.getElementById('learning-dashboard');
                App.dom.planInput = document.getElementById('plan-input');
                App.dom.projectTitleMain = document.getElementById('project-title-main');
                App.dom.projectTitleMobile = document.getElementById('project-title-mobile');
                App.dom.projectGoal = document.getElementById('project-goal');
                App.dom.planButton = document.getElementById('plan-button');
                App.dom.actionListContainer = document.getElementById('action-list-container');
                App.dom.actionSelectorBody = document.getElementById('action-selector-body');
                App.dom.promptModalLabel = document.getElementById('promptModalLabel');
                App.dom.dynamicFormContainer = document.getElementById('dynamic-form-container');
                App.dom.dataSelector = document.getElementById('data-selector');
                App.dom.livePreviewContainer = document.getElementById('live-preview-container');
                App.dom.studyPadViewerModal = document.getElementById('studyPadViewerModal');
                App.dom.studyPadViewerContent = document.getElementById('study-pad-viewer-content');
                App.dom.studyPadEditorContent = document.getElementById('study-pad-editor-content');
                App.dom.studyPadViewerTitle = document.getElementById('studyPadViewerTitle');
                App.dom.toggleViewerModeBtn = document.getElementById('toggle-viewer-mode-btn');
                App.dom.saveViewerContentBtn = document.getElementById('save-viewer-content-btn');
                App.dom.overallProgressBar = document.getElementById('overall-progress-bar');
                App.dom.completedModulesCount = document.getElementById('completed-modules-count');
                App.dom.inprogressModulesCount = document.getElementById('inprogress-modules-count');
                App.dom.pendingModulesCount = document.getElementById('pending-modules-count');
                App.dom.moduleStatusChart = document.getElementById('module-status-chart');
                App.chart = null;
                App.dom.authStatus = document.getElementById('auth-status');
                App.dom.googleSigninBtn = document.getElementById('google-signin-btn');
                App.dom.signOutBtn = document.getElementById('signout-btn');
                App.dom.detailViewerModal = document.getElementById('detailViewerModal');
                App.dom.detailViewerTitle = document.getElementById('detailViewerTitle');
                App.dom.detailViewerBody = document.getElementById('detailViewerBody');
                // New elements for lecture detail modal
                App.dom.lectureDetailModal = document.getElementById('lectureDetailModal');
                App.dom.lectureDetailTitle = document.getElementById('lectureDetailTitle');
                App.dom.moduleProgressNav = document.getElementById('module-progress-nav');
                App.dom.lessonList = document.getElementById('lesson-list');
                App.dom.lessonContentTitle = document.getElementById('lesson-content-title');
                App.dom.lessonContentViewer = document.getElementById('lesson-content-viewer');
                App.dom.lessonStudypadInput = document.getElementById('lesson-studypad-input');
                App.dom.lessonPrevBtn = document.getElementById('lesson-prev-btn');
                App.dom.lessonNextBtn = document.getElementById('lesson-next-btn');
                App.dom.lessonStatusInfo = document.getElementById('lesson-status-info');
            }

            function initBootstrap() {
                App.bs.toast = new bootstrap.Toast(document.getElementById('liveToast'));
                App.bs.resourceModal = new bootstrap.Modal(document.getElementById('resourceModal'));
                App.bs.promptModal = new bootstrap.Modal(document.getElementById('promptModal'));
                App.bs.actionManagerModal = new bootstrap.Modal(document.getElementById('actionManagerModal'));
                App.bs.actionEditorModal = new bootstrap.Modal(document.getElementById('actionEditorModal'));
                App.bs.actionSelectorModal = new bootstrap.Modal(document.getElementById('actionSelectorModal'));
                App.bs.newProjectModal = new bootstrap.Modal(document.getElementById('newProjectModal'));
                App.bs.studyPadViewerModal = new bootstrap.Modal(App.dom.studyPadViewerModal);
                App.bs.detailViewerModal = new bootstrap.Modal(App.dom.detailViewerModal);
                // Initialize new modal
                App.bs.lectureDetailModal = new bootstrap.Modal(App.dom.lectureDetailModal);
            }
            
            // --- Firebase Auth Functions ---
            async function signInWithGoogle() {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                    showToast("환영합니다!", "성공적으로 로그인되었습니다.", "success");
                } catch (error) {
                    console.error("Google 로그인 실패:", error);
                    showToast("로그인 실패", "Google 로그인 중 오류가 발생했습니다: " + error.message, "danger");
                }
            }

            async function signOutUser() {
                try {
                    await signOut(auth);
                    showToast("안녕히 가세요!", "로그아웃되었습니다.", "info");
                } catch (error) {
                    console.error("로그아웃 실패:", error);
                    showToast("로그아웃 실패", "로그아웃 중 오류가 발생했습니다: " + error.message, "danger");
                }
            }

            // Listen for authentication state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    App.dom.authStatus.textContent = `${user.displayName}님 환영합니다!`;
                    App.dom.googleSigninBtn.classList.add('d-none');
                    App.dom.signOutBtn.classList.remove('d-none');
                    App.db.currentUser = {
                        uid: user.uid,
                        displayName: user.displayName,
                        email: user.email
                    };
                    await loadUserProjectsFromFirestore(user.uid);
                    render();
                    showToast("로그인됨", `${user.displayName}님 환영합니다!`, "info");
                } else {
                    App.dom.authStatus.textContent = "로그인이 필요합니다.";
                    App.dom.googleSigninBtn.classList.remove('d-none');
                    App.dom.signOutBtn.classList.add('d-none');
                    App.db.currentUser = null;
                    App.db.activeProjectId = null;
                    App.db.projects = {};
                    saveDb();
                    render();
                    showToast("로그아웃됨", "로그인하여 프로젝트를 관리하세요.", "info");
                }
            });

            // --- Firestore Data Management Functions ---
            async function loadUserProjectsFromFirestore(userId) {
                App.db.projects = {};
                try {
                    const projectsColRef = collection(db, `users/${userId}/projects`);
                    const q = query(projectsColRef);
                    const querySnapshot = await getDocs(q);

                    querySnapshot.forEach((doc) => {
                        const projectData = doc.data();
                        App.db.projects[doc.id] = { id: doc.id, ...projectData };
                        if (!App.db.projects[doc.id].actions || App.db.projects[doc.id].actions.length === 0) {
                            App.db.projects[doc.id].actions = JSON.parse(JSON.stringify(DEFAULT_ACTIONS));
                        } else {
                            DEFAULT_ACTIONS.forEach(defaultAction => {
                                if (!App.db.projects[doc.id].actions.some(a => a.key === defaultAction.key)) {
                                    App.db.projects[doc.id].actions.push(defaultAction);
                                }
                            });
                        }
                    });

                    if (App.db.activeProjectId && App.db.projects[App.db.activeProjectId]) {
                        // Active project already set, keep it
                    } else if (Object.keys(App.db.projects).length > 0) {
                        App.db.activeProjectId = Object.keys(App.db.projects)[0];
                    } else {
                        App.db.activeProjectId = null;
                    }
                    console.log("Firebase에서 프로젝트 로드 완료");
                } catch (e) {
                    console.error("Firebase에서 프로젝트 로드 실패:", e);
                    showToast("데이터 로드 오류", "프로젝트를 불러오지 못했습니다.", "danger");
                }
            }

            async function saveProjectToFirestore(project) {
                if (!App.db.currentUser?.uid) {
                    showToast("오류", "로그인이 필요합니다.", "danger");
                    return false;
                }
                try {
                    const projectRef = doc(db, `users/${App.db.currentUser.uid}/projects`, project.id);
                    await setDoc(projectRef, project);
                    console.log(`프로젝트 '${project.name}' Firebase에 저장됨`);
                    return true;
                } catch (e) {
                    console.error("Firebase에 프로젝트 저장 실패:", e);
                    showToast("저장 실패", "프로젝트를 저장하지 못했습니다.", "danger");
                    return false;
                }
            }

            async function deleteProjectFromFirestore(projectId) {
                if (!App.db.currentUser?.uid) {
                    showToast("오류", "로그인이 필요합니다.", "danger");
                    return false;
                }
                try {
                    const projectRef = doc(db, `users/${App.db.currentUser.uid}/projects`, projectId);
                    await deleteDoc(projectRef);
                    console.log(`프로젝트 '${projectId}' Firebase에서 삭제됨`);
                    return true;
                } catch (e) {
                    console.error("Firebase에서 프로젝트 삭제 실패:", e);
                    showToast("삭제 실패", "프로젝트를 삭제하지 못했습니다.", "danger");
                    return false;
                }
            }

            // --- 2. Data Management (Local UI State) ---
            function saveDb() {
                try {
                    const localData = {
                        activeProjectId: App.db.activeProjectId,
                        scrollPositions: App.state.scrollPositions
                    };
                    localStorage.setItem('ile_local_ui_state', JSON.stringify(localData));
                } catch (e) {
                    console.error("로컬 UI 상태 저장 실패:", e);
                    showToast("오류", "로컬 설정 저장에 실패했습니다.", "danger");
                }
            }

            function loadDb() {
                try {
                    const stored = localStorage.getItem('ile_local_ui_state');
                    if (stored) {
                        const localData = JSON.parse(stored);
                        App.db.activeProjectId = localData.activeProjectId || null;
                        App.state.scrollPositions = localData.scrollPositions || {};
                    }
                } catch (e) {
                    console.error("로컬 UI 상태 불러오기 실패:", e);
                    App.db.activeProjectId = null;
                    App.state.scrollPositions = {};
                    showToast("경고", "로컬 설정을 불러오는 중 오류가 발생하여 초기화합니다.", "warning");
                }
            }

            function showToast(title, body, type = 'info') {
                const toastEl = document.getElementById('liveToast');
                if (!toastEl) return;
                toastEl.style.borderColor = `var(--${type}-color, var(--border-color))`;
                document.getElementById('toast-title').textContent = title;
                document.getElementById('toast-body').textContent = body;
                App.bs.toast.show();
            }

            // --- 3. UI Rendering ---
            function render() {
                renderProjectList();
                renderWorkspace();
            }

            function renderProjectList() {
                const listEl = App.dom.projectList;
                if (!listEl) return;
                listEl.innerHTML = '';

                if (!App.db.currentUser) {
                    listEl.innerHTML = `<p class="small text-secondary px-2 py-2">로그인 후 프로젝트를 이용할 수 있습니다.</p>`;
                    return;
                }

                const projectIds = Object.keys(App.db.projects);

                if (projectIds.length === 0) {
                    listEl.innerHTML = `<p class="small text-secondary px-2 py-2">프로젝트가 없습니다.</p>`;
                    return;
                }

                projectIds.forEach(id => {
                    const p = App.db.projects[id];
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = `list-group-item list-group-item-action d-flex justify-content-between align-items-center ${p.id === App.db.activeProjectId ? 'active' : ''}`;
                    item.dataset.projectId = p.id;
                    item.innerHTML = `
                        <span class="text-truncate" style="max-width: 85%;">${p.name}</span>
                        <i class="fa-solid fa-trash-can text-secondary small delete-btn" title="프로젝트 삭제"></i>
                    `;
                    listEl.appendChild(item);
                });
            }
            
            function renderWorkspace() {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project) {
                    App.dom.welcomeScreen?.classList.remove('d-none');
                    App.dom.projectWorkspace?.classList.add('d-none');
                    if (App.dom.projectTitleMobile) App.dom.projectTitleMobile.textContent = "ILE v9.0";
                    return;
                }

                App.dom.welcomeScreen?.classList.add('d-none');
                App.dom.projectWorkspace?.classList.remove('d-none');
                
                App.dom.projectTitleMain.textContent = project.name;
                App.dom.projectTitleMobile.textContent = project.name;
                App.dom.projectGoal.textContent = project.goal;
                App.dom.planInput.value = project.learningPlan ? JSON.stringify(project.learningPlan, null, 2) : '';
                
                renderResourceList();
                renderLearningDashboard();
            }

            function renderResourceList() {
                const listEl = App.dom.resourceList;
                if (!listEl) return;
                listEl.innerHTML = '';
                const project = App.db.projects[App.db.activeProjectId];
                
                if (!project?.resources?.length) {
                    listEl.innerHTML = `<p class="small text-secondary px-2">자원이 없습니다.</p>`;
                    return;
                }

                project.resources.forEach(r => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    item.dataset.resourceId = r.id;
                    item.style.cursor = 'pointer';
                    item.innerHTML = `
                        <span class="text-truncate" style="max-width: 85%;">${r.name}</span>
                        <i class="fa-solid fa-times text-secondary small delete-btn" title="자원 삭제" style="cursor: pointer;"></i>
                    `;
                    listEl.appendChild(item);
                });
            }
            
            function renderLearningDashboard() {
                const dashboard = App.dom.learningDashboard;
                if (!dashboard) return;
                const project = App.db.projects[App.db.activeProjectId];
                const plan = project?.learningPlan;

                if (!plan?.modules?.length) {
                    dashboard.innerHTML = '<p class="text-secondary text-center small col-12">학습 계획을 먼저 적용해주세요.</p>';
                    return;
                }

                dashboard.innerHTML = '';
                plan.modules.forEach((module, index) => {
                    const card = document.createElement('div');
                    card.className = `module-card status-${module.status || 'pending'}`;
                    card.dataset.moduleIndex = index;

                    const learningObjectivesText = (module.learningObjectives || []).join(', ');
                    const displayLearningObjectives = `<b>학습 목표:</b> <span class="learning-objectives-preview">${learningObjectivesText || '없음'}</span>`;
                    const viewObjectivesButton = learningObjectivesText.length > 50 ?
                        `<button class="btn btn-link btn-sm p-0 d-block mt-1 view-details-btn" data-detail-type="learning-objectives" data-module-index="${index}">자세히 보기</button>` : '';

                    card.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 text-truncate">${module.title}</h6>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle py-0 px-2" type="button" data-bs-toggle="dropdown">상태</button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item status-change-btn" href="#" data-status="pending">대기</a></li>
                                    <li><a class="dropdown-item status-change-btn" href="#" data-status="inprogress">진행 중</a></li>
                                    <li><a class="dropdown-item status-change-btn" href="#" data-status="completed">완료</a></li>
                                </ul>
                            </div>
                        </div>
                        <p class="small text-secondary mb-2"><b>핵심 개념:</b> ${(module.keyConcepts || []).join(', ')}</p>
                        <p class="small mb-3">${displayLearningObjectives}${viewObjectivesButton}</p>
                        ${module.recommendedResources && module.recommendedResources.length > 0 ?
                            `<p class="small text-primary mb-3"><b>추천 리소스:</b> ${module.recommendedResources.join(', ')}</p>` : ''
                        }
                        <button class="btn btn-sm btn-primary w-100 open-module-detail-btn" data-module-index="${index}"><i class="fa-solid fa-book-open me-2"></i>모듈 시작/자세히 보기</button>
                    `;
                    dashboard.appendChild(card);
                });

                // Calculate progress and update stats
                const totalModules = plan.modules.length;
                const completedModules = plan.modules.filter(m => m.status === 'completed').length;
                const inprogressModules = plan.modules.filter(m => m.status === 'inprogress').length;
                const pendingModules = totalModules - completedModules - inprogressModules;

                const completionPercentage = totalModules > 0 ? Math.round((completedModules / totalModules) * 100) : 0;

                let progressBarColor = 'var(--text-secondary)';
                if (completionPercentage > 0 && completionPercentage < 100) {
                    progressBarColor = 'var(--warning-color)';
                } else if (completionPercentage === 100) {
                    progressBarColor = 'var(--success-color)';
                }
                App.dom.overallProgressBar.style.width = `${completionPercentage}%`;
                App.dom.overallProgressBar.setAttribute('aria-valuenow', completionPercentage);
                App.dom.overallProgressBar.textContent = `${completionPercentage}%`;
                App.dom.overallProgressBar.style.backgroundColor = progressBarColor;


                App.dom.completedModulesCount.textContent = completedModules;
                App.dom.inprogressModulesCount.textContent = inprogressModules;
                App.dom.pendingModulesCount.textContent = pendingModules;

                if (App.chart) {
                    App.chart.destroy();
                }
                if (totalModules > 0 && App.dom.moduleStatusChart) {
                    const ctx = App.dom.moduleStatusChart.getContext('2d');
                    const successColor = '#34A853';
                    const warningColor = '#FBBC04';
                    const secondaryTextColor = '#5F6368';
                    const primaryTextColor = '#3C4043';

                    App.chart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['완료', '진행 중', '대기'],
                            datasets: [{
                                data: [completedModules, inprogressModules, pendingModules],
                                backgroundColor: [
                                    successColor,
                                    warningColor,
                                    secondaryTextColor
                                ],
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: {
                                        color: primaryTextColor,
                                    }
                                },
                                title: {
                                    display: true,
                                    text: '모듈 상태 분석',
                                    color: primaryTextColor,
                                }
                            }
                        }
                    });
                }
            }

            function renderActionSelector(moduleIndex) {
                const body = App.dom.actionSelectorBody;
                const project = App.db.projects[App.db.activeProjectId];
                const actions = project?.actions && project.actions.length > 0 ? project.actions : DEFAULT_ACTIONS;

                const groupedActions = actions.reduce((acc, action) => {
                    if (action.key === '0_plan') return acc;
                    const category = action.category || '기타';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(action);
                    return acc;
                }, {});

                body.innerHTML = '';
                for (const category of Object.keys(groupedActions).sort()) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'action-category mb-4';
                    categoryDiv.innerHTML = `<h6 class="mb-3">${category}</h6>`;
                    const actionGrid = document.createElement('div');
                    actionGrid.className = 'd-grid gap-2';
                    groupedActions[category].forEach(action => {
                        const button = document.createElement('button');
                        button.className = 'btn btn-outline-light text-start build-prompt-btn';
                        button.dataset.templateKey = action.key;
                        button.dataset.moduleIndex = moduleIndex;
                        button.textContent = action.title;
                        actionGrid.appendChild(button);
                    });
                    categoryDiv.appendChild(actionGrid);
                    body.appendChild(categoryDiv);
                }
                App.bs.actionSelectorModal.show();
            }

            function renderActionManager() {
                const container = App.dom.actionListContainer;
                if (!container) return;
                const project = App.db.projects[App.db.activeProjectId];
                const actions = project?.actions && project.actions.length > 0 ? project.actions : DEFAULT_ACTIONS;

                container.innerHTML = actions.map(action => {
                    if(action.key === '0_plan') return '';
                    return `
                    <div class="p-3 rounded mb-2 d-flex justify-content-between align-items-center action-list-item">
                        <div>
                            <h6 class="mb-0">${action.title}</h6>
                            <small class="text-secondary">${action.category} / Key: ${action.key}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-light edit-action-btn" data-action-key="${action.key}"><i class="fa-solid fa-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger delete-action-btn" data-action-key="${action.key}"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>`;
                }).join('');
            }

            // New: Lesson Detail UI Renderer
            function renderLessonDetail(moduleIndex, lessonIndex) {
                const project = App.db.projects[App.db.activeProjectId];
                const module = project.learningPlan.modules[moduleIndex];
                const lesson = module.lessons[lessonIndex];
                
                App.db.activeModuleIndex = moduleIndex;
                App.db.activeLessonIndex = lessonIndex;
                
                // Update header
                App.dom.lectureDetailTitle.textContent = `${module.title}`;
                App.dom.currentModuleTitle.textContent = `현재 모듈: ${module.title}`;
                
                // Update lesson content
                App.dom.lessonContentTitle.textContent = lesson.title;
                App.dom.lessonContentViewer.innerHTML = marked.parse(lesson.content || '내용이 없습니다.');
                App.dom.lessonStudypadInput.value = lesson.studyPad || '';
                
                // Update lesson status badge
                const statusBadge = App.dom.lessonStatusInfo;
                statusBadge.textContent = `상태: ${getKoreanStatus(lesson.status)}`;
                statusBadge.className = `badge ${getBootstrapStatusClass(lesson.status)}`;
                
                // Update progress panel
                renderEdxProgressPanel(project.learningPlan.modules, moduleIndex);

                // Update lesson list
                renderLessonList(module.lessons, lessonIndex);
                
                // Update navigation buttons
                App.dom.lessonPrevBtn.disabled = lessonIndex === 0;
                App.dom.lessonNextBtn.disabled = lessonIndex === module.lessons.length - 1;

                // Call MathJax to render equations after content is set
                if (typeof MathJax !== 'undefined') {
                    MathJax.typesetPromise([App.dom.lessonContentViewer]).catch((err) => console.error('MathJax rendering failed:', err));
                }
            }

            function renderEdxProgressPanel(modules, activeModuleIndex) {
                const navPanel = App.dom.moduleProgressNav;
                navPanel.innerHTML = '';
                modules.forEach((mod, index) => {
                    const item = document.createElement('div');
                    item.className = `module-nav-item ${index == activeModuleIndex ? 'active' : ''} ${mod.status === 'completed' ? 'completed' : ''}`;
                    item.dataset.moduleIndex = index;
                    item.innerHTML = `
                        <span class="module-circle">${index + 1}</span>
                        <span class="module-title">${mod.title}</span>
                    `;
                    navPanel.appendChild(item);
                });
            }

            function renderLessonList(lessons, activeLessonIndex) {
                const listEl = App.dom.lessonList;
                listEl.innerHTML = '';
                lessons.forEach((lesson, index) => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = `list-group-item list-group-item-action lesson-list-item ${index === activeLessonIndex ? 'active' : ''} ${lesson.status === 'completed' ? 'completed' : ''}`;
                    item.dataset.lessonIndex = index;
                    item.innerHTML = `
                        <i class="fa-solid ${lesson.status === 'completed' ? 'fa-check-circle' : 'fa-circle-dot'} me-2"></i>
                        ${lesson.title}
                    `;
                    listEl.appendChild(item);
                });
            }

            function getKoreanStatus(status) {
                switch(status) {
                    case 'completed': return '완료';
                    case 'inprogress': return '진행 중';
                    default: return '대기';
                }
            }
            function getBootstrapStatusClass(status) {
                switch(status) {
                    case 'completed': return 'bg-success';
                    case 'inprogress': return 'bg-warning text-dark';
                    default: return 'bg-secondary';
                }
            }
            
            // Module Management
            function updateModuleField(index, field, value) {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project?.learningPlan?.modules[index]) return;

                project.learningPlan.modules[index][field] = value;
                clearTimeout(App.state.saveTimeout);
                App.state.saveTimeout = setTimeout(() => {
                    saveProjectToFirestore(project);
                    renderLearningDashboard();
                }, 1000);
            }

            // New: Update Lesson Field
            function updateLessonField(moduleIndex, lessonIndex, field, value) {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project?.learningPlan?.modules[moduleIndex]?.lessons[lessonIndex]) return;
                
                project.learningPlan.modules[moduleIndex].lessons[lessonIndex][field] = value;
                clearTimeout(App.state.saveTimeout);
                App.state.saveTimeout = setTimeout(() => {
                    saveProjectToFirestore(project);
                    renderLearningDashboard();
                    // Re-render lesson list to update status icons
                    renderLessonList(project.learningPlan.modules[moduleIndex].lessons, lessonIndex);
                }, 1000);
            }
            
            // Action (Prompt Template) Management
            function openActionEditor(actionKey = null) {
                const form = document.getElementById('action-editor-form');
                if (!form) return;
                form.reset();
                const project = App.db.projects[App.db.activeProjectId];
                const action = actionKey ? project?.actions.find(a => a.key === actionKey) : null;
                
                document.getElementById('actionEditorTitle').textContent = action ? '액션 편집' : '새 액션 추가';
                document.getElementById('action-key-input').value = action ? action.key : `custom_${Date.now()}`;
                if (action) {
                    document.getElementById('action-title-input').value = action.title;
                    document.getElementById('action-category-input').value = action.category;
                    document.getElementById('action-purpose-input').value = action.purpose;
                }
                App.bs.actionEditorModal.show();
            }

            async function saveAction() {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project) return;
                if (!App.db.currentUser?.uid) {
                    showToast("오류", "로그인이 필요합니다.", "danger");
                    return;
                }

                const key = document.getElementById('action-key-input').value;
                const updatedAction = {
                    key: key,
                    title: document.getElementById('action-title-input').value.trim(),
                    category: document.getElementById('action-category-input').value.trim(),
                    purpose: document.getElementById('action-purpose-input').value,
                };
                if (!updatedAction.title || !updatedAction.category || !updatedAction.purpose) {
                    return showToast('오류', '모든 필드를 입력해야 합니다.', 'danger');
                }
                
                if (!project.actions) project.actions = [];
                const existingIndex = project.actions.findIndex(a => a.key === key);
                if (existingIndex > -1) {
                    project.actions[existingIndex] = updatedAction;
                } else {
                    project.actions.push(updatedAction);
                }
                
                const success = await saveProjectToFirestore(project);
                if (success) {
                    renderActionManager();
                    App.bs.actionEditorModal.hide();
                    showToast('성공', '액션이 저장되었습니다.', 'success');
                }
            }

            async function deleteAction(actionKey) {
                if (!App.db.currentUser?.uid) {
                    showToast("오류", "로그인이 필요합니다.", "danger");
                    return;
                }
                if (!window.confirm('이 액션을 정말 삭제하시겠습니까?')) {
                    return;
                }

                const project = App.db.projects[App.db.activeProjectId];
                if (!project?.actions) return;
                project.actions = project.actions.filter(a => a.key !== actionKey);
                
                const success = await saveProjectToFirestore(project);
                if (success) {
                    renderActionManager();
                    showToast('성공', '액션이 삭제되었습니다.', 'success');
                }
            }

            function downloadAllStudyPads() {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project || !project.learningPlan?.modules?.length) {
                    return showToast("정보", "다운로드할 스터디 패드 내용이 없습니다.", "info");
                }

                let combinedContent = `# ${project.name}\n\n`;
                combinedContent += `## 최종 학습 목표\n${project.goal || '없음'}\n\n`;
                combinedContent += `---\n\n`;

                project.learningPlan.modules.forEach((module, index) => {
                    combinedContent += `## 모듈 ${index + 1}: ${module.title}\n\n`;
                    combinedContent += `### 핵심 개념: ${(module.keyConcepts || []).join(', ')}\n\n`;
                    combinedContent += `### 학습 목표: ${(module.learningObjectives || []).join(', ')}\n\n`;
                    if (module.recommendedResources && module.recommendedResources.length > 0) {
                        combinedContent += `### 추천 리소스: ${module.recommendedResources.join(', ')}\n\n`;
                    }
                    if (module.lessons && module.lessons.length > 0) {
                        module.lessons.forEach((lesson, lessonIndex) => {
                            combinedContent += `#### 레슨 ${index + 1}.${lessonIndex + 1}: ${lesson.title}\n\n`;
                            combinedContent += `##### 스터디 패드\n\n`;
                            combinedContent += `${lesson.studyPad || '작성된 내용 없음.'}\n\n`;
                        });
                    }
                    combinedContent += `---\n\n`;
                });

                const blob = new Blob([combinedContent], { type: 'text/markdown;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const safeFileName = project.name.replace(/[/\\?%*:|"<>]/g, '-') || 'study-pads';
                a.href = url;
                a.download = `${safeFileName}_study_pads.md`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 100);
                showToast("성공", "스터디 패드 내용이 다운로드되었습니다.", "success");
            }

            function openStudyPadViewer(moduleIndex) {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project || !project.learningPlan?.modules[moduleIndex]) {
                    return showToast("오류", "모듈을 찾을 수 없습니다.", "danger");
                }
                const module = project.learningPlan.modules[moduleIndex];
                
                App.state.currentModuleIndexForViewer = moduleIndex;
                
                App.dom.studyPadViewerContent.classList.remove('d-none');
                App.dom.studyPadEditorContent.classList.add('d-none');
                App.dom.toggleViewerModeBtn.textContent = '편집 모드';
                App.dom.saveViewerContentBtn.classList.add('d-none');

                App.dom.studyPadViewerTitle.textContent = `${module.title} 스터디 패드`;
                App.dom.studyPadViewerContent.innerHTML = marked.parse(module.studyPad || '내용이 없습니다.');
                App.dom.studyPadEditorContent.value = module.studyPad || '';
                
                App.bs.studyPadViewerModal.show();

                App.dom.studyPadViewerModal.addEventListener('shown.bs.modal', function handler() {
                    const savedScroll = App.state.scrollPositions[`module_${moduleIndex}`];
                    if (savedScroll !== undefined) {
                        App.dom.studyPadViewerContent.scrollTop = savedScroll;
                        App.dom.studyPadEditorContent.scrollTop = savedScroll;
                    }
                    App.dom.studyPadViewerModal.removeEventListener('shown.bs.modal', handler);
                });

                if (typeof MathJax !== 'undefined') {
                    MathJax.typesetPromise([App.dom.studyPadViewerContent]).catch((err) => console.error('MathJax rendering failed:', err));
                }
            }

            function toggleStudyPadViewerMode() {
                const moduleIndex = App.state.currentModuleIndexForViewer;
                const isEditing = App.dom.studyPadViewerContent.classList.contains('d-none');

                const currentScroll = isEditing ? App.dom.studyPadEditorContent.scrollTop : App.dom.studyPadViewerContent.scrollTop;
                App.state.scrollPositions[`module_${moduleIndex}`] = currentScroll;
                saveDb();

                if (!isEditing) {
                    App.dom.studyPadViewerContent.classList.add('d-none');
                    App.dom.studyPadEditorContent.classList.remove('d-none');
                    App.dom.toggleViewerModeBtn.textContent = '뷰어 모드';
                    App.dom.saveViewerContentBtn.classList.remove('d-none');
                    App.dom.studyPadEditorContent.focus();
                    App.dom.studyPadEditorContent.scrollTop = currentScroll;
                } else {
                    App.dom.studyPadViewerContent.innerHTML = marked.parse(App.dom.studyPadEditorContent.value);
                    
                    if (typeof MathJax !== 'undefined') {
                        MathJax.typesetPromise([App.dom.studyPadViewerContent]).catch((err) => console.error('MathJax rendering failed:', err));
                    }

                    App.dom.studyPadViewerContent.classList.remove('d-none');
                    App.dom.studyPadEditorContent.classList.add('d-none');
                    App.dom.toggleViewerModeBtn.textContent = '편집 모드';
                    App.dom.saveViewerContentBtn.classList.add('d-none');
                    App.dom.studyPadViewerContent.scrollTop = currentScroll;
                }
            }

            function saveStudyPadViewerContent() {
                const moduleIndex = App.state.currentModuleIndexForViewer;
                if (moduleIndex === null) {
                    showToast("오류", "저장할 모듈을 찾을 수 없습니다.", "danger");
                    return;
                }
                const newStudyPadContent = App.dom.studyPadEditorContent.value;
                updateModuleField(moduleIndex, 'studyPad', newStudyPadContent);
                showToast("성공", "스터디 패드 내용이 저장되었습니다.", "success");
                toggleStudyPadViewerMode();
            }

            function openDetailViewer(moduleIndex, type) {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project || !project.learningPlan?.modules[moduleIndex]) {
                    return showToast("오류", "모듈을 찾을 수 없습니다.", "danger");
                }
                const module = project.learningPlan.modules[moduleIndex];
                let title = '';
                let content = '';

                if (type === 'learning-objectives') {
                    title = `${module.title} 학습 목표`;
                    content = (module.learningObjectives || []).join('\n- ');
                    content = `- ${content}`;
                }
                App.dom.detailViewerTitle.textContent = title;
                App.dom.detailViewerBody.innerHTML = `<pre class="detail-modal-content">${content}</pre>`;
                App.bs.detailViewerModal.show();
            }

            // --- 5. Event Listeners & Handlers ---
            function registerEventListeners() {
                // Static buttons
                App.dom.googleSigninBtn?.addEventListener('click', signInWithGoogle);
                App.dom.signOutBtn?.addEventListener('click', signOutUser);
                document.getElementById('new-project-btn')?.addEventListener('click', handleNewProjectClick);
                document.getElementById('save-project-btn')?.addEventListener('click', handleSaveProjectClick);
                document.getElementById('import-project-btn')?.addEventListener('click', () => document.getElementById('import-file-input')?.click());
                document.getElementById('import-file-input')?.addEventListener('change', handleImportProjectFile);
                document.getElementById('export-project-btn')?.addEventListener('click', handleExportProjectClick);
                document.getElementById('add-resource-btn')?.addEventListener('click', handleAddResourceClick);
                document.getElementById('save-resource-btn')?.addEventListener('click', handleSaveResourceClick);
                document.getElementById('resource-file-input')?.addEventListener('change', handleResourceFileChange);
                document.getElementById('apply-plan-btn')?.addEventListener('click', handleApplyPlanClick);
                document.getElementById('manage-actions-btn')?.addEventListener('click', handleManageActionsClick);
                document.getElementById('add-new-action-btn')?.addEventListener('click', () => openActionEditor());
                document.getElementById('save-action-btn')?.addEventListener('click', saveAction);
                document.getElementById('execute-prompt-btn')?.addEventListener('click', handleExecutePromptClick);
                document.getElementById('download-studypad-btn')?.addEventListener('click', downloadAllStudyPads);
                App.dom.planButton?.addEventListener('click', () => handleBuildPrompt('0_plan', null));
                App.dom.toggleViewerModeBtn?.addEventListener('click', toggleStudyPadViewerMode);
                App.dom.saveViewerContentBtn?.addEventListener('click', saveStudyPadViewerContent);
                App.dom.lessonPrevBtn?.addEventListener('click', handleLessonNavClick);
                App.dom.lessonNextBtn?.addEventListener('click', handleLessonNavClick);
                
                // Event Delegation for dynamic content
                App.dom.projectList?.addEventListener('click', handleProjectListClick);
                App.dom.resourceList?.addEventListener('click', handleResourceListClick);
                App.dom.learningDashboard?.addEventListener('click', handleDashboardClick);
                App.dom.learningDashboard?.addEventListener('input', handleDashboardInput);
                App.dom.actionListContainer?.addEventListener('click', handleActionManagerClick);
                App.dom.actionSelectorBody?.addEventListener('click', handleActionSelectorClick);
                
                // New event delegation for lesson view modal
                App.dom.lectureDetailModal?.addEventListener('click', handleLectureDetailClick);
                App.dom.lessonStudypadInput?.addEventListener('input', handleLessonInput);

                // Mobile UI
                document.getElementById('hamburger-btn')?.addEventListener('click', toggleSidebar);
                App.dom.overlay?.addEventListener('click', toggleSidebar);
            }

            // Specific Click Handlers
            function handleNewProjectClick() {
                document.getElementById('new-project-form').reset();
                App.bs.newProjectModal.show();
            }

            function handleSaveProjectClick() {
                const nameInput = document.getElementById('new-project-name');
                const goalInput = document.getElementById('new-project-goal');
                if (nameInput.value.trim() && goalInput.value.trim()) {
                    createNewProject(nameInput.value, goalInput.value);
                    App.bs.newProjectModal.hide();
                } else {
                    showToast('오류', '프로젝트 이름과 목표를 모두 입력해야 합니다.', 'danger');
                }
            }
            
            async function handleImportProjectFile(e) {
                const file = e.target.files[0];
                if (!file) return;
                if (!App.db.currentUser?.uid) return showToast("오류", "로그인이 필요합니다.", "danger");

                try {
                    const jsonText = await readFileAsText(file);
                    const importedProject = JSON.parse(jsonText);
                    if (importedProject.id && importedProject.name) {
                        App.db.projects[importedProject.id] = importedProject;
                        if (!importedProject.actions || importedProject.actions.length === 0) {
                            importedProject.actions = JSON.parse(JSON.stringify(DEFAULT_ACTIONS));
                        } else {
                            DEFAULT_ACTIONS.forEach(defaultAction => {
                                if (!importedProject.actions.some(a => a.key === defaultAction.key)) {
                                    importedProject.actions.push(defaultAction);
                                }
                            });
                        }
                        const success = await saveProjectToFirestore(importedProject);
                        if (success) {
                            switchActiveProject(importedProject.id);
                            showToast("성공", "프로젝트를 성공적으로 가져왔습니다.", "success");
                        }
                    } else { throw new Error("파일에 'id'와 'name' 속성이 없습니다."); }
                }
                catch (err) {
                    let errorMessage = "유효하지 않은 프로젝트 파일이거나 파일 읽기에 실패했습니다.";
                    if (err instanceof SyntaxError) {
                        errorMessage = "JSON 형식이 올바르지 않습니다. 파일을 확인해주세요.";
                    } else if (err.message) {
                        errorMessage = err.message;
                    }
                    showToast("오류", errorMessage, "danger");
                }
                e.target.value = '';
            }
            
            function handleExportProjectClick() {
                if (!App.db.activeProjectId) return showToast("오류", "내보낼 프로젝트를 선택하세요.", "danger");
                const project = App.db.projects[App.db.activeProjectId];
                const projectData = JSON.stringify(project, null, 2);
                const blob = new Blob([projectData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const safeFileName = project.name.replace(/[/\\?%*:|"<>]/g, '-') || 'project';
                a.href = url;
                a.download = `${safeFileName}.json`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 100);
            }
            
            function handleProjectListClick(e) {
                const listItem = e.target.closest('.list-group-item');
                if (!listItem) return;
                const projectId = listItem.dataset.projectId;
                if (e.target.closest('.delete-btn')) {
                    e.preventDefault();
                    deleteProject(projectId);
                } else {
                    switchActiveProject(projectId);
                }
            }

            function handleResourceListClick(e) {
                const listItem = e.target.closest('.list-group-item[data-resource-id]');
                if (!listItem) return;
                const resourceId = listItem.dataset.resourceId;
                const project = App.db.projects[App.db.activeProjectId];
                if (!project) return;
                if (e.target.closest('.delete-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const resourceName = project.resources.find(r => r.id === resourceId)?.name || "이";
                    if (window.confirm(`'${resourceName}' 자원을 삭제하시겠습니까?`)) {
                        project.resources = project.resources.filter(r => r.id !== resourceId);
                        saveProjectToFirestore(project).then(success => {
                            if (success) {
                                renderResourceList();
                                showToast("성공", "자원이 삭제되었습니다.", "success");
                            }
                        });
                    }
                } else {
                    const resource = project.resources.find(r => r.id === resourceId);
                    if (resource) {
                        document.getElementById('resourceModalTitle').textContent = '자원 편집';
                        document.getElementById('resource-id').value = resource.id;
                        document.getElementById('resource-name').value = resource.name;
                        document.getElementById('resource-content').value = resource.content;
                        document.getElementById('resource-file-input').value = '';
                        App.bs.resourceModal.show();
                    }
                }
            }
            
            function handleAddResourceClick() {
                if (!App.db.activeProjectId) return showToast("오류", "먼저 프로젝트를 선택하세요.", "warning");
                document.getElementById('resourceModalTitle').textContent = '새 자원 추가';
                document.getElementById('resource-id').value = '';
                document.getElementById('resource-name').value = '';
                document.getElementById('resource-content').value = '';
                document.getElementById('resource-file-input').value = '';
                App.bs.resourceModal.show();
            }
            
            async function handleResourceFileChange(e) {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const content = await readFileAsText(file);
                    document.getElementById('resource-content').value = content;
                    const resourceNameInput = document.getElementById('resource-name');
                    if (!resourceNameInput.value) {
                        resourceNameInput.value = file.name.replace(/\.[^/.]+$/, "");
                    }
                } catch(err) { showToast('오류', err.message, 'danger'); }
                e.target.value = '';
            }

            async function handleSaveResourceClick() {
                const id = document.getElementById('resource-id').value;
                const name = document.getElementById('resource-name').value.trim();
                const content = document.getElementById('resource-content').value;
                if (!name || !content) return showToast("오류", "이름과 내용을 모두 입력하세요.", "danger");
                const project = App.db.projects[App.db.activeProjectId];
                if (!project) return;
                if (!project.resources) project.resources = [];
                const existingResource = id ? project.resources.find(r => r.id === id) : null;
                if (existingResource) {
                    existingResource.name = name;
                    existingResource.content = content;
                } else {
                    project.resources.push({ id: `res_${Date.now()}`, name, content });
                }
                
                const success = await saveProjectToFirestore(project);
                if (success) {
                    renderResourceList();
                    App.bs.resourceModal.hide();
                    showToast("성공", `자원이 ${id ? '수정' : '추가'}되었습니다.`, "success");
                }
            }

            async function handleApplyPlanClick() {
                if (!App.db.activeProjectId) return showToast("오류", "먼저 프로젝트를 선택하세요.", "warning");
                if (!App.db.currentUser?.uid) return showToast("오류", "로그인이 필요합니다.", "danger");
                try {
                    const planText = App.dom.planInput.value;
                    const cleanedJsonString = planText.replace(/^```json\s*|```\s*$/g, '').trim();
                    if (!cleanedJsonString) throw new Error("입력된 내용이 없습니다.");
                    const planJSON = JSON.parse(cleanedJsonString);
                    if (!planJSON.modules || !Array.isArray(planJSON.modules)) throw new Error("JSON에 'modules' 배열이 없습니다.");
                    const project = App.db.projects[App.db.activeProjectId];
                    
                    project.learningPlan = planJSON;
                    project.name = planJSON.projectName || project.name;
                    project.goal = planJSON.mainGoal || project.goal;
                    
                    project.learningPlan.modules.forEach(module => {
                        // Ensure all new lessons have necessary fields
                        if (module.lessons) {
                            module.lessons.forEach(lesson => {
                                if (lesson.status === undefined) lesson.status = "pending";
                                if (lesson.studyPad === undefined) lesson.studyPad = "";
                            });
                        }
                        if (module.status === undefined) module.status = "pending";
                        if (module.studyPad === undefined) module.studyPad = "";
                        if (module.notes === undefined) module.notes = "";
                        if (module.recommendedResources === undefined) module.recommendedResources = [];
                    });

                    const success = await saveProjectToFirestore(project);
                    if (success) {
                        render();
                        showToast("성공", "학습 계획이 적용되었습니다.", "success");
                    }
                } catch (e) {
                    showToast("오류", "유효하지 않은 JSON 형식입니다: " + e.message, "danger");
                }
            }
            
            function handleDashboardClick(e) {
                const target = e.target;
                const card = target.closest('.module-card');
                if (!card) return;
                const moduleIndex = card.dataset.moduleIndex;
                if (target.matches('.open-module-detail-btn')) {
                    e.preventDefault();
                    // Set active module and open the detail modal
                    App.db.activeModuleIndex = moduleIndex;
                    App.db.activeLessonIndex = 0; // Start with the first lesson by default
                    renderLessonDetail(App.db.activeModuleIndex, App.db.activeLessonIndex);
                    App.bs.lectureDetailModal.show();
                } else if (target.closest('.status-change-btn')) {
                    e.preventDefault();
                    updateModuleField(moduleIndex, 'status', target.closest('.status-change-btn').dataset.status);
                } else if (target.matches('.view-details-btn')) {
                    e.preventDefault();
                    const type = target.dataset.detailType;
                    openDetailViewer(moduleIndex, type);
                }
            }
            
            function handleDashboardInput(e) {
                const target = e.target;
                const card = target.closest('.module-card');
                if (!card) return;
                const index = card.dataset.moduleIndex;
                if (target.matches('.module-studypad')) {
                    updateModuleField(index, 'studyPad', target.value);
                } else if (target.matches('.module-notes')) {
                    updateModuleField(index, 'notes', target.value);
                }
            }

            function handleManageActionsClick() {
                if (!App.db.activeProjectId) return showToast("오류", "프로젝트를 선택하세요.", "warning");
                renderActionManager();
                App.bs.actionManagerModal.show();
            }

            function handleActionManagerClick(e) {
                const editBtn = e.target.closest('.edit-action-btn');
                if(editBtn) openActionEditor(editBtn.dataset.actionKey);
                
                const deleteBtn = e.target.closest('.delete-action-btn');
                if(deleteBtn) deleteAction(deleteBtn.dataset.actionKey);
            }

            function handleActionSelectorClick(e) {
                const buildBtn = e.target.closest('.build-prompt-btn');
                if (buildBtn) {
                    e.preventDefault();
                    const { templateKey, moduleIndex } = buildBtn.dataset;
                    handleBuildPrompt(templateKey, moduleIndex);
                }
            }

            // New: Handle clicks inside the lecture detail modal
            function handleLectureDetailClick(e) {
                const target = e.target;
                if (target.closest('.lesson-list-item')) {
                    const lessonItem = target.closest('.lesson-list-item');
                    const lessonIndex = parseInt(lessonItem.dataset.lessonIndex, 10);
                    renderLessonDetail(App.db.activeModuleIndex, lessonIndex);
                } else if (target.closest('.module-nav-item')) {
                    const moduleItem = target.closest('.module-nav-item');
                    const newModuleIndex = parseInt(moduleItem.dataset.moduleIndex, 10);
                    App.db.activeModuleIndex = newModuleIndex;
                    App.db.activeLessonIndex = 0; // Reset to the first lesson of the new module
                    renderLessonDetail(App.db.activeModuleIndex, App.db.activeLessonIndex);
                } else if (target.matches('.open-action-selector-lesson')) {
                    renderActionSelector(App.db.activeModuleIndex);
                }
            }

            // New: Handle lesson navigation buttons
            function handleLessonNavClick(e) {
                const project = App.db.projects[App.db.activeProjectId];
                const module = project.learningPlan.modules[App.db.activeModuleIndex];
                let newLessonIndex = App.db.activeLessonIndex;
                
                if (e.currentTarget.id === 'lesson-prev-btn' && newLessonIndex > 0) {
                    newLessonIndex--;
                } else if (e.currentTarget.id === 'lesson-next-btn' && newLessonIndex < module.lessons.length - 1) {
                    newLessonIndex++;
                } else {
                    return; // Do nothing if buttons are disabled
                }
                
                // Update status to 'completed' if moving to the next lesson
                if (newLessonIndex > App.db.activeLessonIndex) {
                    updateLessonField(App.db.activeModuleIndex, App.db.activeLessonIndex, 'status', 'completed');
                }

                App.db.activeLessonIndex = newLessonIndex;
                renderLessonDetail(App.db.activeModuleIndex, App.db.activeLessonIndex);
            }

            // New: Handle input in the lesson study pad
            function handleLessonInput(e) {
                const target = e.target;
                if (target.id === 'lesson-studypad-input') {
                    updateLessonField(App.db.activeModuleIndex, App.db.activeLessonIndex, 'studyPad', target.value);
                }
            }

            function handleBuildPrompt(templateKey, moduleIndex) {
                App.bs.actionSelectorModal.hide();

                const project = App.db.projects[App.db.activeProjectId];
                if (!project) return;
                
                const template = (project.actions || []).find(a => a.key === templateKey);
                if (!template) return showToast('오류', '액션을 찾을 수 없습니다.', 'danger');

                const module = moduleIndex !== undefined && project.learningPlan ? project.learningPlan.modules[moduleIndex] : null;

                App.dom.promptModalLabel.textContent = template.title;
                App.dom.dynamicFormContainer.innerHTML = '';
                
                App.dom.dataSelector.innerHTML = '<option value="">자원 라이브러리에서 선택</option>';
                (project.resources || []).forEach(r => App.dom.dataSelector.innerHTML += `<option value="${r.id}">${r.name}</option>`);

                let purposeTemplate = template.purpose;
                const context = { '학습 목표': project.goal, '현재 수준': '지식이 필요한 학습자', ...(module || {}) };
                if (module) {
                    context['모듈 제목'] = module.title;
                    context['핵심 개념'] = (module.keyConcepts || []).join(', ');
                    if (module.recommendedResources && module.recommendedResources.length > 0) {
                        context['추천 리소스'] = module.recommendedResources.join(', ');
                    }
                    // Add current lesson context if available
                    if (App.db.activeLessonIndex !== null) {
                        const lesson = module.lessons[App.db.activeLessonIndex];
                        context['레슨 제목'] = lesson.title;
                        context['레슨 내용'] = lesson.content;
                    }
                }
                
                // Extract variables that are still [VAR_NAME] after initial pre-filling
                const variables = [...new Set([...purposeTemplate.matchAll(/\[(.*?)\]/g)].map(m => m[1]))];
                variables.forEach(varName => {
                    const prefilledValue = context[varName];
                    if (prefilledValue) {
                        purposeTemplate = purposeTemplate.replaceAll(`[${varName}]`, prefilledValue);
                    } else {
                        App.dom.dynamicFormContainer.innerHTML += `<div class="mb-3"><label for="var-${varName}" class="form-label form-label-sm">${varName}</label><input type="text" id="var-${varName}" class="form-control form-control-sm dynamic-var-input" data-var-name="${varName}" placeholder="${varName} 내용 입력..."></div>`;
                    }
                });

                let currentDataSource = 'none';
                let dataContent = '';
                if (module?.studyPad && (templateKey.startsWith('1_') || templateKey.startsWith('2_'))) {
                    currentDataSource = 'studypad';
                    dataContent = module.studyPad;
                } else if (App.db.activeModuleIndex !== null && App.db.activeLessonIndex !== null) {
                    // Default to current lesson's study pad if in lesson view
                    currentDataSource = 'studypad';
                    dataContent = project.learningPlan.modules[App.db.activeModuleIndex].lessons[App.db.activeLessonIndex].studyPad;
                }

                document.querySelectorAll('input[name="dataSource"]').forEach(radio => radio.checked = false);
                const initialDataSourceRadio = document.getElementById(`source-${currentDataSource}`);
                if (initialDataSourceRadio) {
                    initialDataSourceRadio.checked = true;
                }
                document.getElementById('data-direct-input').value = dataContent;

                const dataSourceContainers = {
                    resource: document.getElementById('data-selector-container'),
                    studypad: document.getElementById('data-direct-input-container'), // Now using direct input for study pad
                    direct: document.getElementById('data-direct-input-container'),
                };
                
                const updateDataSourceVisibility = () => {
                    const selected = document.querySelector('input[name="dataSource"]:checked').value;
                    Object.values(dataSourceContainers).forEach(c => c.classList.add('d-none'));
                    if (selected === 'resource') {
                        dataSourceContainers['resource'].classList.remove('d-none');
                    } else if (selected === 'studypad' || selected === 'direct') {
                        dataSourceContainers['direct'].classList.remove('d-none');
                    }
                };

                const updatePreview = () => {
                    let previewPurpose = purposeTemplate;
                    App.dom.dynamicFormContainer.querySelectorAll('.dynamic-var-input').forEach(input => {
                        const varName = input.dataset.varName;
                        const value = input.value || `[${varName}]`;
                        previewPurpose = previewPurpose.replaceAll(`[${varName}]`, value);
                    });
                    
                    const selectedDataSource = document.querySelector('input[name="dataSource"]:checked').value;
                    let finalDataContent = '없음';
                    if (selectedDataSource === 'resource') {
                        const resId = App.dom.dataSelector.value;
                        if (resId) finalDataContent = (project.resources.find(r => r.id === resId) || {}).content;
                    } else if (selectedDataSource === 'studypad') {
                        if (App.db.activeModuleIndex !== null && App.db.activeLessonIndex !== null) {
                            finalDataContent = project.learningPlan.modules[App.db.activeModuleIndex].lessons[App.db.activeLessonIndex].studyPad;
                        } else if (module?.studyPad) {
                            finalDataContent = module.studyPad;
                        }
                    } else if (selectedDataSource === 'direct') {
                        finalDataContent = document.getElementById('data-direct-input').value;
                    }
                    
                    const contextForAI = {
                        projectName: project.name,
                        mainGoal: project.goal,
                    };
                    if (project.learningPlan) {
                        contextForAI.tutorPersona = project.learningPlan.tutorPersona;
                        contextForAI.fullTableOfContents = project.learningPlan.modules.map(m => ({ id: m.id, title: m.title, status: m.status }));
                    }
                    if (module) {
                        const { studyPad, notes, ...currentModuleContext } = module;
                        contextForAI.currentModule = currentModuleContext;
                    }
                    if (App.db.activeLessonIndex !== null) {
                        const lesson = module.lessons[App.db.activeLessonIndex];
                        contextForAI.currentLesson = { id: lesson.id, title: lesson.title, status: lesson.status };
                    }

                    const projectContext = JSON.stringify(contextForAI, null, 2);
                    let finalPrompt = MASTER_PROMPT_SHELL.replace(/{{purpose}}/g, previewPurpose)
                                                         .replace(/{{data}}/g, finalDataContent || '내용 없음')
                                                         .replace(/{{projectContext}}/g, projectContext);
                    App.dom.livePreviewContainer.textContent = finalPrompt;
                };

                document.querySelectorAll('input[name="dataSource"]').forEach(radio => radio.onchange = () => {
                    updateDataSourceVisibility();
                    updatePreview();
                });

                App.dom.dynamicFormContainer.addEventListener('input', updatePreview);
                App.dom.dataSelector.addEventListener('change', updatePreview);
                document.getElementById('data-direct-input').addEventListener('input', updatePreview);
                
                updateDataSourceVisibility();
                updatePreview();
                App.bs.promptModal.show();
            }

            function handleExecutePromptClick() {
                const finalPromptText = App.dom.livePreviewContainer.textContent;
                copyToClipboard(finalPromptText);
            }
            
            function toggleSidebar() {
                App.dom.sidebar?.classList.toggle('is-open');
                App.dom.overlay?.classList.toggle('is-visible');
            }

            // --- 6. Initial Execution ---
            initApp();
        });
    </script>
</body>
</html>
