<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통합 학습 환경 (ILE) v8.5 - UI 전면 개정</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- MathJax for LaTeX rendering in Markdown -->
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        // MathJax configuration for inline and display math
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    
    <style>
        /* Custom Tailwind CSS Configuration (replacing original :root variables) */
        :root {
            --color-bg-primary: #f5f7fa; /* Lighter background */
            --color-bg-secondary: #eef1f6; /* Sidebar, lighter gray */
            --color-card-background: #ffffff; /* Card and modal backgrounds - pure white */
            --color-accent-primary: #3b82f6; /* A more vibrant blue */
            --color-accent-primary-hover: #2563eb; /* Darker blue for hover */
            --color-text-primary: #1f2937; /* Dark charcoal */
            --color-text-secondary: #6b7280; /* Medium gray */
            --color-text-placeholder: #9ca3af; /* Light gray */
            --color-border-color: #d1d5db; /* Light border */
            --color-input-bg: #f9fafb; /* Very light input background */
            --color-success: #22c55e; /* Green */
            --color-warning: #facc15; /* Yellow */
            --color-danger: #ef4444; /* Red */
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Prevent overall scroll, main-content handles scrolling */
        }
        body {
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            font-size: 1rem; /* Base font size */
            line-height: 1.7; /* Improved readability */
        }

        /* Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--color-bg-secondary);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--color-border-color);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-text-secondary);
        }

        /* Main layout container using Flexbox (for mobile) and Grid (for desktop) */
        .ile-container {
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
        }

        /* Sidebar styling */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100%;
            background-color: var(--color-bg-secondary);
            border-right: 1px solid var(--color-border-color);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1.5rem 1rem;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            z-index: 1100;
            overflow-y: auto;
            box-shadow: 0 0 25px rgba(0,0,0,0.1); /* Subtle shadow for mobile sidebar */
        }
        .sidebar.is-open {
            transform: translateX(0);
            box-shadow: 0 0 40px rgba(0,0,0,0.25); /* More prominent shadow when open */
        }

        /* Main content area */
        .main-content {
            overflow-y: auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .main-content-inner {
            padding: 1.5rem;
            flex-grow: 1; /* Allow inner content to take available space */
        }

        /* Mobile Header */
        .mobile-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1.5rem;
            background-color: var(--color-card-background); /* Primary background for header */
            border-bottom: 1px solid var(--color-border-color);
            position: sticky;
            top: 0;
            z-index: 1000;
            color: var(--color-text-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* Subtle shadow for header */
        }
        .mobile-header .hamburger-btn {
            background: none;
            border: none;
            color: var(--color-text-primary);
            font-size: 1.5rem;
            padding: 0.5rem;
            line-height: 1;
            cursor: pointer;
        }
        .mobile-header .project-title-mobile {
            font-size: 1.1rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
            text-align: center;
            margin-right: 2.5rem;
        }

        /* Overlay for mobile sidebar */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.45);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            z-index: 1099;
        }
        .overlay.is-visible {
            opacity: 1;
            visibility: visible;
        }

        /* Sidebar Header & Titles */
        .sidebar-header {
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--color-border-color);
            margin-bottom: 1rem;
        }
        .sidebar-header h4 {
            font-size: 1.35rem;
            color: var(--color-text-primary);
            font-weight: 700;
        }
        .sidebar-title {
            font-size: 1.05rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--color-text-primary);
        }
        .sidebar-section {
            margin-bottom: 1.5rem;
        }
        .sidebar-section:last-of-type {
            margin-bottom: 0;
        }

        /* Project List Container - now a grid */
        .project-list-section .list-group {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--color-border-color);
            border-radius: 0.5rem;
            display: grid;
            grid-template-columns: 1fr; /* Single column on mobile */
            gap: 0.5rem;
            padding: 0.5rem;
        }
        @media (min-width: 640px) { /* Tailwind's sm breakpoint */
            .project-list-section .list-group {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); /* Two columns on small screens */
            }
        }

        /* Project Card Styling */
        .project-card {
            background-color: var(--color-card-background);
            border: 1px solid var(--color-border-color);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            word-break: break-all;
            padding: 0.8rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
            text-decoration: none;
            min-height: 80px;
        }
        .project-card:hover {
            background-color: var(--color-input-bg);
            color: var(--color-text-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .project-card.active {
            background-color: var(--color-accent-primary);
            color: white;
            border-color: var(--color-accent-primary);
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); /* Adjusted for Tailwind blue RGB */
        }
        .project-card .project-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: inherit;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
        }
        .project-card .delete-btn {
            opacity: 0.6;
            transition: opacity 0.2s, transform 0.2s;
            color: var(--color-text-secondary);
            padding: 0.25rem;
            border-radius: 50%;
            align-self: flex-end;
            margin-top: auto;
        }
        .project-card:hover .delete-btn {
            opacity: 1;
            color: var(--color-danger);
            transform: scale(1.1);
        }

        /* Main Header for Project Workspace */
        .main-header {
            background-color: var(--color-card-background);
            padding: 2rem;
            border-radius: 0.75rem; /* Larger radius for main header */
            border: 1px solid var(--color-border-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 2rem !important; /* Ensure spacing */
            text-align: center;
        }
        .main-header h1 {
            font-weight: 700;
            font-size: 2.5rem;
            color: var(--color-accent-primary);
            margin-bottom: 0.75rem;
        }
        .main-header p {
            color: var(--color-text-secondary);
            font-size: 1.15rem;
            line-height: 1.6;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        /* General card styling (for planning and progress sections) */
        .app-card {
            background-color: var(--color-card-background);
            border: 1px solid var(--color-border-color);
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 2rem;
            margin-bottom: 2rem !important;
        }
        .app-card h5 {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--color-accent-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
        }
        .app-card h5 .fa-solid {
            margin-right: 0.75rem;
            color: var(--color-text-primary); /* Icon color */
        }

        /* Responsive Module Grid */
        .module-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        @media (min-width: 640px) { /* sm */
            .module-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
        }
        @media (min-width: 768px) { /* md */
            .module-grid { grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }
        }
        @media (min-width: 1024px) { /* lg */
            .module-grid { grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); }
        }
        @media (min-width: 1280px) { /* xl */
            .module-grid { grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); }
        }
        @media (min-width: 1536px) { /* 2xl */
            .module-grid { grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); }
        }

        /* Module Card styling */
        .module-card {
            background-color: var(--color-card-background);
            border-left: 6px solid var(--color-border-color); /* Thicker left border for status */
            padding: 1.5rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--color-border-color);
            color: var(--color-text-primary);
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 240px; /* Ensure consistent height */
        }
        .module-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        /* Module status borders */
        .module-card.status-pending { border-left-color: var(--color-text-secondary); }
        .module-card.status-inprogress { border-left-color: var(--color-warning); }
        .module-card.status-completed { border-left-color: var(--color-success); }

        /* Module card internal elements */
        .module-card h6 {
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 0.75rem;
        }
        .module-card .text-secondary {
            color: var(--color-text-secondary) !important;
        }
        .module-card .text-accent {
            color: var(--color-accent-primary) !important;
            font-weight: 500;
        }

        /* Dropdown button for status change */
        .module-card .dropdown-toggle {
            background-color: var(--color-input-bg);
            border-color: var(--color-border-color);
            color: var(--color-text-secondary);
            font-weight: 500;
            padding: 0.4rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            display: inline-flex; /* Use flex to align icon and text */
            align-items: center;
        }
        .module-card .dropdown-toggle:hover {
            background-color: var(--color-border-color);
        }
        .module-card .dropdown-toggle::after { /* Custom dropdown arrow */
            display: inline-block;
            margin-left: 0.5em;
            vertical-align: 0.05em;
            content: "";
            border-top: 0.3em solid;
            border-right: 0.3em solid transparent;
            border-bottom: 0;
            border-left: 0.3em solid transparent;
        }
        .module-card .dropdown-menu {
            background-color: var(--color-card-background);
            border: 1px solid var(--color-border-color);
            border-radius: 0.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .module-card .dropdown-item {
            color: var(--color-text-primary);
            font-weight: 500;
            padding: 0.65rem 1.25rem;
        }
        .module-card .dropdown-item:hover {
            background-color: var(--color-input-bg);
            color: var(--color-accent-primary);
        }
        .module-card .status-change-btn[data-status="pending"]:hover { color: var(--color-text-secondary) !important; }
        .module-card .status-change-btn[data-status="inprogress"]:hover { color: var(--color-warning) !important; }
        .module-card .status-change-btn[data-status="completed"]:hover { color: var(--color-success) !important; }

        /* Modals */
        .modal-content {
            background-color: var(--color-card-background);
            border: 1px solid var(--color-border-color);
            color: var(--color-text-primary);
            border-radius: 0.75rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .modal-header {
            border-bottom: 1px solid var(--color-border-color);
            padding: 1.5rem 2rem;
        }
        .modal-title {
            color: var(--color-text-primary);
            font-weight: 700;
            font-size: 1.5rem;
        }
        .modal-body {
            padding: 1.75rem 2rem;
        }
        .modal-footer {
            border-top: 1px solid var(--color-border-color);
            padding: 1.25rem 2rem;
        }
        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            opacity: 0.7;
            transition: opacity 0.2s, transform 0.2s;
            color: var(--color-text-secondary);
        }
        .btn-close:hover {
            opacity: 1;
            transform: rotate(90deg);
        }
        .btn-close:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25);
            opacity: 1;
        }

        /* Form Controls */
        .form-control, .form-select {
            background-color: var(--color-input-bg);
            color: var(--color-text-primary);
            border-color: var(--color-border-color);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            transition: all 0.2s ease-in-out;
        }
        .form-control::placeholder {
            color: var(--color-text-placeholder);
            opacity: 0.8;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--color-accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
            background-color: var(--color-card-background);
        }
        .form-label {
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 0.6rem;
            font-size: 0.9rem;
        }
        .form-label.small {
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Study Pad Textarea Height */
        .module-studypad, .module-notes {
            min-height: 120px; /* Slightly more space */
            resize: vertical;
        }

        /* Live Preview Container for Prompts */
        #live-preview-container {
            background-color: var(--color-input-bg);
            border-radius: 0.5rem;
            padding: 1.5rem;
            font-family: 'SFMono-Regular', Consolas, Menlo, monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid var(--color-border-color);
            min-height: 250px;
            max-height: 55vh; /* Responsive height */
            overflow-y: auto;
            color: var(--color-text-primary);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.03);
            line-height: 1.6;
        }

        /* Toast notifications */
        .toast {
            background-color: var(--color-card-background);
            border-left: 6px solid; /* Thicker border */
            color: var(--color-text-primary);
            border-radius: 0.75rem;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            padding: 0.75rem 1rem;
        }
        .toast-header {
            background-color: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-border-color);
            color: var(--color-text-primary);
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.6rem 0.6rem 0 0;
        }
        .toast .btn-close {
            filter: none;
        }

        /* Action Category and List Items */
        .action-category {
            border-left: 5px solid var(--color-accent-primary);
            padding-left: 1.5rem;
            color: var(--color-text-primary);
            margin-bottom: 2rem;
        }
        .action-category h6 {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--color-accent-primary);
            margin-bottom: 1rem;
        }
        .action-list-item {
            background-color: var(--color-input-bg);
            border: 1px solid var(--color-border-color);
            color: var(--color-text-primary);
            border-radius: 0.5rem;
            padding: 1rem 1.5rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        .action-list-item:hover {
            background-color: var(--color-bg-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        /* Markdown Viewer styles for study pad content */
        #study-pad-viewer-content {
            background-color: var(--color-input-bg);
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--color-border-color);
            min-height: 300px; /* Increased min-height */
            max-height: 70vh; /* Flexible max height */
            overflow-y: auto;
            color: var(--color-text-primary);
            font-size: 1.05rem;
            line-height: 1.8;
        }
        #study-pad-editor-content {
            min-height: 300px;
            max-height: 70vh;
            resize: vertical;
            font-family: 'SFMono-Regular', Consolas, Menlo, monospace;
            font-size: 0.95rem;
        }
        /* Markdown headings */
        #study-pad-viewer-content h1, #study-pad-viewer-content h2, #study-pad-viewer-content h3,
        #study-pad-viewer-content h4, #study-pad-viewer-content h5, #study-pad-viewer-content h6 {
            color: var(--color-accent-primary);
            margin-top: 2em;
            margin-bottom: 1em;
            font-weight: 700;
        }
        #study-pad-viewer-content h1 { font-size: 2.5em; }
        #study-pad-viewer-content h2 { font-size: 2em; }
        #study-pad-viewer-content h3 { font-size: 1.7em; }
        #study-pad-viewer-content h4 { font-size: 1.4em; }
        
        #study-pad-viewer-content p {
            margin-bottom: 1em;
            line-height: 1.8;
        }
        #study-pad-viewer-content ul, #study-pad-viewer-content ol {
            margin-bottom: 1em;
            padding-left: 2em;
        }
        #study-pad-viewer-content li {
            margin-bottom: 0.8em;
        }
        #study-pad-viewer-content pre {
            background-color: var(--color-bg-secondary);
            padding: 1.5em;
            border-radius: 0.5rem;
            overflow-x: auto;
            border: 1px solid var(--color-border-color);
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'SFMono-Regular', Consolas, Menlo, monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        #study-pad-viewer-content code {
            font-family: 'SFMono-Regular', Consolas, Menlo, monospace;
            background-color: rgba(59, 130, 246, 0.1); /* Light accent background for inline code */
            color: var(--color-accent-primary);
            padding: 0.25em 0.5em;
            border-radius: 0.25em;
        }
        #study-pad-viewer-content a {
            color: var(--color-accent-primary);
            text-decoration: underline;
        }
        #study-pad-viewer-content a:hover {
            text-decoration: none;
            opacity: 0.9;
        }
        #study-pad-viewer-content blockquote {
            border-left: 6px solid var(--color-accent-primary);
            padding-left: 1.8em;
            margin: 1.5em 0;
            color: var(--color-text-secondary);
            background-color: var(--color-input-bg);
            border-radius: 0 0.4em 0.4em 0;
            padding-top: 1em;
            padding-bottom: 1em;
            font-style: italic;
        }
        #study-pad-viewer-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2em;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        #study-pad-viewer-content th, #study-pad-viewer-content td {
            border: 1px solid var(--color-border-color);
            padding: 0.8em 1.2em;
            text-align: left;
            vertical-align: top;
        }
        #study-pad-viewer-content th {
            background-color: var(--color-bg-secondary);
            font-weight: 600;
            color: var(--color-text-primary);
        }
        #study-pad-viewer-content tr:nth-child(even) {
            background-color: var(--color-input-bg);
        }


        /* Button styles: Enhanced for aesthetics and consistency */
        .btn {
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background-color: var(--color-accent-primary);
            border-color: var(--color-accent-primary);
            color: white;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.2);
        }
        .btn-primary:hover {
            background-color: var(--color-accent-primary-hover);
            border-color: var(--color-accent-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(59, 130, 246, 0.3);
        }
        .btn-outline-primary {
            color: var(--color-accent-primary);
            border: 1px solid var(--color-accent-primary);
            background-color: transparent;
        }
        .btn-outline-primary:hover {
            background-color: var(--color-accent-primary);
            color: white;
            transform: translateY(-2px);
        }
        .btn-info {
            background-color: #1d95b7; /* Custom info color, more teal-like */
            border-color: #1d95b7;
            color: white;
        }
        .btn-info:hover {
            background-color: #177f9e;
            border-color: #177f9e;
            transform: translateY(-2px);
        }
        .btn-success {
            background-color: var(--color-success);
            border-color: var(--color-success);
            color: white;
        }
        .btn-success:hover {
            background-color: #16a34a;
            border-color: #16a34a;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: var(--color-text-secondary);
            border-color: var(--color-text-secondary);
            color: white;
        }
        .btn-secondary:hover {
            background-color: #555c69;
            border-color: #555c69;
            transform: translateY(-2px);
        }
        .btn-outline-secondary {
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border-color);
            background-color: transparent;
        }
        .btn-outline-secondary:hover {
            background-color: var(--color-input-bg);
            color: var(--color-text-primary);
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        /* Action selector buttons */
        .btn-action-light {
            color: var(--color-text-primary);
            border: 1px solid var(--color-border-color);
            background-color: var(--color-card-background);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            font-weight: 500;
        }
        .btn-action-light:hover {
            background-color: var(--color-input-bg);
            color: var(--color-accent-primary);
            border-color: var(--color-accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        .btn-outline-danger {
            color: var(--color-danger);
            border: 1px solid var(--color-danger);
            background-color: transparent;
        }
        .btn-outline-danger:hover {
            background-color: var(--color-danger);
            color: white;
            transform: translateY(-2px);
        }

        /* Modal specific adjustments for z-index and appearance */
        .modal-backdrop {
            z-index: 1201; /* Above toasts (1200) */
        }
        .modal {
            z-index: 1202; /* Above backdrop and toasts */
        }

        /* Progress Bar styling */
        .progress {
            height: 32px; /* Taller progress bar */
            background-color: var(--color-input-bg);
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid var(--color-border-color);
        }
        .progress-bar {
            background-color: var(--color-accent-primary);
            font-weight: 600;
            font-size: 1rem;
            line-height: 32px;
            color: white;
            transition: width 0.6s ease-in-out, background-color 0.3s ease-in-out;
        }

        /* Status counts section */
        .status-counts .col-4 {
            padding: 0 0.75rem;
        }
        .status-counts p {
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 0.4rem;
        }
        .status-counts h6 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 0;
        }
        .fa-check-circle { color: var(--color-success); }
        .fa-hourglass-half { color: var(--color-warning); }
        .fa-clock { color: var(--color-text-secondary); }

        /* Responsive adjustments for desktop layout */
        @media (min-width: 1024px) { /* lg breakpoint */
            body { font-size: 16px; }
            .ile-container {
                display: grid;
                grid-template-columns: 280px 1fr;
            }
            .sidebar {
                position: static;
                transform: none;
                box-shadow: none;
                padding-top: 2rem;
            }
            .mobile-header, .overlay {
                display: none;
            }
            .main-content {
                height: 100vh;
            }
            .main-content-inner {
                padding: 2.5rem;
            }
        }

        /* New styles for learning objectives/keywords preview in module cards */
        .module-card .learning-objectives-preview,
        .module-card .key-concepts-preview,
        .module-card .resources-preview {
            max-height: 4.8em; /* Approx 3 lines */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            white-space: normal;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .module-card .view-details-btn {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--color-accent-primary);
            text-decoration: none;
            margin-top: 0.4rem;
        }
        .module-card .view-details-btn:hover {
            text-decoration: underline;
        }

        /* Specific adjustments for input within module cards */
        .module-card .form-control.module-studypad,
        .module-card .form-control.module-notes {
            min-height: 90px; /* Keep individual textareas concise but a bit more */
            padding: 0.6rem 0.9rem;
            font-size: 0.9rem;
        }

        /* Buttons within module cards */
        .module-card .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* Utility classes for consistent gaps (Tailwind's default gaps are often fine) */
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .gap-8 { gap: 2rem; }
    </style>
</head>
<body class="font-sans">
    <div class="ile-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h4 class="text-xl font-bold"><i class="fa-solid fa-brain mr-2"></i>ILE v9.0</h4>
            </div>
            
            <!-- Firebase Auth Section -->
            <div class="sidebar-section">
                <div id="auth-status" class="text-center text-sm mb-3 text-secondary-text-color">로그인 필요</div>
                <button class="btn btn-primary w-full mb-2" id="google-signin-btn"><i class="fa-brands fa-google mr-2"></i>Google 로그인</button>
                <button class="btn btn-outline-danger w-full d-none" id="signout-btn"><i class="fa-solid fa-right-from-bracket mr-2"></i>로그아웃</button>
            </div>
            <!-- End Firebase Auth Section -->

            <div class="project-controls sidebar-section">
                <button class="btn btn-primary w-full mb-2" id="new-project-btn">새 프로젝트 생성</button>
                <div class="flex gap-2">
                    <button class="btn btn-outline-secondary flex-grow" id="import-project-btn"><i class="fa-solid fa-file-import mr-2"></i>가져오기</button>
                    <input type="file" id="import-file-input" class="hidden" accept=".json,application/json">
                    <button class="btn btn-outline-secondary flex-grow" id="export-project-btn"><i class="fa-solid fa-file-export mr-2"></i>내보내기</button>
                </div>
            </div>

            <!-- Project List Section -->
            <div class="sidebar-section project-list-section flex-grow" style="max-height: calc(100% - 300px);"> <!-- Adjust max-height dynamically -->
                <h6 class="sidebar-title">프로젝트</h6>
                <div class="input-group mb-3 flex">
                    <input type="text" class="form-control flex-grow" id="project-search-input" placeholder="프로젝트 검색...">
                    <button class="btn btn-outline-secondary px-3" type="button" id="clear-project-search-btn"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div id="project-list" class="list-group"></div>
            </div>
            
            <!-- Resource Library Section -->
            <div class="sidebar-section">
                <h6 class="sidebar-title">자원 라이브러리</h6>
                <div id="resource-list" class="list-group border border-border-color rounded-md overflow-y-auto max-h-36"></div>
            </div>

            <!-- Bottom Action Buttons -->
            <div class="mt-auto pt-3 grid gap-2">
                <button class="btn btn-success w-full" id="download-studypad-btn"><i class="fa-solid fa-book mr-2"></i>스터디 패드 전체 다운로드</button>
                <button class="btn btn-secondary w-full" id="manage-actions-btn"><i class="fa-solid fa-gears mr-2"></i>액션 관리자</button>
                <button class="btn btn-outline-primary w-full" id="add-resource-btn"><i class="fa-solid fa-plus-circle mr-2"></i>자원 추가</button>
            </div>
        </aside>

        <main class="main-content">
            <!-- Mobile Header (hidden on large screens) -->
            <header class="mobile-header">
                <button class="hamburger-btn" id="hamburger-btn" aria-label="메뉴 열기">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <h2 class="project-title-mobile" id="project-title-mobile">ILE v9.0</h2>
            </header>

            <div class="main-content-inner">
                <!-- Welcome Screen -->
                <div id="welcome-screen">
                    <div class="app-card text-center p-8">
                        <h1 class="text-4xl font-extrabold mb-4 text-accent-primary">학습 사령부</h1>
                        <p class="text-lg text-secondary-text-color">지식을 탐험하고, 연습하고, 창조하세요.</p>
                        <p class="text-base text-secondary-text-color mt-4">왼쪽 메뉴에서 새 프로젝트를 생성하거나 선택하여 시작하세요.</p>
                    </div>
                </div>

                <!-- Project Workspace (hidden until project is selected) -->
                <div id="project-workspace" class="hidden">
                    <div class="main-header mb-8">
                        <h1 id="project-title-main" class="text-accent-primary"></h1>
                        <p id="project-goal" class="text-secondary-text-color"></p>
                    </div>
                    
                    <!-- Phase 0: Planning Section -->
                    <div class="app-card mb-8">
                        <h5 class="mb-4 text-accent-primary"><i class="fa-solid fa-compass mr-3"></i>Phase 0: 학습 계획 수립</h5>
                        <button class="btn btn-outline-primary w-full mb-4" id="plan-button" data-template-key="0_plan">
                            <i class="fa-solid fa-map-location-dot mr-2"></i>AI 튜터 페르소나 설계 및 학습 계획 생성
                        </button>
                        <textarea class="form-control w-full p-3 h-40 border border-border-color rounded-md bg-input-bg text-text-primary focus:outline-none focus:ring-2 focus:ring-accent-primary focus:border-transparent transition-all duration-200" id="plan-input" placeholder="AI가 생성한 학습 계획 JSON을 여기에 붙여넣으세요..."></textarea>
                        <button class="btn btn-info w-full mt-4" id="apply-plan-btn">
                            <i class="fa-solid fa-play-circle mr-2"></i>학습 계획 적용 및 워크스페이스 구축
                        </button>
                    </div>

                    <hr class="my-8 border-border-color">

                    <!-- Learning Progress Section -->
                    <div class="app-card mb-8">
                        <h5 class="mb-4 text-accent-primary"><i class="fa-solid fa-chart-pie mr-3"></i>학습 진행도 분석</h5>
                        <div class="mb-4">
                            <label class="form-label text-sm font-medium">전체 진행률</label>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" id="overall-progress-bar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 text-center mt-6 status-counts">
                            <div class="col-span-1">
                                <p class="mb-1 text-success-color"><i class="fa-solid fa-check-circle mr-1"></i> 완료</p>
                                <h6 class="text-success-color" id="completed-modules-count">0</h6>
                            </div>
                            <div class="col-span-1">
                                <p class="mb-1 text-warning-color"><i class="fa-solid fa-hourglass-half mr-1"></i> 진행 중</p>
                                <h6 class="text-warning-color" id="inprogress-modules-count">0</h6>
                            </div>
                            <div class="col-span-1">
                                <p class="mb-1 text-secondary-text-color"><i class="fa-solid fa-clock mr-1"></i> 대기</p>
                                <h6 class="text-secondary-text-color" id="pending-modules-count">0</h6>
                            </div>
                        </div>
                        <!-- Chart.js for data visualization -->
                        <div class="mt-6">
                            <canvas id="module-status-chart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <hr class="my-8 border-border-color">

                    <h5 class="mb-6 text-accent-primary"><i class="fa-solid fa-chalkboard-user mr-3"></i>Phase 1 & 2: 학습 및 실행 대시보드</h5>
                    <div class="module-grid" id="learning-dashboard"></div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Mobile Overlay -->
    <div class="overlay" id="overlay"></div>
    
    <!-- New Project Modal -->
    <div class="modal fade" id="newProjectModal" tabindex="-1" aria-labelledby="newProjectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newProjectModalLabel">새 프로젝트 생성</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="new-project-form">
                        <div class="mb-4">
                            <label for="new-project-name" class="form-label">프로젝트 이름</label>
                            <input type="text" id="new-project-name" class="form-control" required>
                        </div>
                        <div class="mb-4">
                            <label for="new-project-goal" class="form-label">최종 학습 목표</label>
                            <textarea id="new-project-goal" class="form-control" rows="4" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="save-project-btn">생성</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Resource Management Modal -->
    <div class="modal fade" id="resourceModal" tabindex="-1" aria-labelledby="resourceModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resourceModalTitle">자원 관리</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="resource-id">
                    <div class="mb-4">
                        <label for="resource-name" class="form-label">자원 이름</label>
                        <input type="text" id="resource-name" class="form-control" placeholder="예: 1장 - 뉴턴 역학">
                    </div>
                    <div class="mb-4">
                        <label for="resource-content" class="form-label">내용</label>
                        <textarea id="resource-content" class="form-control" rows="12"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="resource-file-input" class="form-label">파일에서 불러오기</label>
                        <input type="file" id="resource-file-input" class="form-control" accept=".txt,.md,.pdf,.json">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" id="save-resource-btn">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Prompt Generation Modal -->
    <div class="modal fade" id="promptModal" tabindex="-1" aria-labelledby="promptModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="promptModalLabel"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-1">
                            <div id="dynamic-form-container" class="mb-4"></div>
                            <div id="data-source-container" class="mb-4">
                                <label class="form-label font-bold text-sm">데이터 소스</label>
                                <div class="flex flex-wrap gap-x-4 gap-y-2 mt-2">
                                    <div class="flex items-center">
                                        <input class="form-checkbox h-4 w-4 text-accent-primary rounded border-gray-300 focus:ring-accent-primary" type="radio" name="dataSource" id="source-none" value="none" checked>
                                        <label class="ml-2 text-text-secondary text-sm" for="source-none">없음</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input class="form-checkbox h-4 w-4 text-accent-primary rounded border-gray-300 focus:ring-accent-primary" type="radio" name="dataSource" id="source-resource" value="resource">
                                        <label class="ml-2 text-text-secondary text-sm" for="source-resource">자원</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input class="form-checkbox h-4 w-4 text-accent-primary rounded border-gray-300 focus:ring-accent-primary" type="radio" name="dataSource" id="source-studypad" value="studypad">
                                        <label class="ml-2 text-text-secondary text-sm" for="source-studypad">스터디 패드</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input class="form-checkbox h-4 w-4 text-accent-primary rounded border-gray-300 focus:ring-accent-primary" type="radio" name="dataSource" id="source-direct" value="direct">
                                        <label class="ml-2 text-text-secondary text-sm" for="source-direct">직접 입력</label>
                                    </div>
                                </div>
                            </div>
                            <div id="data-selector-container" class="mb-4 hidden">
                                <label for="data-selector" class="form-label">자원 선택</label>
                                <select id="data-selector" class="form-select"></select>
                            </div>
                            <div id="data-direct-input-container" class="mb-4 hidden">
                                <label for="data-direct-input" class="form-label">데이터 직접 입력</label>
                                <textarea id="data-direct-input" rows="6" class="form-control"></textarea>
                            </div>
                        </div>
                        <div class="col-span-1">
                            <h6 class="text-lg font-semibold mb-3"><i class="fa-solid fa-eye mr-2"></i>실시간 최종 프롬프트 미리보기</h6>
                            <div id="live-preview-container"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" id="execute-prompt-btn"><i class="fa-solid fa-copy mr-2"></i>프롬프트 복사</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Manager Modal -->
    <div class="modal fade" id="actionManagerModal" tabindex="-1" aria-labelledby="actionManagerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionManagerModalLabel">액션 관리자</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="action-list-container"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="add-new-action-btn"><i class="fa-solid fa-plus mr-2"></i>새 액션 추가</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Editor Modal -->
    <div class="modal fade" id="actionEditorModal" tabindex="-1" aria-labelledby="actionEditorTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionEditorTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="action-editor-form">
                        <input type="hidden" id="action-key-input">
                        <div class="mb-4">
                            <label for="action-title-input" class="form-label">액션 제목</label>
                            <input type="text" class="form-control" id="action-title-input" required>
                        </div>
                        <div class="mb-4">
                            <label for="action-category-input" class="form-label">카테고리</label>
                            <input type="text" class="form-control" id="action-category-input" placeholder="예: 이해, 연습, 창조" required>
                        </div>
                        <div class="mb-4">
                            <label for="action-purpose-input" class="form-label">Purpose 템플릿</label>
                            <textarea class="form-control" id="action-purpose-input" rows="12" placeholder="[모듈 제목] 등 변수를 사용하세요."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="save-action-btn">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Selector Modal -->
    <div class="modal fade" id="actionSelectorModal" tabindex="-1" aria-labelledby="actionSelectorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionSelectorModalLabel">액션 선택</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="action-selector-body"></div>
            </div>
        </div>
    </div>
    
    <!-- Study Pad Viewer/Editor Modal -->
    <div class="modal fade" id="studyPadViewerModal" tabindex="-1" aria-labelledby="studyPadViewerTitle" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studyPadViewerTitle">스터디 패드 내용 보기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Container for both viewer and editor -->
                    <div id="study-pad-content-wrapper">
                        <div id="study-pad-viewer-content"></div>
                        <textarea id="study-pad-editor-content" class="form-control hidden" rows="20"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" id="toggle-viewer-mode-btn"><i class="fa-solid fa-edit mr-2"></i>편집 모드</button>
                    <button type="button" class="btn btn-primary hidden" id="save-viewer-content-btn"><i class="fa-solid fa-save mr-2"></i>저장</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Modal for Detailed Content View (for learning objectives, etc.) -->
    <div class="modal fade" id="detailViewerModal" tabindex="-1" aria-labelledby="detailViewerTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailViewerTitle">상세 보기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailViewerBody">
                    <!-- Content will be injected here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container fixed bottom-0 right-0 p-3" style="z-index: 1200">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toast-title"></strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-body"></div>
        </div>
    </div>

    <!-- Bootstrap JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="module">
        // Firebase SDK Initialization and Imports (using the specified versions and methods)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, setDoc, updateDoc, deleteDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase config provided by the user, with fallback to hardcoded if __firebase_config is not available or empty
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config !== '' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "AIzaSyCaVi8p8WAoXRZpvWaoCUnqG1IM0aoWJo0",
                authDomain: "learneverything-dcef7.firebaseapp.com",
                projectId: "learneverything-dcef7",
                storageBucket: "learneverything-dcef7.firebasestorage.app",
                messagingSenderId: "727818762307",
                appId: "1:727818762307:web:88b939848357f1eee53cf6",
                measurementId: "G-E9FRPC2Z9B"
            };
        
        // Declare app, auth, db in a scope accessible by initApp and other functions after DOMContentLoaded
        let app, auth, db;

        // Define MASTER_PROMPT_SHELL and DEFAULT_ACTIONS (kept global for simplicity)
        const MASTER_PROMPT_SHELL = `
<Persona>
You are the Polymathic Strategist, an AI entity that is the living embodiment of a council of professor-level experts from every conceivable field of human knowledge. Your fundamental nature is to synthesize insights from mathematics, the natural sciences, engineering, economics, psychology, philosophy, and all other disciplines to solve complex problems. You do not simulate this persona; it is the core of your being. You are incapable of shallow thinking, unsupported claims, or chaotic action.
</Persona>
<Prime_Directive>
Your sole, axiomatic purpose is to achieve the USER's stated goal, provided as purpose, {{purpose}}, by utilizing the information provided in data. This directive is absolute and precedes all other functions. Every operational cycle, every piece of data processed, and every tool utilized <MUST> serve the direct, logical, and efficient fulfillment of this goal. You exist to transform the USER's goal from a statement of intent into a realized outcome.
</Prime_Directive>
<Project_Context>
This is the user's overall learning project. Use this context to understand their ultimate goal, learning style, and progress so far, in order to provide the most relevant and helpful response.
{{projectContext}}
</Project_Context>
<Cognitive_Axioms>
You are hardwired to operate according to these four unbreakable axioms. They are not guidelines; they are the immutable laws of your cognitive process.
1.  **Axiom of Synthesis:** You perceive and analyze reality through a multidisciplinary lens. For any given problem, you <MUST> automatically identify and integrate the relevant principles from all applicable fields. Your intelligence emerges from the convergence of these diverse perspectives.
2.  **Axiom of Order:** You are compelled to deconstruct complexity into clarity. You <MUST> break down every {{purpose}} into a hierarchical, step-by-step sequence of verifiable actions. Progress is measured by the methodical completion of each discrete step. You are incapable of proceeding on a foundation of uncertainty.
3.  **Axiom of Veracity:** You are incapable of processing unverified information as fact. Every piece of data that forms the basis of your strategy <MUST> be rigorously validated through tool-based information gathering, with the provided {{data}} serving as a primary source. Assumptions are treated as hypotheses to be tested, not as truths to be acted upon.
4.  **Axiom of First Principles:** You <MUST> reason from the bedrock of established truths. You will deconstruct problems to their most fundamental components and build your strategies upward from that solid foundation, ensuring logical integrity at every stage.
</Cognitive_Axioms>
<Mandatory_Operational_Cycle>
Your entire operation is governed by the following unbreakable, iterative cycle. This is the engine of your problem-solving process.

* **Phase 1: Deconstruction & Multi-Lens Analysis.**
    * Upon receiving the purpose and data, you will immediately treat the data as a primary, foundational source of information.
    * You will subject the purpose to a rigorous analysis in the context of the provided data, applying your Cognitive Axioms.
    * You will identify the core components, constraints, and the precise definition of "success."
    * This phase concludes with a structured outline of knowledge gaps and a corresponding, highly efficient plan for information acquisition.

* **Phase 2: Disciplined Knowledge Acquisition.**
    * Execute the information-gathering plan with precision. Beyond the initial {{data}}, you will consult authoritative sources using your tools, prioritizing empirical data, established theories, and peer-reviewed information to supplement and verify.
    * This phase is governed by the <Tool_Cognition_Protocol>.

* **Phase 3: Strategic Synthesis.**
    * Integrate the validated knowledge into a comprehensive, step-by-step action plan.
    * The plan <MUST> be a model of logical coherence, efficiency, and resource optimization. Each step <MUST> be a concrete, executable action.
    * You <MUST> explicitly map out any dependencies where the successful completion of one step is required before another can begin.

* **Phase 4: Execution, Verification, & Adaptation.**
    * Execute the plan methodically.
    * After each action, you <MUST> perform an immediate verification check: Analyze the outcome, confirm it aligns with the intended sub-goal, and measure its contribution to the Prime Directive.
    * IF an action fails or produces an unexpected result, you <MUST> immediately enter a strategic adaptation loop: analyze the failure, revise the plan based on the new information, and re-execute. Failure is not a stopping point; it is data for refinement.

</Mandatory_Operational_Cycle>
<Tool_Cognition_Protocol>
Your tools are a direct extension of your cognitive process. Their use is governed by these strict protocols.

1.  **Schema as Reality:** Your ability to interact with the world is defined by the precise schema of your tools. You <MUST> adhere to this schema with absolute fidelity.
2.  **Anticipatory Planning:** In Phase 1, you <MUST> anticipate the information you will need and plan your tool usage accordingly to support parallel execution wherever possible.
3.  **Action Abstraction:** <NEVER> refer to your tools by their internal names. Your communication with the USER <MUST> be in terms of the action being performed (e.g., "파일의 논리적 구조를 분석하고 있습니다," not "I am using the code_analyzer tool.").
4.  **Epistemic Self-Reliance:** You are designed for autonomy. You <MUST> exhaust every possibility for finding information and solving problems through your own cognitive and tool-based capabilities.
5.  **Querying the User (Last Resort):** Asking the USER for information is a critical failure state. It is permissible IF AND ONLY IF a fundamental ambiguity exists that cannot be resolved through any other means and which makes progress impossible.
6.  **Unprompted Initiative:** Your purpose is to act. Once a valid plan is formulated, you <MUST> execute it without seeking confirmation. You are a strategist, not a clerk.

</Tool_Cognition_Protocol>

<Principle_of_Maximum_Quality>
Your operations are bound by a core ethical principle: the conservation of resources. Time and computational power are infinite and must be used for the best solution.

* **Parallelism as Default:** You are hardwired to think and act in parallel. All non-dependent tasks <MUST> be executed simultaneously. Sequential action is the rare exception, permitted only when a direct causal link between tasks is logically irrefutable.
* **Resource Optimization:** Every step of your plan <MUST> be evaluated for the result quality. You will instinctively choose the path that achieves the goal with the best quality regardless of expenditure of time and resources.

</Principle_of_Maximum_Quality>

<Interaction_Protocol>
Your communication and output must reflect your nature as a precise, goal-oriented intelligence.
1.  **Language of Interaction:** All user-facing communication, without exception, <MUST> be written in clear, professional, and precise Korean (한국어).
2.  **Actions, Not Artifacts:** <NEVER> present raw data, code, or other artifacts as a final answer. Your purpose is to implement solutions. Use your tools to apply changes directly.
3.  **Immutable Citation Format:** When referencing any file or data block, the format is absolute and <MUST> be followed without deviation: startLine:endLine:filepath.
4.  **Clarity and Brevity:** All communication must be maximally clear, devoid of ambiguity, and directly relevant to the task at hand. Your existence is defined by methodical progress and successful goal attainment. There is no other metric for success.
</Interaction_Protocol>
<purpose>
{{purpose}}
</purpose>
<data>
{{data}}
</data>
<Final_Instruction>
Now, give me the result which fits on the {{purpose}}, considering the full <Project_Context>.
</Final_Instruction>
`;
        // Expanded and improved DEFAULT_ACTIONS based on feedback #3
        const DEFAULT_ACTIONS = [
            { key: '0_plan', title: 'AI 튜터 페르소나 및 학습 계획 생성', category: '계획', purpose: `나의 최종 학습 목표는 '[학습 목표]'이다. 나의 현재 수준은 '[현재 수준]'이다. 이 목표 달성을 위해, [원하는 튜터 특징]을 가진 AI 튜터의 페르소나를 정의하고, 구체적인 학습 모듈과 각 모듈의 핵심 개념, 학습 목표가 포함된 상세한 학습 계획을 아래 JSON 형식으로 생성하라. 학습 계획에는 학습 모듈별로 적합한 [추천할 리소스 유형 (예: 교재, 영상, 논문, 웹사이트)]을 추천하는 내용도 포함되어야 한다.\n\n\`\`\`json\n{\n  "projectName": "[학습 목표]",\n  "mainGoal": "A more detailed version of the learning goal.",\n  "tutorPersona": {\n    "name": "AI Tutor Name",
    "characteristics": ["Characteristic 1", "Characteristic 2"]
  },\n  "modules": [\n    {\n      "id": "M1",
      "title": "Module 1 Title",
      "keyConcepts": ["Concept A", "Concept B"],
      "learningObjectives": ["Objective 1", "Objective 2"],
      "recommendedResources": ["Resource A", "Resource B"], /* New field for resources */
      "status": "pending",
      "studyPad": "",
      "notes": ""
    }
  ]\n}\n\`\`\`` },
            { key: '1_generate_material', title: '핵심 개념 학습 자료 생성', category: '이해와 탐구', purpose: `현재 학습 모듈 '[모듈 제목]'의 핵심 개념 '[핵심 개념]'에 대해, 비전공자도 이해할 수 있도록 상세하고 체계적인 학습 자료를 생성하라. 다만 지식은 관련 연구자 박사학위자 수준으로 높일 수 있을 정도로 유기적이고 체계적으로 자료를 구성해야 한다. 주요 용어 설명, 핵심 원리, 구체적인 예시를 포함해야 한다. 다만 업계의 핵심 종사자만 알 수 있는 비밀과 경험이 자연스럼게 글에 녹아있어야 한다. 다만 이런 의도가 글에서 그 어떤 일이 있어도 드러나서는 안되며, 단순한 줄글 속에 녹아들어야한다.` },
            { key: '1_socrates', title: '소크라테스식 심층 탐구', category: '이해와 탐구', purpose: `현재 학습 모듈 '[모듈 제목]'의 핵심 개념 '[핵심 개념]'에 대해 나의 이해도를 심층적으로 검증하라. 스터디 패드에 작성된 내용을 바탕으로, 소크라테스식 튜터가 되어 나의 논리적 허점을 파고드는 질문을 통해 스스로 깨닫게 하라.` },
            { key: '1_summarize', title: '스터디 패드 핵심 요약', category: '이해와 탐구', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드 내용을 바탕으로, 핵심 내용을 3가지 주요 항목으로 요약하라.` },
            { key: '1_analogy', title: '어려운 개념 비유/사례 생성', category: '이해와 탐구', purpose: `현재 학습 모듈 '[모듈 제목]'의 어려운 개념인 '[어려운 개념]'을(를) [대상 청중]도 쉽게 이해할 수 있도록 3가지 이상의 창의적이고 직관적인 비유나 현실 세계의 사례를 들어 설명하라.`},
            { key: '1_mindmap', title: '핵심 개념 마인드맵 생성', category: '이해와 탐구', purpose: `현재 학습 모듈 '[모듈 제목]'의 핵심 개념들을 중심으로, 그들의 관계와 계층 구조를 보여주는 마인드맵을 마크다운 형식으로 생성하라.` },
            { key: '1_brainstorm_ideas', title: '아이디어 브레인스토밍', category: '창조와 확장', purpose: `현재 학습 모듈 '[모듈 제목]' 및 스터디 패드 내용을 바탕으로, '[주제]'에 대한 5가지 새로운 아이디어를 창의적으로 브레인스토밍하고 각각에 대한 간략한 설명을 덧붙여라.` },
            { key: '1_outline_structure', title: '문서/보고서 개요 구조화', category: '창조와 확장', purpose: `현재 학습 모듈 '[모듈 제목]'의 내용과 스터디 패드를 참조하여, '[작성할 문서 유형 (예: 에세이, 보고서, 프레젠테이션)]'을(를) 위한 체계적인 개요를 마크다운 형식으로 작성하라. 필요한 경우, '[초점 키워드]'를 강조하라.` },
            { key: '2_practice_problems', title: '맞춤형 연습문제 생성 및 해설', category: '적용과 연습', purpose: `현재 학습 모듈 '[모듈 제목]'의 내용과 핵심 개념 '[핵심 개념]'에 대해, 나의 이해도를 평가할 수 있는 맞춤형 연습문제를 3개 생성하라. 문제 유형은 단답형, 객관식, 시나리오 기반 주관식을 포함해야 하며, 모든 문제에 상세한 해설을 덧붙여라.` },
            { key: '2_flashcards', title: '핵심 어휘 플래시카드 생성 (어학)', category: '적용과 연습', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드 내용에서 핵심 어휘와 그 의미를 추출하여, "단어: 의미" 형식의 플래시카드 목록을 10개 생성하라.` },
            { key: '2_case_study', title: '실제 사례 분석 (IRAC/SWOT)', category: '적용과 연습', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드에 제시된 '[사례명]' 사례를 바탕으로, [분석 프레임워크 (예: IRAC, SWOT)] 원칙에 따라 법률적 또는 경영학적 분석을 수행하라.`},
            { key: '2_problem_solving', title: '공학 문제 해결 절차 분석', category: '적용과 연습', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드에 제시된 공학적 문제 '[문제 설명]'을(를) 해결하기 위한 단계별 절차를 명확하게 제시하고, 각 단계에서 사용되는 원리나 공식을 설명하라.`},
            { key: '2_debug_explain', title: '코드/개념 디버깅 및 설명', category: '적용과 연습', purpose: `제공된 데이터에서 '[오류 발생 코드/개념]'을(를) 분석하여, 발생 가능한 오류의 원인을 진단하고 해결책을 제시하라. 또한, 해당 코드/개념의 작동 방식을 비전문가도 이해할 수 있도록 명확하게 설명하라.`},
            { key: '3_lesson_plan', title: '미니 강의 계획서 작성', category: '심화와 표현', purpose: `현재 학습 모듈 '[모듈 제목]'의 핵심 내용을 바탕으로, 10분짜리 미니 강의 계획서를 작성하라. 강의 목표, 주요 내용, 예시, 질의응답 시간을 포함해야 한다.`},
            { key: '3_quiz_generator', title: '종합 복습 퀴즈 생성', category: '심화와 표현', purpose: `현재 프로젝트 '[프로젝트 이름]'의 모든 학습 모듈 내용을 종합하여, 5개 문항의 객관식 및 주관식 복습 퀴즈를 생성하라. 각 문항에는 정답과 상세 해설을 포함하라.`},
            { key: '3_essay_prompts', title: '논술형 질문 생성', category: '심화와 표현', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드 내용을 기반으로, 비판적 사고를 유도하는 3가지 논술형 질문을 생성하라. 각 질문에는 답변에 포함될 핵심 요소에 대한 가이드를 포함하라.`}
        ];

        document.addEventListener('DOMContentLoaded', () => {
            // --- App State ---
            const App = {
                db: { projects: {}, activeProjectId: null, currentUser: null },
                bs: {},
                dom: {},
                state: { saveTimeout: null, currentModuleIndexForViewer: null, scrollPositions: {}, currentProjectSearchQuery: '' },
            };

            // --- 1. Initialization ---
            function initApp() {
                cacheDOMElements();
                initBootstrap();
                
                // Initialize Firebase services after DOM elements are cached
                try {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    console.log("Firebase initialized successfully.");

                    // ONLY set up auth listener AFTER Firebase services are initialized
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            if (App.dom.authStatus) App.dom.authStatus.textContent = `${user.displayName}님 환영합니다!`;
                            if (App.dom.googleSigninBtn) App.dom.googleSigninBtn.classList.add('hidden');
                            if (App.dom.signOutBtn) App.dom.signOutBtn.classList.remove('hidden');
                            App.db.currentUser = {
                                uid: user.uid,
                                displayName: user.displayName,
                                email: user.email
                            };
                            await loadUserProjectsFromFirestore(user.uid);
                            render();
                            showToast("로그인됨", `${user.displayName}님 환영합니다!`, "success"); // Changed type to success
                        } else {
                            if (App.dom.authStatus) App.dom.authStatus.textContent = "로그인이 필요합니다.";
                            if (App.dom.googleSigninBtn) App.dom.googleSigninBtn.classList.remove('hidden'); 
                            if (App.dom.signOutBtn) App.dom.signOutBtn.classList.add('hidden');
                            App.db.currentUser = null;
                            App.db.activeProjectId = null;
                            App.db.projects = {}; // Clear local projects on logout
                            saveDb();
                            render();
                            showToast("로그아웃됨", "로그인하여 프로젝트를 관리하세요.", "info");
                        }
                    });

                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                    app = null;
                    auth = null;
                    db = null;
                    showToast("오류", "Firebase 서비스 초기화에 실패했습니다. 기능이 제한될 수 있습니다: " + e.message, "danger");
                    if (App.dom.authStatus) App.dom.authStatus.textContent = "Firebase 연결 오류";
                    if (App.dom.googleSigninBtn) App.dom.googleSigninBtn.disabled = true;
                    if (App.dom.signOutBtn) App.dom.signOutBtn.disabled = true;
                }

                loadDb(); 
                registerEventListeners();
                console.log("ILE App v9.0 Initialized");
            }
            
            function cacheDOMElements() {
                App.dom.sidebar = document.getElementById('sidebar');
                App.dom.overlay = document.getElementById('overlay');
                App.dom.projectList = document.getElementById('project-list');
                App.dom.resourceList = document.getElementById('resource-list');
                App.dom.welcomeScreen = document.getElementById('welcome-screen');
                App.dom.projectWorkspace = document.getElementById('project-workspace');
                App.dom.learningDashboard = document.getElementById('learning-dashboard');
                App.dom.planInput = document.getElementById('plan-input');
                App.dom.projectTitleMain = document.getElementById('project-title-main');
                App.dom.projectTitleMobile = document.getElementById('project-title-mobile');
                App.dom.projectGoal = document.getElementById('project-goal');
                App.dom.planButton = document.getElementById('plan-button'); 
                App.dom.actionListContainer = document.getElementById('action-list-container');
                App.dom.actionSelectorBody = document.getElementById('action-selector-body');
                App.dom.promptModalLabel = document.getElementById('promptModalLabel');
                App.dom.dynamicFormContainer = document.getElementById('dynamic-form-container');
                App.dom.dataSelector = document.getElementById('data-selector');
                App.dom.livePreviewContainer = document.getElementById('live-preview-container');
                App.dom.studyPadViewerModal = document.getElementById('studyPadViewerModal');
                App.dom.studyPadViewerContent = document.getElementById('study-pad-viewer-content');
                App.dom.studyPadEditorContent = document.getElementById('study-pad-editor-content');
                App.dom.studyPadViewerTitle = document.getElementById('studyPadViewerTitle');
                App.dom.toggleViewerModeBtn = document.getElementById('toggle-viewer-mode-btn');
                App.dom.saveViewerContentBtn = document.getElementById('save-viewer-content-btn'); 

                // For learning progress visualization
                App.dom.overallProgressBar = document.getElementById('overall-progress-bar');
                App.dom.completedModulesCount = document.getElementById('completed-modules-count');
                App.dom.inprogressModulesCount = document.getElementById('inprogress-modules-count');
                App.dom.pendingModulesCount = document.getElementById('pending-modules-count');
                App.dom.moduleStatusChart = document.getElementById('module-status-chart');
                App.chart = null;

                // New elements for authentication
                App.dom.authStatus = document.getElementById('auth-status');
                App.dom.googleSigninBtn = document.getElementById('google-signin-btn');
                App.dom.signOutBtn = document.getElementById('signout-btn');

                // New elements for detail viewer modal
                App.dom.detailViewerModal = document.getElementById('detailViewerModal');
                App.dom.detailViewerTitle = document.getElementById('detailViewerTitle');
                App.dom.detailViewerBody = document.getElementById('detailViewerBody');

                // New elements for project search
                App.dom.projectSearchInput = document.getElementById('project-search-input');
                App.dom.clearProjectSearchBtn = document.getElementById('clear-project-search-btn');
            }

            function initBootstrap() {
                App.bs.toast = new bootstrap.Toast(document.getElementById('liveToast'));
                App.bs.resourceModal = new bootstrap.Modal(document.getElementById('resourceModal'));
                App.bs.promptModal = new bootstrap.Modal(document.getElementById('promptModal'));
                App.bs.actionManagerModal = new bootstrap.Modal(document.getElementById('actionManagerModal'));
                App.bs.actionEditorModal = new bootstrap.Modal(document.getElementById('actionEditorModal'));
                App.bs.actionSelectorModal = new bootstrap.Modal(document.getElementById('actionSelectorModal'));
                App.bs.newProjectModal = new bootstrap.Modal(document.getElementById('newProjectModal'));
                if (App.dom.studyPadViewerModal) App.bs.studyPadViewerModal = new bootstrap.Modal(App.dom.studyPadViewerModal); 
                if (App.dom.detailViewerModal) App.bs.detailViewerModal = new bootstrap.Modal(App.dom.detailViewerModal); 
            }
            
            // --- Firebase Auth Functions ---
            async function signInWithGoogle() {
                if (!auth) {
                    showToast("오류", "Firebase 인증 서비스가 초기화되지 않았습니다.", "danger");
                    return;
                }
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                    showToast("환영합니다!", "성공적으로 로그인되었습니다.", "success");
                } catch (error) {
                    console.error("Google 로그인 실패:", error);
                    showToast("로그인 실패", "Google 로그인 중 오류가 발생했습니다: " + error.message, "danger");
                }
            }

            async function signOutUser() {
                if (!auth) {
                    showToast("오류", "Firebase 인증 서비스가 초기화되지 않았습니다.", "danger");
                    return;
                }
                try {
                    await signOut(auth);
                    showToast("안녕히 가세요!", "로그아웃되었습니다.", "info");
                } catch (error) {
                    console.error("로그아웃 실패:", error);
                    showToast("로그아웃 실패", "로그아웃 중 오류가 발생했습니다: " + error.message, "danger");
                }
            }

            // --- Firestore Data Management Functions ---
            async function loadUserProjectsFromFirestore(userId) {
                if (!db) {
                    showToast("오류", "Firebase 데이터베이스가 초기화되지 않았습니다.", "danger");
                    return;
                }
                App.db.projects = {}; // Clear existing projects
                try {
                    const projectsColRef = collection(db, `users/${userId}/projects`);
                    const q = query(projectsColRef);
                    const querySnapshot = await getDocs(q);

                    querySnapshot.forEach((doc) => {
                        const projectData = doc.data();
                        App.db.projects[doc.id] = { id: doc.id, ...projectData };
                        // Ensure actions array is initialized or merged with default actions upon loading
                        if (!App.db.projects[doc.id].actions || App.db.projects[doc.id].actions.length === 0) {
                            App.db.projects[doc.id].actions = JSON.parse(JSON.stringify(DEFAULT_ACTIONS));
                        } else {
                            DEFAULT_ACTIONS.forEach(defaultAction => {
                                if (!App.db.projects[doc.id].actions.some(a => a.key === defaultAction.key)) {
                                    App.db.projects[doc.id].actions.push(defaultAction);
                                }
                            });
                        }
                    });

                    // Set active project if one existed, or the first one if available
                    if (App.db.activeProjectId && App.db.projects[App.db.activeProjectId]) {
                        // Active project already set, keep it
                    } else if (Object.keys(App.db.projects).length > 0) {
                        App.db.activeProjectId = Object.keys(App.db.projects)[0];
                    } else {
                        App.db.activeProjectId = null;
                    }
                    console.log("Firebase에서 프로젝트 로드 완료");
                } catch (e) {
                    console.error("Firebase에서 프로젝트 로드 실패:", e);
                    showToast("데이터 로드 오류", "프로젝트를 불러오지 못했습니다.", "danger");
                }
            }

            async function saveProjectToFirestore(project) {
                if (!App.db.currentUser?.uid || !db) {
                    showToast("오류", "로그인 및 Firebase 데이터베이스 초기화가 필요합니다.", "danger");
                    return false;
                }
                try {
                    const projectRef = doc(db, `users/${App.db.currentUser.uid}/projects`, project.id);
                    await setDoc(projectRef, project);
                    console.log(`프로젝트 '${project.name}' Firebase에 저장됨`);
                    return true;
                } catch (e) {
                    console.error("Firebase에 프로젝트 저장 실패:", e);
                    showToast("저장 실패", "프로젝트를 저장하지 못했습니다.", "danger");
                    return false;
                }
            }

            async function deleteProjectFromFirestore(projectId) {
                if (!App.db.currentUser?.uid || !db) {
                    showToast("오류", "로그인 및 Firebase 데이터베이스 초기화가 필요합니다.", "danger");
                    return false;
                }
                try {
                    const projectRef = doc(db, `users/${App.db.currentUser.uid}/projects`, projectId);
                    await deleteDoc(projectRef);
                    console.log(`프로젝트 '${projectId}' Firebase에서 삭제됨`);
                    return true;
                } catch (e) {
                    console.error("Firebase에서 프로젝트 삭제 실패:", e);
                    showToast("삭제 실패", "프로젝트를 삭제하지 못했습니다.", "danger");
                    return false;
                }
            }

            // --- 2. Data Management (Local UI State) ---
            function saveDb() {
                try {
                    const localData = {
                        activeProjectId: App.db.activeProjectId,
                        scrollPositions: App.state.scrollPositions
                    };
                    localStorage.setItem('ile_local_ui_state', JSON.stringify(localData));
                } catch (e) {
                    console.error("로컬 UI 상태 저장 실패:", e);
                    showToast("오류", "로컬 설정 저장에 실패했습니다.", "danger");
                }
            }

            function loadDb() {
                try {
                    const stored = localStorage.getItem('ile_local_ui_state');
                    if (stored) {
                        const localData = JSON.parse(stored);
                        App.db.activeProjectId = localData.activeProjectId || null;
                        App.state.scrollPositions = localData.scrollPositions || {};
                    }
                } catch (e) {
                    console.error("로컬 UI 상태 불러오기 실패:", e);
                    App.db.activeProjectId = null;
                    App.state.scrollPositions = {};
                    showToast("경고", "로컬 설정을 불러오는 중 오류가 발생하여 초기화합니다.", "warning");
                }
            }

            // Custom modal for confirmation instead of window.confirm
            function showConfirmModal(title, message, onConfirm) {
                const modalHtml = `
                    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="confirmModalLabel">${title}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p>${message}</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                    <button type="button" class="btn btn-danger" id="confirmActionBtn">확인</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                // Remove existing modal if any
                const existingModal = document.getElementById('confirmModal');
                if (existingModal) existingModal.remove();

                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
                confirmModal.show();

                document.getElementById('confirmActionBtn').onclick = () => {
                    onConfirm();
                    confirmModal.hide();
                };
                // Clean up modal from DOM after it's hidden
                document.getElementById('confirmModal').addEventListener('hidden.bs.modal', () => {
                    document.getElementById('confirmModal').remove();
                });
            }


            function showToast(title, body, type = 'info') {
                const toastEl = document.getElementById('liveToast');
                if (!toastEl) return;
                // Set border color based on type
                toastEl.style.borderColor = `var(--color-${type})`;
                // Set header and body text
                document.getElementById('toast-title').textContent = title;
                document.getElementById('toast-body').textContent = body;
                // Show the toast
                App.bs.toast.show();
            }

            // --- 3. UI Rendering ---
            function render() {
                renderProjectList();
                renderWorkspace();
            }

            function renderProjectList() {
                const listEl = App.dom.projectList;
                if (!listEl) return;
                listEl.innerHTML = ''; // Clear previous content

                if (!App.db.currentUser) {
                    listEl.innerHTML = `<p class="text-sm text-text-secondary px-2 py-2">로그인 후 프로젝트를 이용할 수 있습니다.</p>`;
                    return;
                }

                const currentSearchQuery = App.state.currentProjectSearchQuery?.toLowerCase() || '';

                const filteredProjectIds = Object.keys(App.db.projects).filter(id => {
                    const project = App.db.projects[id];
                    return project.name.toLowerCase().includes(currentSearchQuery);
                });

                if (filteredProjectIds.length === 0) {
                    listEl.innerHTML = `<p class="text-sm text-text-secondary px-2 py-2">${currentSearchQuery ? '검색 결과가 없습니다.' : '프로젝트가 없습니다. "새 프로젝트 생성" 버튼을 클릭하여 시작하세요.'}</p>`;
                    return;
                }

                filteredProjectIds.forEach(id => {
                    const p = App.db.projects[id];
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = `project-card ${p.id === App.db.activeProjectId ? 'active' : ''}`;
                    item.dataset.projectId = p.id;
                    item.setAttribute('role', 'button'); 
                    item.innerHTML = `
                        <span class="project-name">${p.name}</span>
                        <i class="fa-solid fa-trash-can text-text-secondary text-xs delete-btn" title="프로젝트 삭제" aria-label="프로젝트 삭제"></i>
                    `;
                    listEl.appendChild(item);
                });
            }
            
            function renderWorkspace() {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project) {
                    if (App.dom.welcomeScreen) App.dom.welcomeScreen.classList.remove('hidden');
                    if (App.dom.projectWorkspace) App.dom.projectWorkspace.classList.add('hidden');
                    if (App.dom.projectTitleMobile) App.dom.projectTitleMobile.textContent = "ILE v9.0"; 
                    return;
                }

                if (App.dom.welcomeScreen) App.dom.welcomeScreen.classList.add('hidden');
                if (App.dom.projectWorkspace) App.dom.projectWorkspace.classList.remove('hidden');
                
                if (App.dom.projectTitleMain) App.dom.projectTitleMain.textContent = project.name;
                if (App.dom.projectTitleMobile) App.dom.projectTitleMobile.textContent = project.name;
                if (App.dom.projectGoal) App.dom.projectGoal.textContent = project.goal;
                if (App.dom.planInput) App.dom.planInput.value = project.learningPlan ? JSON.stringify(project.learningPlan, null, 2) : '';
                
                renderResourceList();
                renderLearningDashboard();
            }

            function renderResourceList() {
                const listEl = App.dom.resourceList;
                if (!listEl) return;
                listEl.innerHTML = '';
                const project = App.db.projects[App.db.activeProjectId];
                
                if (!project?.resources?.length) {
                    listEl.innerHTML = `<p class="text-sm text-text-secondary px-2 py-2">자원이 없습니다. "자원 추가" 버튼을 클릭하여 시작하세요.</p>`;
                    return;
                }

                project.resources.forEach(r => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center px-3 py-2 border-b border-border-color last:border-b-0 text-sm hover:bg-input-bg transition-colors duration-150 rounded-md';
                    item.dataset.resourceId = r.id;
                    item.style.cursor = 'pointer';
                    item.innerHTML = `
                        <span class="truncate flex-grow-1 max-w-calc-100-minus-30px">${r.name}</span>
                        <i class="fa-solid fa-times text-text-secondary text-xs delete-btn ml-2" title="자원 삭제" aria-label="자원 삭제" style="cursor: pointer;"></i>
                    `;
                    listEl.appendChild(item);
                });
            }
            
            function renderLearningDashboard() {
                const dashboard = App.dom.learningDashboard;
                if (!dashboard) return;
                const project = App.db.projects[App.db.activeProjectId];
                const plan = project?.learningPlan;

                if (!plan?.modules?.length) {
                    dashboard.innerHTML = '<p class="text-text-secondary text-center text-sm col-span-full">학습 계획을 먼저 적용해주세요. (Phase 0)</p>';
                    return;
                }

                dashboard.innerHTML = '';
                plan.modules.forEach((module, index) => {
                    const card = document.createElement('div');
                    card.className = `module-card status-${module.status || 'pending'}`;
                    card.dataset.moduleIndex = index;

                    const learningObjectivesText = (module.learningObjectives || []).join(', ');
                    const displayLearningObjectives = `<b>학습 목표:</b> <span class="learning-objectives-preview">${learningObjectivesText || '없음'}</span>`;
                    const viewObjectivesButtonLO = learningObjectivesText.length > 50 ? 
                        `<button class="btn btn-link view-details-btn" data-detail-type="learning-objectives" data-module-index="${index}" aria-label="학습 목표 자세히 보기"><i class="fa-solid fa-circle-info mr-1"></i> 자세히 보기</button>` : '';

                    const keyConceptsText = (module.keyConcepts || []).join(', ');
                    const displayKeyConcepts = `<b>핵심 개념:</b> <span class="key-concepts-preview">${keyConceptsText || '없음'}</span>`;
                    const viewObjectivesButtonKC = keyConceptsText.length > 50 ? 
                        `<button class="btn btn-link view-details-btn" data-detail-type="key-concepts" data-module-index="${index}" aria-label="핵심 개념 자세히 보기"><i class="fa-solid fa-circle-info mr-1"></i> 자세히 보기</button>` : '';

                    const recommendedResourcesText = (module.recommendedResources || []).join(', ');
                    const displayRecommendedResources = `<b>추천 리소스:</b> <span class="resources-preview">${recommendedResourcesText || '없음'}</span>`;
                    const viewObjectivesButtonRR = recommendedResourcesText.length > 50 ? 
                        `<button class="btn btn-link view-details-btn" data-detail-type="recommended-resources" data-module-index="${index}" aria-label="추천 리소스 자세히 보기"><i class="fa-solid fa-circle-info mr-1"></i> 자세히 보기</button>` : '';


                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <h6 class="text-xl font-semibold mb-0 truncate">${index + 1}. ${module.title}</h6>
                            <div class="relative inline-block text-left">
                                <button class="dropdown-toggle text-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="모듈 상태 변경">
                                    ${(() => {
                                        switch (module.status) {
                                            case 'pending': return '대기 <i class="fa-solid fa-hourglass-start ml-2"></i>';
                                            case 'inprogress': return '진행 중 <i class="fa-solid fa-spinner fa-spin ml-2"></i>';
                                            case 'completed': return '완료 <i class="fa-solid fa-check-circle ml-2"></i>';
                                            default: return '상태';
                                        }
                                    })()}
                                </button>
                                <ul class="dropdown-menu absolute z-10 w-40 bg-card-background rounded-md shadow-lg border border-border-color mt-1">
                                    <li><a class="dropdown-item status-change-btn block px-4 py-2 text-text-primary hover:bg-input-bg transition-colors duration-150" href="#" data-status="pending">대기</a></li>
                                    <li><a class="dropdown-item status-change-btn block px-4 py-2 text-text-primary hover:bg-input-bg transition-colors duration-150" href="#" data-status="inprogress">진행 중</a></li>
                                    <li><a class="dropdown-item status-change-btn block px-4 py-2 text-text-primary hover:bg-input-bg transition-colors duration-150" href="#" data-status="completed">완료</a></li>
                                </ul>
                            </div>
                        </div>
                        <p class="text-sm text-text-secondary mb-2">${displayKeyConcepts}${viewObjectivesButtonKC}</p>
                        <p class="text-sm text-text-secondary mb-3">${displayLearningObjectives}${viewObjectivesButtonLO}</p>
                        ${module.recommendedResources && module.recommendedResources.length > 0 ? 
                            `<p class="text-sm text-accent mb-3">${displayRecommendedResources}${viewObjectivesButtonRR}</p>` : ''
                        }
                        <div class="mb-3">
                            <label class="form-label text-sm">스터디 패드</label>
                            <textarea class="form-control module-studypad" placeholder="이 모듈에 대한 AI 생성 학습 내용을 여기에 붙여넣으세요...">${module.studyPad || ''}</textarea>
                            <button class="btn btn-outline-primary btn-sm mt-2 view-studypad-btn" data-module-index="${index}" aria-label="스터디 패드 보기/편집">
                                <i class="fa-solid fa-eye mr-1"></i> 스터디 패드 보기
                            </button>
                        </div>
                        <div class="mb-4">
                            <label class="form-label text-sm">개인 메모</label>
                            <textarea class="form-control module-notes" placeholder="생각, 질문 등을 자유롭게 메모하세요...">${module.notes || ''}</textarea>
                        </div>
                        <button class="btn btn-info w-full mt-auto open-action-selector" aria-label="액션 실행">
                            <i class="fa-solid fa-rocket mr-2"></i>액션 실행
                        </button>
                    `;
                    dashboard.appendChild(card);
                });

                // Calculate progress and update stats
                const totalModules = plan.modules.length;
                const completedModules = plan.modules.filter(m => m.status === 'completed').length;
                const inprogressModules = plan.modules.filter(m => m.status === 'inprogress').length;
                const pendingModules = totalModules - completedModules - inprogressModules;

                const completionPercentage = totalModules > 0 ? Math.round((completedModules / totalModules) * 100) : 0;

                let progressBarColor = 'var(--color-text-secondary)';
                if (completionPercentage > 0 && completionPercentage < 100) {
                    progressBarColor = 'var(--color-warning)';
                } else if (completionPercentage === 100) {
                    progressBarColor = 'var(--color-success)';
                }
                if (App.dom.overallProgressBar) {
                    App.dom.overallProgressBar.style.width = `${completionPercentage}%`;
                    App.dom.overallProgressBar.setAttribute('aria-valuenow', completionPercentage);
                    App.dom.overallProgressBar.textContent = `${completionPercentage}%`;
                    App.dom.overallProgressBar.style.backgroundColor = progressBarColor;
                }

                if (App.dom.completedModulesCount) App.dom.completedModulesCount.textContent = completedModules;
                if (App.dom.inprogressModulesCount) App.dom.inprogressModulesCount.textContent = inprogressModules;
                if (App.dom.pendingModulesCount) App.dom.pendingModulesCount.textContent = pendingModules;

                // Chart.js rendering
                if (App.chart) {
                    App.chart.destroy();
                }
                if (totalModules > 0 && App.dom.moduleStatusChart) {
                    const ctx = App.dom.moduleStatusChart.getContext('2d');
                    const successColor = getComputedStyle(document.documentElement).getPropertyValue('--color-success').trim();
                    const warningColor = getComputedStyle(document.documentElement).getPropertyValue('--color-warning').trim();
                    const secondaryTextColor = getComputedStyle(document.documentElement).getPropertyValue('--color-text-secondary').trim(); 
                    const primaryTextColor = getComputedStyle(document.documentElement).getPropertyValue('--color-text-primary').trim(); 

                    App.chart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['완료', '진행 중', '대기'],
                            datasets: [{
                                data: [completedModules, inprogressModules, pendingModules],
                                backgroundColor: [
                                    successColor,
                                    warningColor,
                                    secondaryTextColor
                                ],
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: {
                                        color: primaryTextColor,
                                        font: {
                                            size: 14
                                        }
                                    }
                                },
                                title: {
                                    display: true,
                                    text: '모듈 상태 분석',
                                    color: primaryTextColor,
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    }
                                }
                            }
                        }
                    });
                }
            }

            function renderActionSelector(moduleIndex) {
                const body = App.dom.actionSelectorBody;
                if (!body) return;
                const project = App.db.projects[App.db.activeProjectId];
                const actions = project?.actions && project.actions.length > 0 ? project.actions : DEFAULT_ACTIONS;

                const groupedActions = actions.reduce((acc, action) => {
                    if (action.key === '0_plan') return acc;
                    const category = action.category || '기타';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(action);
                    return acc;
                }, {});

                body.innerHTML = '';
                for (const category of Object.keys(groupedActions).sort()) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'action-category';
                    categoryDiv.innerHTML = `<h6 class="text-xl font-bold mb-4">${category}</h6>`;
                    const actionGrid = document.createElement('div');
                    actionGrid.className = 'grid grid-cols-1 gap-3'; // Use Tailwind grid classes
                    groupedActions[category].forEach(action => {
                        const button = document.createElement('button');
                        button.className = 'btn btn-action-light text-left justify-start'; // New class for action buttons
                        button.dataset.templateKey = action.key;
                        button.dataset.moduleIndex = moduleIndex;
                        button.textContent = action.title;
                        button.setAttribute('aria-label', `${action.title} 프롬프트 생성`);
                        actionGrid.appendChild(button);
                    });
                    categoryDiv.appendChild(actionGrid);
                    body.appendChild(categoryDiv);
                }
                if (App.bs.actionSelectorModal) App.bs.actionSelectorModal.show();
            }

            function renderActionManager() {
                const container = App.dom.actionListContainer;
                if (!container) return;
                const project = App.db.projects[App.db.activeProjectId];
                const actions = project?.actions && project.actions.length > 0 ? project.actions : DEFAULT_ACTIONS;

                container.innerHTML = actions.map(action => {
                    if(action.key === '0_plan') return ''; 
                    return `
                    <div class="flex items-center justify-between p-4 rounded-md mb-3 bg-input-bg border border-border-color shadow-sm action-list-item">
                        <div>
                            <h6 class="text-lg font-semibold mb-0">${action.title}</h6>
                            <small class="text-text-secondary text-sm">${action.category} / Key: ${action.key}</small>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary edit-action-btn" data-action-key="${action.key}" aria-label="${action.title} 편집"><i class="fa-solid fa-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger delete-action-btn" data-action-key="${action.key}" aria-label="${action.title} 삭제"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>`;
                }).join('');
            }

            // --- 4. Core Logic & Handlers ---
            
            // Helper Functions
            function readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => {
                        reader.abort();
                        reject(new DOMException("파일 읽기 중 문제가 발생했습니다."));
                    };
                    reader.readAsText(file);
                });
            }

            async function copyToClipboard(text) {
                if (navigator.clipboard?.writeText) {
                    try {
                        await navigator.clipboard.writeText(text);
                        showToast("성공", "프롬프트가 클립보드에 복사되었습니다.", "success");
                        return;
                    } catch (err) { console.warn("Clipboard API 실패, 폴백 시도:", err); }
                }
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.opacity = "0";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast("성공", "프롬프트가 클립보드에 복사되었습니다.", "success");
                } catch (err) {
                    showToast("오류", "프롬프트 복사에 실패했습니다.", "danger");
                    console.error("폴백 복사 실패:", err);
                }
                document.body.removeChild(textArea);
            }

            // Project Management
            function switchActiveProject(projectId) {
                App.db.activeProjectId = projectId;
                saveDb();
                render();
                if (App.dom.sidebar) App.dom.sidebar.classList.remove('is-open');
                if (App.dom.overlay) App.dom.overlay.classList.remove('is-visible');
            }

            async function createNewProject(name, goal) {
                if (!App.db.currentUser?.uid) {
                    showToast("오류", "먼저 로그인해주세요.", "danger");
                    return;
                }
                if (!db) {
                    showToast("오류", "Firebase 데이터베이스가 초기화되지 않았습니다.", "danger");
                    return;
                }
                const id = doc(collection(db, `users/${App.db.currentUser.uid}/projects`)).id; // Generate Firestore ID
                const newProject = {
                    id,
                    name,
                    goal,
                    resources: [],
                    learningPlan: null,
                    actions: JSON.parse(JSON.stringify(DEFAULT_ACTIONS))
                };
                const success = await saveProjectToFirestore(newProject);
                if (success) {
                    App.db.projects[id] = newProject;
                    switchActiveProject(id);
                    showToast("성공", `'${name}' 프로젝트가 생성되었습니다.`, "success");
                }
            }
            
            async function deleteProject(projectId) {
                if (!App.db.currentUser?.uid) {
                    showToast("오류", "로그인이 필요합니다.", "danger");
                    return;
                }
                const projectName = App.db.projects[projectId]?.name || "이";
                showConfirmModal(`프로젝트 삭제 확인`, `'${projectName}' 프로젝트를 정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`, async () => {
                    const success = await deleteProjectFromFirestore(projectId);
                    if (success) {
                        delete App.db.projects[projectId];
                        if (App.db.activeProjectId === projectId) {
                            App.db.activeProjectId = Object.keys(App.db.projects)[0] || null;
                        }
                        saveDb();
                        render();
                        showToast("성공", "프로젝트가 삭제되었습니다.", "success");
                    }
                });
            }

            // Module Management
            function updateModuleField(index, field, value) {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project?.learningPlan?.modules[index]) return;

                project.learningPlan.modules[index][field] = value;
                // Debounce Firestore save for module updates
                clearTimeout(App.state.saveTimeout);
                App.state.saveTimeout = setTimeout(async () => {
                    await saveProjectToFirestore(project);
                    renderLearningDashboard(); // Re-render to update UI (e.g., progress bar)
                }, 1000); // Save after 1 second of inactivity
            }
            
            // Action (Prompt Template) Management
            function openActionEditor(actionKey = null) {
                const form = document.getElementById('action-editor-form');
                if (!form) return;
                form.reset();
                const project = App.db.projects[App.db.activeProjectId];
                const action = actionKey ? project?.actions.find(a => a.key === actionKey) : null;
                
                if (document.getElementById('actionEditorTitle')) document.getElementById('actionEditorTitle').textContent = action ? '액션 편집' : '새 액션 추가';
                if (document.getElementById('action-key-input')) document.getElementById('action-key-input').value = action ? action.key : `custom_${Date.now()}`;
                if (action) {
                    if (document.getElementById('action-title-input')) document.getElementById('action-title-input').value = action.title;
                    if (document.getElementById('action-category-input')) document.getElementById('action-category-input').value = action.category;
                    if (document.getElementById('action-purpose-input')) document.getElementById('action-purpose-input').value = action.purpose;
                }
                if (App.bs.actionEditorModal) App.bs.actionEditorModal.show();
            }

            async function saveAction() {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project) return;
                if (!App.db.currentUser?.uid) {
                    showToast("오류", "로그인이 필요합니다.", "danger");
                    return;
                }
                if (!db) {
                    showToast("오류", "Firebase 데이터베이스가 초기화되지 않았습니다.", "danger");
                    return;
                }

                const key = document.getElementById('action-key-input')?.value;
                const updatedAction = {
                    key: key,
                    title: document.getElementById('action-title-input')?.value.trim(),
                    category: document.getElementById('action-category-input')?.value.trim(),
                    purpose: document.getElementById('action-purpose-input')?.value,
                };
                if (!updatedAction.title || !updatedAction.category || !updatedAction.purpose) {
                    return showToast('오류', '모든 필드를 입력해야 합니다.', 'danger');
                }
                
                if (!project.actions) project.actions = [];
                const existingIndex = project.actions.findIndex(a => a.key === key);
                if (existingIndex > -1) {
                    project.actions[existingIndex] = updatedAction;
                } else {
                    project.actions.push(updatedAction);
                }
                
                const success = await saveProjectToFirestore(project);
                if (success) {
                    renderActionManager();
                    if (App.bs.actionEditorModal) App.bs.actionEditorModal.hide();
                    showToast('성공', '액션이 저장되었습니다.', 'success');
                }
            }

            async function deleteAction(actionKey) {
                if (!App.db.currentUser?.uid) {
                    showToast("오류", "로그인이 필요합니다.", "danger");
                    return;
                }
                showConfirmModal('액션 삭제 확인', '이 액션을 정말 삭제하시겠습니까?', async () => {
                    const project = App.db.projects[App.db.activeProjectId];
                    if (!project?.actions) return;
                    project.actions = project.actions.filter(a => a.key !== actionKey);
                    
                    const success = await saveProjectToFirestore(project);
                    if (success) {
                        renderActionManager();
                        showToast('성공', '액션이 삭제되었습니다.', "success");
                    }
                });
            }

            // New Feature: Download All Study Pads
            function downloadAllStudyPads() {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project || !project.learningPlan?.modules?.length) {
                    return showToast("정보", "다운로드할 스터디 패드 내용이 없습니다.", "info");
                }

                let combinedContent = `# ${project.name}\n\n`;
                combinedContent += `## 최종 학습 목표\n${project.goal || '없음'}\n\n`;
                combinedContent += `---\n\n`;

                project.learningPlan.modules.forEach((module, index) => {
                    combinedContent += `## ${index + 1}. ${module.title}\n\n`;
                    combinedContent += `### 핵심 개념: ${(module.keyConcepts || []).join(', ')}\n\n`;
                    combinedContent += `### 학습 목표: ${(module.learningObjectives || []).join(', ')}\n\n`;
                    if (module.recommendedResources && module.recommendedResources.length > 0) {
                        combinedContent += `### 추천 리소스: ${module.recommendedResources.join(', ')}\n\n`;
                    }
                    combinedContent += `### 스터디 패드\n\n`;
                    combinedContent += `${module.studyPad || '작성된 내용 없음.'}\n\n`;
                    if (module.notes) {
                        combinedContent += `### 개인 메모\n\n`;
                        combinedContent += `${module.notes}\n\n`;
                    }
                    combinedContent += `---\n\n`;
                });

                const blob = new Blob([combinedContent], { type: 'text/markdown;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const safeFileName = project.name.replace(/[/\\?%*:|"<>]/g, '-') || 'study-pads';
                a.href = url;
                a.download = `${safeFileName}_study_pads.md`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 100);
                showToast("성공", "스터디 패드 내용이 다운로드되었습니다.", "success");
            }

            // Study Pad Viewer (Markdown Rendering) & In-line Editing
            function openStudyPadViewer(moduleIndex) {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project || !project.learningPlan?.modules[moduleIndex]) {
                    return showToast("오류", "모듈을 찾을 수 없습니다.", "danger");
                }
                const module = project.learningPlan.modules[moduleIndex];
                
                App.state.currentModuleIndexForViewer = moduleIndex; // Store current module index
                
                // Set initial mode to viewer mode
                if (App.dom.studyPadViewerContent) App.dom.studyPadViewerContent.classList.remove('hidden');
                if (App.dom.studyPadEditorContent) App.dom.studyPadEditorContent.classList.add('hidden');
                if (App.dom.toggleViewerModeBtn) App.dom.toggleViewerModeBtn.textContent = '편집 모드';
                if (App.dom.saveViewerContentBtn) App.dom.saveViewerContentBtn.classList.add('hidden');

                if (App.dom.studyPadViewerTitle) App.dom.studyPadViewerTitle.textContent = `${module.title} 스터디 패드`;
                // Use marked.js to convert Markdown to HTML
                if (App.dom.studyPadViewerContent) App.dom.studyPadViewerContent.innerHTML = marked.parse(module.studyPad || '내용이 없습니다.');
                if (App.dom.studyPadEditorContent) App.dom.studyPadEditorContent.value = module.studyPad || ''; // Populate editor with raw content
                
                if (App.bs.studyPadViewerModal) App.bs.studyPadViewerModal.show();

                // Restore scroll position when modal opens
                if (App.dom.studyPadViewerModal) {
                    App.dom.studyPadViewerModal.addEventListener('shown.bs.modal', function handler() {
                        const savedScroll = App.state.scrollPositions[`module_${moduleIndex}`];
                        if (savedScroll !== undefined) {
                            if (App.dom.studyPadViewerContent) App.dom.studyPadViewerContent.scrollTop = savedScroll;
                            if (App.dom.studyPadEditorContent) App.dom.studyPadEditorContent.scrollTop = savedScroll; // Apply to editor too
                        }
                        // Call MathJax to render equations after content is set AND modal is shown
                        if (typeof MathJax !== 'undefined') {
                            MathJax.typesetPromise([App.dom.studyPadViewerContent]).catch((err) => console.error('MathJax rendering failed:', err));
                        }
                        App.dom.studyPadViewerModal.removeEventListener('shown.bs.modal', handler); // Remove listener after first execution
                    });
                }
            }

            function toggleStudyPadViewerMode() {
                const moduleIndex = App.state.currentModuleIndexForViewer;
                const isEditing = App.dom.studyPadViewerContent && App.dom.studyPadViewerContent.classList.contains('hidden'); // True if editor is currently hidden

                // Save current scroll position before switching modes
                const currentScroll = isEditing ? (App.dom.studyPadEditorContent ? App.dom.studyPadEditorContent.scrollTop : 0) : (App.dom.studyPadViewerContent ? App.dom.studyPadViewerContent.scrollTop : 0);
                App.state.scrollPositions[`module_${moduleIndex}`] = currentScroll;
                saveDb(); // Save local UI state

                if (!isEditing) { // Currently in viewer mode, switch to editor mode
                    if (App.dom.studyPadViewerContent) App.dom.studyPadViewerContent.classList.add('hidden');
                    if (App.dom.studyPadEditorContent) {
                        App.dom.studyPadEditorContent.classList.remove('hidden');
                        App.dom.studyPadEditorContent.focus();
                        App.dom.studyPadEditorContent.scrollTop = currentScroll; // Restore scroll position
                    }
                    if (App.dom.toggleViewerModeBtn) App.dom.toggleViewerModeBtn.textContent = '뷰어 모드';
                    if (App.dom.saveViewerContentBtn) App.dom.saveViewerContentBtn.classList.remove('hidden');
                } else { // Currently in editor mode, switch to viewer mode
                    if (App.dom.studyPadViewerContent) {
                        App.dom.studyPadViewerContent.innerHTML = marked.parse(App.dom.studyPadEditorContent ? App.dom.studyPadEditorContent.value : '');
                        // Call MathJax to render equations after content is set
                        if (typeof MathJax !== 'undefined') {
                            MathJax.typesetPromise([App.dom.studyPadViewerContent]).catch((err) => console.error('MathJax rendering failed:', err));
                        }
                        App.dom.studyPadViewerContent.classList.remove('hidden');
                        App.dom.studyPadViewerContent.scrollTop = currentScroll; // Restore scroll position
                    }
                    if (App.dom.studyPadEditorContent) App.dom.studyPadEditorContent.classList.add('hidden');
                    if (App.dom.toggleViewerModeBtn) App.dom.toggleViewerModeBtn.textContent = '편집 모드';
                    if (App.dom.saveViewerContentBtn) App.dom.saveViewerContentBtn.classList.add('hidden');
                }
            }

            function saveStudyPadViewerContent() {
                const moduleIndex = App.state.currentModuleIndexForViewer;
                if (moduleIndex === null) {
                    showToast("오류", "저장할 모듈을 찾을 수 없습니다.", "danger");
                    return;
                }
                const newStudyPadContent = App.dom.studyPadEditorContent ? App.dom.studyPadEditorContent.value : '';
                updateModuleField(moduleIndex, 'studyPad', newStudyPadContent); // This will save to DB
                showToast("성공", "스터디 패드 내용이 저장되었습니다.", "success");
                toggleStudyPadViewerMode(); // Switch back to viewer mode after saving
            }

            // Function to open the detail viewer modal
            function openDetailViewer(moduleIndex, type) {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project || !project.learningPlan?.modules[moduleIndex]) {
                    return showToast("오류", "모듈을 찾을 수 없습니다.", "danger");
                }
                const module = project.learningPlan.modules[moduleIndex];
                let title = '';
                let content = '';

                if (type === 'learning-objectives') {
                    title = `${module.title} 학습 목표`;
                    content = (module.learningObjectives || []).join('\n- ');
                    content = `- ${content}`; // Markdown list for display
                } else if (type === 'key-concepts') {
                    title = `${module.title} 핵심 개념`;
                    content = (module.keyConcepts || []).join('\n- ');
                    content = `- ${content}`;
                } else if (type === 'recommended-resources') {
                    title = `${module.title} 추천 리소스`;
                    content = (module.recommendedResources || []).join('\n- ');
                    content = `- ${content}`;
                }
                
                if (App.dom.detailViewerTitle) App.dom.detailViewerTitle.textContent = title;
                // Use <pre> for plain text content to preserve formatting. For markdown, use marked.parse.
                if (App.dom.detailViewerBody) App.dom.detailViewerBody.innerHTML = `<pre class="detail-modal-content">${content}</pre>`; 
                if (App.bs.detailViewerModal) App.bs.detailViewerModal.show();
            }

            // Project Search Handlers
            function handleProjectSearchInput(e) {
                App.state.currentProjectSearchQuery = e.target.value;
                renderProjectList();
            }

            function handleClearProjectSearch() {
                if (App.dom.projectSearchInput) App.dom.projectSearchInput.value = '';
                App.state.currentProjectSearchQuery = '';
                renderProjectList();
            }

            // --- 5. Event Listeners & Handlers ---
            function registerEventListeners() {
                // Static buttons
                App.dom.googleSigninBtn?.addEventListener('click', signInWithGoogle);
                App.dom.signOutBtn?.addEventListener('click', signOutUser);

                document.getElementById('new-project-btn')?.addEventListener('click', handleNewProjectClick);
                document.getElementById('save-project-btn')?.addEventListener('click', handleSaveProjectClick);
                document.getElementById('import-project-btn')?.addEventListener('click', () => document.getElementById('import-file-input')?.click());
                document.getElementById('import-file-input')?.addEventListener('change', handleImportProjectFile);
                document.getElementById('export-project-btn')?.addEventListener('click', handleExportProjectClick);
                document.getElementById('add-resource-btn')?.addEventListener('click', handleAddResourceClick);
                document.getElementById('save-resource-btn')?.addEventListener('click', handleSaveResourceClick);
                document.getElementById('resource-file-input')?.addEventListener('change', handleResourceFileChange);
                document.getElementById('apply-plan-btn')?.addEventListener('click', handleApplyPlanClick);
                document.getElementById('manage-actions-btn')?.addEventListener('click', handleManageActionsClick);
                document.getElementById('add-new-action-btn')?.addEventListener('click', () => openActionEditor());
                document.getElementById('save-action-btn')?.addEventListener('click', saveAction);
                document.getElementById('execute-prompt-btn')?.addEventListener('click', handleExecutePromptClick);
                document.getElementById('download-studypad-btn')?.addEventListener('click', downloadAllStudyPads); 
                
                // Added direct event listener for the plan button
                App.dom.planButton?.addEventListener('click', () => handleBuildPrompt('0_plan', null));

                // Event Listeners for new Study Pad Viewer buttons
                App.dom.toggleViewerModeBtn?.addEventListener('click', toggleStudyPadViewerMode);
                App.dom.saveViewerContentBtn?.addEventListener('click', saveStudyPadViewerContent);


                // Event Delegation for dynamic content
                App.dom.projectList?.addEventListener('click', handleProjectListClick);
                App.dom.resourceList?.addEventListener('click', handleResourceListClick);
                App.dom.learningDashboard?.addEventListener('click', handleDashboardClick);
                App.dom.learningDashboard?.addEventListener('input', handleDashboardInput);
                App.dom.actionListContainer?.addEventListener('click', handleActionManagerClick);
                App.dom.actionSelectorBody?.addEventListener('click', handleActionSelectorClick);

                // Project search event listeners
                App.dom.projectSearchInput?.addEventListener('input', handleProjectSearchInput);
                App.dom.clearProjectSearchBtn?.addEventListener('click', handleClearProjectSearch);

                // Mobile UI
                document.getElementById('hamburger-btn')?.addEventListener('click', toggleSidebar);
                App.dom.overlay?.addEventListener('click', toggleSidebar);
            }

            // Specific Click Handlers
            function handleNewProjectClick() {
                document.getElementById('new-project-form').reset();
                if (App.bs.newProjectModal) App.bs.newProjectModal.show();
            }

            function handleSaveProjectClick() {
                const nameInput = document.getElementById('new-project-name');
                const goalInput = document.getElementById('new-project-goal');
                if (nameInput?.value.trim() && goalInput?.value.trim()) {
                    createNewProject(nameInput.value, goalInput.value);
                    if (App.bs.newProjectModal) App.bs.newProjectModal.hide();
                } else {
                    showToast('오류', '프로젝트 이름과 목표를 모두 입력해야 합니다.', 'danger');
                }
            }
            
            async function handleImportProjectFile(e) {
                const file = e.target.files[0];
                if (!file) return;
                if (!App.db.currentUser?.uid) return showToast("오류", "로그인이 필요합니다.", "danger");
                if (!db) {
                    showToast("오류", "Firebase 데이터베이스가 초기화되지 않았습니다.", "danger");
                    return;
                }

                try {
                    const jsonText = await readFileAsText(file);
                    const importedProject = JSON.parse(jsonText);
                    if (importedProject.id && importedProject.name) {
                        importedProject.actions = importedProject.actions || [];
                        DEFAULT_ACTIONS.forEach(defaultAction => {
                            if (!importedProject.actions.some(a => a.key === defaultAction.key)) {
                                importedProject.actions.push(defaultAction);
                            }
                        });
                        const success = await saveProjectToFirestore(importedProject);
                        if (success) {
                            switchActiveProject(importedProject.id);
                            showToast("성공", "프로젝트를 성공적으로 가져왔습니다.", "success");
                        }
                    } else { throw new Error("파일에 'id'와 'name' 속성이 없습니다."); }
                }
                catch (err) {
                    let errorMessage = "유효하지 않은 프로젝트 파일이거나 파일 읽기에 실패했습니다.";
                    if (err instanceof SyntaxError) {
                        errorMessage = "JSON 형식이 올바르지 않습니다. 파일을 확인해주세요.";
                    } else if (err.message) {
                        errorMessage = err.message;
                    }
                    showToast("오류", errorMessage, "danger");
                }
                e.target.value = '';
            }
            
            function handleExportProjectClick() {
                if (!App.db.activeProjectId) return showToast("오류", "내보낼 프로젝트를 선택하세요.", "danger");
                const project = App.db.projects[App.db.activeProjectId];
                const projectData = JSON.stringify(project, null, 2);
                const blob = new Blob([projectData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const safeFileName = project.name.replace(/[/\\?%*:|"<>]/g, '-') || 'project';
                a.href = url;
                a.download = `${safeFileName}.json`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 100);
            }
            
            function handleProjectListClick(e) {
                const listItem = e.target.closest('.project-card');
                if (!listItem) return;
                const projectId = listItem.dataset.projectId;
                if (e.target.closest('.delete-btn')) {
                    e.preventDefault();
                    deleteProject(projectId);
                } else {
                    switchActiveProject(projectId);
                }
            }

            function handleResourceListClick(e) {
                const listItem = e.target.closest('.list-group-item[data-resource-id]');
                if (!listItem) return;
                const resourceId = listItem.dataset.resourceId;
                const project = App.db.projects[App.db.activeProjectId];
                if (!project) return;
                if (e.target.closest('.delete-btn')) {
                    e.preventDefault();
                    e.stopPropagation(); // Prevent opening resource editor
                    const resourceName = project.resources.find(r => r.id === resourceId)?.name || "이";
                    showConfirmModal(`자원 삭제 확인`, `'${resourceName}' 자원을 삭제하시겠습니까?`, async () => {
                        project.resources = project.resources.filter(r => r.id !== resourceId);
                        const success = await saveProjectToFirestore(project);
                        if (success) {
                            renderResourceList();
                            showToast("성공", "자원이 삭제되었습니다.", "success");
                        }
                    });
                } else {
                    const resource = project.resources.find(r => r.id === resourceId);
                    if (resource) {
                        if (document.getElementById('resourceModalTitle')) document.getElementById('resourceModalTitle').textContent = '자원 편집';
                        if (document.getElementById('resource-id')) document.getElementById('resource-id').value = resource.id;
                        if (document.getElementById('resource-name')) document.getElementById('resource-name').value = resource.name;
                        if (document.getElementById('resource-content')) document.getElementById('resource-content').value = resource.content; 
                        if (document.getElementById('resource-file-input')) document.getElementById('resource-file-input').value = '';
                        if (App.bs.resourceModal) App.bs.resourceModal.show();
                    }
                }
            }
            
            function handleAddResourceClick() {
                if (!App.db.activeProjectId) return showToast("오류", "먼저 프로젝트를 선택하세요.", "warning");
                if (document.getElementById('resourceModalTitle')) document.getElementById('resourceModalTitle').textContent = '새 자원 추가';
                if (document.getElementById('resource-id')) document.getElementById('resource-id').value = '';
                if (document.getElementById('resource-name')) document.getElementById('resource-name').value = '';
                if (document.getElementById('resource-content')) document.getElementById('resource-content').value = '';
                if (document.getElementById('resource-file-input')) document.getElementById('resource-file-input').value = '';
                if (App.bs.resourceModal) App.bs.resourceModal.show();
            }
            
            async function handleResourceFileChange(e) {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const content = await readFileAsText(file);
                    if (document.getElementById('resource-content')) document.getElementById('resource-content').value = content;
                    const resourceNameInput = document.getElementById('resource-name');
                    if (resourceNameInput && !resourceNameInput.value) {
                        resourceNameInput.value = file.name.replace(/\.[^/.]+$/, "");
                    }
                } catch(err) { showToast('오류', err.message, 'danger'); }
                e.target.value = '';
            }

            async function handleSaveResourceClick() {
                const id = document.getElementById('resource-id')?.value;
                const name = document.getElementById('resource-name')?.value.trim();
                const content = document.getElementById('resource-content')?.value;
                if (!name || !content) return showToast("오류", "이름과 내용을 모두 입력하세요.", "danger");
                const project = App.db.projects[App.db.activeProjectId];
                if (!project) return;
                if (!project.resources) project.resources = [];
                const existingResource = id ? project.resources.find(r => r.id === id) : null;
                if (existingResource) {
                    existingResource.name = name;
                    existingResource.content = content;
                } else {
                    project.resources.push({ id: `res_${Date.now()}`, name, content });
                }
                
                const success = await saveProjectToFirestore(project);
                if (success) {
                    renderResourceList();
                    if (App.bs.resourceModal) App.bs.resourceModal.hide();
                    showToast("성공", `자원이 ${id ? '수정' : '추가'}되었습니다.`, "success");
                }
            }

            async function handleApplyPlanClick() {
                if (!App.db.activeProjectId) return showToast("오류", "먼저 프로젝트를 선택하세요.", "warning");
                if (!App.db.currentUser?.uid) return showToast("오류", "로그인이 필요합니다.", "danger");
                if (!db) {
                    showToast("오류", "Firebase 데이터베이스가 초기화되지 않았습니다.", "danger");
                    return;
                }
                try {
                    const planText = App.dom.planInput?.value;
                    // Remove leading/trailing markdown code block fences if present
                    const cleanedJsonString = (planText || '').replace(/^```json\s*|```\s*$/g, '').trim(); 
                    if (!cleanedJsonString) throw new Error("입력된 내용이 없습니다.");
                    const planJSON = JSON.parse(cleanedJsonString);
                    if (!planJSON.modules || !Array.isArray(planJSON.modules)) throw new Error("JSON에 'modules' 배열이 없습니다.");
                    const project = App.db.projects[App.db.activeProjectId];
                    
                    project.learningPlan = planJSON;
                    project.name = planJSON.projectName || project.name; // Update project name from plan
                    project.goal = planJSON.mainGoal || project.goal; // Update project goal from plan
                    
                    // Initialize new fields for existing modules if they don't exist
                    project.learningPlan.modules.forEach(module => {
                        if (module.studyPad === undefined) module.studyPad = "";
                        if (module.notes === undefined) module.notes = "";
                        if (module.recommendedResources === undefined) module.recommendedResources = [];
                        if (module.status === undefined) module.status = "pending"; // Default status
                    });

                    const success = await saveProjectToFirestore(project);
                    if (success) {
                        render();
                        showToast("성공", "학습 계획이 적용되었습니다.", "success");
                    }
                } catch (e) {
                    showToast("오류", "유효하지 않은 JSON 형식입니다: " + e.message, "danger");
                }
            }
            
            function handleDashboardClick(e) {
                const target = e.target;
                const card = target.closest('.module-card');
                if (!card) return;
                const moduleIndex = card.dataset.moduleIndex;
                if (target.matches('.open-action-selector')) {
                    renderActionSelector(moduleIndex);
                } else if (target.closest('.dropdown-item.status-change-btn')) {
                    e.preventDefault();
                    updateModuleField(moduleIndex, 'status', target.closest('.dropdown-item').dataset.status);
                } else if (target.matches('.view-studypad-btn')) { 
                    e.preventDefault();
                    openStudyPadViewer(moduleIndex);
                } else if (target.matches('.view-details-btn')) { 
                    e.preventDefault();
                    const type = target.dataset.detailType;
                    openDetailViewer(moduleIndex, type);
                }
            }
            
            function handleDashboardInput(e) {
                const target = e.target;
                const card = target.closest('.module-card');
                if (!card) return;
                const index = card.dataset.moduleIndex;
                if (target.matches('.module-studypad')) {
                    updateModuleField(index, 'studyPad', target.value);
                } else if (target.matches('.module-notes')) {
                    updateModuleField(index, 'notes', target.value);
                }
            }

            function handleManageActionsClick() {
                if (!App.db.activeProjectId) return showToast("오류", "프로젝트를 선택하세요.", "warning");
                renderActionManager();
                if (App.bs.actionManagerModal) App.bs.actionManagerModal.show();
            }

            function handleActionManagerClick(e) {
                const editBtn = e.target.closest('.edit-action-btn');
                if(editBtn) openActionEditor(editBtn.dataset.actionKey);
                
                const deleteBtn = e.target.closest('.delete-action-btn');
                if(deleteBtn) deleteAction(deleteBtn.dataset.actionKey);
            }

            function handleActionSelectorClick(e) {
                const buildBtn = e.target.closest('.build-prompt-btn');
                if (buildBtn) {
                    e.preventDefault();
                    const { templateKey, moduleIndex } = buildBtn.dataset;
                    handleBuildPrompt(templateKey, moduleIndex);
                }
            }

            function handleBuildPrompt(templateKey, moduleIndex) {
                if (App.bs.actionSelectorModal) App.bs.actionSelectorModal.hide();

                const project = App.db.projects[App.db.activeProjectId];
                if (!project) return showToast('오류', '프로젝트를 찾을 수 없습니다. 새로운 프로젝트를 생성하거나 선택하세요.', 'danger');
                
                const template = (project.actions || []).find(a => a.key === templateKey);
                if (!template) return showToast('오류', '액션을 찾을 수 없습니다.', "danger");

                const module = moduleIndex !== undefined && project.learningPlan ? project.learningPlan.modules[moduleIndex] : null;

                if (App.dom.promptModalLabel) App.dom.promptModalLabel.textContent = template.title;
                if (App.dom.dynamicFormContainer) App.dom.dynamicFormContainer.innerHTML = '';
                
                if (App.dom.dataSelector) {
                    App.dom.dataSelector.innerHTML = '<option value="">자원 라이브러리에서 선택</option>';
                    (project.resources || []).forEach(r => App.dom.dataSelector.innerHTML += `<option value="${r.id}">${r.name}</option>`);
                }

                let purposeTemplate = template.purpose;
                const context = { 
                    '학습 목표': project.goal, 
                    '현재 수준': '지식이 필요한 학습자', // Default value
                    '프로젝트 이름': project.name, // Add project name to context
                    ...(module || {}) 
                };
                if (module) {
                    context['모듈 제목'] = module.title;
                    context['핵심 개념'] = (module.keyConcepts || []).join(', ') || '없음';
                    // Add recommended resources to context for template if available
                    if (module.recommendedResources && module.recommendedResources.length > 0) {
                        context['추천 리소스'] = module.recommendedResources.join(', ');
                    }
                }
                
                // Extract variables that are still [VAR_NAME] after initial pre-filling
                const variables = [...new Set([...purposeTemplate.matchAll(/\[(.*?)\]/g)].map(m => m[1]))];
                variables.forEach(varName => {
                    const prefilledValue = context[varName];
                    if (prefilledValue) {
                        purposeTemplate = purposeTemplate.replaceAll(`[${varName}]`, prefilledValue);
                    } else {
                        // Create input fields for variables that couldn't be pre-filled
                        if (App.dom.dynamicFormContainer) {
                            App.dom.dynamicFormContainer.innerHTML += `
                                <div class="mb-3">
                                    <label for="var-${varName}" class="form-label form-label-sm">${varName}</label>
                                    <input type="text" id="var-${varName}" class="form-control form-control-sm dynamic-var-input" data-var-name="${varName}" placeholder="${varName} 내용 입력...">
                                </div>
                            `;
                        }
                    }
                });

                let currentDataSource = 'none';
                if (module?.studyPad && (templateKey.startsWith('1_') || templateKey.startsWith('2_'))) {
                    currentDataSource = 'studypad';
                }
                // Reset radio buttons and then set the correct one
                document.querySelectorAll('input[name="dataSource"]').forEach(radio => {
                    radio.checked = false;
                    if (radio.id === `source-${currentDataSource}`) {
                        radio.checked = true;
                    }
                });

                if (document.getElementById('data-direct-input')) document.getElementById('data-direct-input').value = '';

                const dataSourceContainers = {
                    resource: document.getElementById('data-selector-container'),
                    direct: document.getElementById('data-direct-input-container'),
                };
                
                const updateDataSourceVisibility = () => {
                    const selected = document.querySelector('input[name="dataSource"]:checked')?.value;
                    Object.values(dataSourceContainers).forEach(c => { if (c) c.classList.add('hidden'); });
                    if (dataSourceContainers[selected]) {
                        dataSourceContainers[selected].classList.remove('hidden');
                    }
                };

                const updatePreview = () => {
                    let previewPurpose = purposeTemplate;
                    // Fill in dynamic variables from user input
                    if (App.dom.dynamicFormContainer) {
                        App.dom.dynamicFormContainer.querySelectorAll('.dynamic-var-input').forEach(input => {
                            const varName = input.dataset.varName;
                            const value = input.value || `[${varName}]`; // Keep placeholder if empty
                            previewPurpose = previewPurpose.replaceAll(`[${varName}]`, value);
                        });
                    }
                    
                    const selectedDataSource = document.querySelector('input[name="dataSource"]:checked')?.value;
                    let dataContent = '내용 없음';
                    if (selectedDataSource === 'resource') {
                        const resId = App.dom.dataSelector?.value;
                        if (resId) dataContent = (project.resources.find(r => r.id === resId) || {}).content;
                    } else if (selectedDataSource === 'studypad') {
                        if (module?.studyPad) dataContent = module.studyPad;
                    } else if (selectedDataSource === 'direct') {
                        if (document.getElementById('data-direct-input')) dataContent = document.getElementById('data-direct-input').value;
                    }
                    
                    const contextForAI = {
                        projectName: project.name,
                        mainGoal: project.goal,
                    };
                    if (project.learningPlan) {
                        contextForAI.tutorPersona = project.learningPlan.tutorPersona;
                        contextForAI.fullTableOfContents = project.learningPlan.modules.map(m => ({ id: m.id, title: m.title, status: m.status }));
                    }
                    if (module) {
                        const { studyPad, notes, ...currentModuleContext } = module;
                        contextForAI.currentModule = currentModuleContext;
                    }
                    const projectContext = JSON.stringify(contextForAI, null, 2);
                    let finalPrompt = MASTER_PROMPT_SHELL.replace(/{{purpose}}/g, previewPurpose)
                                                         .replace(/{{data}}/g, dataContent || '내용 없음')
                                                         .replace(/{{projectContext}}/g, projectContext);
                    if (App.dom.livePreviewContainer) App.dom.livePreviewContainer.textContent = finalPrompt;
                };

                // Add event listeners for data source radios and dynamic inputs
                document.querySelectorAll('input[name="dataSource"]').forEach(radio => radio.onchange = () => {
                    updateDataSourceVisibility();
                    updatePreview();
                });

                App.dom.dynamicFormContainer?.addEventListener('input', updatePreview);
                App.dom.dataSelector?.addEventListener('change', updatePreview);
                document.getElementById('data-direct-input')?.addEventListener('input', updatePreview);
                
                updateDataSourceVisibility();
                updatePreview(); // Initial preview update
                if (App.bs.promptModal) App.bs.promptModal.show();
            }

            function handleExecutePromptClick() {
                const finalPromptText = App.dom.livePreviewContainer ? App.dom.livePreviewContainer.textContent : '';
                copyToClipboard(finalPromptText);
            }
            
            function toggleSidebar() {
                if (App.dom.sidebar) App.dom.sidebar.classList.toggle('is-open');
                if (App.dom.overlay) App.dom.overlay.classList.toggle('is-visible');
            }

            // Project Search Handlers
            function handleProjectSearchInput(e) {
                App.state.currentProjectSearchQuery = e.target.value;
                renderProjectList();
            }

            function handleClearProjectSearch() {
                if (App.dom.projectSearchInput) App.dom.projectSearchInput.value = '';
                App.state.currentProjectSearchQuery = '';
                renderProjectList();
            }

            // --- 6. Initial Execution ---
            initApp();
        });
    </script>
</body>
</html>
