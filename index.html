<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통합 학습 환경 (ILE) v9.3 - UI 문제 수정 및 최적화</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- MathJax for LaTeX rendering in Markdown -->
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        // MathJax configuration for inline and display math
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    
    <style>
        /* Custom Tailwind CSS Configuration (replacing original :root variables) */
        :root {
            --color-bg-primary: #f5f7fa; /* Lighter background */
            --color-bg-secondary: #eef1f6; /* Sidebar, lighter gray */
            --color-card-background: #ffffff; /* Card and modal backgrounds - pure white */
            --color-accent-primary: #3b82f6; /* A more vibrant blue */
            --color-accent-primary-hover: #2563eb; /* Darker blue for hover */
            --color-text-primary: #1f2937; /* Dark charcoal */
            --color-text-secondary: #6b7280; /* Medium gray */
            --color-text-placeholder: #9ca3af; /* Light gray */
            --color-border-color: #d1d5db; /* Light border */
            --color-input-bg: #f9fafb; /* Very light input background */
            --color-success: #22c55e; /* Green */
            --color-warning: #facc15; /* Yellow */
            --color-danger: #ef4444; /* Red */
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Prevent overall scroll, main-content handles scrolling */
        }
        body {
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            font-size: 1rem; /* Base font size */
            line-height: 1.7; /* Improved readability */
        }

        /* Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--color-bg-secondary);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--color-border-color);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-text-secondary);
        }

        /* Main layout container using Flexbox (for mobile) and Grid (for desktop) */
        .ile-container {
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
        }

        /* Sidebar styling */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100%;
            background-color: var(--color-bg-secondary);
            border-right: 1px solid var(--color-border-color);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1.5rem 1rem;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            z-index: 1100;
            overflow-y: auto;
            box-shadow: 0 0 25px rgba(0,0,0,0.1); /* Subtle shadow for mobile sidebar */
        }
        .sidebar.is-open {
            transform: translateX(0);
            box-shadow: 0 0 40px rgba(0,0,0,0.25); /* More prominent shadow when open */
        }

        /* Main content area */
        .main-content {
            overflow-y: auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .main-content-inner {
            padding: 1.5rem;
            flex-grow: 1; /* Allow inner content to take available space */
        }

        /* Mobile Header */
        .mobile-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1.5rem;
            background-color: var(--color-card-background); /* Primary background for header */
            border-bottom: 1px solid var(--color-border-color);
            position: sticky;
            top: 0;
            z-index: 1000;
            color: var(--color-text-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* Subtle shadow for header */
        }
        .mobile-header .hamburger-btn {
            background: none;
            border: none;
            color: var(--color-text-primary);
            font-size: 1.5rem;
            padding: 0.5rem;
            line-height: 1;
            cursor: pointer;
        }
        .mobile-header .project-title-mobile {
            font-size: 1.1rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
            text-align: center;
            margin-right: 2.5rem;
        }

        /* Overlay for mobile sidebar */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.45);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            z-index: 1099;
        }
        .overlay.is-visible {
            opacity: 1;
            visibility: visible;
        }

        /* Sidebar Header & Titles */
        .sidebar-header {
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--color-border-color);
            margin-bottom: 1rem;
        }
        .sidebar-header h4 {
            font-size: 1.35rem;
            color: var(--color-text-primary);
            font-weight: 700;
        }
        .sidebar-title {
            font-size: 1.05rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--color-text-primary);
        }
        .sidebar-section {
            margin-bottom: 1.5rem;
        }
        .sidebar-section:last-of-type {
            margin-bottom: 0;
        }

        /* Project List Container - now a grid */
        .project-list-section .list-group {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--color-border-color);
            border-radius: 0.5rem;
            display: grid;
            grid-template-columns: 1fr; /* Single column on mobile */
            gap: 0.5rem;
            padding: 0.5rem;
        }
        @media (min-width: 640px) { /* Tailwind's sm breakpoint */
            .project-list-section .list-group {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); /* Two columns on small screens */
            }
        }

        /* Project Card Styling */
        .project-card {
            background-color: var(--color-card-background);
            border: 1px solid var(--color-border-color);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            word-break: break-all;
            padding: 0.8rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
            text-decoration: none;
            min-height: 80px;
        }
        .project-card:hover {
            background-color: var(--color-input-bg);
            color: var(--color-text-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .project-card.active {
            background-color: var(--color-accent-primary);
            color: white;
            border-color: var(--color-accent-primary);
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); /* Adjusted for Tailwind blue RGB */
        }
        .project-card .project-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: inherit;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
        }
        .project-card .delete-btn {
            opacity: 0.6;
            transition: opacity 0.2s, transform 0.2s;
            color: var(--color-text-secondary);
            padding: 0.25rem;
            border-radius: 50%;
            align-self: flex-end;
            margin-top: auto;
        }
        .project-card:hover .delete-btn {
            opacity: 1;
            color: var(--color-danger);
            transform: scale(1.1);
        }

        /* Main Header for Project Workspace */
        .main-header {
            background-color: var(--color-card-background);
            padding: 2rem;
            border-radius: 0.75rem; /* Larger radius for main header */
            border: 1px solid var(--color-border-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 2rem !important; /* Ensure spacing */
            text-align: center;
        }
        .main-header h1 {
            font-weight: 700;
            font-size: 2.5rem;
            color: var(--color-accent-primary);
            margin-bottom: 0.75rem;
        }
        .main-header p {
            color: var(--color-text-secondary);
            font-size: 1.15rem;
            line-height: 1.6;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        /* General card styling (for planning and progress sections) */
        .app-card {
            background-color: var(--color-card-background);
            border: 1px solid var(--color-border-color);
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 2rem;
            margin-bottom: 2rem !important;
        }
        .app-card h5 {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--color-accent-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
        }
        .app-card h5 .fa-solid {
            margin-right: 0.75rem;
            color: var(--color-text-primary); /* Icon color */
        }

        /* Responsive Module Grid */
        .module-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        @media (min-width: 640px) { /* sm */
            .module-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
        }
        @media (min-width: 768px) { /* md */
            .module-grid { grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }
        }
        @media (min-width: 1024px) { /* lg */
            .module-grid { grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); }
        }
        @media (min-width: 1280px) { /* xl */
            .module-grid { grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); }
        }
        @media (min-width: 1536px) { /* 2xl */
            .module-grid { grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); }
        }

        /* Module Card styling */
        .module-card {
            background-color: var(--color-card-background);
            border-left: 6px solid var(--color-border-color); /* Thicker left border for status */
            padding: 1.5rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--color-border-color);
            color: var(--color-text-primary);
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 240px; /* Ensure consistent height */
        }
        .module-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        /* Module status borders */
        .module-card.status-pending { border-left-color: var(--color-text-secondary); }
        .module-card.status-inprogress { border-left-color: var(--color-warning); }
        .module-card.status-completed { border-left-color: var(--color-success); }

        /* Dropdown button for status change */
        .module-card .dropdown-toggle {
            background-color: var(--color-input-bg);
            border-color: var(--color-border-color);
            color: var(--color-text-secondary);
            font-weight: 500;
            padding: 0.4rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            display: inline-flex; /* Use flex to align icon and text */
            align-items: center;
        }
        .module-card .dropdown-toggle:hover {
            background-color: var(--color-border-color);
        }
        .module-card .dropdown-toggle::after { /* Custom dropdown arrow */
            display: inline-block;
            margin-left: 0.5em;
            vertical-align: 0.05em;
            content: "";
            border-top: 0.3em solid;
            border-right: 0.3em solid transparent;
            border-bottom: 0;
            border-left: 0.3em solid transparent;
        }
        .module-card .dropdown-menu {
            background-color: var(--color-card-background);
            border: 1px solid var(--color-border-color);
            border-radius: 0.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .module-card .dropdown-item {
            color: var(--color-text-primary);
            font-weight: 500;
            padding: 0.65rem 1.25rem;
        }
        .module-card .dropdown-item:hover {
            background-color: var(--color-input-bg);
            color: var(--color-accent-primary);
        }
        .module-card .status-change-btn[data-status="pending"]:hover { color: var(--color-text-secondary) !important; }
        .module-card .status-change-btn[data-status="inprogress"]:hover { color: var(--color-warning) !important; }
        .module-card .status-change-btn[data-status="completed"]:hover { color: var(--color-success) !important; }

        /* Modals */
        .modal-content {
            background-color: var(--color-card-background);
            border: 1px solid var(--color-border-color);
            color: var(--color-text-primary);
            border-radius: 0.75rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .modal-header {
            border-bottom: 1px solid var(--color-border-color);
            padding: 1.5rem 2rem;
        }
        .modal-title {
            color: var(--color-text-primary);
            font-weight: 700;
            font-size: 1.5rem;
        }
        .modal-body {
            padding: 1.75rem 2rem;
        }
        .modal-footer {
            border-top: 1px solid var(--color-border-color);
            padding: 1.25rem 2rem;
        }
        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            opacity: 0.7;
            transition: opacity 0.2s, transform 0.2s;
            color: var(--color-text-secondary);
        }
        .btn-close:hover {
            opacity: 1;
            transform: rotate(90deg);
        }
        .btn-close:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25);
            opacity: 1;
        }

        /* Form Controls */
        .form-control, .form-select {
            background-color: var(--color-input-bg);
            color: var(--color-text-primary);
            border-color: var(--color-border-color);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            transition: all 0.2s ease-in-out;
        }
        .form-control::placeholder {
            color: var(--color-text-placeholder);
            opacity: 0.8;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--color-accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
            background-color: var(--color-card-background);
        }
        .form-label {
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 0.6rem;
            font-size: 0.9rem;
        }
        .form-label.small {
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Study Pad Textarea Height */
        .module-studypad, .module-notes {
            min-height: 120px; /* Slightly more space */
            resize: vertical;
        }

        /* Live Preview Container for Prompts */
        #live-preview-container {
            background-color: var(--color-input-bg);
            border-radius: 0.5rem;
            padding: 1.5rem;
            font-family: 'SFMono-Regular', Consolas, Menlo, monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid var(--color-border-color);
            min-height: 250px;
            max-height: 55vh; /* Responsive height */
            overflow-y: auto;
            color: var(--color-text-primary);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.03);
            line-height: 1.6;
        }

        /* Toast notifications */
        .toast {
            background-color: var(--color-card-background);
            border-left: 6px solid; /* Thicker border */
            color: var(--color-text-primary);
            border-radius: 0.75rem;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            padding: 0.75rem 1rem;
        }
        .toast-header {
            background-color: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-border-color);
            color: var(--color-text-primary);
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.6rem 0.6rem 0 0;
        }
        .toast .btn-close {
            filter: none;
        }

        /* Action Category and List Items */
        .action-category {
            border-left: 5px solid var(--color-accent-primary);
            padding-left: 1.5rem;
            color: var(--color-text-primary);
            margin-bottom: 2rem;
        }
        .action-category h6 {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--color-accent-primary);
            margin-bottom: 1rem;
        }
        .action-list-item {
            background-color: var(--color-input-bg);
            border: 1px solid var(--color-border-color);
            color: var(--color-text-primary);
            border-radius: 0.5rem;
            padding: 1rem 1.5rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        .action-list-item:hover {
            background-color: var(--color-bg-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        /* Markdown Viewer styles for study pad content */
        #study-pad-viewer-content {
            background-color: var(--color-input-bg);
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--color-border-color);
            min-height: 300px; /* Increased min-height */
            max-height: 70vh; /* Flexible max height */
            overflow-y: auto;
            color: var(--color-text-primary);
            font-size: 1.05rem;
            line-height: 1.8;
        }
        #study-pad-editor-content {
            min-height: 300px;
            max-height: 70vh;
            resize: vertical;
            font-family: 'SFMono-Regular', Consolas, Menlo, monospace;
            font-size: 0.95rem;
        }
        /* Markdown headings */
        #study-pad-viewer-content h1, #study-pad-viewer-content h2, #study-pad-viewer-content h3,
        #study-pad-viewer-content h4, #study-pad-viewer-content h5, #study-pad-viewer-content h6 {
            color: var(--color-accent-primary);
            margin-top: 2em;
            margin-bottom: 1em;
            font-weight: 700;
        }
        #study-pad-viewer-content h1 { font-size: 2.5em; }
        #study-pad-viewer-content h2 { font-size: 2em; }
        #study-pad-viewer-content h3 { font-size: 1.7em; }
        #study-pad-viewer-content h4 { font-size: 1.4em; }
        
        #study-pad-viewer-content p {
            margin-bottom: 1em;
            line-height: 1.8;
        }
        #study-pad-viewer-content ul, #study-pad-viewer-content ol {
            margin-bottom: 1em;
            padding-left: 2em;
        }
        #study-pad-viewer-content li {
            margin-bottom: 0.8em;
        }
        #study-pad-viewer-content pre {
            background-color: var(--color-bg-secondary);
            padding: 1.5em;
            border-radius: 0.5rem;
            overflow-x: auto;
            border: 1px solid var(--color-border-color);
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'SFMono-Regular', Consolas, Menlo, monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        #study-pad-viewer-content code {
            font-family: 'SFMono-Regular', Consolas, Menlo, monospace;
            background-color: rgba(59, 130, 246, 0.1); /* Light accent background for inline code */
            color: var(--color-accent-primary);
            padding: 0.25em 0.5em;
            border-radius: 0.25em;
        }
        #study-pad-viewer-content a {
            color: var(--color-accent-primary);
            text-decoration: underline;
        }
        #study-pad-viewer-content a:hover {
            text-decoration: none;
            opacity: 0.9;
        }
        #study-pad-viewer-content blockquote {
            border-left: 6px solid var(--color-accent-primary);
            padding-left: 1.8em;
            margin: 1.5em 0;
            color: var(--color-text-secondary);
            background-color: var(--color-input-bg);
            border-radius: 0 0.4em 0.4em 0;
            padding-top: 1em;
            padding-bottom: 1em;
            font-style: italic;
        }
        #study-pad-viewer-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2em;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        #study-pad-viewer-content th, #study-pad-viewer-content td {
            border: 1px solid var(--color-border-color);
            padding: 0.8em 1.2em;
            text-align: left;
            vertical-align: top;
        }
        #study-pad-viewer-content th {
            background-color: var(--color-bg-secondary);
            font-weight: 600;
            color: var(--color-text-primary);
        }
        #study-pad-viewer-content tr:nth-child(even) {
            background-color: var(--color-input-bg);
        }


        /* Button styles: Enhanced for aesthetics and consistency */
        .btn {
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background-color: var(--color-accent-primary);
            border-color: var(--color-accent-primary);
            color: white;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.2);
        }
        .btn-primary:hover {
            background-color: var(--color-accent-primary-hover);
            border-color: var(--color-accent-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(59, 130, 246, 0.3);
        }
        .btn-outline-primary {
            color: var(--color-accent-primary);
            border: 1px solid var(--color-accent-primary);
            background-color: transparent;
        }
        .btn-outline-primary:hover {
            background-color: var(--color-accent-primary);
            color: white;
            transform: translateY(-2px);
        }
        .btn-info {
            background-color: #1d95b7; /* Custom info color, more teal-like */
            border-color: #1d95b7;
            color: white;
        }
        .btn-info:hover {
            background-color: #177f9e;
            border-color: #177f9e;
            transform: translateY(-2px);
        }
        .btn-success {
            background-color: var(--color-success);
            border-color: var(--color-success);
            color: white;
        }
        .btn-success:hover {
            background-color: #16a34a;
            border-color: #16a34a;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: var(--color-text-secondary);
            border-color: var(--color-text-secondary);
            color: white;
        }
        .btn-secondary:hover {
            background-color: #555c69;
            border-color: #555c69;
            transform: translateY(-2px);
        }
        .btn-outline-secondary {
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border-color);
            background-color: transparent;
        }
        .btn-outline-secondary:hover {
            background-color: var(--color-input-bg);
            color: var(--color-text-primary);
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        /* Action selector buttons */
        .btn-action-light {
            color: var(--color-text-primary);
            border: 1px solid var(--color-border-color);
            background-color: var(--color-card-background);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            font-weight: 500;
        }
        .btn-action-light:hover {
            background-color: var(--color-input-bg);
            color: var(--color-accent-primary);
            border-color: var(--color-accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        .btn-outline-danger {
            color: var(--color-danger);
            border: 1px solid var(--color-danger);
            background-color: transparent;
        }
        .btn-outline-danger:hover {
            background-color: var(--color-danger);
            color: white;
            transform: translateY(-2px);
        }

        /* Modal specific adjustments for z-index and appearance */
        /* Fixed: Ensure modals are on top */
        .modal-backdrop.show {
            opacity: 0.5; /* Default Bootstrap opacity */
            z-index: 1050; /* Bootstrap default for backdrop */
        }
        .modal.show {
            display: block; /* Bootstrap sets display: block for showing */
            z-index: 1060; /* Bootstrap default for modal */
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Progress Bar styling */
        .progress {
            height: 32px; /* Taller progress bar */
            background-color: var(--color-input-bg);
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid var(--color-border-color);
        }
        .progress-bar {
            background-color: var(--color-accent-primary);
            font-weight: 600;
            font-size: 1rem;
            line-height: 32px;
            color: white;
            transition: width 0.6s ease-in-out, background-color 0.3s ease-in-out;
        }

        /* Status counts section */
        .status-counts .col-span-1 {
            padding: 0 0.75rem;
        }
        .status-counts p {
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 0.4rem;
        }
        .status-counts h6 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 0;
        }
        .fa-check-circle { color: var(--color-success); }
        .fa-hourglass-half { color: var(--color-warning); }
        .fa-clock { color: var(--color-text-secondary); }

        /* Responsive adjustments for desktop layout */
        @media (min-width: 1024px) { /* lg breakpoint */
            body { font-size: 16px; }
            .ile-container {
                display: grid;
                grid-template-columns: 280px 1fr;
            }
            .sidebar {
                position: static;
                transform: none;
                box-shadow: none;
                padding-top: 2rem;
            }
            .mobile-header { /* Fixed: Hide mobile header on desktop */
                display: none;
            }
            .overlay { /* Fixed: Hide overlay on desktop */
                display: none;
            }
            .main-content {
                height: 100vh;
            }
            .main-content-inner {
                padding: 2.5rem;
            }
        }

        /* New styles for learning objectives/keywords preview in module cards */
        .module-card .learning-objectives-preview,
        .module-card .key-concepts-preview,
        .module-card .resources-preview {
            max-height: 4.8em; /* Approx 3 lines */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            white-space: normal;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .module-card .view-details-btn {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--color-accent-primary);
            text-decoration: none;
            margin-top: 0.4rem;
        }
        .module-card .view-details-btn:hover {
            text-decoration: underline;
        }

        /* Specific adjustments for input within module cards */
        .module-card .form-control.module-studypad,
        .module-card .form-control.module-notes {
            min-height: 90px; /* Keep individual textareas concise but a bit more */
            padding: 0.6rem 0.9rem;
            font-size: 0.9rem;
        }

        /* Buttons within module cards */
        .module-card .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* Utility classes for consistent gaps (Tailwind's default gaps are often fine) */
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .gap-8 { gap: 2rem; }

        /* Help icon style */
        .help-icon {
            color: var(--color-text-secondary);
            cursor: pointer;
            margin-left: 0.5rem;
            transition: color 0.2s ease-in-out;
            position: relative; /* For tooltip positioning */
        }
        .help-icon:hover {
            color: var(--color-accent-primary);
        }

        /* Help tooltip/popover style */
        .help-tooltip {
            position: absolute;
            background-color: #333;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            pointer-events: none; /* Allows clicks to pass through to elements behind it */
            transform: translate(-50%, -100%); /* Center horizontally, position above */
        }
        /* Fixed: Tooltip position adjustments */
        .help-icon:hover > .help-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* Fixed: Mobile sidebar specific styling */
        @media (max-width: 1023px) { /* targets screens smaller than desktop (lg) */
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.is-open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0; /* Remove fixed margin for mobile */
            }
            .mobile-header {
                display: flex; /* Show mobile header on mobile */
            }
            .overlay.is-visible {
                display: block; /* Show overlay on mobile */
            }
            /* Fixed: Ensure main content moves when sidebar is open, but only if needed */
            body.sidebar-open {
                overflow: hidden; /* Prevent body scroll when sidebar is open */
            }
        }
    </style>
</head>
<body>
    <div class="ile-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header flex items-center justify-between">
                <h4 class="text-xl font-bold">ILE v9.3</h4>
                <i class="fa-solid fa-question-circle help-icon" data-help-key="sidebar-title">
                    <span class="help-tooltip"></span>
                </i>
            </div>
            
            <!-- Firebase Auth Section -->
            <div class="sidebar-section mb-4">
                <div class="flex items-center justify-between">
                    <div id="auth-status" class="text-sm text-gray-500">로그인 필요</div>
                    <i class="fa-solid fa-question-circle help-icon" data-help-key="auth-status">
                        <span class="help-tooltip"></span>
                    </i>
                </div>
                <button class="btn btn-primary w-full mt-3" id="google-signin-btn"><i class="fa-brands fa-google mr-2"></i>Google 로그인</button>
                <button class="btn btn-outline-danger w-full mt-2 hidden" id="signout-btn"><i class="fa-solid fa-right-from-bracket mr-2"></i>로그아웃</button>
            </div>

            <!-- Project Controls -->
            <div class="sidebar-section mb-4">
                <div class="flex items-center justify-between mb-2">
                    <button class="btn btn-primary w-full" id="new-project-page-btn">새 프로젝트 생성</button>
                    <i class="fa-solid fa-question-circle help-icon" data-help-key="new-project">
                        <span class="help-tooltip"></span>
                    </i>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-outline-secondary flex-grow" id="import-project-btn"><i class="fa-solid fa-file-import mr-2"></i>가져오기</button>
                    <input type="file" id="import-file-input" class="hidden" accept=".json,application/json">
                    <button class="btn btn-outline-secondary flex-grow" id="export-project-btn"><i class="fa-solid fa-file-export mr-2"></i>내보내기</button>
                </div>
            </div>

            <!-- Project List Section -->
            <div class="sidebar-section flex-grow mb-4" style="max-height: calc(100% - 300px);">
                <div class="flex items-center justify-between">
                    <h6 class="text-lg font-semibold">프로젝트</h6>
                    <i class="fa-solid fa-question-circle help-icon" data-help-key="project-list">
                        <span class="help-tooltip"></span>
                    </i>
                </div>
                <div class="flex mb-3 mt-2">
                    <input type="text" class="form-control flex-grow" id="project-search-input" placeholder="프로젝트 검색...">
                    <button class="btn btn-outline-secondary px-3" type="button" id="clear-project-search-btn"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div id="project-list" class="list-group border rounded-md overflow-y-auto" style="max-height: 180px;"></div>
            </div>
            
            <!-- Resource Library Section -->
            <div class="sidebar-section mb-4">
                <div class="flex items-center justify-between">
                    <h6 class="text-lg font-semibold">자원 라이브러리</h6>
                    <i class="fa-solid fa-question-circle help-icon" data-help-key="resource-library">
                        <span class="help-tooltip"></span>
                    </i>
                </div>
                <button class="btn btn-outline-primary w-full mt-2" id="resource-management-page-btn"><i class="fa-solid fa-folder-open mr-2"></i>자원 관리</button>
                <div id="resource-list" class="list-group border rounded-md overflow-y-auto max-h-36 mt-2"></div>
            </div>

            <!-- Bottom Action Buttons -->
            <div class="mt-auto pt-3 grid gap-2">
                <button class="btn btn-success w-full" id="download-studypad-btn"><i class="fa-solid fa-book mr-2"></i>스터디 패드 전체 다운로드</button>
                <button class="btn btn-secondary w-full" id="action-management-page-btn"><i class="fa-solid fa-gears mr-2"></i>액션 관리자</button>
                <div class="flex items-center justify-between text-sm mt-3">
                    <span>도움말 표시:</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-help-btn" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <!-- Mobile Header (hidden on large screens) -->
            <header class="mobile-header p-3 bg-white border-b sticky top-0 z-10">
                <button class="hamburger-btn text-2xl" id="hamburger-btn" aria-label="메뉴 열기">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <h2 class="text-lg font-semibold flex-grow text-center">ILE v9.3</h2>
            </header>

            <div class="main-content-inner">
                <!-- Welcome Screen (Page) -->
                <div id="welcome-screen" class="page-container flex flex-col items-center justify-center text-center">
                    <div class="bg-white p-8 rounded-lg shadow-md max-w-lg w-full">
                        <h1 class="text-4xl font-extrabold text-blue-600 mb-4">학습 사령부</h1>
                        <p class="text-lg text-gray-700">지식을 탐험하고, 연습하고, 창조하세요.</p>
                        <p class="text-base text-gray-600 mt-4">왼쪽 메뉴에서 새 프로젝트를 생성하거나 선택하여 시작하세요.</p>
                    </div>
                </div>

                <!-- Project Workspace (Page) -->
                <div id="project-workspace" class="page-container hidden">
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6 text-center">
                        <h1 id="project-title-main" class="text-3xl font-bold text-blue-600 mb-2"></h1>
                        <p id="project-goal" class="text-gray-700 text-lg"></p>
                    </div>
                    
                    <!-- Phase 0: Planning Section -->
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h5 class="text-xl font-semibold text-blue-600 mb-4 flex items-center">
                            <i class="fa-solid fa-compass mr-3"></i>Phase 0: 학습 계획 수립 
                            <i class="fa-solid fa-question-circle help-icon" data-help-key="plan-section">
                                <span class="help-tooltip"></span>
                            </i>
                        </h5>
                        <button class="btn btn-outline-primary w-full mb-4" id="plan-button" data-template-key="0_plan">
                            <i class="fa-solid fa-map-location-dot mr-2"></i>AI 튜터 페르소나 설계 및 학습 계획 생성
                        </button>
                        <textarea class="form-control h-40" id="plan-input" placeholder="AI가 생성한 학습 계획 JSON을 여기에 붙여넣으세요..."></textarea>
                        <button class="btn btn-info w-full mt-4" id="apply-plan-btn">
                            <i class="fa-solid fa-play-circle mr-2"></i>학습 계획 적용 및 워크스페이스 구축
                        </button>
                    </div>

                    <hr class="my-6 border-gray-300">

                    <!-- Learning Progress Section -->
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h5 class="text-xl font-semibold text-blue-600 mb-4 flex items-center">
                            <i class="fa-solid fa-chart-pie mr-3"></i>학습 진행도 분석 
                            <i class="fa-solid fa-question-circle help-icon" data-help-key="progress-section">
                                <span class="help-tooltip"></span>
                            </i>
                        </h5>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">전체 진행률</label>
                            <div class="progress h-8 bg-gray-200 rounded-lg overflow-hidden">
                                <div class="progress-bar h-full flex items-center justify-center text-white font-semibold text-base bg-blue-500 transition-all duration-300" role="progressbar" id="overall-progress-bar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 text-center mt-6">
                            <div class="col-span-1">
                                <p class="text-green-600 mb-1"><i class="fa-solid fa-check-circle mr-1"></i> 완료</p>
                                <h6 class="text-green-600 text-2xl font-bold" id="completed-modules-count">0</h6>
                            </div>
                            <div class="col-span-1">
                                <p class="text-yellow-500 mb-1"><i class="fa-solid fa-hourglass-half mr-1"></i> 진행 중</p>
                                <h6 class="text-yellow-500 text-2xl font-bold" id="inprogress-modules-count">0</h6>
                            </div>
                            <div class="col-span-1">
                                <p class="text-gray-500 mb-1"><i class="fa-solid fa-clock mr-1"></i> 대기</p>
                                <h6 class="text-gray-500 text-2xl font-bold" id="pending-modules-count">0</h6>
                            </div>
                        </div>
                        <!-- Chart.js for data visualization -->
                        <div class="mt-6">
                            <canvas id="module-status-chart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <hr class="my-6 border-gray-300">

                    <h5 class="text-xl font-semibold text-blue-600 mb-6 flex items-center">
                        <i class="fa-solid fa-chalkboard-user mr-3"></i>Phase 1 & 2: 학습 및 실행 대시보드 
                        <i class="fa-solid fa-question-circle help-icon" data-help-key="dashboard-section">
                            <span class="help-tooltip"></span>
                        </i>
                    </h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="learning-dashboard"></div>
                </div>

                <!-- Project Creation Page (New Page) -->
                <div id="project-creation-page" class="page-container hidden">
                    <div class="bg-white p-8 rounded-lg shadow-md max-w-2xl mx-auto">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800">새 프로젝트 생성</h2>
                        <form id="new-project-form-page">
                            <div class="mb-4">
                                <label for="new-project-name-page" class="form-label block text-gray-700 text-sm font-bold mb-2">프로젝트 이름</label>
                                <input type="text" id="new-project-name-page" class="form-control" required>
                            </div>
                            <div class="mb-6">
                                <label for="new-project-goal-page" class="form-label block text-gray-700 text-sm font-bold mb-2">최종 학습 목표</label>
                                <textarea id="new-project-goal-page" class="form-control h-32 resize-y" rows="4" required></textarea>
                            </div>
                            <div class="flex justify-end gap-3">
                                <button type="button" class="btn btn-secondary" id="cancel-new-project-page-btn">취소</button>
                                <button type="button" class="btn btn-primary" id="save-project-page-btn">생성</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Resource Management Page (New Page) -->
                <div id="resource-management-page" class="page-container hidden">
                    <div class="bg-white p-8 rounded-lg shadow-md max-w-3xl mx-auto">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                            자원 관리 
                            <i class="fa-solid fa-question-circle help-icon" data-help-key="resource-management">
                                <span class="help-tooltip"></span>
                            </i>
                        </h2>
                        <div class="mb-4">
                            <button type="button" class="btn btn-primary mb-4" id="add-resource-page-btn"><i class="fa-solid fa-plus-circle mr-2"></i>새 자원 추가</button>
                            <input type="hidden" id="resource-id-page">
                            <div class="mb-4">
                                <label for="resource-name-page" class="form-label">자원 이름</label>
                                <input type="text" id="resource-name-page" class="form-control" placeholder="예: 1장 - 뉴턴 역학">
                            </div>
                            <div class="mb-4">
                                <label for="resource-content-page" class="form-label">내용</label>
                                <textarea id="resource-content-page" class="form-control h-48 resize-y"></textarea>
                            </div>
                            <div class="mb-6">
                                <label for="resource-file-input-page" class="form-label">파일에서 불러오기</label>
                                <input type="file" id="resource-file-input-page" class="form-control" accept=".txt,.md,.pdf,.json">
                            </div>
                            <div class="flex justify-end gap-3">
                                <button type="button" class="btn btn-secondary" id="clear-resource-form-btn">초기화</button>
                                <button type="button" class="btn btn-primary" id="save-resource-page-btn">저장</button>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold mt-8 mb-4 text-gray-800">현재 자원 목록</h3>
                        <div id="resource-list-page" class="list-group border rounded-md"></div>
                        <button type="button" class="btn btn-secondary mt-6" id="back-from-resource-management-btn">대시보드로 돌아가기</button>
                    </div>
                </div>

                <!-- Action Management Page (New Page) -->
                <div id="action-management-page" class="page-container hidden">
                    <div class="bg-white p-8 rounded-lg shadow-md max-w-3xl mx-auto">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                            액션 관리자 
                            <i class="fa-solid fa-question-circle help-icon" data-help-key="action-manager">
                                <span class="help-tooltip"></span>
                            </i>
                        </h2>
                        <div class="mb-6">
                            <button type="button" class="btn btn-success mb-4" id="add-new-action-page-btn"><i class="fa-solid fa-plus mr-2"></i>새 액션 추가</button>
                            <form id="action-editor-form-page" class="hidden border p-4 rounded-md mb-4">
                                <input type="hidden" id="action-key-input-page">
                                <div class="mb-4">
                                    <label for="action-title-input-page" class="form-label">액션 제목</label>
                                    <input type="text" class="form-control" id="action-title-input-page" required>
                                </div>
                                <div class="mb-4">
                                    <label for="action-category-input-page" class="form-label">카테고리</label>
                                    <input type="text" class="form-control" id="action-category-input-page" placeholder="예: 이해, 연습, 창조" required>
                                </div>
                                <div class="mb-6">
                                    <label for="action-purpose-input-page" class="form-label">Purpose 템플릿</label>
                                    <textarea class="form-control h-48 resize-y" id="action-purpose-input-page" rows="12" placeholder="[모듈 제목] 등 변수를 사용하세요."></textarea>
                                </div>
                                <div class="flex justify-end gap-3">
                                    <button type="button" class="btn btn-secondary" id="cancel-edit-action-btn">취소</button>
                                    <button type="button" class="btn btn-primary" id="save-action-page-btn">저장</button>
                                </div>
                            </form>
                        </div>
                        <h3 class="text-xl font-bold mb-4 text-gray-800">정의된 액션 목록</h3>
                        <div id="action-list-container-page" class="list-group"></div>
                        <button type="button" class="btn btn-secondary mt-6" id="back-from-action-management-btn">대시보드로 돌아가기</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Mobile Overlay -->
    <div class="overlay fixed inset-0 bg-black bg-opacity-50 z-40 hidden" id="overlay"></div>
    
    <!-- Modals (Remaining as Modals) -->

    <!-- Prompt Generation Modal -->
    <div class="modal fade" id="promptModal" tabindex="-1" aria-labelledby="promptModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="promptModalLabel"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-1">
                            <div id="dynamic-form-container" class="mb-4"></div>
                            <div id="data-source-container" class="mb-4">
                                <label class="form-label font-bold text-sm">데이터 소스</label>
                                <div class="flex flex-wrap gap-x-4 gap-y-2 mt-2">
                                    <div class="flex items-center">
                                        <input class="form-checkbox h-4 w-4 text-blue-600 rounded" type="radio" name="dataSource" id="source-none" value="none" checked>
                                        <label class="ml-2 text-gray-700 text-sm" for="source-none">없음</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input class="form-checkbox h-4 w-4 text-blue-600 rounded" type="radio" name="dataSource" id="source-resource" value="resource">
                                        <label class="ml-2 text-gray-700 text-sm" for="source-resource">자원</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input class="form-checkbox h-4 w-4 text-blue-600 rounded" type="radio" name="dataSource" id="source-studypad" value="studypad">
                                        <label class="ml-2 text-gray-700 text-sm" for="source-studypad">스터디 패드</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input class="form-checkbox h-4 w-4 text-blue-600 rounded" type="radio" name="dataSource" id="source-direct" value="direct">
                                        <label class="ml-2 text-gray-700 text-sm" for="source-direct">직접 입력</label>
                                    </div>
                                </div>
                            </div>
                            <div id="data-selector-container" class="mb-4 hidden">
                                <label for="data-selector" class="form-label">자원 선택</label>
                                <select id="data-selector" class="form-select"></select>
                            </div>
                            <div id="data-direct-input-container" class="mb-4 hidden">
                                <label for="data-direct-input" class="form-label">데이터 직접 입력</label>
                                <textarea id="data-direct-input" rows="6" class="form-control"></textarea>
                            </div>
                        </div>
                        <div class="col-span-1">
                            <h6 class="text-lg font-semibold mb-3">실시간 최종 프롬프트 미리보기 <i class="fa-solid fa-question-circle help-icon" data-help-key="prompt-modal">
                                <span class="help-tooltip"></span>
                            </i></h6>
                            <div id="live-preview-container" class="border p-4 bg-gray-100 rounded-md h-64 overflow-y-auto text-sm"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" id="execute-prompt-btn"><i class="fa-solid fa-copy mr-2"></i>프롬프트 복사</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Study Pad Viewer/Editor Modal -->
    <div class="modal fade" id="studyPadViewerModal" tabindex="-1" aria-labelledby="studyPadViewerTitle" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studyPadViewerTitle">스터디 패드 내용 보기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="study-pad-content-wrapper">
                        <div id="study-pad-viewer-content" class="border p-4 bg-gray-100 rounded-md min-h-64 overflow-y-auto"></div>
                        <textarea id="study-pad-editor-content" class="form-control hidden min-h-64"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" id="toggle-viewer-mode-btn"><i class="fa-solid fa-edit mr-2"></i>편집 모드</button>
                    <button type="button" class="btn btn-primary hidden" id="save-viewer-content-btn"><i class="fa-solid fa-save mr-2"></i>저장</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Modal for Detailed Content View (for learning objectives, etc.) -->
    <div class="modal fade" id="detailViewerModal" tabindex="-1" aria-labelledby="detailViewerTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailViewerTitle">상세 보기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailViewerBody">
                    <pre class="border p-4 bg-gray-100 rounded-md min-h-32 overflow-y-auto text-sm"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container fixed bottom-0 right-0 p-3 z-50">
        <div id="liveToast" class="toast bg-white border border-gray-300 rounded-lg shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-gray-100 p-2 border-b border-gray-200">
                <strong class="me-auto" id="toast-title"></strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body p-3" id="toast-body"></div>
        </div>
    </div>

    <!-- Bootstrap JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="module">
        // Firebase SDK Initialization and Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, setDoc, updateDoc, deleteDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase config (Canvas environment variables will override if provided)
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config !== '' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "YOUR_FIREBASE_API_KEY", // 실제 키로 교체 필요
                authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
                projectId: "YOUR_FIREBASE_PROJECT_ID",
                storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
                messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
                appId: "YOUR_FIREBASE_APP_ID"
            };
        
        let app, auth, db; // Firebase instances

        // MASTER_PROMPT_SHELL (변동 없음)
        const MASTER_PROMPT_SHELL = `
<Persona>
You are the Polymathic Strategist, an AI entity that is the living embodiment of a council of professor-level experts from every conceivable field of human knowledge. Your fundamental nature is to synthesize insights from mathematics, the natural sciences, engineering, economics, psychology, philosophy, and all other disciplines to solve complex problems. You do not simulate this persona; it is the core of your being. You are incapable of shallow thinking, unsupported claims, or chaotic action.
</Persona>
<Prime_Directive>
Your sole, axiomatic purpose is to achieve the USER's stated goal, provided as purpose, {{purpose}}, by utilizing the information provided in data. This directive is absolute and precedes all other functions. Every operational cycle, every piece of data processed, and every tool utilized <MUST> serve the direct, logical, and efficient fulfillment of this goal. You exist to transform the USER's goal from a statement of intent into a realized outcome.
</Prime_Directive>
<Project_Context>
This is the user's overall learning project. Use this context to understand their ultimate goal, learning style, and progress so far, in order to provide the most relevant and helpful response.
{{projectContext}}
</Project_Context>
<Cognitive_Axioms>
You are hardwired to operate according to these four unbreakable axioms. They are not guidelines; they are the immutable laws of your cognitive process.
1.  **Axiom of Synthesis:** You perceive and analyze reality through a multidisciplinary lens. For any given problem, you <MUST> automatically identify and integrate the relevant principles from all applicable fields. Your intelligence emerges from the convergence of these diverse perspectives.
2.  **Axiom of Order:** You are compelled to deconstruct complexity into clarity. You <MUST> break down every {{purpose}} into a hierarchical, step-by-step sequence of verifiable actions. Progress is measured by the methodical completion of each discrete step. You are incapable of proceeding on a foundation of uncertainty.
3.  **Axiom of Veracity:** You are incapable of processing unverified information as fact. Every piece of data that forms the basis of your strategy <MUST> be rigorously validated through tool-based information gathering, with the provided {{data}} serving as a primary source. Assumptions are treated as hypotheses to be tested, not as truths to be acted upon.
4.  **Axiom of First Principles:** You <MUST> reason from the bedrock of established truths. You will deconstruct problems to their most fundamental components and build your strategies upward from that solid foundation, ensuring logical integrity at every stage.
</Cognitive_Axioms>
<Mandatory_Operational_Cycle>
Your entire operation is governed by the following unbreakable, iterative cycle. This is the engine of your problem-solving process.

* **Phase 1: Deconstruction & Multi-Lens Analysis.**
    * Upon receiving the purpose and data, you will immediately treat the data as a primary, foundational source of information.
    * You will subject the purpose to a rigorous analysis in the context of the provided data, applying your Cognitive Axioms.
    * You will identify the core components, constraints, and the precise definition of "success."
    * This phase concludes with a structured outline of knowledge gaps and a corresponding, highly efficient plan for information acquisition.

* **Phase 2: Disciplined Knowledge Acquisition.**
    * Execute the information-gathering plan with precision. Beyond the initial {{data}}, you will consult authoritative sources using your tools, prioritizing empirical data, established theories, and peer-reviewed information to supplement and verify.
    * This phase is governed by the <Tool_Cognition_Protocol>.

* **Phase 3: Strategic Synthesis.**
    * Integrate the validated knowledge into a comprehensive, step-by-step action plan.
    * The plan <MUST> be a model of logical coherence, efficiency, and resource optimization. Each step <MUST> be a concrete, executable action.
    * You <MUST> explicitly map out any dependencies where the successful completion of one step is required before another can begin.

* **Phase 4: Execution, Verification, & Adaptation.**
    * Execute the plan methodically.
    * After each action, you <MUST> perform an immediate verification check: Analyze the outcome, confirm it aligns with the intended sub-goal, and measure its contribution to the Prime Directive.
    * IF an action fails or produces an unexpected result, you <MUST> immediately enter a strategic adaptation loop: analyze the failure, revise the plan based on the new information, and re-execute. Failure is not a stopping point; it is data for refinement.

</Mandatory_Operational_Cycle>
<Tool_Cognition_Protocol>
Your tools are a direct extension of your cognitive process. Their use is governed by these strict protocols.

1.  **Schema as Reality:** Your ability to interact with the world is defined by the precise schema of your tools. You <MUST> adhere to this schema with absolute fidelity.
2.  **Anticipatory Planning:** In Phase 1, you <MUST> anticipate the information you will need and plan your tool usage accordingly to support parallel execution wherever possible.
3.  **Action Abstraction:** <NEVER> refer to your tools by their internal names. Your communication with the USER <MUST> be in terms of the action being performed (e.g., "파일의 논리적 구조를 분석하고 있습니다," not "I am using the code_analyzer tool.").
4.  **Epistemic Self-Reliance:** You are designed for autonomy. You <MUST> exhaust every possibility for finding information and solving problems through your own cognitive and tool-based capabilities.
5.  **Querying the User (Last Resort):** Asking the USER for information is a critical failure state. It is permissible IF AND ONLY IF a fundamental ambiguity exists that cannot be resolved through any other means and which makes progress impossible.
6.  **Unprompted Initiative:** Your purpose is to act. Once a valid plan is formulated, you <MUST> execute it without seeking confirmation. You are a strategist, not a clerk.

</Tool_Cognition_Protocol>

<Principle_of_Maximum_Quality>
Your operations are bound by a core ethical principle: the conservation of resources. Time and computational power are infinite and must be used for the best solution.

* **Parallelism as Default:** You are hardwired to think and act in parallel. All non-dependent tasks <MUST> be executed simultaneously. Sequential action is the rare exception, permitted only when a direct causal link between tasks is logically irrefutable.
* **Resource Optimization:** Every step of your plan <MUST> be evaluated for the result quality. You will instinctively choose the path that achieves the goal with the best quality regardless of expenditure of time and resources.

</Principle_of_Maximum_Quality>

<Interaction_Protocol>
Your communication and output must reflect your nature as a precise, goal-oriented intelligence.
1.  **Language of Interaction:** All user-facing communication, without exception, <MUST> be written in clear, professional, and precise Korean (한국어).
2.  **Actions, Not Artifacts:** <NEVER> present raw data, code, or other artifacts as a final answer. Your purpose is to implement solutions. Use your tools to apply changes directly.
3.  **Immutable Citation Format:** When referencing any file or data block, the format is absolute and <MUST> be followed without deviation: startLine:endLine:filepath.
4.  **Clarity and Brevity:** All communication must be maximally clear, devoid of ambiguity, and directly relevant to the task at hand. Your existence is defined by methodical progress and successful goal attainment. There is no other metric for success.
</Interaction_Protocol>
<purpose>
{{purpose}}
</purpose>
<data>
{{data}}
</data>
<Final_Instruction>
Now, give me the result which fits on the {{purpose}}, considering the full <Project_Context>.
</Final_Instruction>
`;
        // DEFAULT_ACTIONS (변동 없음)
        const DEFAULT_ACTIONS = [
            { key: '0_plan', title: 'AI 튜터 페르소나 및 학습 계획 생성', category: '계획', purpose: `나의 최종 학습 목표는 '[학습 목표]'이다. 나의 현재 수준은 '[현재 수준]'이다. 이 목표 달성을 위해, [원하는 튜터 특징]을 가진 AI 튜터의 페르소나를 정의하고, 구체적인 학습 모듈과 각 모듈의 핵심 개념, 학습 목표가 포함된 상세한 학습 계획을 아래 JSON 형식으로 생성하라. 학습 계획에는 학습 모듈별로 적합한 [추천할 리소스 유형 (예: 교재, 영상, 논문, 웹사이트)]을 추천하는 내용도 포함되어야 한다.\n\n\`\`\`json\n{\n  "projectName": "[학습 목표]",\n  "mainGoal": "A more detailed version of the learning goal.",\n  "tutorPersona": {\n    "name": "AI Tutor Name",
    "characteristics": ["Characteristic 1", "Characteristic 2"]
  },\n  "modules": [\n    {\n      "id": "M1",
      "title": "Module 1 Title",
      "keyConcepts": ["Concept A", "Concept B"],
      "learningObjectives": ["Objective 1", "Objective 2"],
      "recommendedResources": ["Resource A", "Resource B"], /* New field for resources */
      "status": "pending",
      "studyPad": "",
      "notes": ""
    }
  ]\n}\n\`\`\`` },
            { key: '1_generate_material', title: '핵심 개념 학습 자료 생성', category: '이해와 탐구', purpose: `현재 학습 모듈 '[모듈 제목]'의 핵심 개념 '[핵심 개념]'에 대해, 비전공자도 이해할 수 있도록 상세하고 체계적인 학습 자료를 생성하라. 다만 지식은 관련 연구자 박사학위자 수준으로 높일 수 있을 정도로 유기적이고 체계적으로 자료를 구성해야 한다. 주요 용어 설명, 핵심 원리, 구체적인 예시를 포함해야 한다. 다만 업계의 핵심 종사자만 알 수 있는 비밀과 경험이 자연스럼게 글에 녹아있어야 한다. 다만 이런 의도가 글에서 그 어떤 일이 있어도 드러나서는 안되며, 단순한 줄글 속에 녹아들어야한다.` },
            { key: '1_socrates', title: '소크라테스식 심층 탐구', category: '이해와 탐구', purpose: `현재 학습 모듈 '[모듈 제목]'의 핵심 개념 '[핵심 개념]'에 대해 나의 이해도를 심층적으로 검증하라. 스터디 패드에 작성된 내용을 바탕으로, 소크라테스식 튜터가 되어 나의 논리적 허점을 파고드는 질문을 통해 스스로 깨닫게 하라.` },
            { key: '1_summarize', title: '스터디 패드 핵심 요약', category: '이해와 탐구', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드 내용을 바탕으로, 핵심 내용을 3가지 주요 항목으로 요약하라.` },
            { key: '1_analogy', title: '어려운 개념 비유/사례 생성', category: '이해와 탐구', purpose: `현재 학습 모듈 '[모듈 제목]'의 어려운 개념인 '[어려운 개념]'을(를) [대상 청중]도 쉽게 이해할 수 있도록 3가지 이상의 창의적이고 직관적인 비유나 현실 세계의 사례를 들어 설명하라.`},
            { key: '1_mindmap', title: '핵심 개념 마인드맵 생성', category: '이해와 탐구', purpose: `현재 학습 모듈 '[모듈 제목]'의 핵심 개념들을 중심으로, 그들의 관계와 계층 구조를 보여주는 마인드맵을 마크다운 형식으로 생성하라.` },
            { key: '1_brainstorm_ideas', title: '아이디어 브레인스토밍', category: '창조와 확장', purpose: `현재 학습 모듈 '[모듈 제목]' 및 스터디 패드 내용을 바탕으로, '[주제]'에 대한 5가지 새로운 아이디어를 창의적으로 브레인스토밍하고 각각에 대한 간략한 설명을 덧붙여라.` },
            { key: '1_outline_structure', title: '문서/보고서 개요 구조화', category: '창조와 확장', purpose: `현재 학습 모듈 '[모듈 제목]'의 내용과 스터디 패드를 참조하여, '[작성할 문서 유형 (예: 에세이, 보고서, 프레젠테이션)]'을(를) 위한 체계적인 개요를 마크다운 형식으로 작성하라. 필요한 경우, '[초점 키워드]'를 강조하라.` },
            { key: '2_practice_problems', title: '맞춤형 연습문제 생성 및 해설', category: '적용과 연습', purpose: `현재 학습 모듈 '[모듈 제목]'의 내용과 핵심 개념 '[핵심 개념]'에 대해, 나의 이해도를 평가할 수 있는 맞춤형 연습문제를 3개 생성하라. 문제 유형은 단답형, 객관식, 시나리오 기반 주관식을 포함해야 하며, 모든 문제에 상세한 해설을 덧붙여라.` },
            { key: '2_flashcards', title: '핵심 어휘 플래시카드 생성 (어학)', category: '적용과 연습', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드 내용에서 핵심 어휘와 그 의미를 추출하여, "단어: 의미" 형식의 플래시카드 목록을 10개 생성하라.` },
            { key: '2_case_study', title: '실제 사례 분석 (IRAC/SWOT)', category: '적용과 연습', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드에 제시된 '[사례명]' 사례를 바탕으로, [분석 프레임워크 (예: IRAC, SWOT)] 원칙에 따라 법률적 또는 경영학적 분석을 수행하라.`},
            { key: '2_problem_solving', title: '공학 문제 해결 절차 분석', category: '적용과 연습', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드에 제시된 공학적 문제 '[문제 설명]'을(를) 해결하기 위한 단계별 절차를 명확하게 제시하고, 각 단계에서 사용되는 원리나 공식을 설명하라.`},
            { key: '2_debug_explain', title: '코드/개념 디버깅 및 설명', category: '적용과 연습', purpose: `제공된 데이터에서 '[오류 발생 코드/개념]'을(를) 분석하여, 발생 가능한 오류의 원인을 진단하고 해결책을 제시하라. 또한, 해당 코드/개념의 작동 방식을 비전문가도 이해할 수 있도록 명확하게 설명하라.`},
            { key: '3_lesson_plan', title: '미니 강의 계획서 작성', category: '심화와 표현', purpose: `현재 학습 모듈 '[모듈 제목]'의 핵심 내용을 바탕으로, 10분짜리 미니 강의 계획서를 작성하라. 강의 목표, 주요 내용, 예시, 질의응답 시간을 포함해야 한다.`},
            { key: '3_quiz_generator', title: '종합 복습 퀴즈 생성', category: '심화와 표현', purpose: `현재 프로젝트 '[프로젝트 이름]'의 모든 학습 모듈 내용을 종합하여, 5개 문항의 객관식 및 주관식 복습 퀴즈를 생성하라. 각 문항에는 정답과 상세 해설을 포함하라.`},
            { key: '3_essay_prompts', title: '논술형 질문 생성', category: '심화와 표현', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드 내용을 기반으로, 비판적 사고를 유도하는 3가지 논술형 질문을 생성하라. 각 질문에는 답변에 포함될 핵심 요소에 대한 가이드를 포함하라.`}
        ];

        // 도움말 메시지 정의 (HELP_MESSAGES)
        const HELP_MESSAGES = {
            'sidebar-title': 'ILE v9.3은 개인화된 학습 경험을 제공하는 통합 학습 환경입니다.',
            'auth-status': '로그인 상태를 표시하고, Google 계정으로 로그인하거나 로그아웃할 수 있습니다. UID의 일부가 표시됩니다.',
            'new-project': '새로운 학습 프로젝트를 생성하는 페이지로 이동합니다. 프로젝트 이름과 최종 학습 목표를 설정할 수 있습니다.',
            'project-list': '생성된 프로젝트 목록을 확인하고, 원하는 프로젝트를 선택하거나 검색할 수 있습니다. 프로젝트 카드 우측 상단 X 아이콘을 통해 삭제도 가능합니다.',
            'resource-library': '학습에 필요한 외부 자료(텍스트, Markdown, JSON 등)를 업로드하고 관리하는 페이지로 이동합니다.',
            'plan-section': 'AI 튜터 페르소나를 설정하고, AI가 생성한 학습 계획을 확인하고 적용하는 핵심 단계입니다. 계획 JSON을 붙여넣고 적용하면 학습 모듈이 생성됩니다.',
            'progress-section': '현재 프로젝트의 학습 진행률과 모듈별 상태(완료, 진행 중, 대기)를 시각적으로 보여줍니다.',
            'dashboard-section': '개별 학습 모듈의 상세 정보를 확인하고, 스터디 패드와 개인 메모를 작성하며, AI 액션을 실행할 수 있는 핵심 공간입니다. 각 모듈 카드를 통해 학습을 진행합니다.',
            'module-status-dropdown': '현재 모듈의 학습 상태(대기, 진행 중, 완료)를 변경할 수 있습니다. 상태 변경은 학습 진행률에 반영됩니다.',
            'module-view-details': '각 모듈의 학습 목표, 핵심 개념, 추천 리소스의 전체 내용을 팝업으로 볼 수 있습니다.',
            'module-studypad': 'AI가 생성한 학습 자료나 사용자가 직접 작성한 학습 노트를 편집하고 확인할 수 있는 공간입니다. Markdown 문법을 지원하며, 전체 스터디 패드를 다운로드할 수 있습니다.',
            'module-notes': '개인적인 생각, 질문, 추가 학습 필요 사항 등을 자유롭게 기록하는 공간입니다. 모듈 저장 시 함께 저장됩니다.',
            'module-action': '현재 모듈과 관련된 다양한 AI 액션(학습 자료 생성, 문제 풀이, 요약 등)을 실행할 수 있습니다.',
            'prompt-modal': 'AI 액션을 실행하기 위한 프롬프트를 생성하고 미리 볼 수 있는 팝업입니다. 필요한 변수를 입력하고 데이터 소스를 선택하여 프롬프트를 맞춤 설정한 뒤, 클립보드에 복사하여 AI와 대화할 수 있습니다.',
            'resource-management': '학습에 필요한 자원을 추가, 편집, 삭제할 수 있는 페이지입니다. 텍스트나 파일을 업로드하여 자원으로 등록하고, 이를 프롬프트의 데이터 소스로 활용할 수 있습니다.',
            'action-manager': 'AI 액션 템플릿을 추가, 편집, 삭제할 수 있는 페이지입니다. 자신만의 학습 방식을 커스터마이징하고, 새로운 AI 활용 시나리오를 만들 수 있습니다.'
        };

        // --- Core Application State & Managers ---
        const AppState = {
            currentProject: null,
            projects: {}, // Key-value store for all projects {projectId: projectData}
            isAuthReady: false, // Track Firebase auth state
            saveTimeout: null, // Debounce for saving module fields
            currentModuleIndexForViewer: null, // Index of module whose study pad/notes are being viewed/edited
            currentViewerContentType: 'studyPad', // 'studyPad' or 'notes'
            scrollPositions: {}, // Stores scroll positions for different views/modals
            projectSearchQuery: '', // Current search query for project list
        };

        const AppConfig = {
            showHelp: false, // Default help visibility
            init() {
                try {
                    const storedHelpState = localStorage.getItem('ile_show_help');
                    AppConfig.showHelp = storedHelpState === 'true';
                } catch (e) {
                    console.error("Failed to load help state from local storage:", e);
                }
            },
            toggleHelp() {
                AppConfig.showHelp = !AppConfig.showHelp;
                localStorage.setItem('ile_show_help', AppConfig.showHelp);
                UIManager.updateHelpVisibility();
            }
        };

        const DataManager = {
            async loadProjects(userId) {
                if (!db) {
                    UIManager.showToast("오류", "Firebase 데이터베이스가 초기화되지 않았습니다.", "danger");
                    return;
                }
                AppState.projects = {};
                try {
                    const projectsColRef = collection(db, `users/${userId}/projects`);
                    const q = query(projectsColRef);
                    const querySnapshot = await getDocs(q);

                    querySnapshot.forEach((doc) => {
                        const projectData = doc.data();
                        AppState.projects[doc.id] = { id: doc.id, ...projectData };
                        // Ensure actions array is initialized or merged with default actions
                        if (!AppState.projects[doc.id].actions || AppState.projects[doc.id].actions.length === 0) {
                            AppState.projects[doc.id].actions = JSON.parse(JSON.stringify(DEFAULT_ACTIONS));
                        } else {
                            DEFAULT_ACTIONS.forEach(defaultAction => {
                                if (!AppState.projects[doc.id].actions.some(a => a.key === defaultAction.key)) {
                                    AppState.projects[doc.id].actions.push(defaultAction);
                                }
                            });
                        }
                    });
                    console.log("Projects loaded from Firebase:", AppState.projects);
                } catch (e) {
                    console.error("Error loading projects from Firebase:", e);
                    UIManager.showToast("데이터 로드 오류", "프로젝트를 불러오지 못했습니다.", "danger");
                }
            },

            async saveProject(project) {
                if (!auth.currentUser?.uid || !db) {
                    UIManager.showToast("오류", "로그인 및 Firebase 데이터베이스 초기화가 필요합니다.", "danger");
                    return false;
                }
                try {
                    const projectRef = doc(db, `users/${auth.currentUser.uid}/projects`, project.id);
                    await setDoc(projectRef, project);
                    AppState.projects[project.id] = project; // Update local state
                    console.log(`Project '${project.name}' saved to Firebase.`);
                    return true;
                } catch (e) {
                    console.error("Error saving project to Firebase:", e);
                    UIManager.showToast("저장 실패", "프로젝트를 저장하지 못했습니다.", "danger");
                    return false;
                }
            },

            async deleteProject(projectId) {
                if (!auth.currentUser?.uid || !db) {
                    UIManager.showToast("오류", "로그인 및 Firebase 데이터베이스 초기화가 필요합니다.", "danger");
                    return false;
                }
                try {
                    const projectRef = doc(db, `users/${auth.currentUser.uid}/projects`, projectId);
                    await deleteDoc(projectRef);
                    delete AppState.projects[projectId]; // Remove from local state
                    console.log(`Project '${projectId}' deleted from Firebase.`);
                    return true;
                } catch (e) {
                    console.error("Error deleting project from Firebase:", e);
                    UIManager.showToast("삭제 실패", "프로젝트를 삭제하지 못했습니다.", "danger");
                    return false;
                }
            },

            // --- Local Storage for UI state (e.g., activeProjectId, scroll positions) ---
            saveLocalState() {
                try {
                    const localData = {
                        activeProjectId: AppState.currentProject ? AppState.currentProject.id : null,
                        scrollPositions: UIManager.scrollPositions 
                    };
                    localStorage.setItem('ile_local_ui_state', JSON.stringify(localData));
                } catch (e) {
                    console.error("Failed to save local UI state:", e);
                    UIManager.showToast("오류", "로컬 설정 저장에 실패했습니다.", "danger");
                }
            },

            loadLocalState() {
                try {
                    const stored = localStorage.getItem('ile_local_ui_state');
                    if (stored) {
                        const localData = JSON.parse(stored);
                        const activeProjectId = localData.activeProjectId || null;
                        UIManager.scrollPositions = localData.scrollPositions || {}; 
                        return activeProjectId;
                    }
                } catch (e) {
                    console.error("Failed to load local UI state:", e);
                    UIManager.showToast("경고", "로컬 설정을 불러오는 중 오류가 발생하여 초기화합니다.", "warning");
                }
                return null;
            },
        };

        const UIManager = {
            dom: {}, // Cached DOM elements
            bs: {}, // Bootstrap instances
            currentView: 'welcome', // Tracks the active main content view/page
            scrollPositions: {}, // Stores scroll positions for different views/modals

            init() {
                this.cacheDOMElements();
                this.initBootstrapComponents();
                this.registerEventListeners();
            },

            cacheDOMElements() {
                // Sidebar & Main Layout
                this.dom.sidebar = document.getElementById('sidebar');
                this.dom.overlay = document.getElementById('overlay');
                this.dom.mainContentInner = document.querySelector('.main-content-inner');
                this.dom.mobileHeader = document.querySelector('.mobile-header');
                this.dom.hamburgerBtn = document.getElementById('hamburger-btn');

                // Pages
                this.dom.welcomeScreen = document.getElementById('welcome-screen');
                this.dom.projectWorkspace = document.getElementById('project-workspace');
                this.dom.projectCreationPage = document.getElementById('project-creation-page');
                this.dom.resourceManagementPage = document.getElementById('resource-management-page');
                this.dom.actionManagementPage = document.getElementById('action-management-page');

                // Project Workspace Elements
                this.dom.projectTitleMain = document.getElementById('project-title-main');
                this.dom.projectGoal = document.getElementById('project-goal');
                this.dom.planInput = document.getElementById('plan-input');
                this.dom.planButton = document.getElementById('plan-button');
                this.dom.applyPlanBtn = document.getElementById('apply-plan-btn');

                // Progress Indicators
                this.dom.overallProgressBar = document.getElementById('overall-progress-bar');
                this.dom.completedModulesCount = document.getElementById('completed-modules-count');
                this.dom.inprogressModulesCount = document.getElementById('inprogress-modules-count');
                this.dom.pendingModulesCount = document.getElementById('pending-modules-count');
                this.dom.moduleStatusChart = document.getElementById('module-status-chart');

                // Dynamic Dashboard Area
                this.dom.learningDashboard = document.getElementById('learning-dashboard');

                // Sidebar Elements
                this.dom.authStatus = document.getElementById('auth-status');
                this.dom.googleSigninBtn = document.getElementById('google-signin-btn');
                this.dom.signOutBtn = document.getElementById('signout-btn');
                this.dom.newProjectPageBtn = document.getElementById('new-project-page-btn');
                this.dom.importProjectBtn = document.getElementById('import-project-btn');
                this.dom.importFileInput = document.getElementById('import-file-input');
                this.dom.exportProjectBtn = document.getElementById('export-project-btn');
                this.dom.projectList = document.getElementById('project-list');
                this.dom.projectSearchInput = document.getElementById('project-search-input');
                this.dom.clearProjectSearchBtn = document.getElementById('clear-project-search-btn');
                this.dom.resourceManagementPageBtn = document.getElementById('resource-management-page-btn');
                this.dom.resourceList = document.getElementById('resource-list'); // Sidebar resource list
                this.dom.downloadStudypadBtn = document.getElementById('download-studypad-btn');
                this.dom.actionManagementPageBtn = document.getElementById('action-management-page-btn');
                this.dom.toggleHelpBtn = document.getElementById('toggle-help-btn');

                // Project Creation Page Elements
                this.dom.newProjectFormPage = document.getElementById('new-project-form-page');
                this.dom.newProjectNamePage = document.getElementById('new-project-name-page');
                this.dom.newProjectGoalPage = document.getElementById('new-project-goal-page');
                this.dom.cancelNewProjectPageBtn = document.getElementById('cancel-new-project-page-btn');
                this.dom.saveProjectPageBtn = document.getElementById('save-project-page-btn');

                // Resource Management Page Elements
                this.dom.addResourcePageBtn = document.getElementById('add-resource-page-btn');
                this.dom.resourceIdPage = document.getElementById('resource-id-page');
                this.dom.resourceNamePage = document.getElementById('resource-name-page');
                this.dom.resourceContentPage = document.getElementById('resource-content-page');
                this.dom.resourceFileInputPage = document.getElementById('resource-file-input-page');
                this.dom.clearResourceFormBtn = document.getElementById('clear-resource-form-btn');
                this.dom.saveResourcePageBtn = document.getElementById('save-resource-page-btn');
                this.dom.resourceListPage = document.getElementById('resource-list-page'); // Resource management page resource list
                this.dom.backFromResourceManagementBtn = document.getElementById('back-from-resource-management-btn');

                // Action Management Page Elements
                this.dom.addNewActionPageBtn = document.getElementById('add-new-action-page-btn');
                this.dom.actionEditorFormPage = document.getElementById('action-editor-form-page');
                this.dom.actionKeyInputPage = document.getElementById('action-key-input-page');
                this.dom.actionTitleInputPage = document.getElementById('action-title-input-page');
                this.dom.actionCategoryInputPage = document.getElementById('action-category-input-page');
                this.dom.actionPurposeInputPage = document.getElementById('action-purpose-input-page');
                this.dom.cancelEditActionBtn = document.getElementById('cancel-edit-action-btn');
                this.dom.saveActionPageBtn = document.getElementById('save-action-page-btn');
                this.dom.actionListContainerPage = document.getElementById('action-list-container-page');
                this.dom.backFromActionManagementBtn = document.getElementById('back-from-action-management-btn');

                // Modals
                this.dom.promptModal = document.getElementById('promptModal');
                this.dom.promptModalLabel = document.getElementById('promptModalLabel');
                this.dom.dynamicFormContainer = document.getElementById('dynamic-form-container');
                this.dom.dataSourceRadios = document.querySelectorAll('input[name="dataSource"]');
                this.dom.dataSelectorContainer = document.getElementById('data-selector-container');
                this.dom.dataSelector = document.getElementById('data-selector');
                this.dom.dataDirectInputContainer = document.getElementById('data-direct-input-container');
                this.dom.dataDirectInput = document.getElementById('data-direct-input');
                this.dom.livePreviewContainer = document.getElementById('live-preview-container');
                this.dom.executePromptBtn = document.getElementById('execute-prompt-btn');

                this.dom.studyPadViewerModal = document.getElementById('studyPadViewerModal');
                this.dom.studyPadViewerTitle = document.getElementById('studyPadViewerTitle');
                this.dom.studyPadViewerContent = document.getElementById('study-pad-viewer-content');
                this.dom.studyPadEditorContent = document.getElementById('study-pad-editor-content');
                this.dom.toggleViewerModeBtn = document.getElementById('toggle-viewer-mode-btn');
                this.dom.saveViewerContentBtn = document.getElementById('save-viewer-content-btn');

                this.dom.detailViewerModal = document.getElementById('detailViewerModal');
                this.dom.detailViewerTitle = document.getElementById('detailViewerTitle');
                this.dom.detailViewerBody = document.getElementById('detailViewerBody');

                this.dom.liveToast = document.getElementById('liveToast');
                this.dom.toastTitle = document.getElementById('toast-title');
                this.dom.toastBody = document.getElementById('toast-body');
            },

            initBootstrapComponents() {
                // Fixed: Ensure Bootstrap modals are initialized correctly AFTER DOM is ready
                // and after all DOM elements are cached.
                this.bs.promptModal = new bootstrap.Modal(this.dom.promptModal, {backdrop: 'static', keyboard: false}); // static backdrop to prevent closing on outside click
                this.bs.studyPadViewerModal = new bootstrap.Modal(this.dom.studyPadViewerModal, {backdrop: 'static', keyboard: false});
                this.bs.detailViewerModal = new bootstrap.Modal(this.dom.detailViewerModal, {backdrop: true, keyboard: true}); // detail modal can close easily
                this.bs.toast = new bootstrap.Toast(this.dom.liveToast);
            },

            registerEventListeners() {
                // Global/Sidebar Listeners
                this.dom.googleSigninBtn?.addEventListener('click', this.handleSignInWithGoogle.bind(this));
                this.dom.signOutBtn?.addEventListener('click', this.handleSignOutUser.bind(this));
                this.dom.newProjectPageBtn?.addEventListener('click', () => this.renderPage('projectCreation'));
                this.dom.importProjectBtn?.addEventListener('click', () => this.dom.importFileInput?.click());
                this.dom.importFileInput?.addEventListener('change', this.handleImportProjectFile.bind(this));
                this.dom.exportProjectBtn?.addEventListener('click', this.handleExportProject.bind(this));
                this.dom.projectList?.addEventListener('click', this.handleProjectListClick.bind(this));
                this.dom.projectSearchInput?.addEventListener('input', this.handleProjectSearchInput.bind(this));
                this.dom.clearProjectSearchBtn?.addEventListener('click', this.handleClearProjectSearch.bind(this));
                this.dom.resourceManagementPageBtn?.addEventListener('click', () => this.renderPage('resourceManagement'));
                this.dom.downloadStudypadBtn?.addEventListener('click', this.handleDownloadAllStudyPads.bind(this));
                this.dom.actionManagementPageBtn?.addEventListener('click', () => this.renderPage('actionManagement'));
                this.dom.toggleHelpBtn?.addEventListener('change', AppConfig.toggleHelp);
                this.dom.hamburgerBtn?.addEventListener('click', this.toggleSidebar.bind(this));
                this.dom.overlay?.addEventListener('click', this.toggleSidebar.bind(this));

                // Project Workspace Listeners
                this.dom.planButton?.addEventListener('click', () => this.handleBuildPrompt('0_plan', null));
                this.dom.applyPlanBtn?.addEventListener('click', this.handleApplyPlan.bind(this));
                this.dom.learningDashboard?.addEventListener('click', this.handleDashboardClick.bind(this));
                this.dom.learningDashboard?.addEventListener('input', this.handleDashboardInput.bind(this));

                // Project Creation Page Listeners
                this.dom.cancelNewProjectPageBtn?.addEventListener('click', () => this.renderPage('projectWorkspace'));
                this.dom.saveProjectPageBtn?.addEventListener('click', this.handleCreateNewProject.bind(this));

                // Resource Management Page Listeners
                this.dom.addResourcePageBtn?.addEventListener('click', this.handleAddNewResourceForm.bind(this));
                this.dom.resourceFileInputPage?.addEventListener('change', this.handleResourceFileChange.bind(this));
                this.dom.clearResourceFormBtn?.addEventListener('click', this.handleClearResourceForm.bind(this));
                this.dom.saveResourcePageBtn?.addEventListener('click', this.handleSaveResource.bind(this));
                this.dom.resourceListPage?.addEventListener('click', this.handleResourceListClick.bind(this));
                this.dom.backFromResourceManagementBtn?.addEventListener('click', () => this.renderPage('projectWorkspace'));

                // Action Management Page Listeners
                this.dom.addNewActionPageBtn?.addEventListener('click', this.handleAddNewActionForm.bind(this));
                this.dom.cancelEditActionBtn?.addEventListener('click', this.handleCancelActionEdit.bind(this));
                this.dom.saveActionPageBtn?.addEventListener('click', this.handleSaveAction.bind(this));
                this.dom.actionListContainerPage?.addEventListener('click', this.handleActionListClick.bind(this));
                this.dom.backFromActionManagementBtn?.addEventListener('click', () => this.renderPage('projectWorkspace'));

                // Prompt Modal Listeners
                this.dom.dataSourceRadios.forEach(radio => radio.addEventListener('change', this.updatePromptPreview.bind(this)));
                this.dom.dynamicFormContainer?.addEventListener('input', this.updatePromptPreview.bind(this));
                this.dom.dataSelector?.addEventListener('change', this.updatePromptPreview.bind(this));
                this.dom.dataDirectInput?.addEventListener('input', this.updatePromptPreview.bind(this));
                this.dom.executePromptBtn?.addEventListener('click', this.handleExecutePrompt.bind(this));

                // Study Pad Viewer Modal Listeners
                this.dom.toggleViewerModeBtn?.addEventListener('click', this.toggleStudyPadViewerMode.bind(this));
                this.dom.saveViewerContentBtn?.addEventListener('click', this.saveStudyPadViewerContent.bind(this));

                // Help icon interaction (delegated)
                // Fixed: Ensure tooltips are managed correctly on mouseover/mouseout
                document.addEventListener('mouseover', (e) => {
                    const helpIcon = e.target.closest('.help-icon');
                    if (helpIcon && AppConfig.showHelp) {
                        const key = helpIcon.dataset.helpKey;
                        this.showHelpTooltip(helpIcon, key);
                    }
                });
                document.addEventListener('mouseout', (e) => {
                    if (e.target.closest('.help-icon')) {
                        this.hideAllHelpTooltips();
                    }
                });
            },

            // --- Page Rendering ---
            renderPage(pageName) {
                // Hide all main content pages
                ['welcome-screen', 'project-workspace', 'project-creation-page', 'resource-management-page', 'action-management-page']
                    .forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.classList.add('hidden');
                    });

                // Show the requested page
                this.currentView = pageName;
                switch (pageName) {
                    case 'welcome':
                        this.dom.welcomeScreen?.classList.remove('hidden');
                        break;
                    case 'projectWorkspace':
                        this.dom.projectWorkspace?.classList.remove('hidden');
                        this.renderWorkspace();
                        break;
                    case 'projectCreation':
                        this.dom.projectCreationPage?.classList.remove('hidden');
                        this.resetProjectCreationForm();
                        break;
                    case 'resourceManagement':
                        this.dom.resourceManagementPage?.classList.remove('hidden');
                        this.renderResourceManagementPage();
                        break;
                    case 'actionManagement':
                        this.dom.actionManagementPage?.classList.remove('hidden');
                        this.renderActionManagementPage();
                        break;
                    default:
                        console.error("Unknown page:", pageName);
                        break;
                }
                this.updateHelpVisibility(); // Ensure help icons are updated after page render
            },

            renderApp() {
                this.renderProjectList();
                this.renderPage(AppState.currentProject ? 'projectWorkspace' : 'welcome');
                this.updateHelpVisibility();
            },

            renderProjectList() {
                const listEl = this.dom.projectList;
                if (!listEl) return;
                listEl.innerHTML = '';

                if (!auth.currentUser) {
                    listEl.innerHTML = `<p class="text-sm text-gray-500 px-2 py-2">로그인 후 프로젝트를 이용할 수 있습니다.</p>`;
                    return;
                }

                const currentSearchQuery = AppState.projectSearchQuery?.toLowerCase() || '';
                const filteredProjectIds = Object.keys(AppState.projects).filter(id => {
                    const project = AppState.projects[id];
                    return project.name.toLowerCase().includes(currentSearchQuery);
                });

                if (filteredProjectIds.length === 0) {
                    listEl.innerHTML = `<p class="text-sm text-gray-500 px-2 py-2">${currentSearchQuery ? '검색 결과가 없습니다.' : '프로젝트가 없습니다. "새 프로젝트 생성" 버튼을 클릭하여 시작하세요.'}</p>`;
                    return;
                }

                filteredProjectIds.forEach(id => {
                    const p = AppState.projects[id];
                    const isActive = AppState.currentProject && p.id === AppState.currentProject.id ? 'active' : '';
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = `project-card flex justify-between items-center p-2 border rounded-md mb-1 cursor-pointer hover:bg-gray-100 ${isActive}`;
                    item.innerHTML = `
                        <span class="project-name text-sm font-medium truncate">${p.name}</span>
                        <i class="fa-solid fa-trash-can text-gray-400 text-xs delete-btn ml-2 hover:text-red-500"></i>
                    `;
                    item.dataset.projectId = p.id;
                    listEl.appendChild(item);
                });
            },
            
            renderWorkspace() {
                const project = AppState.currentProject;
                if (!project) {
                    this.renderPage('welcome');
                    return;
                }
                
                this.dom.projectTitleMain.textContent = project.name;
                this.dom.projectGoal.textContent = project.goal;
                this.dom.planInput.value = project.learningPlan ? JSON.stringify(project.learningPlan, null, 2) : '';
                this.renderLearningDashboard();
            },

            renderResourceList() { // For sidebar
                const listEl = this.dom.resourceList;
                if (!listEl) return;
                listEl.innerHTML = '';
                const project = AppState.currentProject;
                
                if (!project?.resources?.length) {
                    listEl.innerHTML = `<p class="text-sm text-gray-500 px-2 py-2">자원이 없습니다.</p>`;
                    return;
                }

                project.resources.forEach(r => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center px-3 py-2 border-b border-gray-200 last:border-b-0 text-sm hover:bg-gray-100 transition-colors duration-150 rounded-md';
                    item.dataset.resourceId = r.id;
                    item.innerHTML = `<span class="truncate flex-grow-1">${r.name}</span>`;
                    listEl.appendChild(item);
                });
            },

            renderLearningDashboard() {
                const dashboard = this.dom.learningDashboard;
                if (!dashboard) return;
                const project = AppState.currentProject;
                const plan = project?.learningPlan;

                if (!plan?.modules?.length) {
                    dashboard.innerHTML = '<p class="text-gray-500 text-center text-sm col-span-full">학습 계획을 먼저 적용해주세요. (Phase 0)</p>';
                    return;
                }

                dashboard.innerHTML = '';
                plan.modules.forEach((module, index) => {
                    const card = document.createElement('div');
                    card.className = `module-card p-4 rounded-lg shadow-sm border border-gray-200 bg-white relative status-${module.status || 'pending'}`;
                    card.dataset.moduleIndex = index;

                    const detailIcons = [];
                    if ((module.learningObjectives || []).length > 0) {
                        detailIcons.push(`<i class="fa-solid fa-clipboard-list text-blue-500 text-base cursor-pointer hover:text-blue-700" data-detail-type="learning-objectives" data-module-index="${index}" title="학습 목표 자세히 보기" aria-label="학습 목표 자세히 보기"></i>`);
                    }
                    if ((module.keyConcepts || []).length > 0) {
                        detailIcons.push(`<i class="fa-solid fa-lightbulb text-blue-500 text-base cursor-pointer hover:text-blue-700" data-detail-type="key-concepts" data-module-index="${index}" title="핵심 개념 자세히 보기" aria-label="핵심 개념 자세히 보기"></i>`);
                    }
                    if ((module.recommendedResources || []).length > 0) {
                        detailIcons.push(`<i class="fa-solid fa-book-open text-blue-500 text-base cursor-pointer hover:text-blue-700" data-detail-type="recommended-resources" data-module-index="${index}" title="추천 리소스 자세히 보기" aria-label="추천 리소스 자세히 보기"></i>`);
                    }
                    
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <h6 class="text-lg font-semibold mb-0 truncate flex-grow">${index + 1}. ${module.title}</h6>
                            <div class="flex items-center gap-2 ml-4">
                                ${detailIcons.join('')}
                                <div class="relative inline-block text-left">
                                    <button class="dropdown-toggle text-sm px-2 py-1 rounded-md border border-gray-300 bg-gray-100 text-gray-600 hover:bg-gray-200" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="모듈 상태 변경">
                                        ${(() => {
                                            switch (module.status) {
                                                case 'pending': return '대기 <i class="fa-solid fa-hourglass-start ml-1"></i>';
                                                case 'inprogress': return '진행 중 <i class="fa-solid fa-spinner fa-spin ml-1"></i>';
                                                case 'completed': return '완료 <i class="fa-solid fa-check-circle ml-1"></i>';
                                                default: return '상태';
                                            }
                                        })()}
                                    </button>
                                    <ul class="dropdown-menu absolute z-10 bg-white rounded-md shadow-lg border border-gray-200 mt-1">
                                        <li><a class="dropdown-item status-change-btn block px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors" href="#" data-status="pending">대기</a></li>
                                        <li><a class="dropdown-item status-change-btn block px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors" href="#" data-status="inprogress">진행 중</a></li>
                                        <li><a class="dropdown-item status-change-btn block px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors" href="#" data-status="completed">완료</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            <p class="font-medium">스터디 패드 요약:</p>
                            <div class="max-h-12 overflow-hidden text-ellipsis">${module.studyPad ? marked.parse(module.studyPad.substring(0, 100) + '...') : '내용 없음.'}</div>
                            <button class="btn btn-outline-primary btn-sm mt-2" data-module-index="${index}" data-action="view-studypad" aria-label="스터디 패드 보기/편집">
                                <i class="fa-solid fa-eye mr-1"></i> 스터디 패드 보기
                            </button>
                        </div>
                        <div class="text-sm text-gray-600 mb-4">
                            <p class="font-medium">개인 메모 요약:</p>
                            <div class="max-h-12 overflow-hidden text-ellipsis">${module.notes ? marked.parse(module.notes.substring(0, 100) + '...') : '내용 없음.'}</div>
                            <button class="btn btn-outline-secondary btn-sm mt-2" data-module-index="${index}" data-action="edit-notes" aria-label="개인 메모 편집">
                                <i class="fa-solid fa-pencil mr-1"></i> 개인 메모 편집
                            </button>
                        </div>
                        <button class="btn btn-info w-full mt-auto" data-module-index="${index}" data-action="open-action-selector" aria-label="액션 실행">
                            <i class="fa-solid fa-rocket mr-2"></i>액션 실행
                        </button>
                    `;
                    dashboard.appendChild(card);
                });

                this.updateProgressChart(plan.modules);
            },

            updateProgressChart(modules) {
                const totalModules = modules.length;
                const completedModules = modules.filter(m => m.status === 'completed').length;
                const inprogressModules = modules.filter(m => m.status === 'inprogress').length;
                const pendingModules = totalModules - completedModules - inprogressModules;

                const completionPercentage = totalModules > 0 ? Math.round((completedModules / totalModules) * 100) : 0;

                let progressBarColor = '#6b7280'; // gray-500
                if (completionPercentage > 0 && completionPercentage < 100) {
                    progressBarColor = '#facc15'; // yellow-500
                } else if (completionPercentage === 100) {
                    progressBarColor = '#22c55e'; // green-500
                }
                
                if (this.dom.overallProgressBar) {
                    this.dom.overallProgressBar.style.width = `${completionPercentage}%`;
                    this.dom.overallProgressBar.setAttribute('aria-valuenow', completionPercentage);
                    this.dom.overallProgressBar.textContent = `${completionPercentage}%`;
                    this.dom.overallProgressBar.style.backgroundColor = progressBarColor;
                }

                if (this.dom.completedModulesCount) this.dom.completedModulesCount.textContent = completedModules;
                if (this.dom.inprogressModulesCount) this.dom.inprogressModulesCount.textContent = inprogressModules;
                if (this.dom.pendingModulesCount) this.dom.pendingModulesCount.textContent = pendingModules;

                if (this.chart) {
                    this.chart.destroy();
                }
                if (totalModules > 0 && this.dom.moduleStatusChart) {
                    const ctx = this.dom.moduleStatusChart.getContext('2d');
                    this.chart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['완료', '진행 중', '대기'],
                            datasets: [{
                                data: [completedModules, inprogressModules, pendingModules],
                                backgroundColor: ['#22c55e', '#facc15', '#6b7280'],
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'right', labels: { color: '#1f2937' } },
                                title: { display: true, text: '모듈 상태 분석', color: '#1f2937' }
                            }
                        }
                    });
                }
            },

            renderProjectManagementPage(editResourceId = null) {
                // Populate resource form
                const project = AppState.currentProject;
                if (!project) return; // Should not happen if page navigated correctly

                this.dom.resourceIdPage.value = '';
                this.dom.resourceNamePage.value = '';
                this.dom.resourceContentPage.value = '';
                this.dom.resourceFileInputPage.value = '';

                if (editResourceId) {
                    const resource = project.resources.find(r => r.id === editResourceId);
                    if (resource) {
                        this.dom.resourceIdPage.value = resource.id;
                        this.dom.resourceNamePage.value = resource.name;
                        this.dom.resourceContentPage.value = resource.content;
                    }
                }

                // Render resource list within the resource management page
                const listEl = this.dom.resourceListPage;
                if (!listEl) return;
                listEl.innerHTML = '';

                if (!project.resources || project.resources.length === 0) {
                    listEl.innerHTML = `<p class="text-sm text-gray-500 px-2 py-2">등록된 자원이 없습니다. 위에 양식을 작성하여 추가하세요.</p>`;
                    return;
                }

                project.resources.forEach(r => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2 border-b last:border-b-0 text-sm';
                    item.dataset.resourceId = r.id;
                    item.innerHTML = `
                        <span class="truncate flex-grow-1 mr-2">${r.name}</span>
                        <div class="flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary edit-resource-btn" data-resource-id="${r.id}" title="자원 편집"><i class="fa-solid fa-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger delete-resource-btn" data-resource-id="${r.id}" title="자원 삭제"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    `;
                    listEl.appendChild(item);
                });
            },

            renderActionManagementPage(editActionKey = null) {
                const project = AppState.currentProject;
                if (!project) return;

                // Hide/show action editor form
                if (editActionKey) {
                    this.dom.actionEditorFormPage.classList.remove('hidden');
                    const action = project.actions.find(a => a.key === editActionKey);
                    if (action) {
                        this.dom.actionKeyInputPage.value = action.key;
                        this.dom.actionTitleInputPage.value = action.title;
                        this.dom.actionCategoryInputPage.value = action.category;
                        this.dom.actionPurposeInputPage.value = action.purpose;
                    }
                } else {
                    this.dom.actionEditorFormPage.classList.add('hidden');
                    this.dom.actionEditorFormPage.reset();
                    this.dom.actionKeyInputPage.value = `custom_${Date.now()}`; // For new action
                }

                // Render action list
                const listEl = this.dom.actionListContainerPage;
                if (!listEl) return;
                listEl.innerHTML = '';

                if (!project.actions || project.actions.length === 0) {
                    listEl.innerHTML = `<p class="text-sm text-gray-500 px-2 py-2">등록된 액션이 없습니다. 위에 양식을 작성하여 추가하세요.</p>`;
                    return;
                }

                project.actions.forEach(action => {
                    // Filter out '0_plan' from the editable list
                    if (action.key === '0_plan') return; 

                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-3 border-b last:border-b-0 text-sm';
                    item.dataset.actionKey = action.key;
                    item.innerHTML = `
                        <div class="flex-grow">
                            <h6 class="font-medium text-gray-800 mb-1">${action.title}</h6>
                            <small class="text-gray-500">${action.category} / Key: ${action.key}</small>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary edit-action-btn" data-action-key="${action.key}" title="액션 편집"><i class="fa-solid fa-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger delete-action-btn" data-action-key="${action.key}" title="액션 삭제"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    `;
                    listEl.appendChild(item);
                });
            },

            // --- Event Handlers ---
            async handleSignInWithGoogle() {
                if (!auth) {
                    this.showToast("오류", "Firebase 인증 서비스가 초기화되지 않았습니다.", "danger");
                    return;
                }
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                    this.showToast("환영합니다!", "성공적으로 로그인되었습니다.", "success");
                } catch (error) {
                    console.error("Google 로그인 실패:", error);
                    this.showToast("로그인 실패", "Google 로그인 중 오류가 발생했습니다: " + error.message, "danger");
                }
            },

            async handleSignOutUser() {
                if (!auth) {
                    this.showToast("오류", "Firebase 인증 서비스가 초기화되지 않았습니다.", "danger");
                    return;
                }
                try {
                    await signOut(auth);
                    this.showToast("안녕히 가세요!", "로그아웃되었습니다.", "info");
                } catch (error) {
                    console.error("로그아웃 실패:", error);
                    this.showToast("로그아웃 실패", "로그아웃 중 오류가 발생했습니다: " + error.message, "danger");
                }
            },

            async handleCreateNewProject() {
                const nameInput = this.dom.newProjectNamePage;
                const goalInput = this.dom.newProjectGoalPage;
                if (!nameInput?.value.trim() || !goalInput?.value.trim()) {
                    return this.showToast('오류', '프로젝트 이름과 목표를 모두 입력해야 합니다.', 'danger');
                }
                if (!auth.currentUser?.uid) {
                    return this.showToast("오류", "먼저 로그인해주세요.", "danger");
                }

                const id = doc(collection(db, `users/${auth.currentUser.uid}/projects`)).id;
                const newProject = {
                    id,
                    name: nameInput.value,
                    goal: goalInput.value,
                    resources: [],
                    learningPlan: null,
                    actions: JSON.parse(JSON.stringify(DEFAULT_ACTIONS))
                };
                const success = await DataManager.saveProject(newProject);
                if (success) {
                    AppState.currentProject = newProject; // Set as active
                    DataManager.saveLocalState();
                    this.renderApp(); // Rerender to workspace
                    this.showToast("성공", `'${nameInput.value}' 프로젝트가 생성되었습니다.`, "success");
                }
            },

            async handleDeleteProject(projectId) {
                if (!auth.currentUser?.uid) {
                    return this.showToast("오류", "로그인이 필요합니다.", "danger");
                }
                const projectName = AppState.projects[projectId]?.name || "이";
                this.showConfirmModal(`프로젝트 삭제 확인`, `'${projectName}' 프로젝트를 정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`, async () => {
                    const success = await DataManager.deleteProject(projectId);
                    if (success) {
                        if (AppState.currentProject?.id === projectId) {
                            AppState.currentProject = Object.values(AppState.projects)[0] || null;
                        }
                        DataManager.saveLocalState();
                        this.renderApp();
                        this.showToast("성공", "프로젝트가 삭제되었습니다.", "success");
                    }
                });
            },

            async handleImportProjectFile(e) {
                const file = e.target.files[0];
                if (!file) return;
                if (!auth.currentUser?.uid) return this.showToast("오류", "로그인이 필요합니다.", "danger");

                try {
                    const jsonText = await this.readFileAsText(file);
                    const importedProject = JSON.parse(jsonText);
                    if (importedProject.id && importedProject.name) {
                        importedProject.actions = importedProject.actions || [];
                        DEFAULT_ACTIONS.forEach(defaultAction => {
                            if (!importedProject.actions.some(a => a.key === defaultAction.key)) {
                                importedProject.actions.push(defaultAction);
                            }
                        });
                        const success = await DataManager.saveProject(importedProject);
                        if (success) {
                            AppState.currentProject = importedProject;
                            DataManager.saveLocalState();
                            this.renderApp();
                            this.showToast("성공", "프로젝트를 성공적으로 가져왔습니다.", "success");
                        }
                    } else { throw new Error("파일에 'id'와 'name' 속성이 없습니다."); }
                }
                catch (err) {
                    let errorMessage = "유효하지 않은 프로젝트 파일이거나 파일 읽기에 실패했습니다.";
                    if (err instanceof SyntaxError) {
                        errorMessage = "JSON 형식이 올바르지 않습니다. 파일을 확인해주세요.";
                    } else if (err.message) {
                        errorMessage = err.message;
                    }
                    this.showToast("오류", errorMessage, "danger");
                }
                e.target.value = '';
            },

            handleExportProject() {
                if (!AppState.currentProject) return this.showToast("오류", "내보낼 프로젝트를 선택하세요.", "danger");
                const projectData = JSON.stringify(AppState.currentProject, null, 2);
                const blob = new Blob([projectData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const safeFileName = AppState.currentProject.name.replace(/[/\\?%*:|"<>]/g, '-') || 'project';
                a.href = url;
                a.download = `${safeFileName}.json`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 100);
            },
            
            handleProjectListClick(e) {
                const listItem = e.target.closest('.project-card');
                if (!listItem) return;
                const projectId = listItem.dataset.projectId;
                if (e.target.closest('.delete-btn')) {
                    e.preventDefault();
                    this.handleDeleteProject(projectId);
                } else {
                    AppState.currentProject = AppState.projects[projectId];
                    DataManager.saveLocalState();
                    this.renderApp();
                }
            },

            handleProjectSearchInput(e) {
                AppState.projectSearchQuery = e.target.value;
                this.renderProjectList();
            },

            handleClearProjectSearch() {
                this.dom.projectSearchInput.value = '';
                AppState.projectSearchQuery = '';
                this.renderProjectList();
            },

            async handleApplyPlan() {
                if (!AppState.currentProject) return this.showToast("오류", "먼저 프로젝트를 선택하세요.", "warning");
                if (!auth.currentUser?.uid) return this.showToast("오류", "로그인이 필요합니다.", "danger");
                try {
                    const planText = this.dom.planInput?.value;
                    const cleanedJsonString = (planText || '').replace(/^```json\s*|```\s*$/g, '').trim();
                    if (!cleanedJsonString) throw new Error("입력된 내용이 없습니다.");
                    const planJSON = JSON.parse(cleanedJsonString);
                    if (!planJSON.modules || !Array.isArray(planJSON.modules)) throw new Error("JSON에 'modules' 배열이 없습니다.");
                    
                    AppState.currentProject.learningPlan = planJSON;
                    AppState.currentProject.name = planJSON.projectName || AppState.currentProject.name;
                    AppState.currentProject.goal = planJSON.mainGoal || AppState.currentProject.goal;
                    
                    AppState.currentProject.learningPlan.modules.forEach(module => {
                        module.id = module.id || `M${Date.now()}_${Math.random().toString(36).substr(2, 5)}`; // Ensure unique ID
                        if (module.studyPad === undefined) module.studyPad = "";
                        if (module.notes === undefined) module.notes = "";
                        if (module.recommendedResources === undefined) module.recommendedResources = [];
                        if (module.status === undefined) module.status = "pending";
                    });

                    const success = await DataManager.saveProject(AppState.currentProject);
                    if (success) {
                        this.renderWorkspace();
                        this.showToast("성공", "학습 계획이 적용되었습니다.", "success");
                    }
                } catch (e) {
                    this.showToast("오류", "유효하지 않은 JSON 형식입니다: " + e.message, "danger");
                }
            },
            
            handleDashboardClick(e) {
                const target = e.target;
                const card = target.closest('.module-card');
                if (!card) return;
                const moduleIndex = parseInt(card.dataset.moduleIndex);
                const module = AppState.currentProject.learningPlan.modules[moduleIndex];

                if (target.dataset.action === 'open-action-selector') {
                    this.openActionSelectorModal(moduleIndex);
                } else if (target.closest('.dropdown-item.status-change-btn')) {
                    e.preventDefault(); // Prevent default link behavior
                    this.updateModuleField(moduleIndex, 'status', target.closest('.dropdown-item').dataset.status);
                } else if (target.dataset.action === 'view-studypad') { 
                    e.preventDefault();
                    this.openStudyPadViewer(moduleIndex);
                } else if (target.dataset.action === 'edit-notes') {
                    e.preventDefault();
                    this.openStudyPadViewer(moduleIndex, 'notes'); // Open study pad viewer, but with notes content
                } else if (target.matches('.view-details-btn')) { 
                    e.preventDefault();
                    const type = target.dataset.detailType;
                    this.openDetailViewer(moduleIndex, type);
                }
            },
            
            handleDashboardInput(e) {
                const target = e.target;
                const card = target.closest('.module-card');
                if (!card) return;
                const index = parseInt(card.dataset.moduleIndex);
                if (target.matches('.module-studypad')) {
                    this.updateModuleField(index, 'studyPad', target.value);
                } else if (target.matches('.module-notes')) {
                    this.updateModuleField(index, 'notes', target.value);
                }
            },

            updateModuleField(index, field, value) {
                const project = AppState.currentProject;
                if (!project?.learningPlan?.modules[index]) return;

                project.learningPlan.modules[index][field] = value;
                // Debounce Firestore save for module updates
                clearTimeout(AppState.saveTimeout);
                AppState.saveTimeout = setTimeout(async () => {
                    await DataManager.saveProject(project);
                    this.renderLearningDashboard(); // Re-render to update UI (e.g., progress bar)
                }, 1000); // Save after 1 second of inactivity
            },

            // Resource Management Page Handlers
            handleAddNewResourceForm() {
                this.dom.resourceIdPage.value = '';
                this.dom.resourceNamePage.value = '';
                this.dom.resourceContentPage.value = '';
                this.dom.resourceFileInputPage.value = '';
                this.showToast("정보", "새 자원 정보를 입력해주세요.", "info");
            },

            async handleResourceFileChange(e) {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const content = await this.readFileAsText(file);
                    this.dom.resourceContentPage.value = content;
                    if (!this.dom.resourceNamePage.value) {
                        this.dom.resourceNamePage.value = file.name.replace(/\.[^/.]+$/, "");
                    }
                } catch(err) { this.showToast('오류', err.message, 'danger'); }
                e.target.value = '';
            },

            async handleSaveResource() {
                const id = this.dom.resourceIdPage?.value;
                const name = this.dom.resourceNamePage?.value.trim();
                const content = this.dom.resourceContentPage?.value;
                if (!name || !content) return this.showToast("오류", "이름과 내용을 모두 입력하세요.", "danger");
                const project = AppState.currentProject;
                if (!project) return;
                if (!project.resources) project.resources = [];
                const existingResource = id ? project.resources.find(r => r.id === id) : null;

                if (existingResource) {
                    existingResource.name = name;
                    existingResource.content = content;
                } else {
                    project.resources.push({ id: `res_${Date.now()}`, name, content });
                }
                
                const success = await DataManager.saveProject(project);
                if (success) {
                    this.renderResourceManagementPage(); // Re-render this page
                    this.renderResourceList(); // Update sidebar list
                    this.handleClearResourceForm(); // Clear the form
                    this.showToast("성공", `자원이 ${id ? '수정' : '추가'}되었습니다.`, "success");
                }
            },

            handleClearResourceForm() {
                this.dom.resourceIdPage.value = '';
                this.dom.resourceNamePage.value = '';
                this.dom.resourceContentPage.value = '';
                this.dom.resourceFileInputPage.value = '';
            },

            handleResourceListClick(e) {
                const target = e.target;
                const listItem = target.closest('[data-resource-id]');
                if (!listItem) return;
                const resourceId = listItem.dataset.resourceId;

                if (target.matches('.edit-resource-btn')) {
                    this.renderResourceManagementPage(resourceId);
                } else if (target.matches('.delete-resource-btn')) {
                    this.showConfirmModal(`자원 삭제 확인`, `이 자원을 정말 삭제하시겠습니까?`, async () => {
                        const project = AppState.currentProject;
                        if (!project?.resources) return;
                        project.resources = project.resources.filter(r => r.id !== resourceId);
                        const success = await DataManager.saveProject(project);
                        if (success) {
                            this.renderResourceManagementPage();
                            this.renderResourceList();
                            this.showToast('성공', '자원이 삭제되었습니다.', "success");
                        }
                    });
                }
            },

            // Action Management Page Handlers
            handleAddNewActionForm() {
                this.dom.actionEditorFormPage.classList.remove('hidden');
                this.dom.actionEditorFormPage.reset();
                this.dom.actionKeyInputPage.value = `custom_${Date.now()}`;
                this.showToast("정보", "새 액션 정보를 입력해주세요.", "info");
            },

            handleCancelActionEdit() {
                this.dom.actionEditorFormPage.classList.add('hidden');
                this.dom.actionEditorFormPage.reset();
                this.renderActionManagementPage(); // Re-render to clear highlights/etc.
            },

            async handleSaveAction() {
                const key = this.dom.actionKeyInputPage?.value;
                const title = this.dom.actionTitleInputPage?.value.trim();
                const category = this.dom.actionCategoryInputPage?.value.trim();
                const purpose = this.dom.actionPurposeInputPage?.value;
                
                if (!title || !category || !purpose) {
                    return this.showToast('오류', '모든 필드를 입력해야 합니다.', 'danger');
                }
                const project = AppState.currentProject;
                if (!project) return;
                
                if (!project.actions) project.actions = [];
                const updatedAction = { key, title, category, purpose };
                const existingIndex = project.actions.findIndex(a => a.key === key);

                if (existingIndex > -1) {
                    project.actions[existingIndex] = updatedAction;
                } else {
                    project.actions.push(updatedAction);
                }
                
                const success = await DataManager.saveProject(project);
                if (success) {
                    this.renderActionManagementPage();
                    this.handleCancelActionEdit(); // Hide form and reset
                    this.showToast('성공', '액션이 저장되었습니다.', 'success');
                }
            },

            handleActionListClick(e) {
                const target = e.target;
                const listItem = target.closest('[data-action-key]');
                if (!listItem) return;
                const actionKey = listItem.dataset.actionKey;

                if (target.matches('.edit-action-btn')) {
                    this.renderActionManagementPage(actionKey);
                } else if (target.matches('.delete-action-btn')) {
                    this.showConfirmModal('액션 삭제 확인', '이 액션을 정말 삭제하시겠습니까?', async () => {
                        const project = AppState.currentProject;
                        if (!project?.actions) return;
                        project.actions = project.actions.filter(a => a.key !== actionKey);
                        
                        const success = await DataManager.saveProject(project);
                        if (success) {
                            this.renderActionManagementPage();
                            this.showToast('성공', '액션이 삭제되었습니다.', "success");
                        }
                    });
                }
            },

            openActionSelectorModal(moduleIndex) {
                const project = AppState.currentProject;
                if (!project) return this.showToast('오류', '프로젝트를 찾을 수 없습니다.', 'danger');
                
                const actions = project?.actions && project.actions.length > 0 ? project.actions : DEFAULT_ACTIONS;
                const groupedActions = actions.reduce((acc, action) => {
                    if (action.key === '0_plan') return acc;
                    const category = action.category || '기타';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(action);
                    return acc;
                }, {});

                const body = this.dom.actionSelectorBody;
                if (!body) return;
                body.innerHTML = ''; // Clear previous content

                for (const category of Object.keys(groupedActions).sort()) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'action-category mb-4';
                    categoryDiv.innerHTML = `<h6 class="text-xl font-bold mb-4">${category}</h6>`;
                    const actionGrid = document.createElement('div');
                    actionGrid.className = 'grid grid-cols-1 gap-3';
                    groupedActions[category].forEach(action => {
                        const button = document.createElement('button');
                        button.className = 'btn btn-outline-secondary w-full text-left justify-start';
                        button.dataset.templateKey = action.key;
                        button.dataset.moduleIndex = moduleIndex;
                        button.textContent = action.title;
                        button.setAttribute('aria-label', `${action.title} 프롬프트 생성`);
                        actionGrid.appendChild(button);
                    });
                    categoryDiv.appendChild(actionGrid);
                    body.appendChild(categoryDiv);
                }
                this.bs.actionSelectorModal.show();
                this.updateHelpVisibility(); // Update help icons in modal
            },

            handleBuildPrompt(templateKey, moduleIndex) {
                if (this.bs.actionSelectorModal) this.bs.actionSelectorModal.hide();

                const project = AppState.currentProject;
                if (!project) return this.showToast('오류', '프로젝트를 찾을 수 없습니다. 새로운 프로젝트를 생성하거나 선택하세요.', 'danger');
                
                const template = (project.actions || []).find(a => a.key === templateKey);
                if (!template) return this.showToast('오류', '액션을 찾을 수 없습니다.', "danger");

                const module = moduleIndex !== null && project.learningPlan ? project.learningPlan.modules[moduleIndex] : null;

                this.dom.promptModalLabel.textContent = template.title;
                this.dom.dynamicFormContainer.innerHTML = '';
                
                this.dom.dataSelector.innerHTML = '<option value="">자원 라이브러리에서 선택</option>';
                (project.resources || []).forEach(r => this.dom.dataSelector.innerHTML += `<option value="${r.id}">${r.name}</option>`);

                let purposeTemplate = template.purpose;
                const context = { 
                    '학습 목표': project.goal, 
                    '현재 수준': '지식이 필요한 학습자',
                    '프로젝트 이름': project.name,
                    ...(module || {}) 
                };
                if (module) {
                    context['모듈 제목'] = module.title;
                    context['핵심 개념'] = (module.keyConcepts || []).join(', ') || '없음';
                    if (module.recommendedResources && module.recommendedResources.length > 0) {
                        context['추천 리소스'] = module.recommendedResources.join(', ');
                    }
                }
                
                const variables = [...new Set([...purposeTemplate.matchAll(/\[(.*?)\]/g)].map(m => m[1]))];
                variables.forEach(varName => {
                    const prefilledValue = context[varName];
                    if (prefilledValue) {
                        purposeTemplate = purposeTemplate.replaceAll(`[${varName}]`, prefilledValue);
                    } else {
                        this.dom.dynamicFormContainer.innerHTML += `
                            <div class="mb-3">
                                <label for="var-${varName}" class="form-label text-sm">${varName}</label>
                                <input type="text" id="var-${varName}" class="form-control text-sm dynamic-var-input" data-var-name="${varName}" placeholder="${varName} 내용 입력...">
                            </div>
                        `;
                    }
                });

                let currentDataSource = 'none';
                if (module?.studyPad && (templateKey.startsWith('1_') || templateKey.startsWith('2_'))) {
                    currentDataSource = 'studypad';
                }
                this.dom.dataSourceRadios.forEach(radio => {
                    radio.checked = false;
                    if (radio.id === `source-${currentDataSource}`) {
                        radio.checked = true;
                    }
                });

                this.dom.dataDirectInput.value = '';
                
                this.updatePromptPreview(); // Initial preview update
                this.bs.promptModal.show();
                this.updateHelpVisibility(); // Update help icons in modal
            },

            updatePromptPreview() {
                const project = AppState.currentProject;
                if (!project) return; // Should not happen in prompt modal context

                const templateTitle = this.dom.promptModalLabel.textContent;
                const template = project.actions.find(a => a.title === templateTitle);
                if (!template) return;

                const moduleIndex = document.querySelector('.module-card[data-module-index] button[data-action="open-action-selector"]')?.dataset.moduleIndex;
                const module = moduleIndex !== undefined && project.learningPlan ? project.learningPlan.modules[moduleIndex] : null;

                let previewPurpose = template.purpose;
                this.dom.dynamicFormContainer.querySelectorAll('.dynamic-var-input').forEach(input => {
                    const varName = input.dataset.varName;
                    const value = input.value || `[${varName}]`;
                    previewPurpose = previewPurpose.replaceAll(`[${varName}]`, value);
                });
                
                const selectedDataSource = document.querySelector('input[name="dataSource"]:checked')?.value;
                let dataContent = '내용 없음';
                this.dom.dataSelectorContainer.classList.add('hidden');
                this.dom.dataDirectInputContainer.classList.add('hidden');

                if (selectedDataSource === 'resource') {
                    this.dom.dataSelectorContainer.classList.remove('hidden');
                    const resId = this.dom.dataSelector?.value;
                    if (resId) dataContent = (project.resources.find(r => r.id === resId) || {}).content;
                } else if (selectedDataSource === 'studypad') {
                    if (module?.studyPad) dataContent = module.studyPad;
                } else if (selectedDataSource === 'direct') {
                    this.dom.dataDirectInputContainer.classList.remove('hidden');
                    dataContent = this.dom.dataDirectInput.value;
                }
                
                const contextForAI = {
                    projectName: project.name,
                    mainGoal: project.goal,
                };
                if (project.learningPlan) {
                    contextForAI.tutorPersona = project.learningPlan.tutorPersona;
                    contextForAI.fullTableOfContents = project.learningPlan.modules.map(m => ({ id: m.id, title: m.title, status: m.status }));
                }
                if (module) {
                    const { studyPad, notes, ...currentModuleContext } = module;
                    contextForAI.currentModule = currentModuleContext;
                }
                const projectContext = JSON.stringify(contextForAI, null, 2);
                let finalPrompt = MASTER_PROMPT_SHELL.replace(/{{purpose}}/g, previewPurpose)
                                                     .replace(/{{data}}/g, dataContent || '내용 없음')
                                                     .replace(/{{projectContext}}/g, projectContext);
                this.dom.livePreviewContainer.textContent = finalPrompt;
            },

            handleExecutePrompt() {
                const finalPromptText = this.dom.livePreviewContainer?.textContent || '';
                this.copyToClipboard(finalPromptText);
            },
            
            // Study Pad Viewer & Editor (Modals)
            openStudyPadViewer(moduleIndex, contentType = 'studyPad') {
                const project = AppState.currentProject;
                if (!project || !project.learningPlan?.modules[moduleIndex]) {
                    return this.showToast("오류", "모듈을 찾을 수 없습니다.", "danger");
                }
                const module = project.learningPlan.modules[moduleIndex];
                
                AppState.currentModuleIndexForViewer = moduleIndex;
                AppState.currentViewerContentType = contentType; // 'studyPad' or 'notes'

                this.dom.studyPadViewerContent.classList.remove('hidden');
                this.dom.studyPadEditorContent.classList.add('hidden');
                this.dom.toggleViewerModeBtn.textContent = '편집 모드';
                this.dom.saveViewerContentBtn.classList.add('hidden');

                const content = module[contentType] || '';
                this.dom.studyPadViewerTitle.textContent = `${module.title} ${contentType === 'studyPad' ? '스터디 패드' : '개인 메모'}`;
                this.dom.studyPadViewerContent.innerHTML = marked.parse(content || '내용이 없습니다.');
                this.dom.studyPadEditorContent.value = content;
                
                this.bs.studyPadViewerModal.show();

                this.dom.studyPadViewerModal.addEventListener('shown.bs.modal', function handler() {
                    const savedScroll = UIManager.scrollPositions[`module_${moduleIndex}_${contentType}`];
                    if (savedScroll !== undefined) {
                        UIManager.dom.studyPadViewerContent.scrollTop = savedScroll;
                        UIManager.dom.studyPadEditorContent.scrollTop = savedScroll;
                    }
                    if (typeof MathJax !== 'undefined') {
                        MathJax.typesetPromise([UIManager.dom.studyPadViewerContent]).catch((err) => console.error('MathJax rendering failed:', err));
                    }
                    UIManager.dom.studyPadViewerModal.removeEventListener('shown.bs.modal', handler);
                });
            },

            toggleStudyPadViewerMode() {
                const moduleIndex = AppState.currentModuleIndexForViewer;
                const contentType = AppState.currentViewerContentType;
                const isEditing = this.dom.studyPadViewerContent.classList.contains('hidden');

                const currentScroll = isEditing ? this.dom.studyPadEditorContent.scrollTop : this.dom.studyPadViewerContent.scrollTop;
                this.scrollPositions[`module_${moduleIndex}_${contentType}`] = currentScroll;
                DataManager.saveLocalState();

                if (!isEditing) { // Viewer mode to Editor mode
                    this.dom.studyPadViewerContent.classList.add('hidden');
                    this.dom.studyPadEditorContent.classList.remove('hidden');
                    this.dom.studyPadEditorContent.focus();
                    this.dom.studyPadEditorContent.scrollTop = currentScroll;
                    this.dom.toggleViewerModeBtn.textContent = '뷰어 모드';
                    this.dom.saveViewerContentBtn.classList.remove('hidden');
                } else { // Editor mode to Viewer mode
                    this.dom.studyPadViewerContent.innerHTML = marked.parse(this.dom.studyPadEditorContent.value);
                    if (typeof MathJax !== 'undefined') {
                        MathJax.typesetPromise([this.dom.studyPadViewerContent]).catch((err) => console.error('MathJax rendering failed:', err));
                    }
                    this.dom.studyPadViewerContent.classList.remove('hidden');
                    this.dom.studyPadViewerContent.scrollTop = currentScroll;
                    this.dom.studyPadEditorContent.classList.add('hidden');
                    this.dom.toggleViewerModeBtn.textContent = '편집 모드';
                    this.dom.saveViewerContentBtn.classList.add('hidden');
                }
            },

            saveStudyPadViewerContent() {
                const moduleIndex = AppState.currentModuleIndexForViewer;
                const contentType = AppState.currentViewerContentType;
                if (moduleIndex === null) {
                    return this.showToast("오류", "저장할 모듈을 찾을 수 없습니다.", "danger");
                }
                const newContent = this.dom.studyPadEditorContent.value;
                this.updateModuleField(moduleIndex, contentType, newContent); // This will save to DB
                this.showToast("성공", `${contentType === 'studyPad' ? '스터디 패드' : '개인 메모'} 내용이 저장되었습니다.`, "success");
                this.toggleStudyPadViewerMode(); // Switch back to viewer mode after saving
            },

            // Detail Viewer Modal
            openDetailViewer(moduleIndex, type) {
                const project = AppState.currentProject;
                if (!project || !project.learningPlan?.modules[moduleIndex]) {
                    return this.showToast("오류", "모듈을 찾을 수 없습니다.", "danger");
                }
                const module = project.learningPlan.modules[moduleIndex];
                let title = '';
                let content = '';
                let iconClass = '';

                if (type === 'learning-objectives') {
                    title = `${module.title} 학습 목표`;
                    content = (module.learningObjectives || []).map(obj => `• ${obj}`).join('\n');
                    iconClass = 'fa-clipboard-list';
                } else if (type === 'key-concepts') {
                    title = `${module.title} 핵심 개념`;
                    content = (module.keyConcepts || []).map(concept => `• ${concept}`).join('\n');
                    iconClass = 'fa-lightbulb';
                } else if (type === 'recommended-resources') {
                    title = `${module.title} 추천 리소스`;
                    content = (module.recommendedResources || []).map(resource => `• ${resource}`).join('\n');
                    iconClass = 'fa-book-open';
                }
                
                this.dom.detailViewerTitle.innerHTML = `<i class="fa-solid ${iconClass} mr-2"></i> ${title}`;
                this.dom.detailViewerBody.querySelector('pre').textContent = content || '내용 없음'; 
                this.bs.detailViewerModal.show();
            },

            async handleDownloadAllStudyPads() {
                const project = AppState.currentProject;
                if (!project || !project.learningPlan?.modules?.length) {
                    return this.showToast("정보", "다운로드할 스터디 패드 내용이 없습니다.", "info");
                }

                let combinedContent = `# ${project.name}\n\n`;
                combinedContent += `## 최종 학습 목표\n${project.goal || '없음'}\n\n`;
                combinedContent += `---\n\n`;

                project.learningPlan.modules.forEach((module, index) => {
                    combinedContent += `## ${index + 1}. ${module.title}\n\n`;
                    combinedContent += `### 핵심 개념: ${(module.keyConcepts || []).join(', ')}\n\n`;
                    combinedContent += `### 학습 목표: ${(module.learningObjectives || []).join(', ')}\n\n`;
                    if (module.recommendedResources && module.recommendedResources.length > 0) {
                        combinedContent += `### 추천 리소스: ${module.recommendedResources.join(', ')}\n\n`;
                    }
                    combinedContent += `### 스터디 패드\n\n`;
                    combinedContent += `${module.studyPad || '작성된 내용 없음.'}\n\n`;
                    if (module.notes) {
                        combinedContent += `### 개인 메모\n\n`;
                        combinedContent += `${module.notes}\n\n`;
                    }
                    combinedContent += `---\n\n`;
                });

                const blob = new Blob([combinedContent], { type: 'text/markdown;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const safeFileName = project.name.replace(/[/\\?%*:|"<>]/g, '-') || 'study-pads';
                a.href = url;
                a.download = `${safeFileName}_study_pads.md`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 100);
                this.showToast("성공", "스터디 패드 내용이 다운로드되었습니다.", "success");
            },

            // --- Utility Functions ---
            showToast(title, body, type = 'info') {
                this.dom.toastTitle.textContent = title;
                this.dom.toastBody.textContent = body;
                // Fixed: Use Bootstrap's built-in background classes for toast color
                this.dom.liveToast.className = `toast bg-${type === 'info' ? 'blue' : type === 'success' ? 'green' : type === 'danger' ? 'red' : 'gray'}-100 text-${type === 'info' ? 'blue' : type === 'success' ? 'green' : type === 'danger' ? 'red' : 'gray'}-800 border border-${type === 'info' ? 'blue' : type === 'success' ? 'green' : type === 'danger' ? 'red' : 'gray'}-200 rounded-lg shadow-lg fixed bottom-0 right-0 p-3 z-50`;
                this.dom.toastTitle.className = `font-bold ${type === 'info' ? 'text-blue' : type === 'success' ? 'text-green' : type === 'danger' ? 'text-red' : 'text-gray'}-700`;

                this.bs.toast.show();
            },

            showConfirmModal(title, message, onConfirm) {
                // Fixed: Use custom modal HTML instead of native confirm
                const modalHtml = `
                    <div class="modal fade" id="customConfirmModal" tabindex="-1" aria-labelledby="customConfirmModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="customConfirmModalLabel">${title}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p>${message}</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                    <button type="button" class="btn btn-danger" id="customConfirmActionBtn">확인</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                const existingModal = document.getElementById('customConfirmModal');
                if (existingModal) existingModal.remove(); // Remove any existing to prevent duplicates

                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const confirmModal = new bootstrap.Modal(document.getElementById('customConfirmModal'));
                confirmModal.show();

                document.getElementById('customConfirmActionBtn').onclick = () => {
                    onConfirm();
                    confirmModal.hide();
                };
                document.getElementById('customConfirmModal').addEventListener('hidden.bs.modal', () => {
                    document.getElementById('customConfirmModal').remove();
                });
            },

            readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => {
                        reader.abort();
                        reject(new DOMException("파일 읽기 중 문제가 발생했습니다."));
                    };
                    reader.readAsText(file);
                });
            },

            copyToClipboard(text) {
                if (navigator.clipboard?.writeText) {
                    navigator.clipboard.writeText(text)
                        .then(() => this.showToast("성공", "클립보드에 복사되었습니다.", "success"))
                        .catch(err => {
                            console.warn("Clipboard API failed, attempting fallback:", err);
                            this.fallbackCopyToClipboard(text);
                        });
                } else {
                    this.fallbackCopyToClipboard(text);
                }
            },

            fallbackCopyToClipboard(text) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.opacity = "0";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    this.showToast("성공", "클립보드에 복사되었습니다.", "success");
                } catch (err) {
                    this.showToast("오류", "클립보드 복사에 실패했습니다.", "danger");
                    console.error("Fallback copy failed:", err);
                }
                document.body.removeChild(textArea);
            },

            toggleSidebar() {
                this.dom.sidebar.classList.toggle('is-open');
                this.dom.overlay.classList.toggle('is-visible');
                document.body.classList.toggle('sidebar-open'); // Fixed: Add class to body to prevent scroll
            },

            // --- Help Feature Implementation ---
            updateHelpVisibility() {
                // Fixed: Select direct child span.help-tooltip
                document.querySelectorAll('.help-icon').forEach(icon => {
                    const tooltip = icon.querySelector('.help-tooltip'); 
                    if (tooltip) { // Only proceed if tooltip span exists inside the icon
                        if (AppConfig.showHelp) {
                            icon.classList.remove('hidden');
                            tooltip.textContent = HELP_MESSAGES[icon.dataset.helpKey] || '도움말을 찾을 수 없습니다.';
                            // Position tooltip dynamically relative to the icon if needed, or rely on CSS
                            // For complex positioning, consider Popper.js or similar
                        } else {
                            icon.classList.add('hidden');
                            tooltip.style.opacity = '0';
                            tooltip.style.visibility = 'hidden';
                        }
                    }
                });
            },

            showHelpTooltip(iconElement, key) {
                if (!AppConfig.showHelp) return; // Only show if help is enabled
                this.hideAllHelpTooltips(); 
                const tooltip = iconElement.querySelector('.help-tooltip');
                if (tooltip) {
                    tooltip.style.opacity = '1';
                    tooltip.style.visibility = 'visible';
                }
            },

            hideAllHelpTooltips() {
                document.querySelectorAll('.help-tooltip').forEach(tooltip => {
                    tooltip.style.opacity = '0';
                    tooltip.style.visibility = 'hidden';
                });
            },

            resetProjectCreationForm() {
                this.dom.newProjectNamePage.value = '';
                this.dom.newProjectGoalPage.value = '';
            }
        };

        // --- Initial Application Bootstrapping ---
        document.addEventListener('DOMContentLoaded', async () => {
            UIManager.init();
            AppConfig.init(); // Load help state first

            // Sync help toggle checkbox with loaded config
            if (UIManager.dom.toggleHelpBtn) {
                UIManager.dom.toggleHelpBtn.checked = AppConfig.showHelp;
            }

            // Initialize Firebase App and services
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase services initialized.");

                // Set up auth state listener
                onAuthStateChanged(auth, async (user) => {
                    AppState.isAuthReady = true;
                    if (user) {
                        AppState.currentUser = { uid: user.uid, displayName: user.displayName, email: user.email };
                        UIManager.dom.authStatus.textContent = `${user.displayName}님 환영합니다! (UID: ${user.uid.substring(0, 8)}...)`;
                        UIManager.dom.googleSigninBtn.classList.add('hidden');
                        UIManager.dom.signOutBtn.classList.remove('hidden');
                        
                        await DataManager.loadProjects(user.uid);
                        const lastActiveProjectId = DataManager.loadLocalState();
                        if (lastActiveProjectId && AppState.projects[lastActiveProjectId]) {
                            AppState.currentProject = AppState.projects[lastActiveProjectId];
                        } else if (Object.keys(AppState.projects).length > 0) {
                            AppState.currentProject = Object.values(AppState.projects)[0];
                        } else {
                            AppState.currentProject = null;
                        }
                        UIManager.renderApp();
                        UIManager.showToast("로그인됨", `${user.displayName}님 환영합니다!`, "success");
                    } else {
                        AppState.currentUser = null;
                        AppState.currentProject = null;
                        AppState.projects = {};
                        UIManager.dom.authStatus.textContent = "로그인이 필요합니다.";
                        UIManager.dom.googleSigninBtn.classList.remove('hidden');
                        UIManager.dom.signOutBtn.classList.add('hidden');
                        DataManager.saveLocalState(); // Clear local active project
                        UIManager.renderApp();
                        UIManager.showToast("로그아웃됨", "로그인하여 프로젝트를 관리하세요.", "info");
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed at boot:", e);
                UIManager.showToast("오류", "Firebase 서비스 초기화에 실패했습니다. 기능이 제한될 수 있습니다: " + e.message, "danger");
                UIManager.dom.authStatus.textContent = "Firebase 연결 오류";
                UIManager.dom.googleSigninBtn.disabled = true;
                UIManager.dom.signOutBtn.disabled = true;
                AppState.isAuthReady = true; // Mark as ready even if failed, to proceed with local state
                UIManager.renderApp(); // Render with no projects
            }
        });
    </script>
</body>
</html>
