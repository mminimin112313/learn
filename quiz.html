<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Quiz Obsidian (v20.11 - Fixed & Complete)</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600&family=Nanum+Gothic:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Dependencies -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- JSZip for Zip Handling -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <!-- Markdown & Math -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
      GoogleAuthProvider, signInWithPopup, signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, 
      onSnapshot, collection, query, where, orderBy, writeBatch
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    window.firebase = {
      app: { initializeApp },
      auth: { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut },
      firestore: { getFirestore, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, writeBatch }
    };
  </script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBR_9ivOtQRIW_KIQRYBxJ_nFtYL7GYZwg",
      authDomain: "quiz-436ac.firebaseapp.com",
      projectId: "quiz-436ac",
      storageBucket: "quiz-436ac.firebasestorage.app",
      messagingSenderId: "131117093431",
      appId: "1:131117093431:web:56e1beff4c63d35b5b25b2"
    };
    window.__firebase_config = JSON.stringify(firebaseConfig);
    window.__app_id = "quiz-436ac"; 
  </script>
  
  <!-- Styles -->
  <style>
    :root {
        --bg-dark: #050505;
        --bg-panel: #0a0a0a;
        --border-glass: 1px solid rgba(255, 255, 255, 0.1);
        --font-main: 'Inter', 'Nanum Gothic', sans-serif;
        --accent-blue: #3b82f6;
    }
    body { font-family: var(--font-main); background-color: var(--bg-dark); color: #e5e5e5; height: 100vh; overflow: hidden; margin: 0; }
    
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }

    .glass-panel { background: rgba(255, 255, 255, 0.03); border: var(--border-glass); }
    .glass-modal { background: #1a1a1a; border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
    .glass-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s; }
    .glass-btn:hover { background: rgba(255, 255, 255, 0.1); border-color: rgba(255,255,255,0.3); }
    
    .app-container { display: flex; height: 100vh; }
    .sidebar-container { width: 50px; display: flex; flex-direction: column; border-right: var(--border-glass); background: var(--bg-panel); z-index: 20; }
    .sidebar-view { width: 320px; background: var(--bg-panel); border-right: var(--border-glass); display: flex; flex-direction: column; transition: width 0.3s; flex-shrink: 0; }
    .main-area { flex-grow: 1; display: flex; flex-direction: column; background: var(--bg-dark); position: relative; overflow: hidden; }
    
    .file-node { padding: 4px 8px; display: flex; align-items: center; cursor: pointer; border-radius: 4px; color: #a3a3a3; user-select: none; }
    .file-node:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .file-node[data-active='true'] { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .file-node[data-drag-over='true'] { border: 1px dashed #60a5fa; background: rgba(59, 130, 246, 0.1); }
    
    .input-std { background: rgba(0,0,0,0.3); border: 1px solid #333; color: white; padding: 8px 12px; border-radius: 6px; width: 100%; transition: border-color 0.2s; }
    .input-std:focus { outline: none; border-color: var(--accent-blue); }
    
    .btn-primary { background: var(--accent-blue); color: white; padding: 6px 16px; border-radius: 4px; font-weight: 500; transition: 0.2s; }
    .btn-primary:hover { filter: brightness(1.1); }

    .btn-secondary { background: rgba(255,255,255,0.1); color: #ccc; padding: 6px 12px; border-radius: 4px; font-size: 0.8rem; transition: 0.2s; }
    .btn-secondary:hover { background: rgba(255,255,255,0.2); color: white; }
    
    .markdown-body { font-family: var(--font-main); color: #e5e5e5; line-height: 1.7; padding: 40px; overflow-y: auto; height: 100%; }
    .markdown-body h1 { font-size: 2em; border-bottom: 1px solid #333; padding-bottom: 0.3em; margin-top: 1.5em; color: #fff; }
    .markdown-body code { background: rgba(255,255,255,0.1); padding: 0.2em 0.4em; border-radius: 3px; font-family: monospace; }
    .markdown-body pre { background: #1e1e1e; padding: 1em; border-radius: 8px; overflow-x: auto; }
    
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 50; animation: fadeIn 0.2s; }
    .modal-content { animation: scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .context-menu { position: fixed; z-index: 1000; background: #252526; border: 1px solid #454545; box-shadow: 0 4px 12px rgba(0,0,0,0.5); border-radius: 6px; min-width: 160px; padding: 4px; }
    .context-item { padding: 6px 12px; cursor: pointer; font-size: 13px; color: #ccc; border-radius: 4px; display: flex; align-items: center; gap: 8px; }
    .context-item:hover { background: #094771; color: white; }
    .context-divider { height: 1px; background: #454545; margin: 4px 0; }

    .quiz-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); padding: 12px; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
    .quiz-card:hover { border-color: rgba(59, 130, 246, 0.5); background: rgba(255,255,255,0.05); }

    .lower-pane-header { padding: 8px 12px; font-size: 0.75rem; font-weight: bold; color: #666; text-transform: uppercase; letter-spacing: 0.05em; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); }
    
    /* Loading Overlay */
    .loading-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(2px); }
    .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-left-color: var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="root"></div>
  <input type="file" id="file-upload-input" style="display: none" multiple />

  <script type="module">
    const { useState, useEffect, useCallback, useMemo, createContext, useContext, useRef } = React;
    const { createRoot } = ReactDOM;
    const e = React.createElement;
    const { app, auth, firestore } = window.firebase;
    const { initializeApp } = app;
    const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } = auth;
    const { getFirestore, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, writeBatch } = firestore;

    const AppContext = createContext(null);
    const ToastContext = createContext(null);
    const ModalContext = createContext(null);
    const useToast = () => useContext(ToastContext);
    const useModal = () => useContext(ModalContext);

    const useHashRoute = () => {
      const [route, setRoute] = useState(window.location.hash.slice(1) || 'files');
      useEffect(() => {
        const onHashChange = () => setRoute(window.location.hash.slice(1) || 'files');
        window.addEventListener('hashchange', onHashChange);
        return () => window.removeEventListener('hashchange', onHashChange);
      }, []);
      const navigate = (path) => window.location.hash = path;
      return { route, navigate };
    };

    /* --- WORKER SCRIPT --- */
    const workerScript = `
      const fetchWithRetry = async (url, options, retries = 3) => {
        for (let i = 0; i < retries; i++) {
          try { const res = await fetch(url, options); if (!res.ok) throw new Error(res.status); return res.json(); } 
          catch (e) { if (i < retries - 1) await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i))); else throw e; }
        }
      };

      self.onmessage = async (e) => {
        const { id, taskType, sourceText, options, settings, attempt } = e.data;
        try {
          const activeKey = settings?.apiKeys?.find(k => k.isActive)?.key || settings?.apiKeys?.[0]?.key;
          if (!activeKey) throw new Error('No Active API Key found in Settings');
          
          const model = settings.modelName || "gemini-2.5-flash";
          const baseUrl = \`https://generativelanguage.googleapis.com/v1beta/models/\${model}:generateContent?key=\${activeKey}\`;

          if (taskType === 'generate') {
             let baseTemplate = options.promptTemplate || "No Template Provided";
             let systemInstruction = baseTemplate
                .replace('{{DIFFICULTY}}', options.difficulty)
                .replace('{{QUESTION_TYPE}}', options.questionType)
                .replace('{{NUM_QUESTIONS}}', options.numQuestions)
                .replace('{{INCLUDE_SNIPPETS}}', options.includeSnippets ? "Include code snippets." : "Do NOT include code snippets/source text in questions.")
                .replace('{{PROVIDE_ANSWER_KEY}}', options.provideAnswerKey ? "Set correctAnswerIndex." : "")
                .replace('{{CUSTOM_INSTRUCTIONS}}', options.customInstructions || "");
             
             const payload = {
                contents: [{ role: "user", parts: [{ text: \`--- SOURCE ---\\n\${sourceText}\\n--- END ---\` }] }],
                systemInstruction: { parts: [{ text: systemInstruction + " JSON Schema: { title: string, questions: [{ questionText: string, options: string[], correctAnswerIndex: number, gradingCriteria: string, contextSnippet: string, questionType: string }] }" }] },
                generationConfig: { responseMimeType: "application/json" }
             };
             const res = await fetchWithRetry(baseUrl, { method: 'POST', body: JSON.stringify(payload) });
             const text = res.candidates?.[0]?.content?.parts?.[0]?.text;
             self.postMessage({ status: 'success', taskId: id, taskType, quizData: JSON.parse(text), options });
          } else if (taskType === 'grade') {
              const answers = JSON.parse(attempt.answers);
              const gradingPromises = answers.map(async (ans) => {
                  if(ans.isCorrect !== null) return ans; 
                  const prompt = \`Grade this answer.\\nQuestion: \${ans.questionText}\\nCriteria: \${ans.gradingCriteria}\\nUser Answer: \${ans.selectedAnswer}\\nOutput JSON: { isCorrect: boolean, feedback: string }\`;
                  const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
                  const res = await fetchWithRetry(baseUrl, { method: 'POST', body: JSON.stringify(payload) });
                  const result = JSON.parse(res.candidates[0].content.parts[0].text);
                  return { ...ans, isCorrect: result.isCorrect, feedback: result.feedback };
              });
              const gradedAnswers = await Promise.all(gradingPromises);
              const score = gradedAnswers.filter(a => a.isCorrect).length;
              self.postMessage({ status: 'success', taskId: id, taskType, updatedAttempt: { ...attempt, score, answers: JSON.stringify(gradedAnswers) } });
          }
        } catch (err) { self.postMessage({ status: 'error', taskId: id, taskType, error: err.message }); }
      };
    `;
    const workerUrl = URL.createObjectURL(new Blob([workerScript], { type: 'application/javascript' }));

    /* --- UI HELPERS --- */
    const ModalProvider = ({ children }) => {
        const [modal, setModal] = useState(null);
        return e(ModalContext.Provider, { value: { openModal: setModal, closeModal: () => setModal(null) } },
            children,
            modal && e('div', { className: 'modal-overlay', onClick: () => setModal(null) },
                e('div', { className: 'glass-modal modal-content rounded-xl p-0 w-full max-w-3xl flex flex-col max-h-[85vh] overflow-hidden', onClick: e => e.stopPropagation() },
                      e('div', { className: 'flex justify-between items-center p-4 border-b border-white/10 bg-black/40' },
                        e('h3', { className: 'text-lg font-semibold text-white' }, modal.title),
                        e('button', { onClick: () => setModal(null), className: 'text-gray-400 hover:text-white' }, e('i', { className: 'bi bi-x-lg' }))
                    ),
                    e('div', { className: 'p-6 overflow-y-auto flex-1' }, modal.content),
                    modal.footer && e('div', { className: 'p-4 border-t border-white/10 bg-black/20 flex justify-end gap-2' }, modal.footer)
                )
            )
        );
    };

    const ToastProvider = ({ children }) => {
        const [toasts, setToasts] = useState([]);
        const show = useCallback((msg, type='info') => { const id=Date.now(); setToasts(p=>[...p,{id,msg,type}]); setTimeout(()=>setToasts(p=>p.filter(t=>t.id!==id)),3000); }, []);
        return e(ToastContext.Provider, { value: { show } }, children, e('div', { className: 'toast-container fixed bottom-5 right-5 flex flex-col gap-2 z-50' }, toasts.map(t => e('div', { key: t.id, className: `px-4 py-3 rounded shadow-lg border flex items-center gap-3 ${t.type==='success'?'bg-green-900/80 border-green-500':t.type==='error'?'bg-red-900/80 border-red-500':'bg-gray-800/90 border-gray-600'} text-white` }, e('i', { className: `bi ${t.type==='success'?'bi-check-circle':t.type==='error'?'bi-exclamation-circle':'bi-info-circle'}` }), t.msg))));
    };

    const ContextMenu = ({ data, onClose, actions }) => {
        if (!data) return null;
        return e('div', { className: 'context-menu', style: { top: data.y, left: data.x }, onClick: e=>e.stopPropagation() },
            actions.map((act, i) => act === 'divider' 
                ? e('div', { key: i, className: 'context-divider' })
                : e('div', { key: i, className: 'context-item', onClick: () => { onClose(); act.action(); } }, 
                    act.icon && e('i', { className: `bi ${act.icon}` }), act.label)
            )
        );
    };

    const PromptModal = ({ label, placeholder, onSubmit, onCancel }) => {
        const [value, setValue] = useState('');
        const [isSubmitting, setIsSubmitting] = useState(false);
        const handleSubmit = async () => {
            if (isSubmitting || !value.trim()) return;
            setIsSubmitting(true);
            await onSubmit(value);
        };
        return e('div', { className: 'flex flex-col gap-4' },
            e('div', { className: 'flex flex-col gap-2' },
                e('label', { className: 'text-xs text-gray-400 font-bold' }, label),
                e('input', { className: 'input-std', value, onChange: e => setValue(e.target.value), placeholder, autoFocus: true, disabled: isSubmitting, onKeyDown: e => { if (e.key === 'Enter') handleSubmit(); } })
            ),
            e('div', { className: 'flex justify-end gap-2' },
                e('button', { className: 'glass-btn px-4 py-2 rounded text-gray-300', onClick: onCancel, disabled: isSubmitting }, 'Cancel'),
                e('button', { className: 'btn-primary px-4 py-2 rounded', onClick: handleSubmit, disabled: isSubmitting }, isSubmitting ? 'Creating...' : 'Create')
            )
        );
    };

    // DEFAULT PROMPT TEMPLATE
    const DEFAULT_PROMPT = `
<AIFramework_V3>
    <Cognitive_Core>
        <Persona>Dr. Elias Thorne, Chief Assessment Architect. Expert in high-stakes educational assessment.</Persona>
        <Prime_Directive>Create professional assessment questions based on SOURCE_TEXT.</Prime_Directive>
    </Cognitive_Core>
    <Operational_Cortex>
        <Directive_Protocol>
            <Rules>
                <Rule name="Output Format">Output ONLY valid JSON matching the schema.</Rule>
                <Rule name="Snippets">{{INCLUDE_SNIPPETS}}</Rule>
                <Rule name="Grading">{{PROVIDE_ANSWER_KEY}}</Rule>
                <Rule name="Custom">{{CUSTOM_INSTRUCTIONS}}</Rule>
                <Rule name="SpecificType">Generate questions of type: {{QUESTION_TYPE}}</Rule>
                <Rule name="Difficulty">Target difficulty level: {{DIFFICULTY}}</Rule>
                <Rule name="Quantity">Generate exactly {{NUM_QUESTIONS}} questions.</Rule>
            </Rules>
        </Directive_Protocol>
    </Operational_Cortex>
</AIFramework_V3>`;

    /* --- APP COMPONENTS --- */
    const QuizTaker = ({ quiz, onClose, onSubmit }) => {
        const [questions] = useState(() => { try { return JSON.parse(quiz.questions); } catch(e) { return []; } });
        const [answers, setAnswers] = useState({});
        const [visibleHints, setVisibleHints] = useState({}); 
        const handleSubmit = () => {
            const results = questions.map((q, idx) => {
                const userAns = answers[idx];
                let isCorrect = null;
                if (q.questionType === 'MultipleChoice') isCorrect = (parseInt(userAns) === q.correctAnswerIndex);
                return { ...q, selectedAnswer: userAns, isCorrect };
            });
            const score = results.filter(r => r.isCorrect === true).length;
            onSubmit({ quizId: quiz.id, quizTitle: quiz.title, total: questions.length, score, answers: JSON.stringify(results), createdAt: new Date().toISOString() });
            onClose();
        };
        return e('div', { className: 'flex flex-col gap-6' },
            questions.map((q, idx) => e('div', { key: idx, className: 'quiz-question border-b border-white/10 pb-4' },
                e('div', { className: 'flex gap-3 mb-3' }, e('span', { className: 'text-blue-400 font-bold' }, `Q${idx+1}`), e('div', { className: 'text-lg text-gray-200' }, q.questionText)),
                q.contextSnippet && e('div', { className: 'mb-4' }, !visibleHints[idx] ? e('button', { className: 'text-xs text-gray-500 hover:text-blue-400 flex items-center gap-1', onClick: () => setVisibleHints(p => ({...p, [idx]: true})) }, e('i', { className: 'bi bi-eye' }), 'Show Hint (Context)') : e('div', null, e('pre', { className: 'bg-black/30 p-3 rounded text-sm text-gray-400 font-mono overflow-x-auto relative' }, q.contextSnippet, e('button', { className: 'absolute top-2 right-2 text-gray-500 hover:text-white', onClick: () => setVisibleHints(p => ({...p, [idx]: false})) }, e('i', { className: 'bi bi-eye-slash' }))))),
                (q.questionType === 'MultipleChoice') ? (e('div', { className: 'flex flex-col gap-2' }, (q.options || []).map((opt, oIdx) => e('label', { key: oIdx, className: 'quiz-option bg-white/5 rounded p-3 cursor-pointer hover:bg-white/10 flex items-center gap-3' }, e('input', { type: 'radio', name: `q${idx}`, checked: answers[idx] == oIdx, onChange: () => setAnswers(p => ({...p, [idx]: oIdx})) }), e('span', { className: 'text-gray-300' }, opt))))) : (e('textarea', { className: 'input-std h-24 resize-none', placeholder: 'Answer...', value: answers[idx]||'', onChange: e => setAnswers(p => ({...p, [idx]: e.target.value})) }))
            )),
            e('div', { className: 'flex justify-end mt-4' }, e('button', { className: 'btn-primary px-8 py-2', onClick: handleSubmit }, 'Submit'))
        );
    };

    const QuizResult = ({ attempt, onClose, onGradeAI }) => {
        const results = JSON.parse(attempt.answers);
        return e('div', { className: 'flex flex-col gap-6' },
            e('div', { className: 'text-center p-6 bg-white/5 rounded-xl border border-white/10' }, e('div', { className: 'text-4xl font-bold text-white mb-2' }, `${attempt.score} / ${attempt.total}`), e('div', { className: 'text-sm text-gray-400' }, 'SCORE')),
            results.map((r, idx) => e('div', { key: idx, className: 'p-4 bg-white/5 rounded-lg' }, e('div', { className: 'flex justify-between mb-2' }, e('span', { className: 'font-bold text-gray-200' }, `Q${idx+1}. ${r.questionText}`), r.isCorrect === true ? e('span', { className: 'text-green-400' }, 'Correct') : r.isCorrect === false ? e('span', { className: 'text-red-400' }, 'Incorrect') : e('span', { className: 'text-yellow-400' }, 'Pending')), e('div', { className: 'text-sm text-gray-400 ml-4' }, `Your Answer: ${r.options ? r.options[r.selectedAnswer] : r.selectedAnswer}`), r.isCorrect === false && r.options && e('div', { className: 'text-sm text-green-400 ml-4 mt-1' }, `Correct Answer: ${r.options[r.correctAnswerIndex]}`), r.feedback && e('div', { className: 'mt-3 p-3 bg-blue-900/20 border-l-2 border-blue-500 text-sm text-blue-200' }, e('strong', null, 'AI Feedback: '), r.feedback))),
            onGradeAI && results.some(r => r.isCorrect === null) && e('div', { className: 'flex justify-center mt-4' }, e('button', { className: 'btn-primary flex items-center gap-2', onClick: onGradeAI }, e('i', { className: 'bi bi-stars' }), 'Grade with AI'))
        );
    };

    const FileManagerView = () => {
        const { fileTree, fileActions, userId, setEditingNodeId, quizzes, activeEditorFile, setActiveEditorFile, openModalWrapper, handleQuizSubmit, dispatchTask, quizOptions, updateQuizTitle, handleGenerateQuiz, expandedFolders, toggleFolder, deleteQuiz, activeProjectId, projects, setActiveProjectId, files } = useContext(AppContext);
        const { openModal, closeModal } = useModal();
        const [contextMenu, setContextMenu] = useState(null);
        const [dragOverId, setDragOverId] = useState(null); 
        const [isUploading, setIsUploading] = useState(false); 
        
        const currentProject = projects.find(p => p.id === activeProjectId);

        /* --- FILE PROCESSING LOGIC --- */
        const ALLOWED_EXTS = ['txt', 'md', 'srt', 'csv', 'json', 'js', 'html', 'css', 'py', 'java', 'c', 'cpp'];

        const readFileContent = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsText(file);
        });

        // Recursive folder creation logic for ZIP paths
        const ensureFolderPath = async (pathParts, rootId) => {
            let currentParentId = rootId;
            let localCreatedFolders = []; 

            for (const part of pathParts) {
                // Check in global files OR locally created ones
                let existing = files.find(f => f.name === part && f.type === 'folder' && f.parentId === currentParentId) 
                               || localCreatedFolders.find(f => f.name === part && f.parentId === currentParentId);

                if (existing) {
                    currentParentId = existing.id;
                } else {
                    // Create new folder
                    const docRef = await fileActions.create(currentParentId, 'folder', part);
                    currentParentId = docRef.id; // fileActions.create returns docRef
                    localCreatedFolders.push({ id: docRef.id, name: part, parentId: currentParentId, type: 'folder' });
                    toggleFolder(docRef.id, true); // Auto-expand
                }
            }
            return currentParentId;
        };

        const processZip = async (file, rootId) => {
            const zip = await JSZip.loadAsync(file);
            const entries = Object.keys(zip.files).map(name => zip.files[name]);
            
            for (const entry of entries) {
                if (entry.dir) continue; // We handle dirs implicitly via file paths
                
                const pathParts = entry.name.split('/');
                const fileName = pathParts.pop();
                const ext = fileName.split('.').pop().toLowerCase();
                
                if (ALLOWED_EXTS.includes(ext)) {
                    // Ensure folders exist
                    const targetFolderId = await ensureFolderPath(pathParts, rootId);
                    // Read content
                    const content = await entry.async('string');
                    // Create file
                    await fileActions.create(targetFolderId, 'file', fileName, content);
                }
            }
        };

        const handleExternalDrop = async (e, targetNodeId) => {
            e.preventDefault();
            setDragOverId(null);
            
            if (!e.dataTransfer.files || e.dataTransfer.files.length === 0) return; // Internal drop handled by FileNode

            setIsUploading(true);
            try {
                const items = Array.from(e.dataTransfer.files);
                for (const file of items) {
                    const ext = file.name.split('.').pop().toLowerCase();
                    
                    if (ext === 'zip') {
                        await processZip(file, targetNodeId);
                    } else if (ALLOWED_EXTS.includes(ext)) {
                        const content = await readFileContent(file);
                        await fileActions.create(targetNodeId, 'file', file.name, content);
                    }
                }
            } catch (err) {
                console.error(err);
                alert("Error processing files: " + err.message);
            } finally {
                setIsUploading(false);
            }
        };

        const handleInternalDrop = async (e, targetNodeId) => {
            e.preventDefault();
            setDragOverId(null);
            const draggedId = e.dataTransfer.getData('nodeId');
            if (!draggedId || draggedId === targetNodeId) return;

            const isDescendant = (parentId, childId) => {
                if (parentId === 'root') return false;
                if (parentId === childId) return true;
                let current = files.find(f => f.id === parentId);
                while (current && current.parentId !== 'root') {
                    if (current.parentId === childId) return true;
                    current = files.find(f => f.id === current.parentId);
                }
                return false;
            };

            if (isDescendant(targetNodeId, draggedId)) return; 
            await fileActions.move(draggedId, targetNodeId);
            if(targetNodeId !== 'root') toggleFolder(targetNodeId, true);
        };

        // --- EXISTING HANDLERS ---
        const handleCreate = (type, pid='root') => { 
            openModal({ title: `New ${type}`, content: e(PromptModal, { label: 'Name', placeholder: `Enter ${type} name...`, onSubmit: async(name)=>{ if(name.trim()) { await fileActions.create(pid, type, name.trim()); if(pid !== 'root') toggleFolder(pid, true); } closeModal(); }, onCancel: closeModal }) }); 
        };
        const handleRenameQuiz = (quiz) => { let n = quiz.title; openModal({ title: 'Rename Quiz', content: e(PromptModal, { label: 'New Title', placeholder: 'Title...', onSubmit: (v) => { updateQuizTitle(quiz.id, v); closeModal(); }, onCancel: closeModal }) }); };
        const handleContextMenu = (e, node) => { e.preventDefault(); e.stopPropagation(); setContextMenu({ x: e.clientX, y: e.clientY, node }); };
        const getActions = () => {
            const { node } = contextMenu; const actions = [];
            if (!node) { actions.push({ label: 'New Folder', icon: 'bi-folder-plus', action: () => handleCreate('folder') }); actions.push({ label: 'New File', icon: 'bi-file-earmark-plus', action: () => handleCreate('file') }); return actions; }
            if (node.type === 'folder') { actions.push({ label: 'New File', icon: 'bi-file-earmark-plus', action: () => handleCreate('file', node.id) }); actions.push({ label: 'New Folder', icon: 'bi-folder-plus', action: () => handleCreate('folder', node.id) }); actions.push('divider'); }
            if (node.type === 'file') { actions.push({ label: 'Generate Quiz', icon: 'bi-lightning-fill', action: () => handleGenerateQuiz(node) }); actions.push('divider'); }
            actions.push({ label: 'Rename', icon: 'bi-pencil', action: () => setEditingNodeId(node.id) });
            actions.push({ label: 'Delete', icon: 'bi-trash', action: () => fileActions.remove(node.id, node.type) });
            return actions;
        };

        const FileNode = ({ node, depth }) => {
            const { activeEditorFile, editingNodeId, setEditingNodeId, fileActions, expandedFolders, toggleFolder } = useContext(AppContext);
            const isOpen = expandedFolders.has(node.id);
            const [editName, setEditName] = useState(node.name);
            const isEditing = editingNodeId === node.id;
            const handleRename = async (e) => { e.preventDefault(); e.stopPropagation(); if(editName.trim() && editName!==node.name) await fileActions.rename(node.id, editName); setEditingNodeId(null); };
            const handleClick = (e) => { e.stopPropagation(); if (node.type === 'folder') { toggleFolder(node.id); } else { setActiveEditorFile(node); } };
            const isFolder = node.type === 'folder';
            const chevronClass = isOpen ? 'bi-chevron-down' : 'bi-chevron-right';
            const iconClass = isFolder ? (isOpen ? 'bi-folder2-open text-yellow-600' : 'bi-folder-fill text-yellow-600') : 'bi-file-earmark-text text-gray-400';
            const isDragOver = dragOverId === node.id;

            return e(React.Fragment, null, 
                e('div', { 
                    className: 'file-node', 
                    style: { paddingLeft: `${depth*12+12}px` }, 
                    'data-active': activeEditorFile?.id===node.id, 
                    'data-drag-over': isDragOver,
                    draggable: true,
                    onDragStart: (e) => { e.dataTransfer.setData('nodeId', node.id); e.dataTransfer.setData('type', node.type); },
                    onDragOver: (e) => { e.preventDefault(); if(node.type === 'folder' && node.id !== e.dataTransfer.getData('nodeId')) setDragOverId(node.id); },
                    onDrop: (e) => { 
                        if (!isFolder) return;
                        // Check if files are being dropped (external) or nodes (internal)
                        if (e.dataTransfer.files.length > 0) handleExternalDrop(e, node.id);
                        else handleInternalDrop(e, node.id);
                    },
                    onDragLeave: (e) => setDragOverId(null),
                    onClick: handleClick, 
                    onContextMenu: (e)=>handleContextMenu(e, node) 
                }, 
                    e('span', { className: 'mr-2 text-gray-500 text-xs w-4 text-center flex justify-center' }, isFolder && e('i', { className: `bi ${chevronClass}` })),
                    e('i', { className: `bi mr-2 ${iconClass}` }), 
                    isEditing ? e('input', { className: 'input-std text-sm py-0 h-6', value: editName, onChange: e=>setEditName(e.target.value), onBlur: handleRename, autoFocus: true, onClick: e=>e.stopPropagation() }) : e('span', { className: 'truncate select-none' }, node.name)
                ), 
                isOpen && node.children?.map(c => e(FileNode, { key: c.id, node: c, depth: depth+1 }))
            );
        };

        const fileQuizzes = activeEditorFile ? quizzes.filter(q => q.fileId === activeEditorFile.id) : [];
        
        return e('div', { className: 'flex flex-col h-full relative', onClick: ()=>setContextMenu(null) },
            // Loading Overlay
            isUploading && e('div', { className: 'loading-overlay' }, e('div', { className: 'spinner' }), e('div', { className: 'mt-4 text-white font-bold' }, 'Processing Files...')),
            
            e('div', { 
                className: 'flex-1 overflow-y-auto flex flex-col border-b border-white/10', 
                onContextMenu: (e)=>handleContextMenu(e, null),
                onDragOver: (e) => { e.preventDefault(); setDragOverId('root'); },
                onDrop: (e) => { 
                    if(e.target === e.currentTarget) {
                        if (e.dataTransfer.files.length > 0) handleExternalDrop(e, 'root');
                        else handleInternalDrop(e, 'root');
                    }
                }
            },
                e('div', { className: 'p-3 font-bold text-white border-b border-white/10 flex justify-between items-center bg-black/20 cursor-pointer hover:bg-white/10', onClick: () => setActiveProjectId(null) }, 
                    e('span', null, currentProject?.name || 'Project'),
                    e('i', { className: 'bi bi-folder2-open text-blue-400' })
                ),
                userId && fileTree.length === 0 && e('div', { className: 'flex flex-col items-center justify-center h-40 text-gray-500 gap-3' }, e('i', { className: 'bi bi-folder-plus text-3xl opacity-50' }), e('div', { className: 'text-sm' }, 'No files found'), e('button', { className: 'btn-secondary text-xs', onClick: () => handleCreate('file') }, 'Create New File')),
                !userId && e('div', { className: 'text-center mt-10 text-gray-500' }, 'Sign in required'),
                userId && fileTree.map(n => e(FileNode, { key: n.id, node: n, depth: 0 }))
            ),
            activeEditorFile && e('div', { className: 'h-1/3 flex flex-col bg-black/20' },
                e('div', { className: 'lower-pane-header' }, `Quizzes: ${activeEditorFile.name}`),
                e('div', { className: 'flex-1 overflow-y-auto p-2' },
                    fileQuizzes.length === 0 && e('div', { className: 'text-xs text-gray-500 text-center p-4' }, 'No quizzes for this file.'),
                    fileQuizzes.map(q => e('div', { key: q.id, className: 'quiz-card flex justify-between items-center group', onClick: () => openModalWrapper({ title: q.title, content: e(QuizTaker, { quiz: q, onClose: null, onSubmit: handleQuizSubmit }) }) },
                        e('div', null, e('div', { className: 'font-bold text-white text-sm' }, q.title), e('div', { className: 'text-xs text-gray-500' }, `${q.questionCount} Qs`)),
                        e('div', { className: 'flex gap-2' }, e('button', { className: 'text-gray-500 hover:text-white opacity-0 group-hover:opacity-100', onClick: (e) => { e.stopPropagation(); handleRenameQuiz(q); } }, e('i', { className: 'bi bi-pencil' })), e('button', { className: 'text-red-500 hover:text-red-300 opacity-0 group-hover:opacity-100', onClick: (e) => { e.stopPropagation(); deleteQuiz(q.id); } }, e('i', { className: 'bi bi-trash' })))
                    ))
                )
            ),
            contextMenu && e(ContextMenu, { data: contextMenu, onClose: ()=>setContextMenu(null), actions: getActions() })
        );
    };

    const SettingsView = () => {
        const { userSettings, updateSettings, toast } = useContext(AppContext);
        const [newKey, setNewKey] = useState('');
        const [selectedPromptType, setSelectedPromptType] = useState('MultipleChoice');
        const [promptEdits, setPromptEdits] = useState(userSettings.prompts || {});
        const handleAddKey = () => { if(!newKey.trim()) return; updateSettings({ ...userSettings, apiKeys: [...(userSettings.apiKeys||[]), {key:newKey.trim(),isActive:!(userSettings.apiKeys||[]).length}] }); setNewKey(''); toast.show('Key Added','success'); };
        const handleSavePrompts = () => { updateSettings({ ...userSettings, prompts: promptEdits }); toast.show('Prompts Saved', 'success'); };
        const handleResetPrompt = () => { setPromptEdits(prev => ({ ...prev, [selectedPromptType]: DEFAULT_PROMPT })); };
        return e('div', { className: 'flex flex-col h-full p-4' }, e('h2', { className: 'text-lg font-semibold mb-6 flex items-center gap-2' }, e('i', { className: 'bi bi-gear-fill text-gray-400' }), 'Settings'), e('div', { className: 'glass-panel rounded-xl p-5 mb-6' }, e('h3', { className: 'text-sm font-bold text-white mb-4' }, 'API Keys'), (userSettings.apiKeys||[]).map((k,i)=>e('div', { key: i, className: 'p-3 rounded border border-white/10 mb-2 flex justify-between items-center' }, e('span', { className: 'text-xs text-gray-400' }, k.key.substring(0,8)+'...'), e('div', { className: 'flex gap-2' }, e('button', { className: `text-xs px-2 ${k.isActive?'text-green-400':'text-gray-400'}`, onClick:()=>{const nk=[...userSettings.apiKeys];nk.forEach((kk,idx)=>kk.isActive=idx===i);updateSettings({...userSettings,apiKeys:nk})} }, k.isActive?'Active':'Activate'), e('button', { className: 'text-xs text-red-400', onClick:()=>{const nk=[...userSettings.apiKeys];nk.splice(i,1);updateSettings({...userSettings,apiKeys:nk})} }, 'Del')))), e('div', { className: 'flex gap-2' }, e('input', { className: 'input-std text-sm flex-grow', placeholder: 'New Gemini Key', type: 'password', value: newKey, onChange: e=>setNewKey(e.target.value) }), e('button', { className: 'btn-primary', onClick: handleAddKey }, 'Add'))), e('div', { className: 'glass-panel rounded-xl p-5 mb-6' }, e('h3', { className: 'text-sm font-bold text-white mb-3' }, 'AI Model'), e('select', { className: 'input-std bg-black/20', value: userSettings.modelName||'gemini-2.5-flash', onChange: e=>updateSettings({...userSettings,modelName:e.target.value}) }, ['gemini-2.5-flash','gemini-2.5-flash-preview','gemini-2.5-pro','gemini-3.0-pro-preview'].map(m=>e('option',{key:m,value:m},m)))), e('div', { className: 'glass-panel rounded-xl p-5 flex flex-col flex-1 overflow-hidden' }, e('h3', { className: 'text-sm font-bold text-white mb-3' }, 'Prompt Engineering'), e('div', { className: 'flex gap-2 mb-3' }, e('select', { className: 'input-std bg-black/20', value: selectedPromptType, onChange: e=>setSelectedPromptType(e.target.value) }, ['MultipleChoice','TrueFalse','ShortAnswer','Essay'].map(t=>e('option',{key:t,value:t}, t))), e('button', { className: 'btn-secondary', onClick: handleResetPrompt }, 'Reset to Default')), e('textarea', { className: 'input-std bg-black/20 flex-1 resize-none font-mono text-xs mb-3', value: promptEdits[selectedPromptType] || DEFAULT_PROMPT, onChange: e => setPromptEdits(prev => ({ ...prev, [selectedPromptType]: e.target.value })) }), e('button', { className: 'btn-primary', onClick: handleSavePrompts }, 'Save All Prompts')));
    };

    const QuizGeneratorView = () => {
        const { quizOptions, setQuizOptions, activeEditorFile, handleGenerateQuiz, userSettings, quizzes, openModalWrapper, handleQuizSubmit, deleteQuiz } = useContext(AppContext);
        const hasApiKey = (userSettings.apiKeys||[]).some(k=>k.isActive);
        const handleGenerate = () => { 
            if(!activeEditorFile) return alert('Please select a file first.');
            handleGenerateQuiz(activeEditorFile); 
        };

        return e('div', { className: 'flex flex-col h-full p-4' }, 
            e('h2', { className: 'text-lg font-semibold mb-6 flex items-center gap-2' }, e('i', { className: 'bi bi-stars text-yellow-400' }), 'Quiz Generator'), 
            e('div', { className: 'glass-panel rounded-xl p-5 flex flex-col gap-4 mb-6' }, 
                e('div', null, e('label', { className: 'block text-xs text-gray-400 font-bold mb-2' }, 'Difficulty'), e('div', { className: 'grid grid-cols-3 gap-2' }, ['Easy','Medium','Hard'].map(l=>e('button', { key: l, className: `py-2 rounded text-sm border ${quizOptions.difficulty===l?'bg-blue-600 border-blue-500 text-white':'border-white/10 text-gray-400'}`, onClick:()=>setQuizOptions(o=>({...o,difficulty:l}))}, l)))), 
                e('div', null, e('label', { className: 'block text-xs text-gray-400 font-bold mb-2' }, 'Type'), e('select', { className: 'input-std bg-black/20', value: quizOptions.questionType, onChange: e=>setQuizOptions(o=>({...o,questionType:e.target.value})) }, ['MultipleChoice','TrueFalse','ShortAnswer','Essay'].map(t=>e('option',{key:t,value:t},t)))), 
                e('div', null, e('label', { className: 'block text-xs text-gray-400 font-bold mb-2' }, 'Instructions'), e('textarea', { className: 'input-std bg-black/20 h-20 resize-none', value: quizOptions.customInstructions||'', onChange: e=>setQuizOptions(o=>({...o,customInstructions:e.target.value})) })), 
                e('div', { className: 'flex items-center gap-2 mt-2' },
                    e('input', { type: 'checkbox', id: 'incSnip', checked: quizOptions.includeSnippets, onChange: e=>setQuizOptions(o=>({...o,includeSnippets:e.target.checked})) }),
                    e('label', { htmlFor: 'incSnip', className: 'text-xs text-gray-400 cursor-pointer select-none' }, 'Include Source Snippets (Context)')
                ),
                e('button', { className: `mt-4 py-3 rounded-lg font-bold shadow-lg ${hasApiKey?'bg-gradient-to-r from-blue-600 to-purple-600 text-white':'bg-gray-700 text-gray-400 cursor-not-allowed'}`, disabled: !hasApiKey, onClick: handleGenerate }, 'Generate Quiz from Selected File')
            ),
            e('h3', { className: 'text-sm font-bold text-gray-400 mb-2 uppercase' }, 'Recent Generated Quizzes'),
            e('div', { className: 'flex-1 overflow-y-auto' },
                quizzes.length === 0 && e('div', { className: 'text-gray-500 text-sm' }, 'No generated quizzes yet.'),
                quizzes.map(q => e('div', { key: q.id, className: 'quiz-card flex justify-between items-center group', onClick: () => openModalWrapper({ title: q.title, content: e(QuizTaker, { quiz: q, onClose: null, onSubmit: handleQuizSubmit }) }) },
                    e('div', null, e('div', { className: 'font-bold text-white text-sm' }, q.title), e('div', { className: 'text-xs text-gray-500' }, new Date(q.createdAt).toLocaleDateString())),
                    e('div', { className: 'flex gap-2 items-center' },
                        e('span', { className: 'text-xs bg-blue-900/50 text-blue-400 px-2 py-1 rounded mr-2' }, `${q.questionCount} Qs`),
                        // FIX: Added Delete Button
                        e('button', { className: 'text-red-500 hover:text-red-300 opacity-0 group-hover:opacity-100', onClick: (e) => { e.stopPropagation(); deleteQuiz(q.id); } }, e('i', { className: 'bi bi-trash' }))
                    )
                ))
            )
        );
    };

    const TaskMonitorView = () => { const { taskQueue } = useContext(AppContext); return e('div', { className: 'flex flex-col h-full p-4' }, e('h3', { className: 'text-sm font-bold text-gray-400 mb-4' }, 'Tasks'), e('div', { className: 'flex-1 overflow-y-auto flex flex-col gap-2' }, (taskQueue||[]).map(t => e('div', { key: t.id, className: 'glass-panel p-3 rounded flex justify-between' }, e('div', null, e('div', { className: 'font-medium text-sm' }, t.taskType), e('div', { className: 'text-xs text-gray-500' }, t.id.substring(0,8))), e('div', { className: `text-xs px-2 py-1 rounded ${t.status==='processing'?'bg-blue-500/20 text-blue-400':t.status==='success'?'bg-green-500/20 text-green-400':'bg-red-500/20 text-red-400'}` }, t.status))))); };

    const QuizHistoryView = () => { const { attempts, openModalWrapper, dispatchGrading } = useContext(AppContext); return e('div', { className: 'flex flex-col h-full p-4' }, e('h2', { className: 'text-lg font-semibold mb-4 flex items-center gap-2' }, e('i', { className: 'bi bi-collection-play' }), 'History'), e('div', { className: 'flex-1 overflow-y-auto' }, attempts.map(a => e('div', { key: a.id, className: 'quiz-card', onClick: () => openModalWrapper({ title: 'Result', content: e(QuizResult, { attempt: a, onGradeAI: () => dispatchGrading(a) }) }) }, e('div', { className: 'flex justify-between items-center' }, e('div', { className: 'font-bold text-white' }, a.quizTitle), e('div', { className: 'text-xl font-bold text-blue-400' }, `${a.score}/${a.total}`)), e('div', { className: 'text-xs text-gray-500 mt-2' }, new Date(a.createdAt).toLocaleString()))))); };

    const MainEditor = () => {
        const { activeEditorFile, fileActions, userId, handleGoogleSignIn, handleGenerateQuiz } = useContext(AppContext);
        const [content, setContent] = useState("");
        const [viewMode, setViewMode] = useState('edit');
        const previewRef = useRef(null);

        useEffect(() => { setContent(activeEditorFile?.content||""); }, [activeEditorFile]);
        useEffect(() => { if(!activeEditorFile || content===activeEditorFile.content) return; const t=setTimeout(()=>fileActions.updateContent(activeEditorFile.id, content),2000); return ()=>clearTimeout(t); }, [content, activeEditorFile, fileActions]);
        useEffect(() => { 
            if(viewMode==='preview' && previewRef.current){
                if(window.renderMathInElement && window.katex) {
                    try {
                        renderMathInElement(previewRef.current, {
                            delimiters:[
                                {left:"$$",right:"$$",display:true},
                                {left:"$",right:"$",display:false},
                                {left:"\\(",right:"\\)",display:false},
                                {left:"\\[",right:"\\]",display:true}
                            ]
                        });
                    } catch (e) { console.error("Katex Error:", e); }
                }
                if(window.hljs) hljs.highlightAll();
            } 
        }, [viewMode, content]);
        
        const rendered = useMemo(() => viewMode==='preview' ? DOMPurify.sanitize(marked.parse(content||"")) : null, [content, viewMode]);
        
        if (!userId) return e('div', { className: 'flex flex-col items-center justify-center h-full text-gray-500' }, e('i', { className: 'bi bi-shield-lock text-6xl mb-6' }), e('button', { className: 'btn-primary flex gap-2 items-center', onClick: handleGoogleSignIn }, e('i', { className: 'bi bi-google' }), 'Sign in'));
        if (!activeEditorFile) return e('div', { className: 'flex flex-col items-center justify-center h-full text-gray-500' }, e('i', { className: 'bi bi-code-square text-6xl mb-4 opacity-20' }), 'Select a file');
        
        return e('div', { className: 'flex flex-col h-full' }, 
            e('div', { className: 'h-12 border-b border-white/10 flex items-center px-4 justify-between bg-black/40' }, 
                e('span', { className: 'text-sm text-gray-300 flex items-center gap-2' }, e('i', { className: 'bi bi-file-earmark-text' }), activeEditorFile.name), 
                e('div', { className: 'flex gap-2 items-center' }, 
                    e('button', { className: 'btn-secondary flex items-center gap-2 text-yellow-400', onClick: () => handleGenerateQuiz(activeEditorFile) }, e('i', { className: 'bi bi-lightning-fill' }), 'Generate Quiz'),
                    e('div', { className: 'w-px h-4 bg-white/10 mx-1' }),
                    e('div', { className: 'flex bg-white/5 p-1 rounded-lg' }, 
                        e('button', { className: `px-3 py-1 rounded text-xs ${viewMode==='edit'?'bg-blue-600 text-white':'text-gray-400'}`, onClick:()=>setViewMode('edit') }, 'Edit'), 
                        e('button', { className: `px-3 py-1 rounded text-xs ${viewMode==='preview'?'bg-blue-600 text-white':'text-gray-400'}`, onClick:()=>setViewMode('preview') }, 'Preview')
                    )
                )
            ), 
            viewMode==='edit' 
                ? e('textarea', { className: 'flex-1 bg-transparent border-none resize-none p-8 outline-none font-mono text-sm text-gray-200', value: content, onChange: e=>setContent(e.target.value) }) 
                : e('div', { className: 'flex-1 p-0 overflow-hidden' }, e('div', { ref: previewRef, className: 'markdown-body', dangerouslySetInnerHTML: { __html: rendered } }))
        );
    };

    const ProjectDashboard = ({ projects, onCreate, onSelect, onDelete }) => {
        const [name, setName] = useState('');
        const [creating, setCreating] = useState(false);
        const handleCreate = (e) => { e.preventDefault(); if(name.trim()) { onCreate(name.trim()); setName(''); setCreating(false); } };
        return e('div', { className: 'h-screen flex flex-col bg-black p-8 overflow-y-auto' },
            e('div', { className: 'max-w-5xl mx-auto w-full' },
                e('h1', { className: 'text-3xl font-light text-white mb-8 flex items-center gap-3' }, e('i', { className: 'bi bi-grid-1x2-fill' }), 'Projects'),
                e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' },
                    e('div', { className: 'glass-panel border-dashed border-white/20 rounded-xl flex flex-col items-center justify-center p-6 cursor-pointer hover:border-blue-500/50', onClick: () => setCreating(true) },
                        creating 
                        ? e('form', { onSubmit: handleCreate, onClick: e=>e.stopPropagation(), className: 'w-full flex flex-col gap-3' }, e('input', { autoFocus: true, className: 'input-std text-center text-lg', placeholder: 'Project Name', value: name, onChange: e=>setName(e.target.value) }), e('div', { className: 'flex gap-2' }, e('button', { type: 'button', className: 'glass-btn w-1/2 py-1 rounded', onClick: (e)=>{e.stopPropagation(); setCreating(false);} }, 'Cancel'), e('button', { type: 'submit', className: 'btn-primary w-1/2 py-1' }, 'Create')))
                        : e('div', { className: 'flex flex-col items-center gap-2 text-gray-500' }, e('i', { className: 'bi bi-plus-lg text-3xl' }), 'New Project')
                    ),
                    projects.map(p => e('div', { key: p.id, className: 'glass-panel rounded-xl p-6 cursor-pointer hover:bg-white/5 group', onClick: () => onSelect(p.id) }, e('div', { className: 'text-xl font-medium text-gray-200' }, p.name), e('div', { className: 'text-xs text-gray-500 mt-1' }, new Date(p.createdAt).toLocaleDateString()), e('button', { className: 'opacity-0 group-hover:opacity-100 text-red-400 absolute top-2 right-2 hover:bg-red-400/10 p-2 rounded', onClick: (e)=>{e.stopPropagation(); onDelete(p.id);}}, e('i', { className: 'bi bi-trash' }))))
                )
            )
        );
    };

    /* --- APP --- */
    const App = () => {
        const [db, setDb] = useState(null);
        const [auth, setAuth] = useState(null);
        const [userId, setUserId] = useState(null);
        const [activeProjectId, setActiveProjectId] = useState(() => localStorage.getItem('activeProjectId'));
        useEffect(() => { if(activeProjectId) localStorage.setItem('activeProjectId', activeProjectId); else localStorage.removeItem('activeProjectId'); }, [activeProjectId]);
        const { route: activeView, navigate } = useHashRoute();
        const [projects, setProjects] = useState([]);
        const [files, setFiles] = useState([]);
        const [quizzes, setQuizzes] = useState([]);
        const [attempts, setAttempts] = useState([]);
        const [taskQueue, setTaskQueue] = useState([]);
        const [activeEditorFile, setActiveEditorFile] = useState(null);
        const [editingNodeId, setEditingNodeId] = useState(null);
        const [expandedFolders, setExpandedFolders] = useState(new Set());
        const [quizOptions, setQuizOptionsState] = useState({ numQuestions: 5, difficulty: 'Medium', questionType: 'MultipleChoice', includeSnippets: false, provideAnswerKey: true });
        const [userSettings, setUserSettings] = useState({ apiKeys: [], modelName: "gemini-2.5-flash", prompts: {} }); 
        const { openModal, closeModal } = useModal();
        const toast = useToast();
        const quizWorker = useMemo(() => new Worker(workerUrl), []);
        const toggleFolder = (id, forceOpen = false) => { setExpandedFolders(prev => { const next = new Set(prev); if (forceOpen) { next.add(id); } else { if (next.has(id)) next.delete(id); else next.add(id); } return next; }); };
        const deleteQuiz = (id) => { openModal({ title: 'Delete Quiz', content: e('div', { className: 'text-gray-300' }, 'Are you sure you want to delete this quiz?'), footer: e('div', { className: 'flex gap-2' }, e('button', { className: 'glass-btn px-4 py-2 rounded text-gray-300', onClick: closeModal }, 'Cancel'), e('button', { className: 'btn-primary bg-red-600 hover:bg-red-500 px-4 py-2 rounded text-white', onClick: async () => { await deleteDoc(doc(db, `artifacts/${window.__app_id}/users/${userId}/quizzes`, id)); closeModal(); toast.show('Quiz deleted', 'success'); }}, 'Delete')) }); };

        useEffect(() => { const conf = JSON.parse(window.__firebase_config); const app = initializeApp(conf); setDb(getFirestore(app)); setAuth(getAuth(app)); onAuthStateChanged(getAuth(app), u => { setUserId(u ? u.uid : null); if (!u) { setActiveProjectId(null); setFiles([]); setQuizzes([]); setAttempts([]); } }); }, []);
        useEffect(() => { if (!db || !userId) return; const loadProjects = onSnapshot(collection(db, `artifacts/${window.__app_id}/users/${userId}/projects`), s => { const data = s.docs.map(d => ({id:d.id, ...d.data()})); data.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)); setProjects(data); }); const loadSettings = onSnapshot(doc(db, `artifacts/${window.__app_id}/users/${userId}/settings/userConfig`), s => { if(s.exists()) setUserSettings(s.data()); }); return () => { loadProjects(); loadSettings(); }; }, [db, userId]);
        useEffect(() => { if (!db || !userId || !activeProjectId) { setFiles([]); setQuizzes([]); setAttempts([]); return; } const colPath = `artifacts/${window.__app_id}/users/${userId}`; const unsubFiles = onSnapshot(query(collection(db, `${colPath}/files`), where('projectId', '==', activeProjectId)), s => setFiles(s.docs.map(d => ({id:d.id, ...d.data()})))); const unsubQuizzes = onSnapshot(collection(db, `${colPath}/quizzes`), s => { const data = s.docs.map(d => ({id:d.id, ...d.data()})); data.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)); setQuizzes(data); }); const unsubAttempts = onSnapshot(collection(db, `${colPath}/quizAttempts`), s => { const data = s.docs.map(d => ({id:d.id, ...d.data()})); data.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)); setAttempts(data); }); return () => { unsubFiles(); unsubQuizzes(); unsubAttempts(); }; }, [db, userId, activeProjectId]);
        useEffect(() => { quizWorker.onmessage = (e) => { const { status, taskId, quizData, updatedAttempt, error, options } = e.data; setTaskQueue(q => q.map(t => t.id === taskId ? { ...t, status: status==='success'?'success':'failed' } : t)); if (status === 'success') { if (quizData) { addDoc(collection(db, `artifacts/${window.__app_id}/users/${userId}/quizzes`), { title: quizData.title, questions: JSON.stringify(quizData.questions), fileId: options.fileId, userId, createdAt: new Date().toISOString(), questionCount: quizData.questions.length, options }); toast.show('Quiz Generated!', 'success'); } if (updatedAttempt) { updateDoc(doc(db, `artifacts/${window.__app_id}/users/${userId}/quizAttempts`, updatedAttempt.id), updatedAttempt); toast.show('Grading Complete!', 'success'); openModal({ title: 'Result', content: e(QuizResult, { attempt: updatedAttempt }) }); } } else { toast.show(`Error: ${error}`, 'error'); } }; }, [quizWorker, db, userId, toast, openModal]);

        const dispatchTask = (task) => { const id=Date.now().toString(); setTaskQueue(p=>[{...task,id,status:'processing'},...p]); quizWorker.postMessage({...task,id,settings:userSettings}); };
        const handleQuizSubmit = async (result) => { const docRef = await addDoc(collection(db, `artifacts/${window.__app_id}/users/${userId}/quizAttempts`), {...result, userId, projectId:activeProjectId}); openModal({ title: 'Result', content: e(QuizResult, { attempt: {...result, id:docRef.id}, onGradeAI:()=>dispatchGrading({...result, id:docRef.id}) }) }); };
        const dispatchGrading = (attempt) => { closeModal(); dispatchTask({ taskType: 'grade', attempt }); toast.show('AI Grading Started','info'); };
        const updateQuizTitle = async (id, title) => { if(!db||!userId) return; await updateDoc(doc(db, `artifacts/${window.__app_id}/users/${userId}/quizzes`, id), { title }); };
        const handleGenerateQuiz = (fileNode) => { if (!fileNode || !fileNode.content) return toast.show("Empty File", 'error'); const hasKey = (userSettings.apiKeys||[]).some(k=>k.isActive); if (!hasKey) return toast.show("No Active API Key", 'error'); const selectedTemplate = (userSettings.prompts && userSettings.prompts[quizOptions.questionType]) || DEFAULT_PROMPT; dispatchTask({ taskType: 'generate', sourceText: fileNode.content, options: { ...quizOptions, fileId: fileNode.id, sourceFileName: fileNode.name, promptTemplate: selectedTemplate } }); toast.show('Started Generation...', 'info'); };

        const fileActions = useMemo(() => { if (!db || !userId || !activeProjectId) return {}; const colRef = collection(db, `artifacts/${window.__app_id}/users/${userId}/files`); return { create: async (pid, type, name, content='') => addDoc(colRef, { parentId: pid, type, name, content, projectId: activeProjectId, userId, createdAt: new Date().toISOString() }), rename: async (id, name) => updateDoc(doc(colRef, id), { name }), remove: async (id) => deleteDoc(doc(colRef, id)), updateContent: async (id, content) => updateDoc(doc(colRef, id), { content }), move: async (id, pid) => updateDoc(doc(colRef, id), { parentId: pid }) }; }, [db, userId, activeProjectId]);
        const fileTree = useMemo(() => { const map = {}; const roots = []; files.forEach(f => map[f.id] = { ...f, children: [] }); Object.values(map).forEach(n => { if (n.parentId === 'root' || !map[n.parentId]) roots.push(n); else map[n.parentId].children.push(n); }); const sortFn = (a,b) => (a.type===b.type ? a.name.localeCompare(b.name) : (a.type==='folder'?-1:1)); const sortNode = (l) => { l.sort(sortFn); l.forEach(c => sortNode(c.children)); }; sortNode(roots); return roots; }, [files]);
        const ctx = { db, userId, fileTree, fileActions, files, activeEditorFile, setActiveEditorFile, editingNodeId, setEditingNodeId, quizOptions, setQuizOptions: setQuizOptionsState, taskQueue, dispatchTask, handleGoogleSignIn: async () => { if (auth) await signInWithPopup(auth, new GoogleAuthProvider()); }, toast, userSettings, updateSettings: (s) => { setUserSettings(s); if(userId) setDoc(doc(db, `artifacts/${window.__app_id}/users/${userId}/settings/userConfig`), s); }, quizzes, attempts, openModalWrapper: ({title, content}) => openModal({title, content}), handleQuizSubmit, dispatchGrading, updateQuizTitle, handleGenerateQuiz, expandedFolders, toggleFolder, deleteQuiz, activeProjectId, projects, setActiveProjectId };
        const navItems = [ { id: 'files', icon: 'bi-files' }, { id: 'quiz', icon: 'bi-lightning-charge' }, { id: 'history', icon: 'bi-collection-play' }, { id: 'settings', icon: 'bi-gear' }, { id: 'tasks', icon: 'bi-activity' } ];
        
        if (userId && !activeProjectId) return e(ProjectDashboard, { projects, onCreate: async (n) => addDoc(collection(db, `artifacts/${window.__app_id}/users/${userId}/projects`), { name: n, createdAt: new Date().toISOString() }), onSelect: setActiveProjectId, onDelete: (id) => deleteDoc(doc(db, `artifacts/${window.__app_id}/users/${userId}/projects`, id)) });

        return e(AppContext.Provider, { value: ctx },
            e('div', { className: 'app-container' },
                e('div', { className: 'sidebar-container items-center py-4 gap-4' },
                    e('button', { className: 'text-blue-400 hover:text-white mb-2', onClick: () => setActiveProjectId(null) }, e('i', { className: 'bi bi-grid-fill text-xl' })),
                    navItems.map(item => e('button', { key: item.id, className: `p-3 rounded-xl transition-all ${activeView === item.id ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-500 hover:text-white hover:bg-white/5'}`, onClick: () => navigate(item.id) }, e('i', { className: `bi ${item.icon} text-xl` }))),
                    e('div', { className: 'mt-auto' }, userId && e('button', { className: 'p-3 text-gray-500 hover:text-red-400', onClick: () => { signOut(auth); setActiveProjectId(null); } }, e('i', { className: 'bi bi-box-arrow-right text-xl' })))
                ),
                e('div', { className: 'sidebar-view' },
                    activeView === 'files' && e(FileManagerView),
                    activeView === 'quiz' && e(QuizGeneratorView),
                    activeView === 'history' && e(QuizHistoryView),
                    activeView === 'settings' && e(SettingsView),
                    activeView === 'tasks' && e(TaskMonitorView)
                ),
                e('div', { className: 'main-area' }, e(MainEditor))
            )
        );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(e(ToastProvider, null, e(ModalProvider, null, e(App))));
  </script>
</body>
</html>
