<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Quiz Obsidian (v14.0 - Project Manager)</title>

  <!-- Fonts: Inter (Requested), Nanum for fallback -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600&family=Nanum+Gothic:wght@300;400;700&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Dependencies -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <!-- Viewer Mode Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
      GoogleAuthProvider, signInWithPopup, signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, 
      onSnapshot, collection, query, where, writeBatch, setLogLevel, orderBy
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    window.firebase = {
      app: { initializeApp },
      auth: { 
        getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
        GoogleAuthProvider, signInWithPopup, signOut 
      },
      firestore: { 
        getFirestore, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, 
        onSnapshot, collection, query, where, writeBatch, setLogLevel, orderBy
      }
    };
  </script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBR_9ivOtQRIW_KIQRYBxJ_nFtYL7GYZwg",
      authDomain: "quiz-436ac.firebaseapp.com",
      projectId: "quiz-436ac",
      storageBucket: "quiz-436ac.firebasestorage.app",
      messagingSenderId: "131117093431",
      appId: "1:131117093431:web:56e1beff4c63d35b5b25b2"
    };
    const appId = "my-unique-app-id";
    window.__firebase_config = JSON.stringify(firebaseConfig);
    window.__app_id = appId;
  </script>
  
  <!-- High Contrast Obsidian Styles -->
  <style>
    :root {
        /* Palette Definition */
        --obsidian-black: #000000;
        --obsidian-dark: #050505;
        --obsidian-panel: #0a0a0a;
        --obsidian-border: #333333;
        
        /* Glassmorphism Variables */
        --glass-bg: rgba(20, 20, 20, 0.65);
        --glass-border: 1px solid rgba(255, 255, 255, 0.15);
        --glass-highlight: 1px solid rgba(255, 255, 255, 0.3);
        --glass-blur: blur(12px);
        
        /* Typography */
        --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        --text-primary: #eeeeee;
        --text-secondary: #a0a0a0;
        --text-tertiary: #666666;
        
        /* Engagement / Accents */
        --accent-gradient: linear-gradient(135deg, #ffffff 0%, #b0b0b0 100%);
        --accent-hover: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
        --accent-text: #000000;
        --danger-color: #ff4d4d;
    }

    body {
      font-family: var(--font-main);
      font-weight: 300;
      margin: 0;
      background-color: var(--obsidian-black);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      letter-spacing: -0.01em;
    }

    .bi { vertical-align: -0.125em; fill: currentColor; }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }

    /* Project Dashboard Specifics */
    .project-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        padding: 40px;
        overflow-y: auto;
        height: 100%;
    }
    .project-card {
        background: rgba(255,255,255,0.03);
        border: var(--glass-border);
        border-radius: 12px;
        padding: 24px;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        cursor: pointer;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
        height: 200px;
    }
    .project-card:hover {
        background: rgba(255,255,255,0.08);
        border-color: rgba(255,255,255,0.4);
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.5);
    }
    .project-card-new {
        border-style: dashed;
        display: flex; align-items: center; justify-content: center;
        color: var(--text-secondary);
    }
    .project-card-new:hover { color: white; border-color: white; }
    .project-title { font-size: 1.2rem; font-weight: 500; margin-bottom: 8px; color: white; }
    .project-desc { font-size: 0.9rem; color: var(--text-secondary); flex-grow: 1; overflow: hidden; text-overflow: ellipsis; }
    .project-meta { font-size: 0.8rem; color: var(--text-tertiary); margin-top: 12px; display: flex; justify-content: space-between; align-items: center; }
    .delete-project-btn {
        opacity: 0; transition: opacity 0.2s; padding: 8px; color: #ff6b6b;
    }
    .project-card:hover .delete-project-btn { opacity: 1; }

    /* Reuse existing styles... */
    .vsc-sidebar-container { display: flex; flex-direction: row; width: auto; height: 100vh; background-color: var(--obsidian-black); }
    .vsc-activity-bar { display: flex; flex-direction: column; justify-content: space-between; padding: 12px 0; background-color: var(--obsidian-black); border-right: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; width: 56px; z-index: 10; }
    .vsc-activity-item { background: transparent; border: none; color: var(--text-tertiary); padding: 12px; margin: 4px 0; cursor: pointer; font-size: 20px; transition: all 0.2s ease; display: flex; justify-content: center; align-items: center; position: relative; }
    .vsc-activity-item:hover { color: var(--text-primary); transform: scale(1.1); }
    .vsc-activity-item[data-active='true'] { color: #fff; }
    .vsc-activity-item[data-active='true']::before { content: ''; position: absolute; left: 0; top: 12px; bottom: 12px; width: 3px; background: white; border-radius: 0 2px 2px 0; box-shadow: 0 0 8px rgba(255,255,255,0.5); }
    .vsc-sidebar-view { flex-grow: 1; background-color: var(--obsidian-panel); color: var(--text-primary); width: 300px; min-width: 300px; border-right: 1px solid rgba(255,255,255,0.08); transition: all 0.3s; display: flex; flex-direction: column; }
    .vsc-sidebar-view[data-visible='false'] { width: 0; min-width: 0; opacity: 0; border-right: none; }
    .view-header, .vsc-view-pane-header { margin: 0; color: var(--text-primary); font-size: 0.9rem; font-weight: 500; padding: 16px; border-bottom: var(--glass-border); background: rgba(255, 255, 255, 0.02); backdrop-filter: var(--glass-blur); display: flex; justify-content: space-between; align-items: center; text-transform: uppercase; letter-spacing: 0.05em; }
    .view-header-icon { background: transparent; border: 1px solid transparent; color: var(--text-secondary); cursor: pointer; padding: 6px; border-radius: 4px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
    .view-header-icon:hover { background-color: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.2); }
    .vsc-view-content, .view-content-scroll, .vsc-view-pane-content { flex-grow: 1; overflow-y: auto; background-color: transparent; }
    .vsc-view-panes { height: 100%; }
    .vsc-view-pane { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; background-color: var(--obsidian-dark); position: relative; }
    .main-editor-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.08); height: 50px; }
    .main-editor-title { font-size: 0.9rem; font-weight: 400; letter-spacing: 0.02em; display: flex; align-items: center; gap: 8px; }
    .editor-toggle-group { display: inline-flex; border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; padding: 2px; background: rgba(0,0,0,0.3); }
    .editor-toggle-btn { background: transparent; color: var(--text-secondary); padding: 4px 12px; border: none; cursor: pointer; font-size: 0.8rem; border-radius: 4px; font-weight: 400; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
    .editor-toggle-btn.active { background-color: rgba(255,255,255,0.1); color: white; font-weight: 500; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
    .main-editor-action-btn, .form-button, .modal-button-primary { background: var(--accent-gradient); color: var(--accent-text); padding: 6px 16px; border: 1px solid white; border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: 600; box-shadow: 0 0 10px rgba(255,255,255,0.1); transition: all 0.2s ease; text-transform: uppercase; letter-spacing: 0.03em; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .main-editor-action-btn:hover, .form-button:hover, .modal-button-primary:hover { transform: translateY(-1px); box-shadow: 0 0 15px rgba(255,255,255,0.3); background: var(--accent-hover); }
    .main-editor-action-btn:disabled, .form-button:disabled { background: #333; color: #666; border-color: #444; cursor: not-allowed; box-shadow: none; transform: none; }
    .main-editor { flex-grow: 1; background-color: var(--obsidian-dark); color: #e0e0e0; border: none; outline: none; padding: 40px; font-family: 'Nanum Gothic', sans-serif; font-size: 15px; line-height: 1.8; resize: none; font-weight: 300; }
    .main-editor-placeholder { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; color: var(--text-secondary); font-weight: 200; gap: 16px; }
    .main-editor-footer { padding: 4px 12px; background-color: rgba(0,0,0,0.8); border-top: 1px solid #333; color: var(--text-secondary); font-size: 0.75rem; display: flex; justify-content: flex-end; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 0.8rem; margin-bottom: 8px; color: var(--text-secondary); font-weight: 400; text-transform: uppercase; }
    .form-input, .form-textarea, .form-select { width: 100%; padding: 10px 12px; box-sizing: border-box; border: var(--glass-border); background-color: rgba(0,0,0,0.3); color: white; border-radius: 4px; font-family: var(--font-main); font-weight: 300; transition: border-color 0.2s; }
    .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: rgba(255,255,255,0.5); background-color: rgba(0,0,0,0.5); }
    .list-item { padding: 14px; background: rgba(255, 255, 255, 0.03); border: 1px solid transparent; border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; position: relative; }
    .list-item:hover { background: rgba(255, 255, 255, 0.07); border-color: rgba(255, 255, 255, 0.2); transform: translateX(2px); }
    .list-item-title { font-weight: 500; color: white; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;}
    .list-item-sub { font-size: 0.8rem; color: var(--text-secondary); font-weight: 300; }
    .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 100; }
    .modal-container { background-color: rgba(15, 15, 15, 0.95); backdrop-filter: blur(24px); color: var(--text-primary); border: var(--glass-highlight); border-radius: 12px; width: 90%; max-width: 700px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 20px 50px -10px rgba(0,0,0,0.8); }
    .modal-header { padding: 20px 24px; border-bottom: var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
    .modal-close-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.2rem; cursor: pointer; transition: color 0.2s; }
    .modal-close-btn:hover { color: white; }
    .modal-body { padding: 24px; overflow-y: auto; }
    .modal-footer { padding: 16px 24px; border-top: var(--glass-border); display: flex; justify-content: flex-end; gap: 12px; background: rgba(0,0,0,0.2); }
    .modal-button-secondary { background: transparent; color: var(--text-primary); border: 1px solid rgba(255,255,255,0.2); padding: 6px 16px; border-radius: 4px; cursor: pointer; transition: all 0.2s; font-weight: 300; }
    .modal-button-secondary:hover { border-color: white; background: rgba(255,255,255,0.05); }
    .file-tree-node { color: var(--text-secondary); border: 1px solid transparent; margin: 1px 0; border-radius: 4px; transition: all 0.15s; }
    .file-tree-node:hover { background-color: rgba(255,255,255,0.05); color: white; }
    .file-tree-node[data-active='true'] { background-color: rgba(255,255,255,0.1); border: var(--glass-border); color: white; }
    .file-tree-node-icon { opacity: 0.8; margin-right: 6px; font-size: 0.9rem; }
    .context-menu { background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 10px 30px rgba(0,0,0,0.8); padding: 4px; border-radius: 6px; }
    .context-menu-item { padding: 8px 12px; font-size: 0.9rem; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px; }
    .context-menu-item:hover { background: rgba(255,255,255,0.1); color: white; }
    .context-menu-divider { border-top: 1px solid rgba(255,255,255,0.1); margin: 4px 0; }
    .prose-readable-wrapper { padding: 40px; }
    .prose-dark-theme { --text-primary: #f0f0f0; --text-secondary: #b0b0b0; --border-color: #333; --accent-primary: #ffffff; --bg-tertiary: rgba(255,255,255,0.05); }
    .prose-readable h1, .prose-readable h2, .prose-readable h3 { font-family: 'Inter', sans-serif; font-weight: 500; color: white; }
    .prose-readable p { font-family: 'Inter', sans-serif; font-weight: 300; font-size: 1.05rem; line-height: 1.8; }
    .prose-readable code { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
    .spinner { border-color: rgba(255,255,255,0.1); border-top-color: white; }
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; color: var(--text-tertiary); text-align: center; gap: 10px; }
    .empty-state i { font-size: 2rem; opacity: 0.5; margin-bottom: 8px; }

  </style>
</head>
<body>
  
  <div id="root"></div>
  <input type="file" id="file-upload-input" style="display: none" multiple accept=".txt,.md,.zip" />

  <script type="module">
    const { useState, useEffect, useCallback, useMemo, createContext, useContext, useRef } = React;
    const { createRoot } = ReactDOM;
    const e = React.createElement;

    const { app, auth, firestore } = window.firebase;
    const { initializeApp } = app;
    const { 
        getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
        GoogleAuthProvider, signInWithPopup, signOut
    } = auth;
    const { 
        getFirestore, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, 
        onSnapshot, collection, query, where, writeBatch, setLogLevel, orderBy
    } = firestore;

    /* --- Common Utils --- */
    const ToastContext = createContext(null);
    const useToast = () => useContext(ToastContext);
    const AppContext = createContext(null);
    
    const FootnoteManager = {
        footnotes: {}, footnoteOrder: [],
        clear() { this.footnotes = {}; this.footnoteOrder = []; },
        addDefinition(k, c) { if(!this.footnotes[k.toLowerCase()]) this.footnotes[k.toLowerCase()] = { text: c.trim(), html: window.marked.parseInline(c.trim()) }; },
        addReference(k) { if(this.footnoteOrder.indexOf(k.toLowerCase()) === -1) this.footnoteOrder.push(k.toLowerCase()); },
        getNote(k) { return this.footnotes[k.toLowerCase()]; },
        getOrder() { return this.footnoteOrder; },
        extractAndClean(md) { this.clear(); return md.replace(/^\[\^(.+?)\]:\s*([\s\S]*?)(?=\n\[\^|$)/gm, (m, n, c) => { this.addDefinition(n, c); return ''; }); }
    };

    const parseMarkdownWithExtensions = (md) => {
        if (typeof md !== 'string') return '';
        if (!window.marked) return md;
        const p = new window.marked.Marked();
        p.use({ gfm: true, breaks: true });
        return p.parse(md);
    };

    class ApiError extends Error { constructor(message, status) { super(message); this.name = 'ApiError'; this.status = status; } }
    const fetchWithRetry = async (url, options, retries = 3, delay = 1000) => {
      for (let i = 0; i < retries; i++) {
        try {
          const res = await fetch(url, options);
          if (!res.ok) throw new ApiError(`HTTP ${res.status}`, res.status);
          return res.json();
        } catch (e) { if (i < retries - 1) await new Promise(r => setTimeout(r, delay * Math.pow(2, i))); else throw e; }
      }
    };

    const generateQuizWithAi = async (text, opts, settings) => {
      const apiKey = settings?.apiKeys?.[0]?.key;
      if (!apiKey) throw new ApiError('API Key Missing', 401);
      const payload = {
        contents: [{ role: "user", parts: [{ text: `--- SOURCE ---\n${text}` }] }],
        systemInstruction: { parts: [{ text: settings.quizSystemPrompt.replace('{{DIFFICULTY}}', opts.difficulty).replace('{{QUESTION_TYPE}}', opts.questionType).replace('{{NUM_QUESTIONS}}', opts.numQuestions) }] },
        generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { title: { type: "STRING" }, questions: { type: "ARRAY", items: { type: "OBJECT", properties: { questionType: { type: "STRING" }, questionText: { type: "STRING" }, options: { type: "ARRAY", items: { "type": "STRING" }, nullable: true }, correctAnswerIndex: { type: "NUMBER", nullable: true }, gradingCriteria: { type: "STRING", nullable: true } }, required: ["questionType", "questionText"] } }, required: ["title", "questions"] }, temperature: 0.3 }
      };
      const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${settings.modelName || "gemini-2.5-flash"}:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      return JSON.parse(res.candidates?.[0]?.content?.parts?.[0]?.text);
    };

    const gradeAnswerWithAi = async (q, a, c, settings) => {
      const apiKey = settings?.apiKeys?.[0]?.key;
      if (!apiKey) throw new ApiError('API Key Missing', 401);
      const payload = {
        contents: [{ role: "user", parts: [{ text: `Q: ${q}\nCriteria: ${c}\nAnswer: ${a}` }] }],
        systemInstruction: { parts: [{ text: settings.gradingSystemPrompt }] },
        generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { isCorrect: { type: "BOOLEAN" }, feedback: { type: "STRING" } }, required: ["isCorrect", "feedback"] }, temperature: 0.1 }
      };
      const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${settings.modelName || "gemini-2.5-flash"}:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      return JSON.parse(res.candidates?.[0]?.content?.parts?.[0]?.text);
    };

    const workerScript = `
      const fetchWithRetry = ${fetchWithRetry.toString()}; ${ApiError.toString()}
      const generateQuizWithAi = ${generateQuizWithAi.toString()};
      const gradeAnswerWithAi = ${gradeAnswerWithAi.toString()};
      self.onmessage = async (e) => {
        const { id, taskType, sourceText, options, settings, attempt } = e.data;
        try {
          if (taskType === 'grade') {
            const res = JSON.parse(attempt.answers);
            const graded = await Promise.all(res.map(async r => {
              if(r.isCorrect !== null) return r;
              try { const g = await gradeAnswerWithAi(r.questionText, r.selectedAnswer, r.gradingCriteria, settings); return { ...r, isCorrect: g.isCorrect, feedback: g.feedback }; }
              catch(e) { return { ...r, isCorrect: false, feedback: "Error: " + e.message }; }
            }));
            self.postMessage({ status: 'success', taskId: id, taskType, updatedAttempt: { ...attempt, score: graded.filter(r=>r.isCorrect).length, answers: JSON.stringify(graded) } });
          } else {
            const data = await generateQuizWithAi(sourceText, options, settings);
            self.postMessage({ status: 'success', taskId: id, taskType, quizData: data, options });
          }
        } catch (err) { self.postMessage({ status: 'error', taskId: id, taskType, error: err.message }); }
      };
    `;
    const workerUrl = URL.createObjectURL(new Blob([workerScript], { type: 'application/javascript' }));

    const DEFAULT_SETTINGS = {
        apiKeys: [{ key: "", rpm: 60 }], defaultDifficulty: "Medium", defaultQuestionType: "MultipleChoice", defaultNumQuestions: 10, modelName: "gemini-2.5-flash",
        quizSystemPrompt: "Generate a {{DIFFICULTY}} quiz with {{NUM_QUESTIONS}} {{QUESTION_TYPE}} questions based on the source text.",
        gradingSystemPrompt: "Grade the answer strictly based on the criteria."
    };

    /* --- Project Aware Hook --- */
    const useFileSystem = (files, db, userId, appId, projectId) => {
        const getCollectionRef = (n) => collection(db, `artifacts/${appId}/users/${userId}/${n}`);
        const fileActions = useMemo(() => {
          if (!db || !userId || !projectId) return {};
          return {
            create: async (pid, type, name, content = '') => {
              const ref = await addDoc(getCollectionRef('files'), { 
                  name: name || (type === 'folder' ? 'New Folder' : 'New File'), 
                  type, parentId: pid, projectId, // Add projectId
                  content: type === 'file' ? content : null, metadata: { notes: '' }, createdAt: new Date().toISOString(), userId 
              });
              return { id: ref.id };
            },
            rename: async (fid, name) => updateDoc(doc(db, `artifacts/${appId}/users/${userId}/files`, fid), { name }),
            remove: async (fid) => deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/files`, fid)),
            updateContent: async (fid, content) => updateDoc(doc(db, `artifacts/${appId}/users/${userId}/files`, fid), { content }),
            move: async (fid, pid) => updateDoc(doc(db, `artifacts/${appId}/users/${userId}/files`, fid), { parentId: pid })
          };
        }, [db, userId, appId, projectId]);

        const fileTree = useMemo(() => {
          if (!projectId) return [];
          const map = {}, roots = [];
          files.forEach(f => map[f.id] = { ...f, children: [] });
          Object.values(map).forEach(n => { if(n.parentId === 'root') roots.push(n); else if(map[n.parentId]) map[n.parentId].children.push(n); });
          const sortFn = (a,b) => (a.type === b.type ? a.name.localeCompare(b.name) : (a.type === 'folder' ? -1 : 1));
          const sortNode = (l) => { l.sort(sortFn); l.forEach(c => sortNode(c.children)); };
          sortNode(roots);
          return roots;
        }, [files, projectId]);
        return { fileTree, fileActions };
    };

    /* --- Components --- */
    const ToastProvider = ({ children }) => {
        const [toasts, setToasts] = useState([]);
        const show = useCallback((message, type = 'info') => {
            const id = crypto.randomUUID();
            setToasts(p => [...p, { id, message, type }]);
            setTimeout(() => setToasts(p => p.filter(t => t.id !== id)), 3000);
        }, []);
        return e(ToastContext.Provider, { value: { show } }, children, e('div', { className: 'toast-container' }, toasts.map(t => e('div', { key: t.id, className: `toast-item ${t.type}` }, e('i', { className: t.type === 'success' ? 'bi bi-check-circle-fill mr-2' : 'bi bi-info-circle-fill mr-2' }), t.message))));
    };

    const ProjectDashboard = ({ projects, onCreate, onSelect, onDelete, isLoading }) => {
        const [newProjName, setNewProjName] = useState('');
        const [isCreating, setIsCreating] = useState(false);
        
        const handleCreate = (e) => {
            e.preventDefault();
            if (newProjName.trim()) {
                onCreate(newProjName.trim());
                setNewProjName('');
                setIsCreating(false);
            }
        };

        return e('div', { className: 'h-screen flex flex-col bg-black' },
            e('div', { className: 'p-8 border-b border-gray-800 flex justify-between items-center glass-header' },
                e('h1', { className: 'text-2xl font-light text-white flex items-center gap-3' }, 
                    e('i', { className: 'bi bi-grid-1x2-fill' }), 'Project Dashboard'
                ),
                e('div', { className: 'text-sm text-gray-500' }, `${projects.length} Projects`)
            ),
            e('div', { className: 'project-grid' },
                // Create New Card
                e('div', { className: 'project-card project-card-new', onClick: () => setIsCreating(true) },
                    isCreating 
                    ? e('form', { onSubmit: handleCreate, className: 'w-full', onClick: e => e.stopPropagation() },
                        e('input', { 
                            autoFocus: true,
                            className: 'form-input text-center bg-transparent border-none text-xl mb-4', 
                            placeholder: 'Project Name',
                            value: newProjName,
                            onChange: e => setNewProjName(e.target.value),
                            onBlur: () => setIsCreating(false)
                        }),
                        e('button', { type: 'submit', className: 'modal-button-primary w-full justify-center' }, 'Create')
                    )
                    : e('div', { className: 'flex flex-col items-center' },
                        e('i', { className: 'bi bi-plus-circle text-4xl mb-4' }),
                        e('span', null, 'New Project')
                    )
                ),
                // Project List
                projects.map(p => e('div', { key: p.id, className: 'project-card', onClick: () => onSelect(p.id) },
                    e('div', { className: 'project-title' }, p.name),
                    e('div', { className: 'project-desc' }, 'Managed Workspace'),
                    e('div', { className: 'project-meta' },
                        e('span', null, new Date(p.createdAt).toLocaleDateString()),
                        e('button', { 
                            className: 'delete-project-btn', 
                            onClick: (e) => { e.stopPropagation(); onDelete(p.id); },
                            title: 'Delete Project'
                        }, e('i', { className: 'bi bi-trash' }))
                    )
                ))
            )
        );
    };

    const ReactVscodeSidebar = ({ items, onActiveChange, activeId, isVisible, onHome, children }) => {
      const renderItem = (i) => e('button', { key: i.id, className: 'vsc-activity-item', onClick: () => onActiveChange(i.id), 'data-active': isVisible && i.id === activeId, title: i.label }, e('i', { className: i.icon }));
      return e('div', { className: 'vsc-sidebar-container' }, 
        e('div', { className: 'vsc-activity-bar' }, 
            e('div', null, items.filter(i => !i.isBottom).map(renderItem)), 
            e('div', null, 
                e('button', { className: 'vsc-activity-item mb-4 text-blue-400', onClick: onHome, title: 'Back to Dashboard' }, e('i', { className: 'bi bi-grid-fill' })),
                items.filter(i => i.isBottom).map(renderItem)
            )
        ), 
        e('div', { className: 'vsc-sidebar-view', 'data-visible': isVisible }, isVisible && React.Children.toArray(children).find(c => c.props.viewId === activeId))
      );
    };

    /* --- Main App Logic Updates --- */
    /* Most components (FileNode, MarkdownViewer, etc) remain similar but depend on AppContext */
    
    const FileNode = ({ node, depth, onContextMenu }) => {
        const { activeEditorFile, editingNodeId, setEditingNodeId, fileActions, setActiveEditorFile } = useContext(AppContext);
        const [isOpen, setIsOpen] = useState(false);
        const [editName, setEditName] = useState(node.name);
        const isEditing = editingNodeId === node.id;
        const handleRename = (e) => { e.preventDefault(); if(editName.trim()) fileActions.rename(node.id, editName); setEditingNodeId(null); };
        const getIcon = () => {
            if (node.type === 'folder') return isOpen ? 'bi bi-folder2-open' : 'bi bi-folder-fill';
            if (node.name.endsWith('.md')) return 'bi bi-markdown-fill';
            return 'bi bi-file-earmark-text';
        };
        return e(React.Fragment, null,
            e('div', { 
                className: 'file-tree-node', style: { paddingLeft: `${depth * 12 + 8}px`, display: 'flex', alignItems: 'center' },
                onClick: (e) => { e.stopPropagation(); node.type === 'folder' ? setIsOpen(!isOpen) : setActiveEditorFile(node); },
                onContextMenu: (e) => onContextMenu(e, node), 'data-active': activeEditorFile?.id === node.id
              },
              e('i', { className: `file-tree-node-icon ${getIcon()} ${node.type === 'folder' ? 'text-yellow-600' : 'text-gray-400'}` }),
              isEditing ? e('form', { onSubmit: handleRename }, e('input', { className: 'form-input !p-0 !h-6 text-sm', value: editName, onChange: e => setEditName(e.target.value), onBlur: handleRename, autoFocus: true, onClick: e => e.stopPropagation() })) : e('span', { className: 'truncate select-none' }, node.name)
            ),
            isOpen && node.children.map(child => e(FileNode, { key: child.id, node: child, depth: depth + 1, onContextMenu }))
        );
    };

    const FileManagerView = ({ viewId }) => {
        const { fileTree, fileActions, userId, setActiveEditorFile } = useContext(AppContext);
        const [contextMenu, setContextMenu] = useState({ visible: false, x: 0, y: 0, node: null });
        const handleContextMenu = (e, node) => { if(!userId) return; e.preventDefault(); e.stopPropagation(); setContextMenu({ visible: true, x: e.clientX, y: e.clientY, node }); };
        useEffect(() => { window.addEventListener('click', () => setContextMenu({ visible: false })); }, []);
        return e('div', { viewId, className: 'vsc-view-panes' },
            e('div', { className: 'vsc-view-pane' },
                e('div', { className: 'view-header' }, e('span', null, e('i', { className: 'bi bi-files mr-2' }), 'Explorer'), userId && e('div', { className: 'flex gap-1' }, e('button', { className: 'view-header-icon', onClick: () => fileActions.create('root', 'folder'), title: 'New Folder' }, e('i', { className: 'bi bi-folder-plus' })), e('button', { className: 'view-header-icon', onClick: () => fileActions.create('root', 'file'), title: 'New File' }, e('i', { className: 'bi bi-file-earmark-plus' })), e('button', { className: 'view-header-icon', onClick: () => document.getElementById('file-upload-input').click(), title: 'Upload' }, e('i', { className: 'bi bi-upload' })))),
                e('div', { className: 'vsc-view-pane-content' },
                    !userId && e('div', { className: 'empty-state' }, e('i', { className: 'bi bi-lock-fill' }), 'Sign in to access files'),
                    userId && fileTree.length === 0 && e('div', { className: 'empty-state' }, e('i', { className: 'bi bi-inbox' }), 'No files yet'),
                    userId && fileTree.map(node => e(FileNode, { key: node.id, node, depth: 0, onContextMenu })),
                    userId && contextMenu.visible && e('div', { className: 'context-menu', style: { position: 'fixed', top: contextMenu.y, left: contextMenu.x, zIndex: 1000 } }, e('div', { className: 'context-menu-item', onClick: () => useContext(AppContext).setEditingNodeId(contextMenu.node.id) }, e('i', { className: 'bi bi-pencil' }), 'Rename'), e('div', { className: 'context-menu-divider' }), e('div', { className: 'context-menu-item text-red-400', onClick: () => fileActions.remove(contextMenu.node.id) }, e('i', { className: 'bi bi-trash' }), 'Delete'))
                )
            )
        );
    };

    const MarkdownViewer = ({ markdownText }) => {
        const viewerRef = useRef(null);
        const { contentHtml } = useMemo(() => ({ contentHtml: window.DOMPurify.sanitize(parseMarkdownWithExtensions(FootnoteManager.extractAndClean(markdownText))) }), [markdownText]);
        return e('div', { className: 'prose-readable-wrapper prose-dark-theme flex-1 overflow-auto' }, e('div', { className: 'prose-readable', dangerouslySetInnerHTML: { __html: contentHtml } }));
    };

    const MainContentEditor = () => {
        const { activeEditorFile, fileActions, dispatchTask, quizOptions, userId, handleGoogleSignIn } = useContext(AppContext);
        const [content, setContent] = useState("");
        const [mode, setMode] = useState('edit');
        const [isSaved, setIsSaved] = useState(true);
        const toast = useToast();
        useEffect(() => { setContent(activeEditorFile?.content || ""); setMode('edit'); setIsSaved(true); }, [activeEditorFile]);
        useEffect(() => { 
            if(!activeEditorFile || content === activeEditorFile.content) { setIsSaved(true); return; }
            setIsSaved(false);
            const timer = setTimeout(() => { fileActions.updateContent(activeEditorFile.id, content).then(() => setIsSaved(true)); }, 1000);
            return () => clearTimeout(timer);
        }, [content, activeEditorFile]);
        
        if (!userId) return e('div', { className: 'main-editor-placeholder' }, e('i', { className: 'bi bi-shield-lock text-6xl mb-4 opacity-50' }), e('p', null, 'Authentication Required'), e('button', { className: 'form-button', onClick: handleGoogleSignIn }, e('i', { className: 'bi bi-google' }), 'Sign In with Google'));
        if (!activeEditorFile) return e('div', { className: 'main-editor-placeholder' }, e('i', { className: 'bi bi-file-earmark-text text-6xl mb-4 opacity-50' }), e('p', null, 'Select a file to edit'));

        return e('div', { className: 'flex flex-col h-full' },
            e('div', { className: 'main-editor-header' },
                e('span', { className: 'main-editor-title' }, e('i', { className: 'bi bi-file-text' }), activeEditorFile.name),
                e('div', { className: 'editor-toggle-group mx-4' }, e('button', { className: `editor-toggle-btn ${mode==='edit'?'active':''}`, onClick: ()=>setMode('edit') }, e('i', { className: 'bi bi-pencil-square' }), 'Edit'), e('button', { className: `editor-toggle-btn ${mode==='view'?'active':''}`, onClick: ()=>setMode('view') }, e('i', { className: 'bi bi-eye' }), 'Preview')),
                e('button', { className: 'main-editor-action-btn', onClick: () => dispatchTask({ taskType: 'generate', sourceText: content, options: { ...quizOptions, fileId: activeEditorFile.id, sourceFileName: activeEditorFile.name } }) }, e('i', { className: 'bi bi-stars' }), 'Generate Quiz')
            ),
            mode === 'view' ? e(MarkdownViewer, { markdownText: content }) : e('textarea', { className: 'main-editor', value: content, onChange: e => setContent(e.target.value), spellCheck: false, placeholder: 'Start typing...' }),
            e('div', { className: 'main-editor-footer' }, e('span', { className: 'flex items-center gap-2' }, isSaved ? e('i', { className: 'bi bi-check2-circle text-green-500' }) : e('i', { className: 'bi bi-circle text-yellow-500' }), isSaved ? 'Saved' : 'Unsaved changes'))
        );
    };

    const QuizGeneratorView = ({ viewId }) => {
        const { quizOptions, setQuizOptions } = useContext(AppContext);
        return e('div', { viewId, className: 'flex flex-col h-full' },
            e('h3', { className: 'view-header' }, e('span', null, e('i', { className: 'bi bi-sliders mr-2' }), 'Quiz Options')),
            e('div', { className: 'view-content-scroll p-4' },
                e('div', { className: 'form-group' }, e('label', { className: 'form-label' }, 'Question Count'), e('input', { type: 'number', className: 'form-input', value: quizOptions.numQuestions, onChange: e => setQuizOptions(o => ({...o, numQuestions: parseInt(e.target.value)})) })),
                e('div', { className: 'form-group' }, e('label', { className: 'form-label' }, 'Difficulty'), e('select', { className: 'form-select', value: quizOptions.difficulty, onChange: e => setQuizOptions(o => ({...o, difficulty: e.target.value})) }, e('option', { value: 'Easy' }, 'Easy'), e('option', { value: 'Medium' }, 'Medium'), e('option', { value: 'Hard' }, 'Hard'))),
                e('div', { className: 'form-group' }, e('label', { className: 'form-label' }, 'Type'), e('select', { className: 'form-select', value: quizOptions.questionType, onChange: e => setQuizOptions(o => ({...o, questionType: e.target.value})) }, e('option', { value: 'MultipleChoice' }, 'Multiple Choice'), e('option', { value: 'Essay' }, 'Essay')))
            )
        );
    };

    const QuizHistoryView = ({ viewId }) => {
        const { attempts, setModalContent, dispatchGradingTask, userSettings, userId } = useContext(AppContext);
        if(!userId) return e('div', { viewId, className: 'empty-state' }, e('i', { className: 'bi bi-lock' }), 'Please Login');
        return e('div', { viewId, className: 'flex flex-col h-full' },
            e('h3', { className: 'view-header' }, e('span', null, e('i', { className: 'bi bi-clock-history mr-2' }), 'History')),
            e('div', { className: 'view-content-scroll p-4' },
                attempts.length === 0 && e('div', { className: 'empty-state' }, e('i', { className: 'bi bi-journal-x' }), 'No quizzes taken yet'),
                attempts.map(a => e('div', { key: a.id, className: 'list-item', onClick: () => setModalContent(e(QuizResult, { attempt: a, onClose: () => setModalContent(null), dispatchGradingTask, userSettings })) }, e('div', { className: 'list-item-title' }, e('i', { className: 'bi bi-check2-square' }), a.quizTitle), e('div', { className: 'list-item-sub flex justify-between' }, e('span', null, `Score: ${a.score}/${a.total}`), e('span', { className: 'opacity-50' }, new Date(a.completedAt || Date.now()).toLocaleDateString()))))
            )
        );
    };
    
    const QuizResult = ({ attempt, onClose, dispatchGradingTask }) => {
        const results = JSON.parse(attempt.answers);
        return e('div', { className: 'modal-overlay', onClick: onClose },
            e('div', { className: 'modal-container', onClick: e => e.stopPropagation() },
                e('div', { className: 'modal-header' }, e('h2', null, attempt.quizTitle), e('button', { className: 'modal-close-btn', onClick: onClose }, e('i', { className: 'bi bi-x-lg' }))),
                e('div', { className: 'modal-body' },
                    e('div', { className: 'flex flex-col items-center mb-8' }, e('div', { className: 'text-4xl font-thin mb-2' }, `${attempt.score} / ${attempt.total}`), e('div', { className: 'text-sm text-gray-400 uppercase tracking-widest' }, 'Final Score')),
                    results.map((r, i) => e('div', { key: i, className: 'quiz-question-card mb-4' }, e('p', { className: 'font-medium mb-2 text-lg' }, `${i+1}. ${r.questionText}`), r.isCorrect === null ? e('p', { className: 'text-yellow-500 text-sm flex items-center gap-2' }, e('i', { className: 'bi bi-hourglass-split' }), 'Pending AI Grading...') : e('div', null, e('p', { className: r.isCorrect ? 'text-green-400 flex items-center gap-2' : 'text-red-400 flex items-center gap-2' }, e('i', { className: r.isCorrect ? 'bi bi-check-circle' : 'bi bi-x-circle' }), r.isCorrect ? 'Correct' : 'Incorrect'), r.feedback && e('div', { className: 'text-sm text-gray-300 mt-2 bg-black bg-opacity-30 p-3 rounded border border-gray-800' }, e('strong', { className: 'block mb-1 text-xs text-blue-300' }, 'AI FEEDBACK'), r.feedback))))
                ),
                e('div', { className: 'modal-footer' }, e('button', { className: 'modal-button-secondary', onClick: onClose }, 'Close'), results.some(r => r.isCorrect === null) && e('button', { className: 'modal-button-primary', onClick: () => { dispatchGradingTask(attempt); onClose(); } }, e('i', { className: 'bi bi-magic' }), 'Auto-Grade'))
            )
        );
    };
    
    const TaskMonitorView = ({ viewId }) => {
        const { taskQueue } = useContext(AppContext);
        return e('div', { viewId, className: 'flex flex-col h-full' },
            e('h3', { className: 'view-header' }, e('span', null, e('i', { className: 'bi bi-activity mr-2' }), 'Tasks')),
            e('div', { className: 'view-content-scroll p-4' },
                taskQueue.length === 0 && e('div', { className: 'empty-state' }, e('i', { className: 'bi bi-check2-all' }), 'All systems nominal'),
                taskQueue.map(t => e('div', { key: t.id, className: 'list-item' }, e('div', { className: 'list-item-title' }, e('i', { className: t.status === 'processing' ? 'bi bi-arrow-repeat animate-spin' : (t.status === 'success' ? 'bi bi-check-circle text-green-500' : 'bi bi-exclamation-triangle text-red-500') }), t.taskType), e('div', { className: 'list-item-sub ml-6' }, t.status === 'processing' ? 'Processing...' : t.status)))
            )
        );
    };
    
    const SettingsModal = ({ onClose }) => {
        const { userSettings, saveSettings } = useContext(AppContext);
        const [key, setKey] = useState(userSettings?.apiKeys?.[0]?.key || "");
        const [model, setModel] = useState(userSettings?.modelName || "gemini-2.5-flash");
        return e('div', { className: 'modal-overlay', onClick: onClose },
            e('div', { className: 'modal-container', onClick: e => e.stopPropagation() },
                e('div', { className: 'modal-header' }, e('h2', null, 'Settings'), e('button', { className: 'modal-close-btn', onClick: onClose }, e('i', { className: 'bi bi-x-lg' }))),
                e('div', { className: 'modal-body' }, e('div', { className: 'form-group' }, e('label', { className: 'form-label' }, 'Gemini API Key'), e('input', { className: 'form-input', type: 'password', value: key, onChange: e => setKey(e.target.value) })), e('div', { className: 'form-group' }, e('label', { className: 'form-label' }, 'Model Name'), e('input', { className: 'form-input', value: model, onChange: e => setModel(e.target.value) }))),
                e('div', { className: 'modal-footer' }, e('button', { className: 'modal-button-secondary', onClick: onClose }, 'Cancel'), e('button', { className: 'modal-button-primary', onClick: () => { saveSettings({ ...userSettings, apiKeys: [{ key, rpm: 60 }], modelName: model }); onClose(); } }, e('i', { className: 'bi bi-save' }), 'Save'))
            )
        );
    };

    const App = () => {
        const [db, setDb] = useState(null);
        const [auth, setAuth] = useState(null);
        const [userId, setUserId] = useState(null);
        const [activeProjectId, setActiveProjectId] = useState(null);
        const [projects, setProjects] = useState([]);
        
        const [userSettings, setUserSettings] = useState(DEFAULT_SETTINGS);
        const [files, setFiles] = useState([]);
        const [quizzes, setQuizzes] = useState([]);
        const [attempts, setAttempts] = useState([]);
        const [taskQueue, setTaskQueue] = useState([]);
        const [activeViewId, setActiveViewId] = useState('files');
        const [activeEditorFile, setActiveEditorFile] = useState(null);
        const [modalContent, setModalContent] = useState(null);
        const [editingNodeId, setEditingNodeId] = useState(null);
        const [quizOptions, setQuizOptions] = useState({ numQuestions: 5, difficulty: 'Medium', questionType: 'MultipleChoice' });
        
        const quizWorker = useMemo(() => new Worker(workerUrl), []);
        const toast = useToast();

        useEffect(() => {
            try {
                const c = JSON.parse(window.__firebase_config);
                const app = initializeApp(c);
                setDb(getFirestore(app));
                setAuth(getAuth(app));
                onAuthStateChanged(getAuth(app), u => {
                    setUserId(u ? u.uid : null);
                    if(!u) setActiveProjectId(null);
                });
            } catch(e) { console.error(e); }
        }, []);

        // Projects Listener
        useEffect(() => {
            if(!db || !userId) return;
            const q = query(collection(db, `artifacts/${window.__app_id}/users/${userId}/projects`), orderBy('createdAt', 'desc'));
            return onSnapshot(q, s => setProjects(s.docs.map(d => ({id: d.id, ...d.data()}))));
        }, [db, userId]);

        // Project-specific Data Listeners
        useEffect(() => {
            if(!db || !userId || !activeProjectId) {
                setFiles([]); setQuizzes([]); setAttempts([]); setActiveEditorFile(null);
                return;
            }
            const filesQuery = query(collection(db, `artifacts/${window.__app_id}/users/${userId}/files`), where('projectId', '==', activeProjectId));
            const quizzesQuery = query(collection(db, `artifacts/${window.__app_id}/users/${userId}/quizzes`), where('projectId', '==', activeProjectId));
            const attemptsQuery = query(collection(db, `artifacts/${window.__app_id}/users/${userId}/quizAttempts`), where('projectId', '==', activeProjectId));
            
            const uF = onSnapshot(filesQuery, s => setFiles(s.docs.map(d => ({id:d.id, ...d.data()}))));
            const uQ = onSnapshot(quizzesQuery, s => setQuizzes(s.docs.map(d => ({id:d.id, ...d.data()}))));
            const uA = onSnapshot(attemptsQuery, s => setAttempts(s.docs.map(d => ({id:d.id, ...d.data()}))));
            const uS = onSnapshot(doc(db, `artifacts/${window.__app_id}/users/${userId}/settings/userConfig`), s => s.exists() && setUserSettings(s.data()));
            return () => { uF(); uQ(); uA(); uS(); };
        }, [db, userId, activeProjectId]);

        useEffect(() => {
            quizWorker.onmessage = (e) => {
                const { status, taskId, taskType, quizData, updatedAttempt, options } = e.data;
                setTaskQueue(q => q.map(t => t.id === taskId ? { ...t, status } : t));
                // Must use activeProjectId when saving result
                if(status === 'success' && taskType === 'generate') {
                     addDoc(collection(db, `artifacts/${window.__app_id}/users/${userId}/quizzes`), { ...quizData, userId, projectId: activeProjectId, createdAt: new Date().toISOString() });
                }
                if(status === 'success' && taskType === 'grade') {
                    updateDoc(doc(db, `artifacts/${window.__app_id}/users/${userId}/quizAttempts`, updatedAttempt.id), updatedAttempt);
                }
            };
        }, [quizWorker, db, userId, activeProjectId]);

        const createProject = async (name) => {
            if(!userId) return;
            await addDoc(collection(db, `artifacts/${window.__app_id}/users/${userId}/projects`), { name, createdAt: new Date().toISOString() });
        };

        const deleteProject = async (id) => {
            if(confirm('Delete this project and all its files?')) {
                await deleteDoc(doc(db, `artifacts/${window.__app_id}/users/${userId}/projects`, id));
                // Ideally we should delete all files in the project too, but for now we just delete the project ref.
            }
        };

        const { fileTree, fileActions } = useFileSystem(files, db, userId, window.__app_id, activeProjectId);

        const contextValue = {
            db, userId, fileTree, fileActions, activeEditorFile, setActiveEditorFile, 
            dispatchTask: (data) => {
                const id = crypto.randomUUID();
                setTaskQueue(p => [{...data, id, status: 'processing'}, ...p]);
                quizWorker.postMessage({ ...data, id, settings: userSettings });
            },
            quizOptions, setQuizOptions, attempts, quizzes, setModalContent, userSettings,
            saveSettings: (s) => setDoc(doc(db, `artifacts/${window.__app_id}/users/${userId}/settings/userConfig`), s, {merge: true}),
            handleGoogleSignIn: () => signInWithPopup(auth, new GoogleAuthProvider()),
            handleSignOut: () => { signOut(auth); setActiveProjectId(null); },
            editingNodeId, setEditingNodeId,
            dispatchGradingTask: (a) => {
                const id = crypto.randomUUID();
                setTaskQueue(p => [{taskType: 'grade', id, status: 'processing'}, ...p]);
                quizWorker.postMessage({ taskType: 'grade', id, attempt: a, settings: userSettings });
            }
        };

        const sidebarItems = [
            { id: 'files', icon: 'bi bi-files', label: 'Explorer' }, 
            { id: 'search', icon: 'bi bi-search', label: 'Search' }, 
            { id: 'quiz-generator', icon: 'bi bi-lightning-charge', label: 'Generate' },
            { id: 'history', icon: 'bi bi-clock-history', label: 'History' }, 
            { id: 'tasks', icon: 'bi bi-activity', label: 'Tasks' }, 
            { id: 'settings', icon: 'bi bi-gear', label: 'Settings', isBottom: true },
            { id: 'user', icon: 'bi bi-person-circle', label: 'User', isBottom: true }
        ];
        
        const handleActiveChange = (id) => {
            if (id === 'settings') setModalContent(e(SettingsModal, { onClose: () => setModalContent(null) }));
            else if (id === 'user' && userId) signOut(auth);
            else setActiveViewId(id);
        };

        // Render Logic
        if (userId && !activeProjectId) {
            return e(ProjectDashboard, { 
                projects, 
                onCreate: createProject, 
                onSelect: setActiveProjectId,
                onDelete: deleteProject
            });
        }

        return e(AppContext.Provider, { value: contextValue },
            e('div', { className: 'flex h-screen' },
                e(ReactVscodeSidebar, { 
                    items: sidebarItems, 
                    onActiveChange: handleActiveChange, 
                    activeId: activeViewId, 
                    isVisible: true,
                    onHome: () => setActiveProjectId(null) 
                },
                    e(FileManagerView, { viewId: 'files' }),
                    e(QuizGeneratorView, { viewId: 'quiz-generator' }),
                    e(QuizHistoryView, { viewId: 'history' }),
                    e(TaskMonitorView, { viewId: 'tasks' })
                ),
                e('div', { className: 'main-content' }, e(MainContentEditor)),
                modalContent
            )
        );
    };

    createRoot(document.getElementById('root')).render(e(ToastProvider, null, e(App)));
  </script>
</body>
</html>
